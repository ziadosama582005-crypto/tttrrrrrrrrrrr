#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import html
import logging
import telebot
from telebot import types
from flask import Flask, request, render_template_string, render_template, redirect, session, jsonify
import json
import random
import hashlib
import time
import uuid
import requests
import firebase_admin
from firebase_admin import credentials, firestore

# ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ŸÑŸÑÿ£ÿÆÿ∑ÿßÿ° (ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ŸÅŸÇÿ∑)
logging.basicConfig(level=logging.ERROR)
logger = logging.getLogger(__name__)

# ŸÖÿ≠ÿßŸàŸÑÿ© ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ FieldFilter ŸÑŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ¨ÿØŸäÿØÿ©
try:
    from google.cloud.firestore_v1.base_query import FieldFilter
    USE_FIELD_FILTER = True
except ImportError:
    USE_FIELD_FILTER = False

# --- ÿ•ÿπÿØÿßÿØÿßÿ™ Firebase ---
# ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÖÿ™ÿ∫Ÿäÿ± ÿßŸÑÿ®Ÿäÿ¶ÿ© ÿ£ŸàŸÑÿßŸã (ŸÑŸÑÿ•ŸÜÿ™ÿßÿ¨ ŸÅŸä Render)
firebase_credentials_json = os.environ.get("FIREBASE_CREDENTIALS")
db = None

try:
    if firebase_credentials_json:
        # ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ± ÿßŸÑÿ®Ÿäÿ¶Ÿä (Render)
        cred_dict = json.loads(firebase_credentials_json)
        cred = credentials.Certificate(cred_dict)
        print("‚úÖ Firebase: ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ± ÿßŸÑÿ®Ÿäÿ¶Ÿä (Production)")
    else:
        # ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ≠ŸÑŸä (ŸÑŸÑÿ™ÿ∑ŸàŸäÿ±)
        if os.path.exists('serviceAccountKey.json'):
            cred = credentials.Certificate('serviceAccountKey.json')
            print("‚úÖ Firebase: ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ≠ŸÑŸä (Development)")
        else:
            raise FileNotFoundError("Firebase credentials not found")

    firebase_admin.initialize_app(cred)
    db = firestore.client()
except Exception as e:
    print(f"‚ö†Ô∏è Firebase ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠: {e}")
    print("‚ö†Ô∏è ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿπŸÖŸÑ ÿ®ÿØŸàŸÜ ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ Firebase (ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ŸÅŸÇÿ∑)")
    db = None

# --- ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ®Ÿàÿ™ ---
# ÿ¢ŸäÿØŸä ÿßŸÑŸÖÿßŸÑŸÉ - Ÿäÿ¨ÿ® ÿ™ÿπŸäŸäŸÜŸá ŸÅŸä ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ®Ÿäÿ¶ÿ© (ADMIN_ID) ŸÅŸä Render
# ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸàŸáŸÖŸäÿ© ŸÑŸÑÿ£ŸÖÿßŸÜ - ŸÑŸÜ ÿ™ÿπŸÖŸÑ ÿ®ÿØŸàŸÜ ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ¢ŸäÿØŸä ÿßŸÑÿ≠ŸÇŸäŸÇŸä
ADMIN_ID = int(os.environ.get("ADMIN_ID", 123456789))
TOKEN = os.environ.get("BOT_TOKEN", "default_token_123456789:ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefgh")
SITE_URL = os.environ.get("SITE_URL", "http://localhost:5000")

# --- ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿØŸÅÿπ EdfaPay ---
EDFAPAY_MERCHANT_ID = os.environ.get("ADFALY_MERCHANT_ID", "")
EDFAPAY_PASSWORD = os.environ.get("ADFALY_PASSWORD", "")
EDFAPAY_API_URL = "https://api.edfapay.com/payment/initiate"

# ÿØÿßŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ Callback URL ŸÅŸä EdfaPay
def register_edfapay_callback():
    """ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÄ webhook ŸÅŸä EdfaPay"""
    if not EDFAPAY_MERCHANT_ID:
        print("‚ö†Ô∏è ŸÑÿß ŸäŸàÿ¨ÿØ MERCHANT_ID ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÄ callback")
        return False
    
    try:
        callback_url = f"{SITE_URL}/payment/edfapay_webhook"
        
        response = requests.post(
            "https://api.edfapay.com/payment/merchants/callback-url",
            json={
                "action": "post",
                "id": EDFAPAY_MERCHANT_ID,
                "url": callback_url
            },
            timeout=30
        )
        
        print(f"üì° ÿ™ÿ≥ÿ¨ŸäŸÑ Callback URL: {response.status_code}")
        print(f"üì° Response: {response.text}")
        
        if response.status_code == 200:
            print(f"‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ Callback URL: {callback_url}")
            return True
        else:
            print(f"‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ Callback URL")
            return False
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ Callback: {e}")
        return False

# ÿØÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Callback URL ÿßŸÑŸÖÿ≥ÿ¨ŸÑ
def check_edfapay_callback():
    """ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÄ webhook ÿßŸÑŸÖÿ≥ÿ¨ŸÑ ŸÅŸä EdfaPay"""
    if not EDFAPAY_MERCHANT_ID:
        return None
    
    try:
        response = requests.post(
            "https://api.edfapay.com/payment/merchants/callback-url",
            json={
                "action": "get",
                "id": EDFAPAY_MERCHANT_ID
            },
            timeout=30
        )
        
        if response.status_code == 200:
            return response.json()
        return None
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Callback: {e}")
        return None

# ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ™ŸàŸÉŸÜ ÿµÿ≠Ÿäÿ≠ (ŸÑŸäÿ≥ ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©)
if TOKEN.startswith("default_token"):
    print("‚ö†Ô∏è BOT_TOKEN ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ - ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ™ÿ∫Ÿäÿ± ÿßŸÑÿ®Ÿäÿ¶ÿ© BOT_TOKEN")
    bot = telebot.TeleBot("dummy_token")  # ÿ•ŸÜÿ¥ÿßÿ° ÿ®Ÿàÿ™ ŸàŸáŸÖŸä ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°
    BOT_ACTIVE = False
    BOT_USERNAME = ""
else:
    try:
        bot = telebot.TeleBot(TOKEN)
        # ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ®Ÿàÿ™ ŸÑÿ™ÿ¨ŸÜÿ® ÿÆÿ∑ÿ£ 429 (Too Many Requests)
        telebot.apihelper.RETRY_ON_ERROR = True
        BOT_ACTIVE = True
        # ÿ¨ŸÑÿ® ÿßÿ≥ŸÖ ÿßŸÑÿ®Ÿàÿ™
        try:
            bot_info = bot.get_me()
            BOT_USERNAME = bot_info.username
            print(f"‚úÖ ÿßŸÑÿ®Ÿàÿ™: ŸÖÿ™ÿµŸÑ ÿ®ŸÜÿ¨ÿßÿ≠ (@{BOT_USERNAME})")
        except:
            BOT_USERNAME = ""
            print(f"‚úÖ ÿßŸÑÿ®Ÿàÿ™: ŸÖÿ™ÿµŸÑ ÿ®ŸÜÿ¨ÿßÿ≠")
    except Exception as e:
        BOT_ACTIVE = False
        BOT_USERNAME = ""
        bot = telebot.TeleBot("dummy_token")  # ÿ•ŸÜÿ¥ÿßÿ° ÿ®Ÿàÿ™ ŸàŸáŸÖŸä ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°
        print(f"‚ö†Ô∏è ÿßŸÑÿ®Ÿàÿ™ ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠: {e}")

app = Flask(__name__)

# --- ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ŸÖÿßŸÜ ŸÑŸÑÿ¨ŸÑÿ≥ÿßÿ™ ---
import secrets
from datetime import timedelta

# ÿ™ŸàŸÑŸäÿØ ŸÖŸÅÿ™ÿßÿ≠ ÿ≥ÿ±Ÿä ŸÇŸàŸä (ÿ£Ÿà ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ± ÿßŸÑÿ®Ÿäÿ¶Ÿä)
SECRET_KEY = os.environ.get("SECRET_KEY")
if not SECRET_KEY or SECRET_KEY == "your-secret-key-here-change-it":
    SECRET_KEY = secrets.token_hex(32)  # 64 ÿ≠ÿ±ŸÅ ÿπÿ¥Ÿàÿßÿ¶Ÿä
    print("‚ö†Ô∏è ÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ ŸÖŸÅÿ™ÿßÿ≠ ÿ≥ÿ±Ÿä ÿ¨ÿØŸäÿØ (ŸäŸèŸÅÿ∂ŸÑ ÿ™ÿπŸäŸäŸÜ SECRET_KEY ŸÅŸä ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ®Ÿäÿ¶ÿ©)")

app.secret_key = SECRET_KEY

# ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÉŸàŸÉŸäÿ≤ ÿßŸÑÿ¢ŸÖŸÜÿ©
# SESSION_COOKIE_SECURE=False ŸÑŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑŸÖÿ≠ŸÑŸäÿå True ŸÑŸÑÿ•ŸÜÿ™ÿßÿ¨
IS_PRODUCTION = os.environ.get("RENDER", False) or os.environ.get("PRODUCTION", False)
app.config.update(
    SESSION_COOKIE_SECURE=IS_PRODUCTION,        
    SESSION_COOKIE_HTTPONLY=True,     
    SESSION_COOKIE_SAMESITE='Strict',  # ‚úÖ ÿ™ŸÇŸàŸäÿ© ŸÖŸÜ Lax ÿ•ŸÑŸâ Strict
    PERMANENT_SESSION_LIFETIME=timedelta(minutes=30),  
    SESSION_COOKIE_NAME='tr_session',  
)

# --- Rate Limiting (ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™) ---
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

limiter = Limiter(
    key_func=get_remote_address,
    app=app,
    default_limits=["200 per day", "50 per hour"],
    storage_uri="memory://",
)

# --- ÿØÿßŸÑÿ© ÿ™ŸÜÿ∏ŸäŸÅ XSS ---
def sanitize(text):
    """ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÜÿµ ŸÖŸÜ ÿ£ŸÉŸàÿßÿØ HTML/JS ÿßŸÑÿÆÿ®Ÿäÿ´ÿ©"""
    if text is None:
        return None
    if not isinstance(text, str):
        return text
    return html.escape(str(text))

# --- Security Headers ---
@app.after_request
def add_security_headers(response):
    """ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿ§Ÿàÿ≥ ÿ£ŸÖÿßŸÜ ŸÑŸÑÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ ÿßŸÑŸáÿ¨ŸÖÿßÿ™"""
    response.headers['X-Content-Type-Options'] = 'nosniff'
    response.headers['X-Frame-Options'] = 'DENY'
    response.headers['X-XSS-Protection'] = '1; mode=block'
    response.headers['Referrer-Policy'] = 'strict-origin-when-cross-origin'
    return response

# ÿØÿßŸÑÿ© ŸÑÿ™ÿ¨ÿØŸäÿØ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿ®ÿπÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
def regenerate_session():
    """ÿ™ÿ¨ÿØŸäÿØ ID ÿßŸÑÿ¨ŸÑÿ≥ÿ© ŸÑŸÖŸÜÿπ Session Fixation"""
    old_data = dict(session)
    session.clear()
    session.update(old_data)
    session.modified = True

# --- ŸÇŸàÿßÿπÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ---
# ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ™Ÿèÿ≠ŸÅÿ∏ ŸÅŸä Firebase (ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨) Ÿàÿ™Ÿèÿ≠ŸÖŸÑ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑÿ≥ÿ±Ÿäÿπ

# ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™/ÿßŸÑÿÆÿØŸÖÿßÿ™
# ÿßŸÑÿ¥ŸÉŸÑ: { item_name, price, seller_id, seller_name, hidden_data, image_url, category }
marketplace_items = []

# ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÜÿ¥ÿ∑ÿ© (ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞ ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿßŸÑŸÖÿ¥ÿ±ŸÅŸäŸÜ)
# ÿßŸÑÿ¥ŸÉŸÑ: { order_id: {buyer_info, item_info, admin_id, status, message_id} }
active_orders = {}

# ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ (ÿßŸÑÿ±ÿµŸäÿØ)
# ÿßŸÑÿ¥ŸÉŸÑ: { user_id: balance }
users_wallets = {}

# ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ© (ÿßŸÑŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑŸÖÿ≠ÿ¨Ÿàÿ≤ÿ©)
transactions = {}

# ÿ±ŸÖŸàÿ≤ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
# ÿßŸÑÿ¥ŸÉŸÑ: { user_id: {code, name, created_at} }
verification_codes = {}

# ÿ£ŸÉŸàÿßÿØ ÿØÿÆŸàŸÑ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ§ŸÇÿ™ÿ©
# ÿßŸÑÿ¥ŸÉŸÑ: { 'code': code, 'created_at': time, 'used': False, 'ip': ip }
admin_login_codes = {}

# ŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑŸÅÿßÿ¥ŸÑÿ© (ŸÑŸÑÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ brute force)
# ÿßŸÑÿ¥ŸÉŸÑ: { ip: {'count': n, 'blocked_until': time} }
failed_login_attempts = {}

# ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑÿ¥ÿ≠ŸÜ ÿßŸÑŸÖŸàŸÑÿØÿ©
# ÿßŸÑÿ¥ŸÉŸÑ: { key_code: {amount, used, used_by, created_at} }
charge_keys = {}

# ÿ≠ÿßŸÑÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ (ŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ© - ŸÖÿ´ŸÑ ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ•ÿØÿÆÿßŸÑ ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ¥ÿ≠ŸÜ)
# ÿßŸÑÿ¥ŸÉŸÑ: { user_id: {'state': 'waiting_amount', 'data': {}} }
user_states = {}

# ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ (ÿ™Ÿèÿ≠ŸÖŸÑ ŸÖŸÜ Firebase)
# ÿßŸÑÿ¥ŸÉŸÑ: { user_id: { items: [...], created_at, expires_at } }
user_carts = {}

# ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÖÿπŸÑŸÇÿ© (ÿ™ŸÜÿ™ÿ∏ÿ± ÿßŸÑÿØŸÅÿπ ŸÖŸÜ Adfaly Pay)
# ÿßŸÑÿ¥ŸÉŸÑ: { invoice_id: {user_id, amount, status, created_at} }
pending_payments = {}

# ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖŸÜÿ¥ÿ£ÿ© ŸÖŸÜ ÿßŸÑÿ™ÿ¨ÿßÿ± (ŸÑŸÑÿπŸÖŸÑÿßÿ°)
# ÿßŸÑÿ¥ŸÉŸÑ: { invoice_id: {merchant_id, merchant_name, amount, customer_phone, status, created_at} }
merchant_invoices = {}

# ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸäÿ©
# ÿßŸÑÿ¥ŸÉŸÑ: { id: {name, image_url, order, delivery_type, created_at} }
categories_list = [
    {'id': '1', 'name': 'ŸÜÿ™ŸÅŸÑŸÉÿ≥', 'image_url': 'https://i.imgur.com/netflix.png', 'order': 1, 'delivery_type': 'instant'},
    {'id': '2', 'name': 'ÿ¥ÿßŸáÿØ', 'image_url': 'https://i.imgur.com/shahid.png', 'order': 2, 'delivery_type': 'instant'},
    {'id': '3', 'name': 'ÿØŸäÿ≤ŸÜŸä ÿ®ŸÑÿ≥', 'image_url': 'https://i.imgur.com/disney.png', 'order': 3, 'delivery_type': 'instant'},
    {'id': '4', 'name': 'ÿßŸàÿ≥ŸÜ ÿ®ŸÑÿ≥', 'image_url': 'https://i.imgur.com/osn.png', 'order': 4, 'delivery_type': 'instant'},
    {'id': '5', 'name': 'ŸÅÿØŸäŸà ÿ®ÿ±ŸäŸÖŸäŸÖ', 'image_url': 'https://i.imgur.com/vedio.png', 'order': 5, 'delivery_type': 'instant'},
    {'id': '6', 'name': 'ÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ÿ£ÿÆÿ±Ÿâ', 'image_url': 'https://i.imgur.com/other.png', 'order': 6, 'delivery_type': 'manual'}
]

# ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ (ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ)
display_settings = {
    'categories_columns': 3  # ÿπÿØÿØ ÿßŸÑÿ£ÿπŸÖÿØÿ©: 2 ÿ£Ÿà 3 ÿ£Ÿà 4
}

# ÿØÿßŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase ÿπŸÜÿØ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
def load_all_data_from_firebase():
    """ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase ÿπŸÜÿØ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ"""
    global marketplace_items, users_wallets, charge_keys, active_orders, categories_list, display_settings
    
    if not db:
        print("‚ö†Ô∏è Firebase ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ - ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿßÿ±ÿ∫ÿ©")
        return
    
    try:
        print("üì• ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase...")
        
        # 1Ô∏è‚É£ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ (ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© ŸÅŸÇÿ∑)
        try:
            products_ref = query_where(db.collection('products'), 'sold', '==', False)
            marketplace_items = []
            count = 0
            for doc in products_ref.stream():
                data = doc.to_dict()
                data['id'] = doc.id
                marketplace_items.append(data)
                count += 1
            print(f"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ {count} ŸÖŸÜÿ™ÿ¨ ŸÖÿ™ÿßÿ≠")
        except Exception as e:
            print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™: {e}")
        
        # 2Ô∏è‚É£ ÿ™ÿ≠ŸÖŸäŸÑ ÿ£ÿ±ÿµÿØÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        try:
            users_ref = db.collection('users')
            users_wallets = {}
            count = 0
            for doc in users_ref.stream():
                data = doc.to_dict()
                users_wallets[doc.id] = data.get('balance', 0.0)
                count += 1
            print(f"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ£ÿ±ÿµÿØÿ© {count} ŸÖÿ≥ÿ™ÿÆÿØŸÖ")
        except Exception as e:
            print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ£ÿ±ÿµÿØÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ: {e}")
        
        # 3Ô∏è‚É£ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑÿ¥ÿ≠ŸÜ (ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ©)
        try:
            keys_ref = query_where(db.collection('charge_keys'), 'used', '==', False)
            charge_keys = {}
            count = 0
            for doc in keys_ref.stream():
                data = doc.to_dict()
                charge_keys[doc.id] = {
                    'amount': data.get('amount', 0),
                    'used': data.get('used', False),
                    'used_by': data.get('used_by'),
                    'created_at': data.get('created_at', time.time())
                }
                count += 1
            print(f"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ {count} ŸÖŸÅÿ™ÿßÿ≠ ÿ¥ÿ≠ŸÜ ŸÜÿ¥ÿ∑")
        except Exception as e:
            print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑÿ¥ÿ≠ŸÜ: {e}")
        
        # 4Ô∏è‚É£ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÜÿ¥ÿ∑ÿ© (pending ÿ£Ÿà claimed)
        try:
            active_orders = {}
            # ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÜÿ¥ÿ∑ÿ©
            orders_ref = db.collection('orders')
            orders_query = orders_ref.where('status', 'in', ['pending', 'claimed'])
            for doc in orders_query.stream():
                data = doc.to_dict()
                active_orders[doc.id] = data
            print(f"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ {len(active_orders)} ÿ∑ŸÑÿ® ŸÜÿ¥ÿ∑")
        except Exception as e:
            print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™: {e}")
        
        # 5Ô∏è‚É£ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
        try:
            cats_ref = db.collection('categories').order_by('order')
            loaded_cats = []
            for doc in cats_ref.stream():
                data = doc.to_dict()
                data['id'] = doc.id
                loaded_cats.append(data)
            if loaded_cats:
                categories_list = loaded_cats
                print(f"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ {len(categories_list)} ŸÇÿ≥ŸÖ")
            else:
                print(f"‚ÑπÔ∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÇÿ≥ÿßŸÖ ŸÅŸä Firebase - ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ({len(categories_list)})")
        except Exception as e:
            print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ: {e}")
        
        # 6Ô∏è‚É£ ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿ±ÿ∂
        try:
            settings_doc = db.collection('settings').document('display').get()
            if settings_doc.exists:
                settings_data = settings_doc.to_dict()
                display_settings['categories_columns'] = settings_data.get('categories_columns', 3)
                print(f"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ (ÿ£ÿπŸÖÿØÿ©: {display_settings['categories_columns']})")
        except Exception as e:
            print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿ±ÿ∂: {e}")
        
        # 7Ô∏è‚É£ ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ŸÑÿßÿ™ ÿßŸÑÿ™ÿ≥ŸàŸÇ ÿßŸÑŸÜÿ¥ÿ∑ÿ©
        try:
            global user_carts
            carts_ref = db.collection('carts')
            for doc in carts_ref.stream():
                data = doc.to_dict()
                # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ≥ŸÑÿ© (3 ÿ≥ÿßÿπÿßÿ™)
                expires_at = data.get('expires_at')
                if expires_at:
                    from datetime import datetime
                    if isinstance(expires_at, datetime):
                        if expires_at.replace(tzinfo=None) > datetime.utcnow():
                            user_carts[doc.id] = data
                else:
                    user_carts[doc.id] = data
            print(f"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ {len(user_carts)} ÿ≥ŸÑÿ© ÿ™ÿ≥ŸàŸÇ ŸÜÿ¥ÿ∑ÿ©")
        except Exception as e:
            print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ŸÑÿßÿ™ ÿßŸÑÿ™ÿ≥ŸàŸÇ: {e}")
        
        print("üéâ ÿßŸÉÿ™ŸÖŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase!")
        
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ÿπÿßŸÖ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: {e}")

# ÿØÿßŸÑÿ© ŸÑŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ where ÿ®ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑŸÖÿ™ŸàÿßŸÅŸÇÿ©
def query_where(collection_ref, field, op, value):
    """ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ where ÿ®ÿ∑ÿ±ŸäŸÇÿ© ŸÖÿ™ŸàÿßŸÅŸÇÿ© ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÜÿ≥ÿÆ"""
    if USE_FIELD_FILTER:
        return collection_ref.where(filter=FieldFilter(field, op, value))
    else:
        return collection_ref.where(field, op, value)

# --- ÿØŸàÿßŸÑ ŸÖÿ≥ÿßÿπÿØÿ© ---

def get_user_profile_photo(user_id):
    """ÿ¨ŸÑÿ® ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ ŸÖŸÜ ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ"""
    try:
        photos = bot.get_user_profile_photos(int(user_id), limit=1)
        if photos.total_count > 0:
            file_id = photos.photos[0][0].file_id
            file_info = bot.get_file(file_id)
            photo_url = f"https://api.telegram.org/file/bot{TOKEN}/{file_info.file_path}"
            return photo_url
        return None
    except Exception as e:
        print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ: {e}")
        return None

def get_balance(user_id):
    """ÿ¨ŸÑÿ® ÿßŸÑÿ±ÿµŸäÿØ ŸÖŸÜ Firebase"""
    try:
        uid = str(user_id)
        doc = db.collection('users').document(uid).get()
        if doc.exists:
            return doc.to_dict().get('balance', 0.0)
        return 0.0
    except Exception as e:
        print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿßŸÑÿ±ÿµŸäÿØ: {e}")
        return users_wallets.get(str(user_id), 0.0)

def add_balance(user_id, amount):
    """ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿµŸäÿØ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Firebase ŸàÿßŸÑÿ∞ÿßŸÉÿ±ÿ©"""
    uid = str(user_id)
    if uid not in users_wallets:
        users_wallets[uid] = 0.0
    users_wallets[uid] += float(amount)
    
    # ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
    try:
        db.collection('users').document(uid).set({
            'balance': users_wallets[uid],
            'telegram_id': uid,
            'updated_at': firestore.SERVER_TIMESTAMP
        }, merge=True)
        print(f"‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ {uid}: {users_wallets[uid]} ÿ±ŸäÿßŸÑ ŸÅŸä Firestore")
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ±ÿµŸäÿØ ÿ•ŸÑŸâ Firebase: {e}")

# ÿ•ÿ∂ÿßŸÅÿ© UUID ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ© (ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÑÿØŸäŸáÿß ID)
def ensure_product_ids():
    for item in marketplace_items:
        if 'id' not in item:
            item['id'] = str(uuid.uuid4())

# ÿØÿßŸÑÿ© ŸÑÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ÿ•ŸÑŸâ Firebase
def migrate_data_to_firebase():
    """ŸÜŸÇŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ÿ•ŸÑŸâ Firebase"""
    try:
        print("üîÑ ÿ®ÿØÿ° ŸÜŸÇŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ Firebase...")
        
        # 1. ÿ±ŸÅÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
        if marketplace_items:
            products_ref = db.collection('products')
            for item in marketplace_items:
                product_id = item.get('id', str(uuid.uuid4()))
                products_ref.document(product_id).set({
                    'item_name': item.get('item_name', ''),
                    'price': float(item.get('price', 0)),
                    'seller_id': str(item.get('seller_id', '')),
                    'seller_name': item.get('seller_name', ''),
                    'hidden_data': item.get('hidden_data', ''),
                    'image_url': item.get('image_url', ''),
                    'category': item.get('category', 'ÿ£ÿÆÿ±Ÿâ'),
                    'details': item.get('details', ''),
                    'sold': item.get('sold', False),
                    'created_at': firestore.SERVER_TIMESTAMP
                })
            print(f"‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ {len(marketplace_items)} ŸÖŸÜÿ™ÿ¨")
        
        # 2. ÿ±ŸÅÿπ ÿ£ÿ±ÿµÿØÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        if users_wallets:
            users_ref = db.collection('users')
            for user_id, balance in users_wallets.items():
                users_ref.document(str(user_id)).set({
                    'balance': float(balance),
                    'telegram_id': str(user_id),
                    'updated_at': firestore.SERVER_TIMESTAMP
                }, merge=True)
            print(f"‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ {len(users_wallets)} ŸÖÿ≥ÿ™ÿÆÿØŸÖ")
        
        # 3. ÿ±ŸÅÿπ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÜÿ¥ÿ∑ÿ©
        if active_orders:
            orders_ref = db.collection('orders')
            for order_id, order_data in active_orders.items():
                orders_ref.document(str(order_id)).set({
                    'item_name': order_data.get('item_name', ''),
                    'price': float(order_data.get('price', 0)),
                    'buyer_id': str(order_data.get('buyer_id', '')),
                    'buyer_name': order_data.get('buyer_name', ''),
                    'seller_id': str(order_data.get('seller_id', '')),
                    'status': order_data.get('status', 'pending'),
                    'admin_id': str(order_data.get('admin_id', '')) if order_data.get('admin_id') else '',
                    'created_at': firestore.SERVER_TIMESTAMP
                })
            print(f"‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ {len(active_orders)} ÿ∑ŸÑÿ®")
        
        # 4. ÿ±ŸÅÿπ ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑÿ¥ÿ≠ŸÜ
        if charge_keys:
            keys_ref = db.collection('charge_keys')
            for key_code, key_data in charge_keys.items():
                keys_ref.document(key_code).set({
                    'amount': float(key_data.get('amount', 0)),
                    'used': key_data.get('used', False),
                    'used_by': str(key_data.get('used_by', '')) if key_data.get('used_by') else '',
                    'created_at': key_data.get('created_at', time.time())
                })
            print(f"‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ {len(charge_keys)} ŸÖŸÅÿ™ÿßÿ≠ ÿ¥ÿ≠ŸÜ")
        
        print("üéâ ÿ™ŸÖ ÿ±ŸÅÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ Firebase ÿ®ŸÜÿ¨ÿßÿ≠!")
        return True
        
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: {e}")
        return False

# ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase ÿ•ŸÑŸâ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© (ÿπŸÜÿØ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ)
def load_data_from_firebase():
    """ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase ÿ•ŸÑŸâ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ≥ÿ±Ÿäÿπ"""
    global marketplace_items, users_wallets, charge_keys, active_orders
    
    try:
        print("üì• ÿ®ÿØÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase...")
        
        # 1. ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ (ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ®ÿßÿπÿ© ŸÅŸÇÿ∑)
        print("üîÑ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖŸÜ Firestore...")
        products_ref = query_where(db.collection('products'), 'sold', '==', False)
        marketplace_items = []
        for doc in products_ref.stream():
            data = doc.to_dict()
            data['id'] = doc.id
            marketplace_items.append(data)
            print(f"  üì¶ ŸÖŸÜÿ™ÿ¨: {data.get('item_name', 'ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ')} - {data.get('price', 0)} ÿ±ŸäÿßŸÑ")
        print(f"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ {len(marketplace_items)} ŸÖŸÜÿ™ÿ¨ ŸÖŸÜ Firestore")
        
        # 2. ÿ™ÿ≠ŸÖŸäŸÑ ÿ£ÿ±ÿµÿØÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        print("üîÑ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÖŸÜ Firestore...")
        users_ref = db.collection('users')
        users_wallets = {}
        for doc in users_ref.stream():
            data = doc.to_dict()
            users_wallets[doc.id] = data.get('balance', 0.0)
            print(f"  üë§ ŸÖÿ≥ÿ™ÿÆÿØŸÖ {doc.id}: {data.get('balance', 0)} ÿ±ŸäÿßŸÑ")
        print(f"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ {len(users_wallets)} ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ Firestore")
        
        # 3. ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑÿ¥ÿ≠ŸÜ (ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ© ŸÅŸÇÿ∑)
        keys_ref = query_where(db.collection('charge_keys'), 'used', '==', False)
        charge_keys = {}
        for doc in keys_ref.stream():
            data = doc.to_dict()
            charge_keys[doc.id] = {
                'amount': data.get('amount', 0),
                'used': data.get('used', False),
                'used_by': data.get('used_by'),
                'created_at': data.get('created_at', time.time())
            }
        print(f"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ {len(charge_keys)} ŸÖŸÅÿ™ÿßÿ≠ ÿ¥ÿ≠ŸÜ")
        
        # 4. ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÜÿ¥ÿ∑ÿ© (pending ŸÅŸÇÿ∑)
        orders_ref = query_where(db.collection('orders'), 'status', '==', 'pending')
        active_orders = {}
        for doc in orders_ref.stream():
            data = doc.to_dict()
            active_orders[doc.id] = data
        print(f"‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ {len(active_orders)} ÿ∑ŸÑÿ® ŸÜÿ¥ÿ∑")
        
        print("üéâ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase ÿ®ŸÜÿ¨ÿßÿ≠!")
        return True
        
    except Exception as e:
        print(f"‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase: {e}")
        print("ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ®ÿØÿ° ÿ®ÿ®ŸäÿßŸÜÿßÿ™ ŸÅÿßÿ±ÿ∫ÿ©")
        return False

# ÿØÿßŸÑÿ© ŸÑÿ™ŸàŸÑŸäÿØ ŸÉŸàÿØ ÿ™ÿ≠ŸÇŸÇ ÿπÿ¥Ÿàÿßÿ¶Ÿä
def generate_verification_code(user_id, user_name):
    # ÿ™ŸàŸÑŸäÿØ ŸÉŸàÿØ ŸÖŸÜ 6 ÿ£ÿ±ŸÇÿßŸÖ
    code = str(random.randint(100000, 999999))
    
    # ÿ≠ŸÅÿ∏ ÿßŸÑŸÉŸàÿØ (ÿµÿßŸÑÿ≠ ŸÑŸÖÿØÿ© 10 ÿØŸÇÿßÿ¶ŸÇ)
    verification_codes[str(user_id)] = {
        'code': code,
        'name': user_name,
        'created_at': time.time()
    }
    
    return code

# ÿØÿßŸÑÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑŸÉŸàÿØ
def verify_code(user_id, code):
    user_id = str(user_id)
    
    if user_id not in verification_codes:
        return None
    
    code_data = verification_codes[user_id]
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÉŸàÿØ (10 ÿØŸÇÿßÿ¶ŸÇ)
    if time.time() - code_data['created_at'] > 600:  # 10 * 60 ÿ´ÿßŸÜŸäÿ©
        del verification_codes[user_id]
        return None
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ∑ÿßÿ®ŸÇ ÿßŸÑŸÉŸàÿØ
    if code_data['code'] != code:
        return None
    
    return code_data

# --- ŸÉŸàÿØ ÿµŸÅÿ≠ÿ© ÿßŸÑŸàŸäÿ® (HTML + JavaScript) ---
HTML_PAGE = """
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿ≥ŸàŸÇ ÿßŸÑÿ™ÿ¨ÿßÿ±</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #6c5ce7;
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #ffffff;
            --active-color: #f1c40f; /* ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ£ÿµŸÅÿ± */
            --nav-bg: #0f3460;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Tajawal', sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 16px 16px 120px 16px; /* ŸÖÿ≥ÿßŸÅÿ© ŸÖŸÜ ÿßŸÑÿ£ÿ≥ŸÅŸÑ ŸÑŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπÿßÿ¶ŸÖ */
        }

        /* --- ÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ®ÿßÿ± ÿßŸÑÿ≥ŸÅŸÑŸä ÿßŸÑÿπÿßÿ¶ŸÖ (Floating Bottom Nav) --- */
        .floating-bottom-nav {
            position: fixed;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 94%;
            max-width: 380px;
            height: 56px;
            background: linear-gradient(135deg, rgba(45, 52, 54, 0.95) 0%, rgba(26, 26, 46, 0.98) 100%);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-radius: 28px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(108, 92, 231, 0.2);
            z-index: 1000;
            padding: 0 8px;
            backdrop-filter: blur(15px);
        }

        .floating-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #888;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
            flex: 1;
            height: 100%;
            max-width: 80px;
        }

        .floating-nav-icon {
            font-size: 20px;
            margin-bottom: 2px;
            transition: all 0.25s;
        }

        .floating-nav-label {
            font-size: 9px;
            font-weight: 600;
            transition: all 0.25s;
            white-space: nowrap;
        }

        /* ÿßŸÑÿ¥ÿßÿ±ÿ© (Badge) ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ */
        .nav-badge {
            position: absolute;
            top: 6px;
            right: 50%;
            transform: translateX(12px);
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            font-size: 9px;
            font-weight: bold;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            box-shadow: 0 2px 6px rgba(231, 76, 60, 0.5);
            animation: pulse-badge 2s infinite;
        }
        
        .nav-badge.hidden {
            display: none;
        }
        
        @keyframes pulse-badge {
            0%, 100% { transform: translateX(12px) scale(1); }
            50% { transform: translateX(12px) scale(1.1); }
        }

        /* ÿßŸÑÿ±ÿµŸäÿØ ÿ™ÿ≠ÿ™ ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ© */
        .nav-balance {
            font-size: 8px;
            color: #55efc4;
            font-weight: bold;
            margin-top: -1px;
        }

        /* ÿßŸÑÿ™ÿ£ÿ´Ÿäÿ± ÿπŸÜÿØ ÿßŸÑÿ™ŸÅÿπŸäŸÑ */
        .floating-nav-item.active {
            color: #f1c40f;
        }

        .floating-nav-item.active .floating-nav-icon {
            font-size: 22px;
            filter: drop-shadow(0 0 8px rgba(241, 196, 15, 0.6));
        }

        .floating-nav-item.active .floating-nav-label {
            color: #f1c40f;
        }
        
        .floating-nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 20px;
            height: 3px;
            background: linear-gradient(90deg, #f1c40f, #f39c12);
            border-radius: 2px;
        }

        /* ÿ™ÿ£ÿ´Ÿäÿ± ÿßŸÑÿ™ÿ≠ŸàŸÖ */
        .floating-nav-item:hover:not(.active) {
            color: #a29bfe;
        }

        .floating-nav-item:hover:not(.active) .floating-nav-icon {
            transform: translateY(-2px);
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ŸÑŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© */
        @media (max-width: 360px) {
            .floating-bottom-nav {
                width: 96%;
                height: 52px;
                bottom: 8px;
                padding: 0 4px;
            }
            .floating-nav-icon {
                font-size: 18px;
            }
            .floating-nav-label {
                font-size: 8px;
            }
            .nav-badge {
                font-size: 8px;
                min-width: 14px;
                height: 14px;
            }
        }
        
        /* --- ÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑÿµŸÅÿ≠ÿ© (Views) --- */
        .view-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .view-section.active-view {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- ÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ --- */
        .delivery-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 5px;
            background: rgba(108, 92, 231, 0.1);
            border-radius: 16px;
        }
        .delivery-tab {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s ease;
            background: transparent;
            color: #888;
        }
        .delivery-tab.active {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
        }
        .delivery-tab:not(.active):hover {
            background: rgba(108, 92, 231, 0.2);
            color: #a29bfe;
        }
        .delivery-tab-icon {
            margin-left: 8px;
        }

        /* --- ÿ®ÿßŸÇŸä ÿßŸÑÿ™ÿµÿßŸÖŸäŸÖ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© --- */
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 16px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 14px; margin-bottom: 12px; background: var(--bg-color); border: 1px solid #444; border-radius: 12px; color: var(--text-color); box-sizing: border-box;}
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; }
        .item-card { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #444; }
        .buy-btn { background: var(--green); width: auto; padding: 8px 20px; font-size: 0.9rem; }
        
        /* ÿ™ÿµŸÖŸäŸÖ ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØ - ÿπÿ±Ÿäÿ∂ */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }
        @media (min-width: 500px) {
            .product-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 768px) {
            .product-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        .product-card {
            background: linear-gradient(145deg, #1e1e2e, #252538);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        .product-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            position: relative;
        }
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .product-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }
        .product-info {
            padding: 14px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .product-category {
            display: none; /* ŸÖÿÆŸÅŸä ŸÑÿ£ŸÜŸá ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑÿ®ÿßÿØÿ¨ */
        }
        /* ÿ¥ÿßÿ±ÿ© ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ */
        .delivery-badge {
            font-size: 10px;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 6px;
        }
        .delivery-badge.instant {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 184, 148, 0.9);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 9px;
            backdrop-filter: blur(5px);
        }
        .delivery-badge.manual {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(243, 156, 18, 0.9);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 9px;
            backdrop-filter: blur(5px);
        }
        .product-name {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 4px;
            color: var(--text-color);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .product-seller {
            color: #666;
            font-size: 10px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .product-price-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .product-price {
            font-size: 14px;
            font-weight: bold;
            color: #00b894;
        }
        .product-price-old {
            font-size: 11px;
            color: #888;
            text-decoration: line-through;
            margin-right: 6px;
        }
        .btn-add-cart {
            background: linear-gradient(135deg, #0984e3, #74b9ff);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        .btn-add-cart:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(9, 132, 227, 0.4);
        }
        .btn-sold {
            background: #444;
            color: #888;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: not-allowed;
            font-size: 11px;
        }
        
        /* ŸÖŸàÿØÿßŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ */
        .pdm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .product-detail-modal {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pdm-header {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid #333;
        }
        .pdm-image {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            border-radius: 15px;
            background: #2d2d44;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            overflow: hidden;
        }
        .pdm-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .pdm-title {
            font-size: 18px;
            font-weight: bold;
            color: white;
            margin-bottom: 8px;
        }
        .pdm-category {
            display: inline-block;
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }
        .pdm-info {
            padding: 20px;
        }
        .pdm-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        .pdm-row.full {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        .pdm-label {
            color: #888;
            font-size: 13px;
        }
        .pdm-value {
            color: white;
            font-size: 14px;
        }
        .pdm-value.price {
            color: #00b894;
            font-weight: bold;
            font-size: 18px;
        }
        .pdm-description, .pdm-instructions {
            background: #2d2d44;
            padding: 12px;
            border-radius: 10px;
            color: #ccc;
            font-size: 13px;
            line-height: 1.6;
            width: 100%;
        }
        .pdm-instructions {
            background: #3d2d44;
            border: 1px dashed #6c5ce7;
        }
        .pdm-actions {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #333;
        }
        .pdm-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .pdm-btn.close {
            background: #555;
            color: white;
        }
        .pdm-btn.cart {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }
        .pdm-btn:hover {
            transform: scale(1.02);
        }
        
        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid #444;
        }
        .product-btns {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .product-buy-btn {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(0, 184, 148, 0.3);
            font-size: 13px;
        }
        .product-buy-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 184, 148, 0.5);
        }
        .product-cart-btn {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .product-cart-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.5);
        }
        .my-product-badge {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
        }
        
        /* ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿπÿ© */
        .sold-product {
            opacity: 0.7;
            position: relative;
        }
        .sold-product .product-image::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
        }
        .sold-ribbon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-25deg);
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 10px 40px;
            font-size: 20px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.6);
            border: 3px solid white;
            letter-spacing: 2px;
        }
        .sold-info {
            color: #e74c3c;
            font-size: 11px;
            font-weight: bold;
            margin: 8px 0;
            padding: 6px 10px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            border-left: 3px solid #e74c3c;
        }
        
        /* ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ£ŸÉŸäÿØ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            margin: 5% auto 80px auto;
            padding: 0;
            border-radius: 20px;
            max-width: 440px;
            max-height: 85vh;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: slideDown 0.3s;
            overflow-y: auto;
        }
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 18px;
            text-align: center;
            color: white;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }
        .modal-body {
            padding: 20px;
            color: var(--text-color);
        }
        .modal-product-info {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
        }
        .modal-info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .modal-info-row:last-child {
            border-bottom: none;
        }
        .modal-info-label {
            color: #888;
            font-size: 14px;
        }
        .modal-info-value {
            color: var(--text-color);
            font-weight: bold;
            font-size: 15px;
        }
        .modal-price {
            color: #00b894;
            font-size: 28px !important;
            font-weight: bold;
        }
        .modal-details {
            background: rgba(102, 126, 234, 0.1);
            padding: 12px;
            border-radius: 10px;
            margin: 15px 0;
            border-right: 4px solid #667eea;
            color: var(--text-color);
            font-size: 14px;
            line-height: 1.6;
        }
        .modal-footer {
            display: flex;
            gap: 10px;
            padding: 0 20px 20px 20px;
        }
        .modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .modal-btn-confirm {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }
        .modal-btn-confirm:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 184, 148, 0.4);
        }
        .modal-btn-cancel {
            background: #e74c3c;
            color: white;
        }
        .modal-btn-cancel:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        /* ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠ */
        .success-modal .modal-header {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
        }
        .success-icon {
            font-size: 80px;
            text-align: center;
            margin: 20px 0;
            animation: scaleIn 0.5s;
        }
        @keyframes scaleIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .success-message {
            text-align: center;
            font-size: 18px;
            color: var(--text-color);
            margin: 20px 0;
            line-height: 1.6;
        }
        .success-note {
            background: rgba(0, 184, 148, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            color: #00b894;
            font-size: 14px;
            border: 2px dashed #00b894;
            margin: 20px 0;
        }
        
        /* ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ≠ÿ∞Ÿäÿ± */
        .warning-modal .modal-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            padding: 18px;
        }
        .warning-icon {
            font-size: 55px;
            text-align: center;
            margin: 10px 0 15px 0;
            animation: bounce 0.6s ease-in-out;
            filter: drop-shadow(0 5px 15px rgba(255, 107, 107, 0.3));
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        .warning-message {
            text-align: center;
            font-size: 15px;
            color: var(--text-color);
            margin: 0 0 18px 0;
            line-height: 1.4;
            font-weight: 500;
        }
        .balance-comparison {
            display: flex;
            gap: 12px;
            margin: 18px 0;
        }
        .balance-box {
            flex: 1;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        .balance-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff6b6b, #ee5a6f);
        }
        .balance-box.current::before {
            background: linear-gradient(90deg, #a29bfe, #6c5ce7);
        }
        .balance-label {
            color: #999;
            font-size: 11px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .balance-value {
            font-size: 28px;
            font-weight: bold;
            color: #ff6b6b;
            margin: 8px 0;
            text-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
        }
        .balance-box.current .balance-value {
            color: #a29bfe;
            text-shadow: 0 2px 10px rgba(162, 155, 254, 0.3);
        }
        .balance-currency {
            font-size: 12px;
            color: #666;
            font-weight: normal;
        }
        .warning-actions {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%);
            padding: 15px;
            border-radius: 12px;
            margin: 18px 0 0 0;
            border: 2px solid rgba(255, 193, 7, 0.3);
        }
        .warning-actions h4 {
            color: #ffc107;
            font-size: 14px;
            margin: 0 0 12px 0;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .action-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            color: var(--text-color);
            font-size: 13px;
        }
        .action-icon {
            font-size: 18px;
            min-width: 28px;
            text-align: center;
        }
        
        /* ÿ≠ÿßŸàŸäÿ© ÿßŸÑŸÅÿ¶ÿßÿ™ - ÿßŸÑÿ¥ÿ®ŸÉÿ© */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(var(--cat-cols, 3), 1fr);
            gap: 8px;
            padding: 5px;
            margin-bottom: 20px;
        }
        
        .categories-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
        .categories-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
        .categories-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }

        /* ŸÉÿ±ÿ™ ÿßŸÑŸÅÿ¶ÿ© */
        .cat-card {
            position: relative;
            border-radius: 12px;
            padding: 15px 5px;
            cursor: pointer;
            text-align: center;
            background: #2d2d2d;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.2s;
            height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .cat-card:active {
            transform: scale(0.95);
        }

        /* ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑÿÆŸÑŸÅŸäÿ© (ÿ™ÿØÿ±ÿ¨ÿßÿ™ ÿÆŸÅŸäŸÅÿ©) */
        .bg-all { background: linear-gradient(180deg, #2d2d2d 0%, #3a2d44 100%); border-bottom: 2px solid #6c5ce7; }
        .bg-netflix { background: linear-gradient(180deg, #2d2d2d 0%, #3a1a1a 100%); border-bottom: 2px solid #e50914; }
        .bg-shahid { background: linear-gradient(180deg, #2d2d2d 0%, #2a3a3a 100%); border-bottom: 2px solid #00b8a9; }
        .bg-disney { background: linear-gradient(180deg, #2d2d2d 0%, #1a2a44 100%); border-bottom: 2px solid #0063e5; }
        .bg-osn { background: linear-gradient(180deg, #2d2d2d 0%, #3a2a1a 100%); border-bottom: 2px solid #f39c12; }
        .bg-video { background: linear-gradient(180deg, #2d2d2d 0%, #2a1a3a 100%); border-bottom: 2px solid #9b59b6; }
        .bg-other { background: linear-gradient(180deg, #2d2d2d 0%, #442a2a 100%); border-bottom: 2px solid #e17055; }

        /* ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ© */
        .cat-icon {
            font-size: 28px;
            margin-bottom: 8px;
            width: 40px;
            height: 40px;
            object-fit: contain;
        }
        
        .cat-icon.emoji {
            font-size: 28px;
            width: auto;
            height: auto;
        }

        /* ÿßŸÑÿπŸÜŸàÿßŸÜ */
        .cat-title {
            color: #fff;
            font-size: 13px;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .categories-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            margin-bottom: 10px;
        }
        
        .categories-header h3 {
            margin: 0;
        }
        
        .categories-header small {
            color: #6c5ce7;
            cursor: pointer;
        }
        
        /* ÿµŸÅ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿπŸÑŸàŸäÿ© */
        .top-buttons-row {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        /* ÿ≤ÿ± ÿ≠ÿ≥ÿßÿ®Ÿä */
        .account-btn {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
            transition: all 0.3s;
            flex: 1;
        }
        .account-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
        }
        .account-btn-left {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: bold;
        }
        .account-icon {
            font-size: 18px;
        }
        .arrow {
            transition: transform 0.3s;
            font-size: 12px;
        }
        .arrow.open {
            transform: rotate(180deg);
        }
        
        /* ÿ≤ÿ± ÿ¥ÿ≠ŸÜ ÿßŸÑŸÉŸàÿØ */
        .charge-btn {
            background: linear-gradient(135deg, #00b894, #55efc4);
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
            transition: all 0.3s;
            flex: 1;
            justify-content: center;
        }
        .charge-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.4);
        }
        
        /* ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ¥ÿ≠ŸÜ ÿßŸÑÿ≥ÿ±Ÿäÿπ */
        .quick-charge-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .quick-charge-btn {
            flex: 1;
            min-width: 70px;
            background: linear-gradient(135deg, #fdcb6e, #f39c12);
            color: #2d3436;
            padding: 10px 8px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            font-size: 13px;
            box-shadow: 0 3px 10px rgba(243, 156, 18, 0.3);
            transition: all 0.3s;
            text-decoration: none;
            display: block;
        }
        .quick-charge-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }
        .quick-charge-btn span {
            display: block;
            font-size: 11px;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        /* ŸÜÿßŸÅÿ∞ÿ© ÿ¥ÿ≠ŸÜ ÿßŸÑŸÉŸàÿØ */
        .charge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .charge-modal.active {
            display: flex;
        }
        .charge-modal-content {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        .charge-modal-content h3 {
            color: #00b894;
            margin-bottom: 20px;
        }
        .charge-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #444;
            border-radius: 10px;
            background: #2d3436;
            color: white;
            font-size: 16px;
            text-align: center;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        .charge-input:focus {
            border-color: #00b894;
            outline: none;
        }
        .charge-submit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #00b894, #55efc4);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .charge-cancel-btn {
            width: 100%;
            padding: 10px;
            background: #636e72;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* ŸÖÿ≠ÿ™ŸàŸâ ÿ≠ÿ≥ÿßÿ®Ÿä ŸàÿßŸÑÿ¥ÿ≠ŸÜ */
        .account-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }
        .account-content.open {
            max-height: 600px;
        }
        .account-details {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .account-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #444;
        }
        .account-row:last-child {
            border-bottom: none;
        }
        .account-label {
            color: #888;
            font-weight: 500;
        }
        .account-value {
            font-weight: bold;
            color: var(--text-color);
        }
        .balance-row {
            background: linear-gradient(135deg, #00b89420, #00cec920);
            padding: 15px !important;
            border-radius: 12px;
            margin: 10px 0;
        }
        .balance-row .account-value {
            color: #00b894;
            font-size: 22px;
        }
        
        .logout-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s;
        }
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        /* ÿ≤ÿ± ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ */
        .orders-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 12px;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s;
        }
        .orders-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
        }
        
        /* ŸÇÿ≥ŸÖ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ */
        .orders-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: var(--card-bg);
            border-radius: 16px;
            margin-bottom: 20px;
        }
        .orders-section.open {
            max-height: 800px;
            overflow-y: auto;
        }
        .orders-header {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            padding: 15px 20px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        .orders-header h3 {
            margin: 0;
            font-size: 18px;
        }
        .close-orders {
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
        }
        .orders-list {
            padding: 20px;
        }
        .order-item {
            background: rgba(108, 92, 231, 0.1);
            border: 2px solid rgba(108, 92, 231, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .order-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.2);
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .order-id {
            color: #6c5ce7;
            font-size: 14px;
        }
        .order-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        .order-status.pending {
            background: #f39c12;
            color: white;
        }
        .order-status.completed {
            background: #27ae60;
            color: white;
        }
        .order-status.claimed {
            background: #3498db;
            color: white;
        }
        .order-info {
            font-size: 14px;
            line-height: 1.8;
        }
        .order-info strong {
            color: var(--text-color);
        }
        
        /* ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ© */
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .login-modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative;
            color: #2d3436;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #636e72;
        }
        .close-modal:hover {
            color: #2d3436;
        }
        .modal-logo {
            font-size: 50px;
            margin-bottom: 15px;
        }
        .modal-title {
            color: #6c5ce7;
            font-size: 24px;
            margin-bottom: 10px;
        }
        .modal-text {
            color: #636e72;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        .login-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }
        .login-input:focus {
            outline: none;
            border-color: #6c5ce7;
        }
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            font-family: 'Tajawal', sans-serif;
        }
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(108, 92, 231, 0.4);
        }
        .help-text {
            color: #636e72;
            font-size: 14px;
            margin-top: 15px;
        }
        .help-text a {
            color: #6c5ce7;
            text-decoration: none;
        }
        .error-message {
            color: #e74c3c;
            background: #ffe5e5;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        /* ========== ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ© ========== */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            z-index: 2001;
            transition: right 0.3s ease;
            overflow-y: auto;
            box-shadow: -5px 0 25px rgba(0, 0, 0, 0.5);
        }
        .sidebar.active {
            right: 0;
        }
        
        .sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px 20px;
            text-align: center;
            position: relative;
        }
        .sidebar-close {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .sidebar-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        .sidebar-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00b894, #55efc4);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 32px;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
        }
        .sidebar-avatar-img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 12px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
            display: block;
        }
        .sidebar-user-name {
            color: white;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .sidebar-user-id {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
        }
        .sidebar-balance {
            background: linear-gradient(135deg, rgba(0, 184, 148, 0.2), rgba(85, 239, 196, 0.2));
            border: 1px solid rgba(0, 184, 148, 0.4);
            border-radius: 25px;
            padding: 8px 20px;
            display: inline-block;
            margin-top: 12px;
            color: #55efc4;
            font-weight: bold;
            font-size: 15px;
        }
        
        .sidebar-section {
            padding: 15px;
        }
        .sidebar-section-title {
            color: #a29bfe;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 10px;
            padding-right: 5px;
            letter-spacing: 1px;
        }
        
        .sidebar-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255, 255, 255, 0.85);
            margin-bottom: 5px;
        }
        .sidebar-menu-item:hover {
            background: rgba(108, 92, 231, 0.2);
            color: white;
            transform: translateX(-5px);
        }
        .sidebar-menu-item.active {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
        }
        .sidebar-menu-icon {
            font-size: 20px;
            width: 30px;
            text-align: center;
        }
        .sidebar-menu-text {
            font-size: 14px;
            font-weight: 500;
        }
        .sidebar-menu-badge {
            margin-right: auto;
            background: #e74c3c;
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .sidebar-categories {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding: 0 5px;
        }
        .sidebar-cat-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .sidebar-cat-item:hover {
            background: rgba(108, 92, 231, 0.2);
            border-color: #6c5ce7;
            transform: scale(1.03);
        }
        .sidebar-cat-icon {
            font-size: 22px;
            margin-bottom: 5px;
        }
        .sidebar-cat-icon img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }
        .sidebar-cat-text {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        
        .sidebar-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            margin: 10px 15px;
        }
        
        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }
        .sidebar-logout-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s;
        }
        .sidebar-logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        /* ÿ≤ÿ± ŸÅÿ™ÿ≠ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© */
        .menu-toggle-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 22px;
            cursor: pointer;
            z-index: 1500;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
        }
        .menu-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        /* ÿ™ÿπÿØŸäŸÑ padding ŸÑŸÑŸÄ body ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ™ÿØÿßÿÆŸÑ ŸÖÿπ ÿ≤ÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ© */
        body {
            padding-top: 70px !important;
        }
    </style>
</head>
<body>
    <!-- ÿ≤ÿ± ŸÅÿ™ÿ≠ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ© -->
    <button class="menu-toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
    
    <!-- ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑŸÖÿ∏ŸÑŸÑÿ© -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    
    <!-- ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ© -->
    <div class="sidebar" id="sidebar">
        <!-- ÿ±ÿ£ÿ≥ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÖÿπ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ -->
        <div class="sidebar-header">
            <button class="sidebar-close" onclick="closeSidebar()">‚úï</button>
            {% if profile_photo %}
            <img src="{{ profile_photo }}" class="sidebar-avatar-img" alt="ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="sidebar-avatar" style="display: none;">üë§</div>
            {% else %}
            <div class="sidebar-avatar">üë§</div>
            {% endif %}
            <div class="sidebar-user-name" id="sidebarUserName">{{ user_name }}</div>
            <div class="sidebar-user-id">ID: <span id="sidebarUserId">{{ current_user_id }}</span></div>
            <div class="sidebar-balance">üí∞ <span id="sidebarBalance">{{ balance }}</span> ÿ±ŸäÿßŸÑ</div>
        </div>
        
        <!-- ÿ±Ÿàÿßÿ®ÿ∑ ÿ≥ÿ±Ÿäÿπÿ© -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</div>
            <div class="sidebar-menu-item active" onclick="scrollToSection('top'); closeSidebar();">
                <span class="sidebar-menu-icon">üè†</span>
                <span class="sidebar-menu-text">ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
            </div>
            <div class="sidebar-menu-item" onclick="scrollToSection('market'); closeSidebar();">
                <span class="sidebar-menu-icon">üõí</span>
                <span class="sidebar-menu-text">ÿßŸÑÿ≥ŸàŸÇ</span>
            </div>
            <div class="sidebar-menu-item" onclick="window.location.href='/my_purchases';">
                <span class="sidebar-menu-icon">üì¶</span>
                <span class="sidebar-menu-text">ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™Ÿä</span>
                {% if my_purchases %}<span class="sidebar-menu-badge">{{ my_purchases|length }}</span>{% endif %}
            </div>
        </div>
        
        <div class="sidebar-divider"></div>
        
        <!-- ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ© ŸàÿßŸÑÿ™ŸàÿßÿµŸÑ -->
        <div class="sidebar-section">
            <div class="sidebar-section-title">ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ©</div>
            <div class="sidebar-menu-item" onclick="window.open('https://t.me/Sbras_1', '_blank');">
                <span class="sidebar-menu-icon">üìû</span>
                <span class="sidebar-menu-text">ÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÜÿß</span>
            </div>
            <div class="sidebar-menu-item" onclick="window.open('https://t.me/YourBotUsername', '_blank');">
                <span class="sidebar-menu-icon">ü§ñ</span>
                <span class="sidebar-menu-text">ÿßŸÑÿ®Ÿàÿ™</span>
            </div>
        </div>
        
        <!-- ÿ≤ÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ - Ÿäÿ∏Ÿáÿ± ŸÅŸÇÿ∑ ŸÑŸÑŸÖÿ≥ÿ¨ŸÑŸäŸÜ -->
        {% if current_user %}
        <div class="sidebar-footer">
            <button class="sidebar-logout-btn" onclick="logout()">
                üö™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
            </button>
        </div>
        {% endif %}
    </div>
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ© -->
    <div class="login-modal" id="loginModal">
        <div class="login-modal-content">
            <span class="close-modal" onclick="closeLoginModal()">‚úï</span>
            <div class="modal-logo">üè™</div>
            <h2 class="modal-title">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</h2>
            <p class="modal-text">ÿ£ÿØÿÆŸÑ ŸÖÿπÿ±ŸÅ ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ ŸàÿßŸÑŸÉŸàÿØ ÿßŸÑÿ∞Ÿä ÿ≥ÿ™ÿ≠ÿµŸÑ ÿπŸÑŸäŸá ŸÖŸÜ ÿßŸÑÿ®Ÿàÿ™</p>
            
            <div id="errorMessage" class="error-message"></div>
            
            <input type="text" id="telegramId" class="login-input" placeholder="ŸÖÿπÿ±ŸÅ ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ (Telegram ID)">
            <input type="text" id="verificationCode" class="login-input" placeholder="ŸÉŸàÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ (ŸÖŸÜ ÿßŸÑÿ®Ÿàÿ™)" maxlength="6">
            
            <button class="login-btn" onclick="submitLogin()">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</button>
            
            <p class="help-text">
                ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ŸÉŸàÿØÿü <a href="#" onclick="showCodeHelp(); return false;">ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÉŸàÿØ ŸÖŸÜ ÿßŸÑÿ®Ÿàÿ™</a>
            </p>
        </div>
    </div>

    <!-- ÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ -->
    <div class="delivery-tabs">
        <button class="delivery-tab active" id="tabInstant" onclick="switchDeliveryTab('instant')">
            ‚ö° ÿ™ÿ≥ŸÑŸäŸÖ ŸÅŸàÿ±Ÿä
        </button>
        <button class="delivery-tab" id="tabManual" onclick="switchDeliveryTab('manual')">
            üë®‚Äçüíº ÿ™ÿ≥ŸÑŸäŸÖ ŸäÿØŸàŸä
        </button>
    </div>

    <div class="categories-header">
        <h3>üíé ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</h3>
        <small onclick="filterCategory('all')">ÿπÿ±ÿ∂ ÿßŸÑŸÉŸÑ</small>
    </div>

    <div class="categories-grid" id="categoriesContainer">
        <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
    </div>

    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <h3 style="margin: 0;">üõí ÿßŸÑÿ≥ŸàŸÇ</h3>
        <span id="categoryFilter" style="color: #6c5ce7; font-size: 14px; font-weight: bold;"></span>
    </div>
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ£ŸÉŸäÿØ -->
    <div id="buyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üõí ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ¥ÿ±ÿßÿ°</h2>
            </div>
            <div class="modal-body">
                <div class="modal-product-info">
                    <div class="modal-info-row">
                        <span class="modal-info-label">üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨:</span>
                        <span class="modal-info-value" id="modalProductName"></span>
                    </div>
                    <div class="modal-info-row">
                        <span class="modal-info-label">üè∑Ô∏è ÿßŸÑŸÅÿ¶ÿ©:</span>
                        <span class="modal-info-value" id="modalProductCategory"></span>
                    </div>
                    <div class="modal-info-row">
                        <span class="modal-info-label">üí∞ ÿßŸÑÿ≥ÿπÿ±:</span>
                        <span class="modal-info-value modal-price" id="modalProductPrice"></span>
                    </div>
                </div>
                <div class="modal-details" id="modalProductDetails"></div>
                
                <!-- ÿ≠ŸÇŸÑ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä ŸÑŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸäÿØŸàŸä -->
                <div id="buyerInputSection" style="display: none; margin-top: 15px;">
                    <div style="background: rgba(243, 156, 18, 0.1); border: 1px solid rgba(243, 156, 18, 0.3); border-radius: 10px; padding: 15px;">
                        <label style="color: #f39c12; font-weight: bold; display: block; margin-bottom: 10px;">
                            üìù <span id="buyerInstructionsLabel">ÿ£ÿØÿÆŸÑ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©:</span>
                        </label>
                        <textarea id="buyerInputDetails" placeholder="ÿßŸÉÿ™ÿ® ŸáŸÜÿß..." style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid rgba(243, 156, 18, 0.5); border-radius: 8px; background: rgba(0,0,0,0.2); color: #fff; font-size: 14px; resize: vertical;"></textarea>
                    </div>
                </div>
                
                <div id="deliveryTypeNote" style="text-align: center; color: #00b894; font-size: 14px; margin-top: 15px;">
                    ‚ö° ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÅŸàÿ±ÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ¥ÿ±ÿßÿ°
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmPurchase()">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ¥ÿ±ÿßÿ° ‚úì</button>
            </div>
        </div>
    </div>
    
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠ -->
    <div id="successModal" class="modal">
        <div class="modal-content success-modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #00b894, #00cec9);">
                <h2>‚úÖ ÿ™ŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ° ÿ®ŸÜÿ¨ÿßÿ≠!</h2>
            </div>
            <div class="modal-body">
                <div class="success-icon" style="font-size: 60px; margin: 15px 0;">üéâ</div>
                <div class="success-message" style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">
                    ÿ™ŸáÿßŸÜŸäŸÜÿß! ÿ™ŸÖ ÿ¥ÿ±ÿßÿ° ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠
                </div>
                <div id="orderIdDisplay" style="background: rgba(108, 92, 231, 0.2); border: 1px solid #6c5ce7; border-radius: 10px; padding: 10px; margin: 10px 0; text-align: center;">
                    <span style="color: #a29bfe; font-size: 13px;">ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®:</span>
                    <span id="successOrderId" style="color: #fff; font-weight: bold; margin-right: 8px;">#---</span>
                </div>
                <div id="purchaseDataContainer" style="display: none; background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #00b894; border-radius: 15px; padding: 20px; margin: 15px 0; text-align: right;">
                    <div style="color: #00b894; font-weight: bold; margin-bottom: 12px; font-size: 16px;">üîê ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ:</div>
                    <div id="purchaseHiddenData" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-all; color: #55efc4; font-size: 14px; border: 1px dashed #00b894;"></div>
                    <button onclick="copyPurchaseData()" style="margin-top: 12px; padding: 10px 25px; background: linear-gradient(135deg, #00b894, #00cec9); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.3s;">üìã ŸÜÿ≥ÿÆ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</button>
                </div>
                <div id="botMessageNote" class="success-note" style="padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 13px; background: rgba(0,184,148,0.1); border: 1px solid rgba(0,184,148,0.3);">
                    üì± ÿ™ÿ≠ŸÇŸÇ ÿ£Ÿäÿ∂ÿßŸã ŸÖŸÜ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ®Ÿàÿ™
                </div>
                <div style="background: rgba(108, 92, 231, 0.1); border-radius: 10px; padding: 12px; margin-top: 15px; border: 1px solid rgba(108, 92, 231, 0.3);">
                    <a href="/my_purchases" style="color: #a29bfe; text-decoration: none; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        üì¶ ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™Ÿä
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-confirm" onclick="closeSuccessModal()" style="width: 100%; background: linear-gradient(135deg, #00b894, #00cec9);">ÿ™ŸÖ üëç</button>
            </div>
        </div>
    </div>
    
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ±ÿµŸäÿØ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸç -->
    <div id="warningModal" class="modal">
        <div class="modal-content warning-modal">
            <div class="modal-header">
                <h2>‚ö†Ô∏è ÿ±ÿµŸäÿØ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸç</h2>
            </div>
            <div class="modal-body">
                <div class="warning-icon">ÔøΩ</div>
                <div class="warning-message">
                    ÿπÿ∞ÿ±ÿßŸãÿå ÿ±ÿµŸäÿØŸÉ ÿßŸÑÿ≠ÿßŸÑŸä ÿ∫Ÿäÿ± ŸÉÿßŸÅŸç ŸÑÿ•ÿ™ŸÖÿßŸÖ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ¥ÿ±ÿßÿ°
                </div>
                <div class="balance-comparison">
                    <div class="balance-box current">
                        <div class="balance-label">ÿ±ÿµŸäÿØŸÉ ÿßŸÑÿ≠ÿßŸÑŸä</div>
                        <div class="balance-value"><span id="warningBalance">0.00</span> <span class="balance-currency">ÿ±ŸäÿßŸÑ</span></div>
                    </div>
                    <div class="balance-box">
                        <div class="balance-label">ÿßŸÑŸÖÿ∑ŸÑŸàÿ®</div>
                        <div class="balance-value"><span id="warningPrice">0.00</span> <span class="balance-currency">ÿ±ŸäÿßŸÑ</span></div>
                    </div>
                </div>
                <div class="warning-actions">
                    <h4>üí° ŸÉŸäŸÅŸäÿ© ÿßŸÑÿ¥ÿ≠ŸÜ</h4>
                    <div class="action-item">
                        <div class="action-icon">üë§</div>
                        <div>ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ŸÑÿ¥ÿ≠ŸÜ ÿßŸÑÿ±ÿµŸäÿØ</div>
                    </div>
                    <div class="action-item">
                        <div class="action-icon">üîë</div>
                        <div>ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖŸÅÿ™ÿßÿ≠ ÿ¥ÿ≠ŸÜ ÿπÿ®ÿ± ÿßŸÑÿ£ŸÖÿ± /ÿ¥ÿ≠ŸÜ</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeWarningModal()" style="width: 100%;">ÿ≠ÿ≥ŸÜÿßŸã</button>
            </div>
        </div>
    </div>
    
    <div id="market" class="product-grid">
        {% for item in items %}
        <div class="product-card {% if item.get('sold') %}sold-product{% endif %}">
            {% if item.get('sold') %}
            <div class="sold-ribbon">ŸÖÿ®ÿßÿπ ‚úì</div>
            {% endif %}
            <div class="product-image">
                {% if item.get('image_url') %}
                <img src="{{ item.image_url }}" alt="{{ item.item_name }}">
                {% else %}
                üéÅ
                {% endif %}
            </div>
            {% if item.get('category') %}
            <div class="product-badge">{{ item.category }}</div>
            {% endif %}
            <div class="product-info">
                {% if item.get('category') %}
                <span class="product-category">{{ item.category }}</span>
                {% endif %}
                <div class="product-name">{{ item.item_name }}</div>
                <div class="product-seller">üè™ {{ item.seller_name }}</div>
                {% if item.get('sold') and item.get('buyer_name') %}
                <div class="sold-info">üéâ ÿ™ŸÖ ÿ¥ÿ±ÿßÿ°Ÿá ÿ®Ÿàÿßÿ≥ÿ∑ÿ©: {{ item.buyer_name }}</div>
                {% endif %}
                <div class="product-footer">
                    <div class="product-price">{{ item.price }} ÿ±ŸäÿßŸÑ</div>
                    {% if item.get('sold') %}
                        <button class="product-buy-btn" disabled style="opacity: 0.5; cursor: not-allowed;">ŸÖÿ®ÿßÿπ üö´</button>
                    {% elif item.seller_id|string != current_user_id|string %}
                        <button class="product-buy-btn" onclick='buyItem("{{ item.id }}", {{ item.price }}, "{{ item.item_name|replace('"', '\\"') }}", "{{ item.get('category', '')|replace('"', '\\"') }}", {{ item.get('details', '')|tojson }})'>ÿ¥ÿ±ÿßÿ° üõí</button>
                    {% else %}
                        <div class="my-product-badge">ŸÖŸÜÿ™ÿ¨ŸÉ ‚≠ê</div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿπÿ© -->
    {% if sold_items %}
    <div id="soldSection" style="margin-top: 30px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #e74c3c;">‚úÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿπÿ©</h3>
            <span style="background: #e74c3c; color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px;">{{ sold_items|length }}</span>
            <span id="soldCategoryFilter" style="color: #e74c3c; font-size: 14px; font-weight: bold;"></span>
        </div>
        
        <div class="product-grid" id="soldProductsGrid">
            {% for item in sold_items %}
            <div class="product-card sold-product sold-item-card" data-category="{{ item.get('category', '') }}" style="opacity: 0.7;">
                <div class="sold-ribbon">ŸÖÿ®ÿßÿπ ‚úì</div>
                <div class="product-image">
                    {% if item.get('image_url') %}
                    <img src="{{ item.image_url }}" alt="{{ item.item_name }}" style="filter: grayscale(50%);">
                    {% else %}
                    üéÅ
                    {% endif %}
                </div>
                {% if item.get('category') %}
                <div class="product-badge" style="background: #e74c3c;">{{ item.category }}</div>
                {% endif %}
                <div class="product-info">
                    {% if item.get('category') %}
                    <span class="product-category" style="background: rgba(231, 76, 60, 0.2); color: #e74c3c;">{{ item.category }}</span>
                    {% endif %}
                    <div class="product-name">{{ item.item_name }}</div>
                    <div class="product-seller">üè™ {{ item.seller_name }}</div>
                    {% if item.get('buyer_name') %}
                    <div class="sold-info">üéâ ÿ™ŸÖ ÿ¥ÿ±ÿßÿ°Ÿá ÿ®Ÿàÿßÿ≥ÿ∑ÿ©: {{ item.buyer_name }}</div>
                    {% endif %}
                    <div class="product-footer">
                        <div class="product-price" style="color: #e74c3c; text-decoration: line-through;">{{ item.price }} ÿ±ŸäÿßŸÑ</div>
                        <span style="color: #e74c3c; font-weight: bold; font-size: 12px;">ŸÖÿ®ÿßÿπ üö´</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        let user = tg.initDataUnsafe.user;
        let userBalance = {{ balance }};
        let currentUserId = {{ current_user_id }};

        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜŸÜÿß ÿØÿßÿÆŸÑ Telegram Web App
        const isTelegramWebApp = tg.initData !== '';
        
        // ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ≥ŸÅŸÑŸä
        function updateNavBalance(balance) {
            const navBalanceEl = document.getElementById('navBalance');
            if(navBalanceEl) {
                navBalanceEl.textContent = balance + ' ÿ±.ÿ≥';
            }
        }
        
        // ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ¥ÿßÿ±ÿ© ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™
        function updateOrdersBadge(count) {
            const badge = document.getElementById('ordersBadge');
            if(badge) {
                if(count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }
        
        // ÿ¨ŸÑÿ® ÿπÿØÿØ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™
        async function fetchOrdersCount() {
            if(!currentUserId || currentUserId == 0) return;
            try {
                const response = await fetch('/get_orders?user_id=' + currentUserId);
                const data = await response.json();
                if(data.orders) {
                    updateOrdersBadge(data.orders.length);
                }
            } catch(e) {
                console.log('Error fetching orders count');
            }
        }
        
        // ÿπÿ±ÿ∂ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        if(user && user.id) {
            // ŸÖÿ≥ÿ™ÿÆÿØŸÖ Telegram Web App
            document.getElementById("userName").innerText = user.first_name + (user.last_name ? ' ' + user.last_name : '');
            document.getElementById("userId").innerText = user.id;
            currentUserId = user.id;
            
            // ÿ¨ŸÑÿ® ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≠ŸÇŸäŸÇŸä ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
            fetch('/get_balance?user_id=' + user.id)
                .then(r => r.json())
                .then(data => {
                    userBalance = data.balance;
                    document.getElementById("balance").innerText = userBalance;
                    updateNavBalance(userBalance);
                });
            
            // ÿ¨ŸÑÿ® ÿπÿØÿØ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™
            fetchOrdersCount();
        } else if(currentUserId && currentUserId != 0) {
            // ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ ÿπÿ®ÿ± ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÖÿ§ŸÇÿ™ ÿ£Ÿà ÿßŸÑÿ¨ŸÑÿ≥ÿ©
            updateNavBalance(userBalance);
            
            // ÿ¨ŸÑÿ® ÿπÿØÿØ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™
            fetchOrdersCount();
        }
        
        // ÿØÿßŸÑÿ© ŸÑŸÅÿ™ÿ≠/ÿ•ÿ∫ŸÑÿßŸÇ ŸÇÿ≥ŸÖ ÿ¥ÿ≠ŸÜ ÿßŸÑŸÉŸàÿØ
        function toggleCharge() {
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
            if(!isTelegramWebApp && (!currentUserId || currentUserId == 0)) {
                showLoginModal();
                return;
            }
            
            // ÿ•ÿ∫ŸÑÿßŸÇ ŸÇÿ≥ŸÖ ÿ≠ÿ≥ÿßÿ®Ÿä ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸÅÿ™Ÿàÿ≠ÿßŸã
            const accountContent = document.getElementById("accountContent");
            const accountArrow = document.getElementById("accountArrow");
            if(accountContent.classList.contains("open")) {
                accountContent.classList.remove("open");
                accountArrow.classList.remove("open");
            }
            
            // ŸÅÿ™ÿ≠/ÿ•ÿ∫ŸÑÿßŸÇ ŸÇÿ≥ŸÖ ÿßŸÑÿ¥ÿ≠ŸÜ
            const chargeContent = document.getElementById("chargeContent");
            const chargeArrow = document.getElementById("chargeArrow");
            chargeContent.classList.toggle("open");
            chargeArrow.classList.toggle("open");
        }
        
        // ÿØÿßŸÑÿ© ŸÜÿ≥ÿÆ ŸÑŸÑÿ≠ÿßŸÅÿ∏ÿ© (ŸÑŸÑÿ£ÿ≤ÿ±ÿßÿ±)
        function copyToClipboard(amount) {
            // ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ∫ŸäŸäÿ± Ÿáÿ∞ÿß ŸÑÿßÿ≠ŸÇÿßŸã ŸÑŸÅÿ™ÿ≠ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿØŸÅÿπ
            alert('üí∞ ÿ¥ÿ±ÿßÿ° ÿ±ÿµŸäÿØ ' + amount + ' ÿ±ŸäÿßŸÑ - ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÇÿ±Ÿäÿ®ÿßŸã');
        }
        
        async function submitChargeCode() {
            const code = document.getElementById('chargeCodeInput').value.trim();
            if(!code) {
                alert('‚ùå ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ¥ÿ≠ŸÜ');
                return;
            }
            
            try {
                const response = await fetch('/charge_balance', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUserId,
                        charge_key: code
                    })
                });
                
                const result = await response.json();
                if(result.success) {
                    alert('‚úÖ ' + result.message);
                    userBalance = result.new_balance;
                    document.getElementById('balance').textContent = userBalance;
                    document.getElementById('sidebarBalance').textContent = userBalance;
                    updateNavBalance(userBalance);
                    document.getElementById('chargeCodeInput').value = '';
                } else {
                    alert('‚ùå ' + result.message);
                }
            } catch(error) {
                alert('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ');
            }
        }
        
        // ========== ÿØŸàÿßŸÑ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ© ==========
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.add('active');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        function scrollToSection(sectionId) {
            let element;
            switch(sectionId) {
                case 'top':
                    window.scrollTo({top: 0, behavior: 'smooth'});
                    return;
                case 'market':
                    element = document.querySelector('.product-grid');
                    break;
                case 'myPurchases':
                    element = document.getElementById('myPurchasesSection');
                    break;
                case 'sold':
                    element = document.getElementById('soldSection');
                    break;
                default:
                    return;
            }
            if(element) {
                element.scrollIntoView({behavior: 'smooth', block: 'start'});
            }
        }
        
        // ÿØÿßŸÑÿ© ŸÑŸÅÿ™ÿ≠/ÿ•ÿ∫ŸÑÿßŸÇ ŸÇÿ≥ŸÖ ÿ≠ÿ≥ÿßÿ®Ÿä
        function toggleAccount() {
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ŸÖÿ™ÿµŸÅÿ≠ ÿπÿßÿØŸä Ÿàÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ
            if(!isTelegramWebApp && (!currentUserId || currentUserId == 0)) {
                // ÿ™Ÿàÿ¨ŸäŸáŸá ŸÑÿµŸÅÿ≠ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑŸÖÿØŸÖÿ¨ÿ©
                showLoginModal();
                return;
            }
            
            // ÿ•ÿ∫ŸÑÿßŸÇ ŸÇÿ≥ŸÖ ÿßŸÑÿ¥ÿ≠ŸÜ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸÅÿ™Ÿàÿ≠ÿßŸã
            const chargeContent = document.getElementById("chargeContent");
            const chargeArrow = document.getElementById("chargeArrow");
            if(chargeContent.classList.contains("open")) {
                chargeContent.classList.remove("open");
                chargeArrow.classList.remove("open");
            }
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑÿå ÿßŸÅÿ™ÿ≠/ÿ£ÿ∫ŸÑŸÇ ÿßŸÑŸÇÿ≥ŸÖ
            const content = document.getElementById("accountContent");
            const arrow = document.getElementById("accountArrow");
            content.classList.toggle("open");
            arrow.classList.toggle("open");
        }
        
        // ÿØÿßŸÑÿ© ŸÑÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
        function showLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'flex';
        }
        
        // ÿØÿßŸÑÿ© ŸÑÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('telegramId').value = '';
            document.getElementById('verificationCode').value = '';
        }
        
        // ÿØÿßŸÑÿ© ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
        async function submitLogin() {
            const userId = document.getElementById('telegramId').value.trim();
            const code = document.getElementById('verificationCode').value.trim();
            const errorDiv = document.getElementById('errorMessage');
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            if(!userId || !code) {
                errorDiv.textContent = 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ¢ŸäÿØŸä ŸàÿßŸÑŸÉŸàÿØ';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('/verify', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: userId,
                        code: code
                    })
                });
                
                const data = await response.json();
                
                if(data.success) {
                    // ŸÜÿ¨ÿ≠ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                    closeLoginModal();
                    location.reload(); // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                } else {
                    errorDiv.textContent = data.message;
                    errorDiv.style.display = 'block';
                }
            } catch(error) {
                errorDiv.textContent = 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£! ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ';
                errorDiv.style.display = 'block';
            }
        }
        
        // ÿØÿßŸÑÿ© ŸÑÿπÿ±ÿ∂ ŸÖÿ≥ÿßÿπÿØÿ© ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÉŸàÿØ
        function showCodeHelp() {
            alert('ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÉŸàÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ:\\n\\n1Ô∏è‚É£ ÿßŸÅÿ™ÿ≠ ÿßŸÑÿ®Ÿàÿ™ ŸÅŸä ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ\\n2Ô∏è‚É£ ÿ£ÿ±ÿ≥ŸÑ ÿßŸÑÿ£ŸÖÿ± /code\\n3Ô∏è‚É£ ÿßŸÜÿ≥ÿÆ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÖŸÉŸàŸÜ ŸÖŸÜ 6 ÿ£ÿ±ŸÇÿßŸÖ\\n4Ô∏è‚É£ ÿßŸÑÿµŸÇŸá ŸÅŸä ÿßŸÑÿ≠ŸÇŸÑ ÿ£ÿπŸÑÿßŸá');
        }
        
        // ÿØÿßŸÑÿ© ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
        async function logout() {
            if(confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü')) {
                try {
                    await fetch('/logout', {method: 'POST'});
                    location.reload();
                } catch(error) {
                    location.reload();
                }
            }
        }
        
        // ÿØÿßŸÑÿ© ŸÑŸÅÿ™ÿ≠/ÿ•ÿ∫ŸÑÿßŸÇ ŸÇÿ≥ŸÖ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™
        async function toggleOrders() {
            const ordersSection = document.getElementById('ordersSection');
            const isOpen = ordersSection.classList.toggle('open');
            
            if(isOpen) {
                // ÿ¨ŸÑÿ® ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
                await loadOrders();
            }
        }
        
        // ÿØÿßŸÑÿ© ŸÑÿ¨ŸÑÿ® Ÿàÿπÿ±ÿ∂ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™
        async function loadOrders() {
            const ordersList = document.getElementById('ordersList');
            ordersList.innerHTML = '<p style="text-align:center; color:#888;">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>';
            
            try {
                const response = await fetch(`/get_orders?user_id=${currentUserId}`);
                const data = await response.json();
                
                if(data.orders && data.orders.length > 0) {
                    ordersList.innerHTML = '';
                    data.orders.forEach(order => {
                        const statusText = order.status === 'pending' ? 'ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±' : 
                                          order.status === 'claimed' ? 'ŸÇŸäÿØ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©' : 'ŸÖŸÉÿ™ŸÖŸÑ';
                        const statusClass = order.status;
                        
                        const orderHTML = `
                            <div class="order-item">
                                <div class="order-header">
                                    <span class="order-id">#${order.order_id}</span>
                                    <span class="order-status ${statusClass}">${statusText}</span>
                                </div>
                                <div class="order-info">
                                    <div>üì¶ <strong>ÿßŸÑŸÖŸÜÿ™ÿ¨:</strong> ${order.item_name}</div>
                                    <div>üí∞ <strong>ÿßŸÑÿ≥ÿπÿ±:</strong> ${order.price} ÿ±ŸäÿßŸÑ</div>
                                    ${order.game_id ? `<div>üéÆ <strong>ŸÖÿπÿ±ŸÅ ÿßŸÑŸÑÿπÿ®ÿ©:</strong> ${order.game_id}</div>` : ''}
                                    ${order.game_name ? `<div>üë§ <strong>ÿßÿ≥ŸÖ ÿßŸÑŸÑÿπÿ®ÿ©:</strong> ${order.game_name}</div>` : ''}
                                    ${order.admin_name ? `<div>üë®‚Äçüíº <strong>ÿßŸÑŸÖÿ¥ÿ±ŸÅ:</strong> ${order.admin_name}</div>` : ''}
                                </div>
                            </div>
                        `;
                        ordersList.innerHTML += orderHTML;
                    });
                } else {
                    ordersList.innerHTML = '<p style="text-align:center; color:#888;">üì≠ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ</p>';
                }
            } catch(error) {
                ordersList.innerHTML = '<p style="text-align:center; color:#e74c3c;">‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™</p>';
            }
        }
        
        // ÿ™ÿµŸÅŸäÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÅÿ¶ÿ©
        let allItems = {{ items|tojson }};
        let allCategories = []; // ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑŸÖÿ≠ŸÖŸÑÿ©
        let currentCategory = 'all'; // ŸÖÿ™ÿ∫Ÿäÿ± ŸÑÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÅÿ¶ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
        let currentDeliveryType = 'instant'; // ŸÖÿ™ÿ∫Ÿäÿ± ŸÑÿ™ÿ™ÿ®ÿπ ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿ≠ÿßŸÑŸä
        
        // ÿØÿßŸÑÿ© ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ®ŸäŸÜ ÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
        function switchDeliveryTab(type) {
            currentDeliveryType = type;
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ∏Ÿáÿ± ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™
            document.getElementById('tabInstant').classList.remove('active');
            document.getElementById('tabManual').classList.remove('active');
            document.getElementById('tab' + (type === 'instant' ? 'Instant' : 'Manual')).classList.add('active');
            
            // ÿ•ÿπÿßÿØÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ (ÿ™ÿÆÿ™ÿßÿ± ÿ£ŸàŸÑ ŸÇÿ≥ŸÖ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã)
            renderCategoriesByType(type);
        }
        
        // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
        function renderCategoriesByType(deliveryType) {
            const container = document.getElementById('categoriesContainer');
            const colors = ['bg-netflix', 'bg-shahid', 'bg-disney', 'bg-osn', 'bg-video', 'bg-other'];
            const defaultIcons = [
                'https://cdn-icons-png.flaticon.com/512/732/732228.png',
                'https://cdn-icons-png.flaticon.com/512/3845/3845874.png',
                'https://cdn-icons-png.flaticon.com/512/5977/5977590.png',
                'https://cdn-icons-png.flaticon.com/512/1946/1946488.png',
                'https://cdn-icons-png.flaticon.com/512/3074/3074767.png',
                'https://cdn-icons-png.flaticon.com/512/2087/2087815.png'
            ];
            
            // ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
            const filteredCats = allCategories.filter(cat => {
                const catDelivery = cat.delivery_type || 'instant';
                return catDelivery === deliveryType;
            });
            
            if(filteredCats.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888; padding: 20px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÇÿ≥ÿßŸÖ</p>';
                return;
            }
            
            container.innerHTML = filteredCats.map((cat, index) => {
                const colorClass = colors[index % colors.length];
                const icon = cat.image_url || defaultIcons[index % defaultIcons.length];
                return `
                    <div class="cat-card ${colorClass}" onclick="filterCategory('${cat.name}')" data-delivery="${cat.delivery_type || 'instant'}">
                        <img class="cat-icon" src="${icon}" alt="${cat.name}" 
                             onerror="this.src='https://cdn-icons-png.flaticon.com/512/2087/2087815.png'">
                        <div class="cat-title">${cat.name}</div>
                    </div>
                `;
            }).join('');
            
            // ÿ™ÿµŸÅŸäÿ© ÿ£ŸàŸÑ ŸÇÿ≥ŸÖ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
            if(filteredCats.length > 0) {
                filterCategory(filteredCats[0].name);
            }
        }
        
        function filterCategory(category) {
            currentCategory = category; // ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿ¶ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÜÿµ ÿßŸÑŸÅÿ¶ÿ©
            const categoryFilterText = document.getElementById('categoryFilter');
            if(category === 'all') {
                categoryFilterText.textContent = '';
            } else {
                categoryFilterText.textContent = `- ${category}`;
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ∏Ÿáÿ± ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
            document.querySelectorAll('.cat-card').forEach(card => {
                card.style.opacity = '0.5';
                card.style.transform = 'scale(0.95)';
            });
            if(category !== 'all') {
                document.querySelectorAll('.cat-card').forEach(card => {
                    if(card.querySelector('.cat-title').textContent.trim() === category) {
                        card.style.opacity = '1';
                        card.style.transform = 'scale(1)';
                        card.style.boxShadow = '0 0 15px rgba(108, 92, 231, 0.5)';
                    }
                });
            } else {
                document.querySelectorAll('.cat-card').forEach(card => {
                    card.style.opacity = '1';
                    card.style.transform = 'scale(1)';
                    card.style.boxShadow = '';
                });
            }
            
            // ÿ™ÿµŸÅŸäÿ© Ÿàÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
            const market = document.getElementById('market');
            market.innerHTML = '';
            
            // ÿ™ÿµŸÅŸäÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÅÿ¶ÿ© ŸàŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
            let filteredItems = allItems.filter(item => {
                // ŸÅŸÑÿ™ÿ± ÿßŸÑŸÅÿ¶ÿ©
                const categoryMatch = category === 'all' || item.category === category;
                // ŸÅŸÑÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ (ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖÿ≠ÿØÿØÿå Ÿäÿπÿ™ÿ®ÿ± ŸÅŸàÿ±Ÿä)
                const deliveryType = item.delivery_type || 'instant';
                const deliveryMatch = deliveryType === currentDeliveryType;
                return categoryMatch && deliveryMatch;
            });
            
            // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™: ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© ÿ£ŸàŸÑÿßŸãÿå ÿ´ŸÖ ÿßŸÑŸÖÿ®ÿßÿπÿ©
            filteredItems.sort((a, b) => {
                if(a.sold && !b.sold) return 1;
                if(!a.sold && b.sold) return -1;
                return 0;
            });
            
            if(filteredItems.length === 0) {
                const emptyMsg = currentDeliveryType === 'instant' ? 
                    'üì≠ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ™ÿ≥ŸÑŸäŸÖ ŸÅŸàÿ±Ÿä ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ' : 
                    'üì≠ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ™ÿ≥ŸÑŸäŸÖ ŸäÿØŸàŸä ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ';
                market.innerHTML = `<p style="text-align:center; color:#888; grid-column: 1/-1; padding: 40px;">${emptyMsg}</p>`;
            } else {
                filteredItems.forEach((item, index) => {
                    const isMyProduct = item.seller_id == currentUserId;
                    const isSold = item.sold === true;
                    const deliveryType = item.delivery_type || 'instant';
                    const deliveryBadge = deliveryType === 'manual' ? '<span class="delivery-badge manual">üë®‚Äçüíº ŸäÿØŸàŸä</span>' : '<span class="delivery-badge instant">‚ö° ŸÅŸàÿ±Ÿä</span>';
                    
                    // ÿ™ÿ¨ŸáŸäÿ≤ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ£ÿ≤ÿ±ÿßÿ±
                    const safeItemName = (item.item_name || '').replace(/'/g, "\\\\'").replace(/"/g, '\\\\"');
                    const buyerInstr = item.buyer_instructions ? item.buyer_instructions.replace(/'/g, "\\\\'").replace(/"/g, '\\\\"') : '';
                    
                    const productHTML = `
                        <div class="product-card ${isSold ? 'sold-product' : ''}" data-product-id="${item.id}">
                            ${isSold ? '<div class="sold-ribbon">ŸÖÿ®ÿßÿπ ‚úì</div>' : ''}
                            <div class="product-image" ${!isSold && !isMyProduct ? `onclick="showProductDetails('${item.id}')"` : ''}>
                                ${item.image_url ? `<img src="${item.image_url}" alt="${item.item_name}">` : 'üéÅ'}
                                ${deliveryBadge}
                            </div>
                            ${item.category ? `<div class="product-badge">${item.category}</div>` : ''}
                            <div class="product-info">
                                <div class="product-name" ${!isSold && !isMyProduct ? `onclick="showProductDetails('${item.id}')"` : ''}>${item.item_name}</div>
                                <div class="product-seller">üè™ ${item.seller_name}</div>
                                <div class="product-price-row">
                                    <div class="product-price">${item.price} ÿ±ŸäÿßŸÑ</div>
                                    ${isSold ? 
                                        `<button class="btn-sold" disabled>ŸÖÿ®ÿßÿπ</button>` :
                                        (!isMyProduct ? 
                                            `<button class="btn-add-cart" data-id="${item.id}" data-name="${safeItemName}" data-delivery="${deliveryType}" data-instructions="${buyerInstr}">üõí ÿ£ÿ∂ŸÅ</button>` : 
                                            `<span class="my-product-badge">ŸÖŸÜÿ™ÿ¨ŸÉ ‚≠ê</span>`)
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                    market.innerHTML += productHTML;
                });
                
                // ÿ•ÿ∂ÿßŸÅÿ© event listeners ŸÑŸÑÿ£ÿ≤ÿ±ÿßÿ±
                document.querySelectorAll('.btn-add-cart').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const id = this.dataset.id;
                        const name = this.dataset.name;
                        const delivery = this.dataset.delivery;
                        const instructions = this.dataset.instructions;
                        addToCart(id, name, delivery, instructions);
                    });
                });
            }
            
            // ÿ™ÿµŸÅŸäÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿπÿ© ÿ£Ÿäÿ∂ÿßŸã
            filterSoldByMainCategory(category);
        }
        
        // ÿØÿßŸÑÿ© ŸÑÿ™ÿµŸÅŸäÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿπÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä
        function filterSoldByMainCategory(category) {
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÜÿµ ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑŸÖÿÆÿ™ÿßÿ±
            const soldCategoryFilter = document.getElementById('soldCategoryFilter');
            if(soldCategoryFilter) {
                if(category === 'all') {
                    soldCategoryFilter.textContent = '';
                } else {
                    soldCategoryFilter.textContent = `- ${category}`;
                }
            }
            
            document.querySelectorAll('.sold-item-card').forEach(card => {
                if(category === 'all' || card.dataset.category === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        let currentPurchaseData = null;
        
        function buyItem(itemId, price, itemName, category, details, deliveryType, buyerInstructions) {
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ ÿ£ŸàŸÑÿßŸã
            if(userBalance < price) {
                showWarningModal(price);
                return;
            }

            // ÿ™ÿ≠ÿØŸäÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä
            let buyerId = currentUserId;
            let buyerName = '{{ user_name }}';
            
            if(user && user.id) {
                buyerId = user.id;
                buyerName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
            }

            if(!buyerId || buyerId == 0) {
                alert("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã!");
                return;
            }

            // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿ±ÿßÿ°
            currentPurchaseData = {
                itemId: itemId,
                buyerId: buyerId,
                buyerName: buyerName,
                deliveryType: deliveryType || 'instant',
                buyerInstructions: buyerInstructions || ''
            };

            // ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ£ŸÉŸäÿØ ŸÖÿπ ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
            document.getElementById('modalProductName').textContent = itemName;
            document.getElementById('modalProductCategory').textContent = category || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            document.getElementById('modalProductPrice').textContent = price + ' ÿ±ŸäÿßŸÑ';
            document.getElementById('modalProductDetails').textContent = details || 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÅÿßÿµŸäŸÑ ÿ•ÿ∂ÿßŸÅŸäÿ©';
            
            // ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿ≠ŸÇŸÑ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
            const buyerInputSection = document.getElementById('buyerInputSection');
            const deliveryTypeNote = document.getElementById('deliveryTypeNote');
            const buyerInputDetails = document.getElementById('buyerInputDetails');
            
            if(deliveryType === 'manual') {
                // ÿ™ÿ≥ŸÑŸäŸÖ ŸäÿØŸàŸä - ÿ•ÿ∏Ÿáÿßÿ± ÿ≠ŸÇŸÑ ÿßŸÑÿ•ÿØÿÆÿßŸÑ
                buyerInputSection.style.display = 'block';
                document.getElementById('buyerInstructionsLabel').textContent = buyerInstructions || 'ÿ£ÿØÿÆŸÑ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©:';
                buyerInputDetails.value = '';
                buyerInputDetails.placeholder = 'ŸÖÿ´ÿßŸÑ: ÿ¢ŸäÿØŸä ÿßŸÑŸÑÿπÿ®ÿ©ÿå ÿßÿ≥ŸÖ ÿßŸÑÿ≠ÿ≥ÿßÿ®...';
                
                deliveryTypeNote.style.color = '#f39c12';
                deliveryTypeNote.innerHTML = 'üë®‚Äçüíº ÿ™ÿ≥ŸÑŸäŸÖ ŸäÿØŸàŸä - ÿ≥Ÿäÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ ÿ∑ŸÑÿ®ŸÉ ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿßŸÑŸÖÿ¥ÿ±ŸÅ';
            } else {
                // ÿ™ÿ≥ŸÑŸäŸÖ ŸÅŸàÿ±Ÿä - ÿ•ÿÆŸÅÿßÿ° ÿ≠ŸÇŸÑ ÿßŸÑÿ•ÿØÿÆÿßŸÑ
                buyerInputSection.style.display = 'none';
                buyerInputDetails.value = '';
                
                deliveryTypeNote.style.color = '#00b894';
                deliveryTypeNote.innerHTML = '‚ö° ÿ™ÿ≥ŸÑŸäŸÖ ŸÅŸàÿ±Ÿä - ÿ≥ÿ™ÿ≠ÿµŸÑ ÿπŸÑŸâ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ®ÿßÿ¥ÿ±ÿ©';
            }
            
            document.getElementById('buyModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('buyModal').style.display = 'none';
            document.getElementById('buyerInputDetails').value = '';
            currentPurchaseData = null;
        }

        function confirmPurchase() {
            if(!currentPurchaseData) return;
            
            // ŸÑŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸäÿØŸàŸä: ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            if(currentPurchaseData.deliveryType === 'manual') {
                const buyerDetails = document.getElementById('buyerInputDetails').value.trim();
                if(!buyerDetails) {
                    alert('‚ùå ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©');
                    return;
                }
                currentPurchaseData.buyerDetails = buyerDetails;
            }
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
            const confirmBtn = document.querySelector('#buyModal .modal-btn-confirm');
            const originalText = confirmBtn.textContent;
            confirmBtn.textContent = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ¥ÿ±ÿßÿ°...';
            confirmBtn.disabled = true;

            fetch('/buy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    buyer_id: currentPurchaseData.buyerId,
                    buyer_name: currentPurchaseData.buyerName,
                    item_id: currentPurchaseData.itemId,
                    delivery_type: currentPurchaseData.deliveryType,
                    buyer_details: currentPurchaseData.buyerDetails || ''
                })
            }).then(r => {
                if(!r.ok) throw new Error('ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ');
                return r.json();
            }).then(data => {
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
                
                if(data.status == 'success') {
                    closeModal();
                    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ ÿ®ÿ£ŸÖÿßŸÜ
                    if(data.new_balance !== undefined) {
                        userBalance = data.new_balance;
                        const balanceEl = document.getElementById('balance');
                        const sidebarBalanceEl = document.getElementById('sidebarBalance');
                        if(balanceEl) balanceEl.textContent = userBalance.toFixed(2);
                        if(sidebarBalanceEl) sidebarBalanceEl.textContent = userBalance.toFixed(2);
                        if(typeof updateNavBalance === 'function') updateNavBalance(userBalance);
                    }
                    // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
                    let successMsg = '';
                    if(data.delivery_type === 'manual') {
                        successMsg = '‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ∑ŸÑÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠! üìã\\n\\nÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: ' + (data.order_id || '---') + '\\n\\nüë®‚Äçüíº ÿ≥Ÿäÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ ÿ∑ŸÑÿ®ŸÉ ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿßŸÑŸÖÿ¥ÿ±ŸÅ ŸÇÿ±Ÿäÿ®ÿßŸã\\n\\nÿ≥ÿ™ÿµŸÑŸÉ ÿ±ÿ≥ÿßŸÑÿ© ÿπŸÜÿØ ÿßŸÉÿ™ŸÖÿßŸÑ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞';
                    } else {
                        successMsg = '‚úÖ ÿ™ŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ° ÿ®ŸÜÿ¨ÿßÿ≠! üéâ\\n\\nÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: ' + (data.order_id || '---') + '\\n\\nÿ≥ÿ™ÿ¨ÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿµŸÅÿ≠ÿ© ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™Ÿä Ÿàÿ£Ÿäÿ∂ÿßŸã ŸÅŸä ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ®Ÿàÿ™';
                    }
                    alert(successMsg);
                    location.reload();
                } else {
                    closeModal();
                    alert('‚ùå ' + (data.message || 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'));
                }
            }).catch(err => {
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
                closeModal();
                alert('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + err.message);
                console.error('Purchase error:', err);
            });
        }

        let lastPurchaseData = '';
        
        function showSuccessModal(hiddenData, messageSent, orderId) {
            const container = document.getElementById('purchaseDataContainer');
            const dataDiv = document.getElementById('purchaseHiddenData');
            const botNote = document.getElementById('botMessageNote');
            const orderIdSpan = document.getElementById('successOrderId');
            
            // ÿπÿ±ÿ∂ ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®
            if(orderId) {
                orderIdSpan.textContent = '#' + orderId;
            }
            
            if(hiddenData && hiddenData !== 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™') {
                container.style.display = 'block';
                dataDiv.textContent = hiddenData;
                lastPurchaseData = hiddenData;
                
                if(messageSent) {
                    botNote.innerHTML = '‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£Ÿäÿ∂ÿßŸã ŸÑŸÑÿ®Ÿàÿ™';
                    botNote.style.color = '#00b894';
                    botNote.style.background = 'rgba(0,184,148,0.15)';
                } else {
                    botNote.innerHTML = '‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ®Ÿàÿ™ (ÿßÿ®ÿØÿ£ ŸÖÿ≠ÿßÿØÿ´ÿ© ŸÖÿπ ÿßŸÑÿ®Ÿàÿ™ ÿ£ŸàŸÑÿßŸã)';
                    botNote.style.color = '#fdcb6e';
                    botNote.style.background = 'rgba(253,203,110,0.15)';
                }
            } else {
                container.style.display = 'none';
            }
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            document.getElementById('successModal').style.display = 'block';
            console.log('‚úÖ Success modal displayed');
        }
        
        function copyPurchaseData() {
            navigator.clipboard.writeText(lastPurchaseData).then(() => {
                alert('‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™!');
            }).catch(() => {
                // fallback ŸÑŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÇÿØŸäŸÖÿ©
                const textArea = document.createElement('textarea');
                textArea.value = lastPurchaseData;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™!');
            });
        }

        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
            document.getElementById('purchaseDataContainer').style.display = 'none';
            location.reload();
        }

        function showWarningModal(price) {
            document.getElementById('warningBalance').textContent = userBalance.toFixed(2);
            document.getElementById('warningPrice').textContent = parseFloat(price).toFixed(2);
            document.getElementById('warningModal').style.display = 'block';
        }

        function closeWarningModal() {
            document.getElementById('warningModal').style.display = 'none';
        }

        // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿÆÿßÿ±ÿ¨Ÿáÿß
        window.onclick = function(event) {
            const buyModal = document.getElementById('buyModal');
            const successModal = document.getElementById('successModal');
            const warningModal = document.getElementById('warningModal');
            if(event.target == buyModal) {
                closeModal();
            }
            if(event.target == successModal) {
                closeSuccessModal();
            }
            if(event.target == warningModal) {
                closeWarningModal();
            }
        }
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ£ŸàŸÑ ŸÇÿ≥ŸÖ (ŸÜÿ™ŸÅŸÑŸÉÿ≥) ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿµŸÅÿ≠ÿ©
        window.addEventListener('DOMContentLoaded', function() {
            loadCategoriesUI();  // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã
            initFloatingNav();
        });
        
        // ÿØÿßŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸÑŸÑŸàÿßÿ¨Ÿáÿ©
        async function loadCategoriesUI() {
            try {
                const response = await fetch('/api/categories');
                const data = await response.json();
                
                if(data.status === 'success' && data.categories.length > 0) {
                    // ÿ≠ŸÅÿ∏ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸÅŸä ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ± ÿßŸÑÿπÿßŸÖ
                    allCategories = data.categories;
                    
                    // ÿ™ÿ∑ÿ®ŸäŸÇ ÿπÿØÿØ ÿßŸÑÿ£ÿπŸÖÿØÿ©
                    const container = document.getElementById('categoriesContainer');
                    const cols = data.columns || 3;
                    container.className = 'categories-grid cols-' + cols;
                    
                    // ÿπÿ±ÿ∂ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿ≠ÿßŸÑŸä (ŸÅŸàÿ±Ÿä ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäÿßŸã)
                    renderCategoriesByType(currentDeliveryType);
                } else {
                    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
                    filterCategory('ŸÜÿ™ŸÅŸÑŸÉÿ≥');
                }
            } catch(error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ:', error);
                filterCategory('ŸÜÿ™ŸÅŸÑŸÉÿ≥');
            }
        }

        // --- Floating Navigation Bar ---
        function initFloatingNav() {
            const navItems = document.querySelectorAll('.floating-nav-item');
            
            // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑÿ£ŸàŸÑ ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäÿßŸã
            if(navItems.length > 0) {
                navItems[0].classList.add('active');
            }
            
            navItems.forEach((item, index) => {
                item.addEventListener('click', function() {
                    // ÿ•ÿ≤ÿßŸÑÿ© active ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÜÿßÿµÿ±
                    navItems.forEach(nav => nav.classList.remove('active'));
                    // ÿ•ÿ∂ÿßŸÅÿ© active ŸÑŸÑÿπŸÜÿµÿ± ÿßŸÑÿ≠ÿßŸÑŸä
                    this.classList.add('active');
                    
                    // ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ÿßŸÑŸÖŸÜÿßÿ≥ÿ®
                    const action = this.getAttribute('data-action');
                    if(action === 'home') {
                        scrollToTop();
                    } else if(action === 'orders') {
                        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã
                        if(!isTelegramWebApp && (!currentUserId || currentUserId == 0)) {
                            showLoginModal();
                            return;
                        }
                        window.location.href = '/my_purchases';
                    } else if(action === 'charge') {
                        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã
                        if(!isTelegramWebApp && (!currentUserId || currentUserId == 0)) {
                            showLoginModal();
                            return;
                        }
                        // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©
                        window.location.href = '/wallet?user_id=' + currentUserId;
                    } else if(action === 'cart') {
                        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã
                        if(!isTelegramWebApp && (!currentUserId || currentUserId == 0)) {
                            showLoginModal();
                            return;
                        }
                        // ÿßŸÑÿ∞Ÿáÿßÿ® ŸÑŸÑÿ≥ŸÑÿ©
                        window.location.href = '/cart';
                    } else if(action === 'account') {
                        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã
                        if(!isTelegramWebApp && (!currentUserId || currentUserId == 0)) {
                            showLoginModal();
                            return;
                        }
                        // ŸÅÿ™ÿ≠ ÿßŸÑŸÑŸàÿ≠ÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©
                        toggleSidebar();
                    }
                });
            });
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleAccountMenu() {
            // Ÿáÿ∞Ÿá ÿßŸÑÿØÿßŸÑÿ© ŸÑŸÑÿ™ŸàÿßŸÅŸÇ ŸÖÿπ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÇÿØŸäŸÖ
            if(!isTelegramWebApp && (!currentUserId || currentUserId == 0)) {
                showLoginModal();
                return;
            }
            toggleSidebar();
        }
        
        // ÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨
        function showProductDetails(productId) {
            const product = allItems.find(p => p.id === productId);
            if(!product) {
                showCustomAlert('ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ', 'error');
                return;
            }
            
            const deliveryText = product.delivery_type === 'manual' ? 'ÿ™ÿ≥ŸÑŸäŸÖ ŸäÿØŸàŸä ü§ù' : 'ÿ™ÿ≥ŸÑŸäŸÖ ŸÅŸàÿ±Ÿä ‚ö°';
            const safeItemName = (product.item_name || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
            const buyerInstr = product.buyer_instructions ? product.buyer_instructions.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';
            
            let detailsHTML = `
                <div class="product-detail-modal">
                    <div class="pdm-header">
                        <div class="pdm-image">
                            ${product.image_url ? `<img src="${product.image_url}" alt="${product.item_name}">` : 'üéÅ'}
                        </div>
                        <div class="pdm-title">${product.item_name}</div>
                        ${product.category ? `<div class="pdm-category">${product.category}</div>` : ''}
                    </div>
                    
                    <div class="pdm-info">
                        <div class="pdm-row">
                            <span class="pdm-label">ÿßŸÑÿ≥ÿπÿ±:</span>
                            <span class="pdm-value price">${product.price} ÿ±ŸäÿßŸÑ</span>
                        </div>
                        <div class="pdm-row">
                            <span class="pdm-label">ÿßŸÑÿ®ÿßÿ¶ÿπ:</span>
                            <span class="pdm-value">üè™ ${product.seller_name || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'}</span>
                        </div>
                        <div class="pdm-row">
                            <span class="pdm-label">ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ:</span>
                            <span class="pdm-value">${deliveryText}</span>
                        </div>
                        ${product.description ? `
                        <div class="pdm-row full">
                            <span class="pdm-label">ÿßŸÑŸàÿµŸÅ:</span>
                            <div class="pdm-description">${product.description}</div>
                        </div>
                        ` : ''}
                        ${product.buyer_instructions ? `
                        <div class="pdm-row full">
                            <span class="pdm-label">ÿ™ÿπŸÑŸäŸÖÿßÿ™ ŸÑŸÑŸÖÿ¥ÿ™ÿ±Ÿä:</span>
                            <div class="pdm-instructions">${product.buyer_instructions}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="pdm-actions">
                        <button class="pdm-btn close" onclick="closeProductDetailModal()">ÿ•ÿ∫ŸÑÿßŸÇ</button>
                        <button class="pdm-btn cart" id="pdmAddCartBtn" data-id="${product.id}" data-name="${safeItemName}" data-delivery="${product.delivery_type || 'instant'}" data-instructions="${buyerInstr}">ÿ£ÿ∂ŸÅ ŸÑŸÑÿ≥ŸÑÿ© üõí</button>
                    </div>
                </div>
            `;
            
            // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸàÿØÿßŸÑ
            let modal = document.getElementById('productDetailModal');
            if(!modal) {
                modal = document.createElement('div');
                modal.id = 'productDetailModal';
                modal.className = 'pdm-overlay';
                document.body.appendChild(modal);
            }
            modal.innerHTML = detailsHTML;
            modal.style.display = 'flex';
            
            // ÿ•ÿ∂ÿßŸÅÿ© event listener ŸÑÿ≤ÿ± ÿßŸÑÿ≥ŸÑÿ©
            document.getElementById('pdmAddCartBtn').addEventListener('click', function() {
                closeProductDetailModal();
                addToCart(this.dataset.id, this.dataset.name, this.dataset.delivery, this.dataset.instructions);
            });
            
            // ÿ•ÿ∫ŸÑÿßŸÇ ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÖŸàÿØÿßŸÑ
            modal.onclick = function(e) {
                if(e.target === modal) closeProductDetailModal();
            };
        }
        
        function closeProductDetailModal() {
            const modal = document.getElementById('productDetailModal');
            if(modal) modal.style.display = 'none';
        }
        
        // ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ©
        let pendingCartItem = null;
        
        function addToCart(productId, productName, deliveryType, buyerInstructions) {
            if(!isTelegramWebApp && (!currentUserId || currentUserId == 0)) {
                showLoginModal();
                return;
            }
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸäÿØŸàŸäÿå ŸÜÿ∑ŸÑÿ® ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ£ŸàŸÑÿßŸã
            if(deliveryType === 'manual') {
                pendingCartItem = {
                    productId: productId,
                    productName: productName,
                    buyerInstructions: buyerInstructions
                };
                showCartInputModal(productName, buyerInstructions);
                return;
            }
            
            // ŸÖŸÜÿ™ÿ¨ ŸÅŸàÿ±Ÿä - ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©
            submitAddToCart(productId, productName, '');
        }
        
        function showCartInputModal(productName, instructions) {
            // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ•ÿØÿÆÿßŸÑ
            let modal = document.getElementById('cartInputModal');
            if(!modal) {
                modal = document.createElement('div');
                modal.id = 'cartInputModal';
                modal.innerHTML = `
                    <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px;">
                        <div style="background:#1a1a2e;border-radius:20px;padding:25px;max-width:400px;width:100%;text-align:center;">
                            <div style="font-size:40px;margin-bottom:15px;">üìù</div>
                            <div style="font-size:18px;font-weight:bold;margin-bottom:10px;">ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖÿ∑ŸÑŸàÿ®ÿ©</div>
                            <div style="color:#888;margin-bottom:15px;" id="cartProductName"></div>
                            <div style="background:rgba(241,196,15,0.1);border:1px solid rgba(241,196,15,0.3);border-radius:10px;padding:12px;margin-bottom:15px;color:#f1c40f;font-size:14px;" id="cartInstructionsLabel"></div>
                            <textarea id="cartBuyerDetails" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©..." style="width:100%;padding:15px;border:2px solid rgba(255,255,255,0.1);border-radius:12px;background:rgba(255,255,255,0.05);color:#fff;font-size:16px;font-family:'Tajawal',sans-serif;resize:none;height:100px;margin-bottom:15px;"></textarea>
                            <div style="display:flex;gap:10px;">
                                <button onclick="submitCartWithDetails()" style="flex:1;padding:14px;background:linear-gradient(135deg,#00b894,#00cec9);border:none;border-radius:12px;color:#fff;font-size:16px;font-weight:bold;cursor:pointer;font-family:'Tajawal',sans-serif;">‚úÖ ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ©</button>
                                <button onclick="closeCartInputModal()" style="flex:1;padding:14px;background:rgba(255,255,255,0.1);border:none;border-radius:12px;color:#fff;font-size:16px;font-weight:bold;cursor:pointer;font-family:'Tajawal',sans-serif;">‚ùå ÿ•ŸÑÿ∫ÿßÿ°</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('cartProductName').textContent = productName;
            document.getElementById('cartInstructionsLabel').textContent = instructions || 'ÿ£ÿØÿÆŸÑ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ŸÑŸÑÿ™ŸÜŸÅŸäÿ∞:';
            document.getElementById('cartBuyerDetails').value = '';
            modal.style.display = 'block';
        }
        
        function closeCartInputModal() {
            const modal = document.getElementById('cartInputModal');
            if(modal) modal.style.display = 'none';
            pendingCartItem = null;
        }
        
        function submitCartWithDetails() {
            const details = document.getElementById('cartBuyerDetails').value.trim();
            if(!details) {
                alert('‚ùå ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©');
                return;
            }
            
            if(pendingCartItem) {
                submitAddToCart(pendingCartItem.productId, pendingCartItem.productName, details);
                closeCartInputModal();
            }
        }
        
        async function submitAddToCart(productId, productName, buyerDetails) {
            try {
                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUserId,
                        product_id: productId,
                        buyer_details: buyerDetails
                    })
                });
                const data = await response.json();
                
                if(data.status === 'success') {
                    // ÿ™ÿ≠ÿØŸäÿ´ ÿπÿØÿßÿØ ÿßŸÑÿ≥ŸÑÿ©
                    updateCartBadge(data.cart_count);
                    // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠
                    showCartToast('‚úÖ ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© "' + productName + '" ŸÑŸÑÿ≥ŸÑÿ©');
                } else {
                    alert('‚ùå ' + (data.message || 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£'));
                }
            } catch(error) {
                console.error('Cart error:', error);
                alert('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ');
            }
        }
        
        function updateCartBadge(count) {
            const badge = document.getElementById('cartBadge');
            if(badge) {
                if(count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }
        
        function showCartToast(message) {
            // ÿ•ŸÜÿ¥ÿßÿ° ÿ™Ÿàÿ≥ÿ™ ŸÖÿ§ŸÇÿ™
            let toast = document.getElementById('cartToast');
            if(!toast) {
                toast = document.createElement('div');
                toast.id = 'cartToast';
                toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#1a1a2e;color:#fff;padding:12px 24px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:1000;opacity:0;transition:opacity 0.3s;border-left:4px solid #00b894;';
                document.body.appendChild(toast);
            }
            toast.textContent = message;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        }
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿπÿØÿØ ÿßŸÑÿ≥ŸÑÿ© ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿµŸÅÿ≠ÿ©
        async function loadCartCount() {
            if(!currentUserId || currentUserId == 0) return;
            try {
                const response = await fetch('/api/cart/count?user_id=' + currentUserId);
                const data = await response.json();
                updateCartBadge(data.count || 0);
            } catch(e) {}
        }
        
        window.addEventListener('DOMContentLoaded', function() {
            loadCartCount();
        });
    </script>
    
    <!-- ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÖŸÑÿßÿ≠ÿ© ÿßŸÑÿ≥ŸÅŸÑŸä ÿßŸÑÿπÿßÿ¶ŸÖ -->
    <div class="floating-bottom-nav">
        <div class="floating-nav-item active" data-action="home">
            <div class="floating-nav-icon">üè†</div>
            <div class="floating-nav-label">ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</div>
        </div>
        <div class="floating-nav-item" data-action="cart">
            <span class="nav-badge {% if cart_count == 0 %}hidden{% endif %}" id="cartBadge">{{ cart_count }}</span>
            <div class="floating-nav-icon">üõí</div>
            <div class="floating-nav-label">ÿßŸÑÿ≥ŸÑÿ©</div>
        </div>
        <div class="floating-nav-item" data-action="orders">
            <span class="nav-badge hidden" id="ordersBadge">0</span>
            <div class="floating-nav-icon">üì¶</div>
            <div class="floating-nav-label">ÿ∑ŸÑÿ®ÿßÿ™Ÿä</div>
        </div>
        <div class="floating-nav-item" data-action="charge">
            <div class="floating-nav-icon">üí≥</div>
            <div class="floating-nav-label">ÿ¥ÿ≠ŸÜ</div>
        </div>
        <div class="floating-nav-item" data-action="account">
            <div class="floating-nav-icon">üë§</div>
            <div class="floating-nav-label">ÿ≠ÿ≥ÿßÿ®Ÿä</div>
            <div class="nav-balance" id="navBalance">{{ balance }} ÿ±.ÿ≥</div>
        </div>
    </div>
    
    <!-- üõ°Ô∏è ÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ ÿßŸÑŸÅÿ≠ÿµ -->
    <script>
        // ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑÿ≤ÿ± ÿßŸÑÿ£ŸäŸÖŸÜ
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        // ÿ™ÿπÿ∑ŸäŸÑ ÿßÿÆÿ™ÿµÿßÿ±ÿßÿ™ DevTools
        document.addEventListener('keydown', function(e) {
            // F12
            if (e.key === 'F12') {
                e.preventDefault();
                return false;
            }
            // Ctrl+Shift+I / Ctrl+Shift+J / Ctrl+Shift+C
            if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j' || e.key === 'C' || e.key === 'c')) {
                e.preventDefault();
                return false;
            }
            // Ctrl+U (ÿπÿ±ÿ∂ ÿßŸÑŸÖÿµÿØÿ±)
            if (e.ctrlKey && (e.key === 'U' || e.key === 'u')) {
                e.preventDefault();
                return false;
            }
        });
    </script>
</body>
</html>
"""

# --- ÿ£ŸàÿßŸÖÿ± ÿßŸÑÿ®Ÿàÿ™ ---

# ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ
def log_message(message, handler_name):
    print("="*50)
    print(f"üì® {handler_name}")
    print(f"üë§ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: {message.from_user.id} - {message.from_user.first_name}")
    print(f"üí¨ ÿßŸÑŸÜÿµ: {message.text}")
    print("="*50)

@bot.message_handler(commands=['start'])
def send_welcome(message):
    log_message(message, "ŸÖÿπÿßŸÑÿ¨ /start")
    try:
        user_id = str(message.from_user.id)
        user_name = message.from_user.first_name
        if message.from_user.last_name:
            user_name += ' ' + message.from_user.last_name
        username = message.from_user.username or ''
        
        # ÿ¨ŸÑÿ® ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ ŸÖŸÜ ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ
        profile_photo = get_user_profile_photo(user_id)
        
        # ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Firebase
        if db:
            try:
                user_ref = db.collection('users').document(user_id)
                user_doc = user_ref.get()
                
                if not user_doc.exists:
                    user_data = {
                        'telegram_id': user_id,
                        'name': user_name,
                        'username': username,
                        'balance': 0.0,
                        'telegram_started': True,  # ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿØÿ£ ŸÖÿ≠ÿßÿØÿ´ÿ© ŸÖÿπ ÿßŸÑÿ®Ÿàÿ™
                        'created_at': firestore.SERVER_TIMESTAMP,
                        'last_seen': firestore.SERVER_TIMESTAMP
                    }
                    if profile_photo:
                        user_data['profile_photo'] = profile_photo
                    user_ref.set(user_data)
                    users_wallets[user_id] = 0.0
                    print(f"‚úÖ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ§Ÿá")
                else:
                    update_data = {
                        'name': user_name,
                        'username': username,
                        'telegram_started': True,  # ÿ™ÿ≠ÿØŸäÿ´: ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿØÿ£ ŸÖÿ≠ÿßÿØÿ´ÿ© ŸÖÿπ ÿßŸÑÿ®Ÿàÿ™
                        'last_seen': firestore.SERVER_TIMESTAMP
                    }
                    if profile_photo:
                        update_data['profile_photo'] = profile_photo
                    user_ref.update(update_data)
                    print(f"‚úÖ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´Ÿá")
            except Exception as e:
                print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä Firebase: {e}")
        
        # ÿ•ŸÜÿ¥ÿßÿ° ÿ£ÿ≤ÿ±ÿßÿ± Inline ÿØÿßÿÆŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
        markup = types.InlineKeyboardMarkup(row_width=2)
        btn_shop = types.InlineKeyboardButton("üè™ ÿßŸÅÿ™ÿ≠ ÿßŸÑÿ≥ŸàŸÇ", callback_data="open_shop")
        btn_code = types.InlineKeyboardButton("üîê ŸÉŸàÿØ ÿßŸÑÿØÿÆŸàŸÑ", callback_data="get_code")
        btn_myid = types.InlineKeyboardButton("üÜî ŸÖÿπÿ±ŸÅŸä", callback_data="my_id")
        markup.add(btn_shop)
        markup.add(btn_code, btn_myid)
        
        # ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
        print(f"üì§ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ±ÿ≠Ÿäÿ®...")
        result = bot.send_message(
            message.chat.id,
            "üåü *ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ ŸÅŸä ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ¢ŸÖŸÜ!* üõ°Ô∏è\n\n"
            "ŸÖŸÜÿµÿ© ÿ¢ŸÖŸÜÿ© ŸÑŸÑÿ®Ÿäÿπ ŸàÿßŸÑÿ¥ÿ±ÿßÿ° ŸÖÿπ ŸÜÿ∏ÿßŸÖ ÿ≠ŸÖÿßŸäÿ© ÿßŸÑÿ£ŸÖŸàÿßŸÑ ‚ùÑÔ∏è\n\n"
            "üìå *ÿßÿÆÿ™ÿ± ŸÖŸÜ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿ£ÿØŸÜÿßŸá:*",
            reply_markup=markup,
            parse_mode="Markdown"
        )
        print(f"‚úÖ ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ! message_id: {result.message_id}")
        
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä send_welcome: {e}")
        import traceback
        traceback.print_exc()

# ŸÖÿπÿßŸÑÿ¨ ÿ£ÿ≤ÿ±ÿßÿ± Inline
@bot.callback_query_handler(func=lambda call: call.data in ["open_shop", "get_code", "my_id"])
def handle_inline_buttons(call):
    try:
        if call.data == "open_shop":
            # ÿ•ÿ±ÿ≥ÿßŸÑ ÿ≤ÿ± ÿ®ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÖŸàŸÇÿπ
            markup = types.InlineKeyboardMarkup()
            btn = types.InlineKeyboardButton("üõí ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑÿ≥ŸàŸÇ", url=SITE_URL)
            markup.add(btn)
            bot.send_message(
                call.message.chat.id,
                f"üè™ *ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑÿ≤ÿ± ÿ£ÿØŸÜÿßŸá ŸÑŸÅÿ™ÿ≠ ÿßŸÑÿ≥ŸàŸÇ:*\n\n"
                f"üîó ÿßŸÑÿ±ÿßÿ®ÿ∑: {SITE_URL}",
                reply_markup=markup,
                parse_mode="Markdown"
            )
        elif call.data == "get_code":
            # ÿ•ŸÜÿ¥ÿßÿ° ŸÉŸàÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ
            user_id = str(call.from_user.id)
            user_name = call.from_user.first_name
            if call.from_user.last_name:
                user_name += ' ' + call.from_user.last_name
            code = str(random.randint(100000, 999999))
            verification_codes[user_id] = {
                'code': code,
                'name': user_name,
                'created_at': time.time()
            }
            bot.send_message(
                call.message.chat.id,
                f"üîê *ŸÉŸàÿØ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ:*\n\n"
                f"`{code}`\n\n"
                f"‚è± ÿµÿßŸÑÿ≠ ŸÑŸÖÿØÿ© 10 ÿØŸÇÿßÿ¶ŸÇ\n"
                f"üìã ÿßŸÜÿ≥ÿÆ ÿßŸÑŸÉŸàÿØ Ÿàÿ£ÿØÿÆŸÑŸá ŸÅŸä ÿßŸÑŸÖŸàŸÇÿπ",
                parse_mode="Markdown"
            )
        elif call.data == "my_id":
            bot.send_message(
                call.message.chat.id,
                f"üÜî *ÿßŸÑÿ¢ŸäÿØŸä ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ:*\n\n`{call.from_user.id}`\n\nÿ£ÿ±ÿ≥ŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ±ŸÇŸÖ ŸÑŸÑŸÖÿßŸÑŸÉ ŸÑŸäÿ∂ŸäŸÅŸÉ ŸÉŸÖÿ¥ÿ±ŸÅ!",
                parse_mode="Markdown"
            )
        # ÿ•ÿ≤ÿßŸÑÿ© ÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÜ ÿßŸÑÿ≤ÿ±
        bot.answer_callback_query(call.id)
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä inline button: {e}")
        bot.answer_callback_query(call.id, "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£!")

@bot.message_handler(commands=['my_id'])
def my_id(message):
    log_message(message, "ŸÖÿπÿßŸÑÿ¨ /my_id")
    try:
        bot.reply_to(message, f"üÜî ÿßŸÑÿ¢ŸäÿØŸä ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ: `{message.from_user.id}`\n\nÿ£ÿ±ÿ≥ŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ±ŸÇŸÖ ŸÑŸÑŸÖÿßŸÑŸÉ ŸÑŸäÿ∂ŸäŸÅŸÉ ŸÉŸÖÿ¥ÿ±ŸÅ!", parse_mode="Markdown")
        print(f"‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ¢ŸäÿØŸä")
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£: {e}")

# ÿ™ÿÆÿ≤ŸäŸÜ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑŸÖÿ§ŸÇÿ™ÿ©
temp_product_data = {}

# ÿ£ŸÖÿ± ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ (ŸÅŸÇÿ∑ ŸÑŸÑŸÖÿßŸÑŸÉ)
@bot.message_handler(commands=['add_product'])
def add_product_command(message):
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸáŸà ÿßŸÑŸÖÿßŸÑŸÉ
    if message.from_user.id != ADMIN_ID:
        return bot.reply_to(message, "‚õî Ÿáÿ∞ÿß ÿßŸÑÿ£ŸÖÿ± ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑!")
    
    # ÿ®ÿØÿ° ÿπŸÖŸÑŸäÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ
    user_id = message.from_user.id
    temp_product_data[user_id] = {}
    
    msg = bot.reply_to(message, "üì¶ **ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ**\n\nüìù ÿ£ÿ±ÿ≥ŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨:", parse_mode="Markdown")
    bot.register_next_step_handler(msg, process_product_name)

def process_product_name(message):
    user_id = message.from_user.id
    
    if message.text == '/cancel':
        temp_product_data.pop(user_id, None)
        return bot.reply_to(message, "‚ùå ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨")
    
    temp_product_data[user_id]['item_name'] = message.text.strip()
    bot.reply_to(message, f"‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿßÿ≥ŸÖ: {message.text.strip()}")
    
    msg = bot.send_message(message.chat.id, "üí∞ ÿ£ÿ±ÿ≥ŸÑ ÿ≥ÿπÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ (ÿ®ÿßŸÑÿ±ŸäÿßŸÑ):")
    bot.register_next_step_handler(msg, process_product_price)

def process_product_price(message):
    user_id = message.from_user.id
    
    if message.text == '/cancel':
        temp_product_data.pop(user_id, None)
        return bot.reply_to(message, "‚ùå ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨")
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≥ÿπÿ±
    try:
        price = float(message.text.strip())
        temp_product_data[user_id]['price'] = str(price)
        bot.reply_to(message, f"‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≥ÿπÿ±: {price} ÿ±ŸäÿßŸÑ")
        
        # ÿ•ÿ±ÿ≥ÿßŸÑ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÅÿ¶ÿßÿ™
        markup = types.ReplyKeyboardMarkup(row_width=2, one_time_keyboard=True, resize_keyboard=True)
        markup.add(
            types.KeyboardButton("ŸÜÿ™ŸÅŸÑŸÉÿ≥"),
            types.KeyboardButton("ÿ¥ÿßŸáÿØ"),
            types.KeyboardButton("ÿØŸäÿ≤ŸÜŸä ÿ®ŸÑÿ≥"),
            types.KeyboardButton("ÿßŸàÿ≥ŸÜ ÿ®ŸÑÿ≥"),
            types.KeyboardButton("ŸÅÿØŸäŸà ÿ®ÿ±ŸäŸÖŸäŸÖ"),
            types.KeyboardButton("ÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ÿ£ÿÆÿ±Ÿâ")
        )
        
        msg = bot.send_message(message.chat.id, "üè∑Ô∏è ÿßÿÆÿ™ÿ± ŸÅÿ¶ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨:", reply_markup=markup)
        bot.register_next_step_handler(msg, process_product_category)
        
    except ValueError:
        msg = bot.reply_to(message, "‚ùå ÿßŸÑÿ≥ÿπÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ±ŸÇŸÖÿßŸã! ÿ£ÿ±ÿ≥ŸÑ ÿßŸÑÿ≥ÿπÿ± ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ:")
        bot.register_next_step_handler(msg, process_product_price)

def process_product_category(message):
    user_id = message.from_user.id
    
    if message.text == '/cancel':
        temp_product_data.pop(user_id, None)
        return bot.reply_to(message, "‚ùå ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨", reply_markup=types.ReplyKeyboardRemove())
    
    valid_categories = ["ŸÜÿ™ŸÅŸÑŸÉÿ≥", "ÿ¥ÿßŸáÿØ", "ÿØŸäÿ≤ŸÜŸä ÿ®ŸÑÿ≥", "ÿßŸàÿ≥ŸÜ ÿ®ŸÑÿ≥", "ŸÅÿØŸäŸà ÿ®ÿ±ŸäŸÖŸäŸÖ", "ÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ÿ£ÿÆÿ±Ÿâ"]
    
    if message.text.strip() not in valid_categories:
        markup = types.ReplyKeyboardMarkup(row_width=2, one_time_keyboard=True, resize_keyboard=True)
        markup.add(
            types.KeyboardButton("ŸÜÿ™ŸÅŸÑŸÉÿ≥"),
            types.KeyboardButton("ÿ¥ÿßŸáÿØ"),
            types.KeyboardButton("ÿØŸäÿ≤ŸÜŸä ÿ®ŸÑÿ≥"),
            types.KeyboardButton("ÿßŸàÿ≥ŸÜ ÿ®ŸÑÿ≥"),
            types.KeyboardButton("ŸÅÿØŸäŸà ÿ®ÿ±ŸäŸÖŸäŸÖ"),
            types.KeyboardButton("ÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ÿ£ÿÆÿ±Ÿâ")
        )
        msg = bot.reply_to(message, "‚ùå ŸÅÿ¶ÿ© ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©! ÿßÿÆÿ™ÿ± ŸÖŸÜ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±:", reply_markup=markup)
        return bot.register_next_step_handler(msg, process_product_category)
    
    temp_product_data[user_id]['category'] = message.text.strip()
    bot.reply_to(message, f"‚úÖ ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÅÿ¶ÿ©: {message.text.strip()}", reply_markup=types.ReplyKeyboardRemove())
    
    msg = bot.send_message(message.chat.id, "üìù ÿ£ÿ±ÿ≥ŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ (ŸÖÿ´ŸÑ: ŸÖÿØÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿå ÿßŸÑŸÖŸÖŸäÿ≤ÿßÿ™ÿå ÿ•ŸÑÿÆ):")
    bot.register_next_step_handler(msg, process_product_details)

def process_product_details(message):
    user_id = message.from_user.id
    
    if message.text == '/cancel':
        temp_product_data.pop(user_id, None)
        return bot.reply_to(message, "‚ùå ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨")
    
    temp_product_data[user_id]['details'] = message.text.strip()
    bot.reply_to(message, "‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ")
    
    markup = types.ReplyKeyboardMarkup(row_width=1, one_time_keyboard=True, resize_keyboard=True)
    markup.add(types.KeyboardButton("ÿ™ÿÆÿ∑Ÿä"))
    
    msg = bot.send_message(message.chat.id, "üñºÔ∏è ÿ£ÿ±ÿ≥ŸÑ ÿ±ÿßÿ®ÿ∑ ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ (ÿ£Ÿà ÿßÿ∂ÿ∫ÿ∑ ÿ™ÿÆÿ∑Ÿä):", reply_markup=markup)
    bot.register_next_step_handler(msg, process_product_image)

def process_product_image(message):
    user_id = message.from_user.id
    
    if message.text == '/cancel':
        temp_product_data.pop(user_id, None)
        return bot.reply_to(message, "‚ùå ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨", reply_markup=types.ReplyKeyboardRemove())
    
    if message.text.strip() == "ÿ™ÿÆÿ∑Ÿä":
        temp_product_data[user_id]['image_url'] = "https://via.placeholder.com/300x200?text=No+Image"
        bot.reply_to(message, "‚è≠Ô∏è ÿ™ŸÖ ÿ™ÿÆÿ∑Ÿä ÿßŸÑÿµŸàÿ±ÿ©", reply_markup=types.ReplyKeyboardRemove())
    else:
        temp_product_data[user_id]['image_url'] = message.text.strip()
        bot.reply_to(message, "‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©", reply_markup=types.ReplyKeyboardRemove())
    
    msg = bot.send_message(message.chat.id, "üîê ÿ£ÿ±ÿ≥ŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿÆŸÅŸäÿ© (ÿßŸÑÿßŸäŸÖŸäŸÑ ŸàÿßŸÑÿ®ÿßÿ≥Ÿàÿ±ÿØ ŸÖÿ´ŸÑÿßŸã):")
    bot.register_next_step_handler(msg, process_product_hidden_data)

def process_product_hidden_data(message):
    user_id = message.from_user.id
    
    if message.text == '/cancel':
        temp_product_data.pop(user_id, None)
        return bot.reply_to(message, "‚ùå ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨")
    
    temp_product_data[user_id]['hidden_data'] = message.text.strip()
    bot.reply_to(message, "‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿÆŸÅŸäÿ©")
    
    # ÿ≥ÿ§ÿßŸÑ ÿπŸÜ ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
    markup = types.ReplyKeyboardMarkup(row_width=2, one_time_keyboard=True, resize_keyboard=True)
    markup.add(
        types.KeyboardButton("‚ö° ÿ™ÿ≥ŸÑŸäŸÖ ŸÅŸàÿ±Ÿä"),
        types.KeyboardButton("üë®‚Äçüíº ÿ™ÿ≥ŸÑŸäŸÖ ŸäÿØŸàŸä")
    )
    
    msg = bot.send_message(
        message.chat.id, 
        "üì¶ ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ:\n\n"
        "‚ö° **ÿ™ÿ≥ŸÑŸäŸÖ ŸÅŸàÿ±Ÿä**: Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÑŸÑŸÖÿ¥ÿ™ÿ±Ÿä\n"
        "üë®‚Äçüíº **ÿ™ÿ≥ŸÑŸäŸÖ ŸäÿØŸàŸä**: Ÿäÿ™ŸÖ ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ£ÿØŸÖŸÜ ŸÑÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ∑ŸÑÿ®",
        parse_mode="Markdown",
        reply_markup=markup
    )
    bot.register_next_step_handler(msg, process_product_delivery_type)

def process_product_delivery_type(message):
    user_id = message.from_user.id
    
    if message.text == '/cancel':
        temp_product_data.pop(user_id, None)
        return bot.reply_to(message, "‚ùå ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨", reply_markup=types.ReplyKeyboardRemove())
    
    if message.text == "‚ö° ÿ™ÿ≥ŸÑŸäŸÖ ŸÅŸàÿ±Ÿä":
        temp_product_data[user_id]['delivery_type'] = 'instant'
        delivery_display = "‚ö° ÿ™ÿ≥ŸÑŸäŸÖ ŸÅŸàÿ±Ÿä"
    elif message.text == "üë®‚Äçüíº ÿ™ÿ≥ŸÑŸäŸÖ ŸäÿØŸàŸä":
        temp_product_data[user_id]['delivery_type'] = 'manual'
        delivery_display = "üë®‚Äçüíº ÿ™ÿ≥ŸÑŸäŸÖ ŸäÿØŸàŸä"
    else:
        markup = types.ReplyKeyboardMarkup(row_width=2, one_time_keyboard=True, resize_keyboard=True)
        markup.add(
            types.KeyboardButton("‚ö° ÿ™ÿ≥ŸÑŸäŸÖ ŸÅŸàÿ±Ÿä"),
            types.KeyboardButton("üë®‚Äçüíº ÿ™ÿ≥ŸÑŸäŸÖ ŸäÿØŸàŸä")
        )
        msg = bot.reply_to(message, "‚ùå ÿßÿÆÿ™Ÿäÿßÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠! ÿßÿÆÿ™ÿ± ŸÖŸÜ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±:", reply_markup=markup)
        return bot.register_next_step_handler(msg, process_product_delivery_type)
    
    bot.reply_to(message, f"‚úÖ ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ: {delivery_display}", reply_markup=types.ReplyKeyboardRemove())
    
    # ÿπÿ±ÿ∂ ŸÖŸÑÿÆÿµ ÿßŸÑŸÖŸÜÿ™ÿ¨
    product = temp_product_data[user_id]
    summary = (
        "üì¶ **ŸÖŸÑÿÆÿµ ÿßŸÑŸÖŸÜÿ™ÿ¨:**\n\n"
        f"üìù ÿßŸÑÿßÿ≥ŸÖ: {product['item_name']}\n"
        f"üí∞ ÿßŸÑÿ≥ÿπÿ±: {product['price']} ÿ±ŸäÿßŸÑ\n"
        f"üè∑Ô∏è ÿßŸÑŸÅÿ¶ÿ©: {product['category']}\n"
        f"üìã ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ: {product['details']}\n"
        f"üñºÔ∏è ÿßŸÑÿµŸàÿ±ÿ©: {product['image_url']}\n"
        f"üîê ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: {product['hidden_data']}\n"
        f"üì¶ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ: {delivery_display}\n\n"
        "ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ÿü"
    )
    
    markup = types.ReplyKeyboardMarkup(row_width=2, one_time_keyboard=True, resize_keyboard=True)
    markup.add(
        types.KeyboardButton("‚úÖ ŸÖŸàÿßŸÅŸÇ"),
        types.KeyboardButton("‚ùå ÿ•ŸÑÿ∫ÿßÿ°")
    )
    
    msg = bot.send_message(message.chat.id, summary, parse_mode="Markdown", reply_markup=markup)
    bot.register_next_step_handler(msg, confirm_add_product)

def confirm_add_product(message):
    user_id = message.from_user.id
    
    if message.text == "‚úÖ ŸÖŸàÿßŸÅŸÇ":
        product = temp_product_data.get(user_id)
        
        if product:
            # ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨
            product_id = str(uuid.uuid4())  # ÿ±ŸÇŸÖ ŸÅÿ±ŸäÿØ ŸÑÿß Ÿäÿ™ŸÉÿ±ÿ±
            delivery_type = product.get('delivery_type', 'instant')
            item = {
                'id': product_id,
                'item_name': product['item_name'],
                'price': str(product['price']),
                'seller_id': str(ADMIN_ID),
                'seller_name': 'ÿßŸÑŸÖÿßŸÑŸÉ',
                'hidden_data': product['hidden_data'],
                'category': product['category'],
                'details': product['details'],
                'image_url': product['image_url'],
                'delivery_type': delivery_type,
                'sold': False
            }
            
            # ÿ≠ŸÅÿ∏ ŸÅŸä Firebase ÿ£ŸàŸÑÿßŸã
            try:
                db.collection('products').document(product_id).set({
                    'item_name': item['item_name'],
                    'price': float(product['price']),
                    'seller_id': str(ADMIN_ID),
                    'seller_name': 'ÿßŸÑŸÖÿßŸÑŸÉ',
                    'hidden_data': item['hidden_data'],
                    'category': item['category'],
                    'details': item['details'],
                    'image_url': item['image_url'],
                    'delivery_type': delivery_type,
                    'sold': False,
                    'created_at': firestore.SERVER_TIMESTAMP
                })
                print(f"‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÜÿ™ÿ¨ {product_id} ŸÅŸä Firebase")
            except Exception as e:
                print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÅŸä Firebase: {e}")
            
            # ÿ≠ŸÅÿ∏ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
            marketplace_items.append(item)
            
            delivery_display = "‚ö° ŸÅŸàÿ±Ÿä" if delivery_type == 'instant' else "üë®‚Äçüíº ŸäÿØŸàŸä"
            bot.reply_to(message,
                         f"‚úÖ **ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠!**\n\n"
                         f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {product['item_name']}\n"
                         f"üí∞ ÿßŸÑÿ≥ÿπÿ±: {product['price']} ÿ±ŸäÿßŸÑ\n"
                         f"üè∑Ô∏è ÿßŸÑŸÅÿ¶ÿ©: {product['category']}\n"
                         f"üì¶ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ: {delivery_display}\n"
                         f"üìä ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™: {len(marketplace_items)}",
                         parse_mode="Markdown",
                         reply_markup=types.ReplyKeyboardRemove())
        
        # ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ§ŸÇÿ™ÿ©
        temp_product_data.pop(user_id, None)
    else:
        bot.reply_to(message, "‚ùå ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨", reply_markup=types.ReplyKeyboardRemove())
        temp_product_data.pop(user_id, None)

@bot.message_handler(commands=['code'])
def get_verification_code(message):
    user_id = message.from_user.id
    user_name = message.from_user.first_name
    if message.from_user.last_name:
        user_name += ' ' + message.from_user.last_name
    
    # ÿ™ŸàŸÑŸäÿØ ŸÉŸàÿØ ÿ™ÿ≠ŸÇŸÇ
    code = generate_verification_code(user_id, user_name)
    
    bot.send_message(message.chat.id,
                     f"üîê **ŸÉŸàÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ:**\n\n"
                     f"`{code}`\n\n"
                     f"‚è±Ô∏è **ÿµÿßŸÑÿ≠ ŸÑŸÖÿØÿ© 10 ÿØŸÇÿßÿ¶ŸÇ**\n\n"
                     f"üí° **ÿÆÿ∑Ÿàÿßÿ™ ÿßŸÑÿØÿÆŸàŸÑ:**\n"
                     f"1Ô∏è‚É£ ÿßŸÅÿ™ÿ≠ ÿßŸÑŸÖŸàŸÇÿπ ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠\n"
                     f"2Ô∏è‚É£ ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± 'ÿ≠ÿ≥ÿßÿ®Ÿä'\n"
                     f"3Ô∏è‚É£ ÿ£ÿØÿÆŸÑ ÿßŸÑÿ¢ŸäÿØŸä ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ: `{user_id}`\n"
                     f"4Ô∏è‚É£ ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸàÿØ ÿ£ÿπŸÑÿßŸá\n\n"
                     f"‚ö†Ô∏è ŸÑÿß ÿ™ÿ¥ÿßÿ±ŸÉ Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ ŸÖÿπ ÿ£ÿ≠ÿØ!",
                     parse_mode="Markdown")

# ÿ£ŸÖÿ± ÿÆÿßÿµ ÿ®ÿßŸÑÿ¢ÿØŸÖŸÜ ŸÑÿ¥ÿ≠ŸÜ ÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
# ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ: /add ID AMOUNT
# ŸÖÿ´ÿßŸÑ: /add 123456789 50
@bot.message_handler(commands=['add'])
def add_funds(message):
    if message.from_user.id != ADMIN_ID:
        return bot.reply_to(message, "‚õî Ÿáÿ∞ÿß ÿßŸÑÿ£ŸÖÿ± ŸÑŸÑŸÖÿ¥ÿ±ŸÅ ŸÅŸÇÿ∑.")
    
    try:
        parts = message.text.split()
        target_id = parts[1]
        amount = float(parts[2])
        add_balance(target_id, amount)
        bot.reply_to(message, f"‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© {amount} ÿ±ŸäÿßŸÑ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ {target_id}")
        bot.send_message(target_id, f"üéâ ÿ™ŸÖ ÿ¥ÿ≠ŸÜ ÿ±ÿµŸäÿØŸÉ ÿ®ŸÖÿ®ŸÑÿ∫ {amount} ÿ±ŸäÿßŸÑ!")
    except:
        bot.reply_to(message, "ÿÆÿ∑ÿ£! ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ: /add ID AMOUNT")

# ÿ£ŸÖÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ/ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Callback URL ŸÅŸä EdfaPay
# ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ: /edfapay (ŸÑŸÑÿ™ÿ≠ŸÇŸÇ) ÿ£Ÿà /edfapay register (ŸÑŸÑÿ™ÿ≥ÿ¨ŸäŸÑ)
@bot.message_handler(commands=['edfapay'])
def edfapay_settings(message):
    """ÿ•ÿØÿßÿ±ÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ EdfaPay"""
    if message.from_user.id != ADMIN_ID:
        return bot.reply_to(message, "‚õî Ÿáÿ∞ÿß ÿßŸÑÿ£ŸÖÿ± ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑!")
    
    try:
        parts = message.text.split()
        action = parts[1] if len(parts) > 1 else "check"
        
        if action == "register":
            # ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÄ callback URL
            bot.reply_to(message, "‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≥ÿ¨ŸäŸÑ Callback URL ŸÅŸä EdfaPay...")
            
            callback_url = f"{SITE_URL}/payment/edfapay_webhook"
            
            response = requests.post(
                "https://api.edfapay.com/payment/merchants/callback-url",
                json={
                    "action": "post",
                    "id": EDFAPAY_MERCHANT_ID,
                    "url": callback_url
                },
                timeout=30
            )
            
            if response.status_code == 200:
                bot.send_message(
                    message.chat.id,
                    f"‚úÖ *ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ Callback URL ÿ®ŸÜÿ¨ÿßÿ≠!*\n\n"
                    f"üîó URL: `{callback_url}`\n\n"
                    f"üì° Response: `{response.text[:200]}`",
                    parse_mode="Markdown"
                )
            else:
                bot.send_message(
                    message.chat.id,
                    f"‚ùå *ŸÅÿ¥ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ Callback URL*\n\n"
                    f"üì° Status: {response.status_code}\n"
                    f"üì° Response: `{response.text[:200]}`",
                    parse_mode="Markdown"
                )
        else:
            # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÄ callback URL ÿßŸÑŸÖÿ≥ÿ¨ŸÑ
            bot.reply_to(message, "‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Callback URL...")
            
            response = requests.post(
                "https://api.edfapay.com/payment/merchants/callback-url",
                json={
                    "action": "get",
                    "id": EDFAPAY_MERCHANT_ID
                },
                timeout=30
            )
            
            # ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÜÿµ ŸÖŸÜ ÿßŸÑÿ±ŸÖŸàÿ≤ ÿßŸÑÿÆÿßÿµÿ©
            response_text = response.text[:300].replace('`', "'").replace('_', '-').replace('*', '')
            
            bot.send_message(
                message.chat.id,
                f"üì° ÿ≠ÿßŸÑÿ© EdfaPay Callback\n\n"
                f"üîë Merchant ID: {EDFAPAY_MERCHANT_ID}\n"
                f"üåê SITE_URL: {SITE_URL}\n\n"
                f"üì° Response ({response.status_code}):\n{response_text}\n\n"
                f"üí° ŸÑŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ£ÿ±ÿ≥ŸÑ: /edfapay register"
            )
            
    except Exception as e:
        bot.reply_to(message, f"‚ùå ÿÆÿ∑ÿ£: {e}")

# ÿ£ŸÖÿ± ÿ™ŸàŸÑŸäÿØ ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑÿ¥ÿ≠ŸÜ
# ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ: /ÿ™ŸàŸÑŸäÿØ AMOUNT [COUNT]
# ŸÖÿ´ÿßŸÑ: /ÿ™ŸàŸÑŸäÿØ 50 10  (ÿ™ŸàŸÑŸäÿØ 10 ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿ®ŸÇŸäŸÖÿ© 50 ÿ±ŸäÿßŸÑ ŸÑŸÉŸÑ ŸÖŸÜŸáÿß)
@bot.message_handler(commands=['ÿ™ŸàŸÑŸäÿØ'])
def generate_keys(message):
    if message.from_user.id != ADMIN_ID:
        return bot.reply_to(message, "‚õî Ÿáÿ∞ÿß ÿßŸÑÿ£ŸÖÿ± ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑!")
    
    try:
        parts = message.text.split()
        amount = float(parts[1])
        count = int(parts[2]) if len(parts) > 2 else 1
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿØŸàÿØ
        if count > 100:
            return bot.reply_to(message, "‚ùå ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 100 ŸÖŸÅÿ™ÿßÿ≠ ŸÅŸä ÿßŸÑŸÖÿ±ÿ© ÿßŸÑŸàÿßÿ≠ÿØÿ©!")
        
        if amount <= 0:
            return bot.reply_to(message, "‚ùå ÿßŸÑŸÖÿ®ŸÑÿ∫ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿµŸÅÿ±!")
        
        # ÿ™ŸàŸÑŸäÿØ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠
        generated_keys = []
        for i in range(count):
            # ÿ™ŸàŸÑŸäÿØ ŸÖŸÅÿ™ÿßÿ≠ ÿπÿ¥Ÿàÿßÿ¶Ÿä
            key_code = f"KEY-{random.randint(10000, 99999)}-{random.randint(1000, 9999)}"
            
            # ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
            charge_keys[key_code] = {
                'amount': amount,
                'used': False,
                'used_by': None,
                'created_at': time.time()
            }
            
            # ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
            try:
                db.collection('charge_keys').document(key_code).set({
                    'amount': float(amount),
                    'used': False,
                    'used_by': '',
                    'created_at': time.time()
                })
            except Exception as e:
                print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ŸÅŸä Firebase: {e}")
            
            generated_keys.append(key_code)
        
        # ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠
        if count == 1:
            response = (
                f"üéÅ **ÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿ®ŸÜÿ¨ÿßÿ≠!**\n\n"
                f"üí∞ ÿßŸÑŸÇŸäŸÖÿ©: {amount} ÿ±ŸäÿßŸÑ\n"
                f"üîë ÿßŸÑŸÖŸÅÿ™ÿßÿ≠:\n"
                f"`{generated_keys[0]}`\n\n"
                f"üìù ŸäŸÖŸÉŸÜ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¥ÿ≠ŸÜŸá ÿ®ÿ•ÿ±ÿ≥ÿßŸÑ: /ÿ¥ÿ≠ŸÜ {generated_keys[0]}"
            )
        else:
            keys_text = "\n".join([f"`{key}`" for key in generated_keys])
            response = (
                f"üéÅ **ÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ {count} ŸÖŸÅÿ™ÿßÿ≠ ÿ®ŸÜÿ¨ÿßÿ≠!**\n\n"
                f"üí∞ ŸÇŸäŸÖÿ© ŸÉŸÑ ŸÖŸÅÿ™ÿßÿ≠: {amount} ÿ±ŸäÿßŸÑ\n"
                f"üíµ ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÉŸÑŸä: {amount * count} ÿ±ŸäÿßŸÑ\n\n"
                f"üîë ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠:\n{keys_text}\n\n"
                f"üìù ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ: /ÿ¥ÿ≠ŸÜ [ÿßŸÑŸÖŸÅÿ™ÿßÿ≠]"
            )
        
        bot.reply_to(message, response, parse_mode="Markdown")
        
    except IndexError:
        bot.reply_to(message, 
                     "‚ùå **ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ!**\n\n"
                     "üìù ÿßŸÑÿµŸäÿ∫ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©:\n"
                     "`/ÿ™ŸàŸÑŸäÿØ [ÿßŸÑŸÖÿ®ŸÑÿ∫] [ÿßŸÑÿπÿØÿØ]`\n\n"
                     "**ÿ£ŸÖÿ´ŸÑÿ©:**\n"
                     "‚Ä¢ `/ÿ™ŸàŸÑŸäÿØ 50` - ŸÖŸÅÿ™ÿßÿ≠ Ÿàÿßÿ≠ÿØ ÿ®ŸÇŸäŸÖÿ© 50 ÿ±ŸäÿßŸÑ\n"
                     "‚Ä¢ `/ÿ™ŸàŸÑŸäÿØ 100 5` - 5 ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿ®ŸÇŸäŸÖÿ© 100 ÿ±ŸäÿßŸÑ ŸÑŸÉŸÑ ŸÖŸÜŸáÿß\n"
                     "‚Ä¢ `/ÿ™ŸàŸÑŸäÿØ 25 10` - 10 ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿ®ŸÇŸäŸÖÿ© 25 ÿ±ŸäÿßŸÑ ŸÑŸÉŸÑ ŸÖŸÜŸáÿß",
                     parse_mode="Markdown")
    except ValueError:
        bot.reply_to(message, "‚ùå ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ£ÿ±ŸÇÿßŸÖ ÿµÿ≠Ÿäÿ≠ÿ©!")

# ÿ£ŸÖÿ± ÿ¥ÿ≠ŸÜ ÿßŸÑÿ±ÿµŸäÿØ (ŸäŸÅÿ™ÿ≠ ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ¥ÿ≠ŸÜ)
@bot.message_handler(commands=['ÿ¥ÿ≠ŸÜ'])
def recharge_balance(message):
    """ÿ£ŸÖÿ± ÿ¥ÿ≠ŸÜ ÿßŸÑÿ±ÿµŸäÿØ - Ÿäÿπÿ±ÿ∂ ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ¥ÿ≠ŸÜ"""
    try:
        user_id = str(message.from_user.id)
        
        # ÿ•ŸÜÿ¥ÿßÿ° ÿ£ÿ≤ÿ±ÿßÿ± ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ¥ÿ≠ŸÜ
        markup = types.InlineKeyboardMarkup(row_width=2)
        btn_payment = types.InlineKeyboardButton("üí≥ ÿ¥ÿ≠ŸÜ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä", callback_data="recharge_payment")
        btn_code = types.InlineKeyboardButton("üîë ÿ¥ÿ≠ŸÜ ÿ®ŸÉŸàÿØ", callback_data="recharge_code")
        markup.add(btn_payment)
        markup.add(btn_code)
        
        bot.send_message(
            message.chat.id,
            "üí∞ *ÿ¥ÿ≠ŸÜ ÿßŸÑÿ±ÿµŸäÿØ*\n\n"
            "ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ¥ÿ≠ŸÜ:\n\n"
            "üí≥ *ÿ¥ÿ≠ŸÜ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä* - ÿßŸÑÿØŸÅÿπ ÿπÿ®ÿ± ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿØŸÅÿπ\n"
            "üîë *ÿ¥ÿ≠ŸÜ ÿ®ŸÉŸàÿØ* - ÿ•ÿ∞ÿß ŸÑÿØŸäŸÉ ŸÉŸàÿØ ÿ¥ÿ≠ŸÜ",
            reply_markup=markup,
            parse_mode="Markdown"
        )
    except Exception as e:
        bot.reply_to(message, f"‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: {str(e)}")

# ŸÖÿπÿßŸÑÿ¨ ÿ≤ÿ± ÿ¥ÿ≠ŸÜ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä
@bot.callback_query_handler(func=lambda call: call.data == "recharge_payment")
def handle_recharge_payment(call):
    """ÿ∑ŸÑÿ® ÿ•ÿØÿÆÿßŸÑ ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ¥ÿ≠ŸÜ"""
    try:
        user_id = str(call.from_user.id)
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿØŸÅÿπ EdfaPay
        if not EDFAPAY_MERCHANT_ID or not EDFAPAY_PASSWORD:
            bot.answer_callback_query(call.id, "‚ùå ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿØŸÅÿπ ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ© ÿ≠ÿßŸÑŸäÿßŸã")
            return bot.send_message(
                call.message.chat.id,
                "‚ùå *ÿπÿ∞ÿ±ÿßŸãÿå ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿØŸÅÿπ ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ© ÿ≠ÿßŸÑŸäÿßŸã*\n\n"
                "ŸäŸÖŸÉŸÜŸÉ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ£ŸÉŸàÿßÿØ ÿßŸÑÿ¥ÿ≠ŸÜ ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿ∞ŸÑŸÉ.",
                parse_mode="Markdown"
            )
        
        # ÿ™ÿπŸäŸäŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ®ŸÑÿ∫
        user_states[user_id] = {
            'state': 'waiting_recharge_amount',
            'created_at': time.time()
        }
        
        bot.answer_callback_query(call.id)
        
        # ÿ•ŸÜÿ¥ÿßÿ° ÿ≤ÿ± ÿ•ŸÑÿ∫ÿßÿ°
        markup = types.InlineKeyboardMarkup()
        btn_cancel = types.InlineKeyboardButton("‚ùå ÿ•ŸÑÿ∫ÿßÿ°", callback_data="cancel_recharge")
        markup.add(btn_cancel)
        
        bot.send_message(
            call.message.chat.id,
            "üí≥ *ÿ¥ÿ≠ŸÜ ÿ±ÿµŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä*\n\n"
            "üíµ ÿ£ÿØÿÆŸÑ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ∞Ÿä ÿ™ÿ±ŸäÿØ ÿ¥ÿ≠ŸÜŸá ÿ®ÿßŸÑÿ±ŸäÿßŸÑ:\n\n"
            "üìå *ŸÖÿ´ÿßŸÑ:* `50` ÿ£Ÿà `100`\n\n"
            "‚ö†Ô∏è ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ: 10 ÿ±ŸäÿßŸÑ\n"
            "‚ö†Ô∏è ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ: 1000 ÿ±ŸäÿßŸÑ",
            reply_markup=markup,
            parse_mode="Markdown"
        )
    except Exception as e:
        bot.answer_callback_query(call.id, "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£!")
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä handle_recharge_payment: {e}")

# ŸÖÿπÿßŸÑÿ¨ ÿ≤ÿ± ÿ¥ÿ≠ŸÜ ÿ®ŸÉŸàÿØ
@bot.callback_query_handler(func=lambda call: call.data == "recharge_code")
def handle_recharge_code(call):
    """ÿ∑ŸÑÿ® ÿ•ÿØÿÆÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ¥ÿ≠ŸÜ"""
    try:
        user_id = str(call.from_user.id)
        
        # ÿ™ÿπŸäŸäŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÉŸàÿØ
        user_states[user_id] = {
            'state': 'waiting_recharge_code',
            'created_at': time.time()
        }
        
        bot.answer_callback_query(call.id)
        
        # ÿ•ŸÜÿ¥ÿßÿ° ÿ≤ÿ± ÿ•ŸÑÿ∫ÿßÿ°
        markup = types.InlineKeyboardMarkup()
        btn_cancel = types.InlineKeyboardButton("‚ùå ÿ•ŸÑÿ∫ÿßÿ°", callback_data="cancel_recharge")
        markup.add(btn_cancel)
        
        bot.send_message(
            call.message.chat.id,
            "üîë *ÿ¥ÿ≠ŸÜ ÿ®ŸÉŸàÿØ*\n\n"
            "üìù ÿ£ÿ±ÿ≥ŸÑ ŸÉŸàÿØ ÿßŸÑÿ¥ÿ≠ŸÜ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ:\n\n"
            "üìå *ŸÖÿ´ÿßŸÑ:* `KEY-XXXXX-XXXXX`",
            reply_markup=markup,
            parse_mode="Markdown"
        )
    except Exception as e:
        bot.answer_callback_query(call.id, "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£!")
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä handle_recharge_code: {e}")

# ŸÖÿπÿßŸÑÿ¨ ÿ≤ÿ± ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ¥ÿ≠ŸÜ
@bot.callback_query_handler(func=lambda call: call.data == "cancel_recharge")
def handle_cancel_recharge(call):
    """ÿ•ŸÑÿ∫ÿßÿ° ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ¥ÿ≠ŸÜ"""
    try:
        user_id = str(call.from_user.id)
        
        # ÿ•ÿ≤ÿßŸÑÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        if user_id in user_states:
            del user_states[user_id]
        
        bot.answer_callback_query(call.id, "ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°")
        bot.send_message(
            call.message.chat.id,
            "‚ùå ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ¥ÿ≠ŸÜ.\n\n"
            "ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ®ÿØÿ° ŸÖŸÜ ÿ¨ÿØŸäÿØ ÿ®ÿ•ÿ±ÿ≥ÿßŸÑ /ÿ¥ÿ≠ŸÜ",
            parse_mode="Markdown"
        )
    except Exception as e:
        bot.answer_callback_query(call.id, "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£!")

# ÿØÿßŸÑÿ© ÿ•ŸÜÿ¥ÿßÿ° ŸÅÿßÿ™Ÿàÿ±ÿ© ÿØŸÅÿπ ŸÖŸÜ EdfaPay
def create_edfapay_invoice(user_id, amount, user_name):
    """ÿ•ŸÜÿ¥ÿßÿ° ŸÅÿßÿ™Ÿàÿ±ÿ© ÿØŸÅÿπ ŸÅŸä EdfaPay"""
    try:
        # ÿ™ŸàŸÑŸäÿØ ŸÖÿπÿ±ŸÅ ŸÅÿ±ŸäÿØ ŸÑŸÑÿ∑ŸÑÿ®
        order_id = f"TR{user_id}{int(time.time())}"
        order_description = f"Recharge {amount} SAR"
        
        # ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÄ Hash
        # Formula: hash = SHA1(MD5(UPPERCASE(order_id + order_amount + order_currency + order_description + merchant_password)))
        to_hash = f"{order_id}{amount}SAR{order_description}{EDFAPAY_PASSWORD}".upper()
        md5_hash = hashlib.md5(to_hash.encode()).hexdigest()
        final_hash = hashlib.sha1(md5_hash.encode()).hexdigest()
        
        # ÿ¨ŸÑÿ® IP ÿßŸÑÿπŸÖŸäŸÑ (ŸÜÿ≥ÿ™ÿÆÿØŸÖ ŸÇŸäŸÖÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©)
        payer_ip = "176.44.76.222"
        
        # ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÑÿ® ŸÑŸÄ EdfaPay API (multipart/form-data)
        payload = {
            'action': 'SALE',
            'edfa_merchant_id': EDFAPAY_MERCHANT_ID,
            'order_id': order_id,
            'order_amount': str(amount),
            'order_currency': 'SAR',
            'order_description': order_description,
            'req_token': 'N',
            'payer_first_name': user_name or 'Customer',
            'payer_last_name': 'User',
            'payer_address': 'Riyadh',
            'payer_country': 'SA',
            'payer_city': 'Riyadh',
            'payer_zip': '12221',
            'payer_email': f'user{user_id}@telegram.com',
            'payer_phone': '966500000000',
            'payer_ip': payer_ip,
            'term_url_3ds': f"{SITE_URL}/payment/success?order_id={order_id}",
            'auth': 'N',
            'recurring_init': 'N',
            'hash': final_hash
        }
        
        print(f"üì§ EdfaPay Request: {payload}")
        
        # ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ® (multipart/form-data)
        # ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ API ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨
        api_url = "https://api.edfapay.com/payment/initiate"
        
        response = requests.post(api_url, data=payload, timeout=30)
        print(f"üì§ EdfaPay Response Status: {response.status_code}")
        print(f"üì§ EdfaPay Response: {response.text[:500]}")
        
        result = response.json()
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÜÿ¨ÿßÿ≠
        if response.status_code == 200 and result.get('redirect_url'):
            payment_url = result.get('redirect_url')
            
            # ÿ≠ŸÅÿ∏ ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑŸÖÿπŸÑŸÇ
            pending_payments[order_id] = {
                'user_id': user_id,
                'amount': amount,
                'order_id': order_id,
                'status': 'pending',
                'created_at': time.time()
            }
            
            # ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
            try:
                db.collection('pending_payments').document(order_id).set({
                    'user_id': user_id,
                    'amount': amount,
                    'order_id': order_id,
                    'status': 'pending',
                    'created_at': firestore.SERVER_TIMESTAMP
                })
            except Exception as e:
                print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ∑ŸÑÿ® ŸÅŸä Firebase: {e}")
            
            return {
                'success': True,
                'payment_url': payment_url,
                'invoice_id': order_id
            }
        else:
            error_msg = result.get('message') or result.get('error') or result.get('errors') or result
            print(f"‚ùå EdfaPay Error: {error_msg}")
            return {
                'success': False,
                'error': str(error_msg)
            }
            
    except requests.exceptions.Timeout:
        return {'success': False, 'error': 'ÿßŸÜÿ™Ÿáÿ™ ŸÖŸáŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ'}
    except requests.exceptions.RequestException as e:
        return {'success': False, 'error': f'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ: {str(e)}'}
    except Exception as e:
        print(f"‚ùå Exception in create_edfapay_invoice: {e}")
        import traceback
        traceback.print_exc()
        return {'success': False, 'error': str(e)}

# ŸÖÿπÿßŸÑÿ¨ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑŸÜÿµŸäÿ© (ŸÑŸÑŸÖÿ®ÿßŸÑÿ∫ ŸàÿßŸÑÿ£ŸÉŸàÿßÿØ)
@bot.message_handler(func=lambda message: str(message.from_user.id) in user_states)
def handle_user_state_message(message):
    """ŸÖÿπÿßŸÑÿ¨ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿ≠ÿ≥ÿ® ÿ≠ÿßŸÑÿ™ŸáŸÖ"""
    try:
        user_id = str(message.from_user.id)
        state_data = user_states.get(user_id)
        
        if not state_data:
            return
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ≠ÿßŸÑÿ© (10 ÿØŸÇÿßÿ¶ŸÇ)
        if time.time() - state_data.get('created_at', 0) > 600:
            del user_states[user_id]
            return bot.reply_to(message, "‚è± ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿπŸÖŸÑŸäÿ©. ÿ£ÿ±ÿ≥ŸÑ /ÿ¥ÿ≠ŸÜ ŸÑŸÑÿ®ÿØÿ° ŸÖŸÜ ÿ¨ÿØŸäÿØ")
        
        state = state_data.get('state')
        
        # === ÿ≠ÿßŸÑÿ© ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ¥ÿ≠ŸÜ ===
        if state == 'waiting_recharge_amount':
            text = message.text.strip()
            
            # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿØÿÆŸÑ ÿ±ŸÇŸÖ
            try:
                amount = float(text)
            except ValueError:
                return bot.reply_to(message, "‚ùå ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿµÿ≠Ÿäÿ≠ ŸÅŸÇÿ∑ (ŸÖÿ´ÿßŸÑ: 50)")
            
            # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿØŸàÿØ
            if amount < 10:
                return bot.reply_to(message, "‚ùå ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑÿ¥ÿ≠ŸÜ ŸáŸà 10 ÿ±ŸäÿßŸÑ")
            if amount > 1000:
                return bot.reply_to(message, "‚ùå ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑŸÑÿ¥ÿ≠ŸÜ ŸáŸà 1000 ÿ±ŸäÿßŸÑ")
            
            # ÿ•ÿ≤ÿßŸÑÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            del user_states[user_id]
            
            # ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÜÿ™ÿ∏ÿßÿ±
            wait_msg = bot.reply_to(message, "‚è≥ ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿØŸÅÿπ...")
            
            # ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
            user_name = message.from_user.first_name
            result = create_edfapay_invoice(user_id, amount, user_name)
            
            if result['success']:
                # ÿ•ŸÜÿ¥ÿßÿ° ÿ≤ÿ± ŸÑŸÑÿØŸÅÿπ
                markup = types.InlineKeyboardMarkup()
                btn_pay = types.InlineKeyboardButton("üí≥ ÿßÿØŸÅÿπ ÿßŸÑÿ¢ŸÜ", url=result['payment_url'])
                markup.add(btn_pay)
                
                bot.edit_message_text(
                    f"‚úÖ *ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ∑ŸÑÿ® ÿßŸÑÿ¥ÿ≠ŸÜ!*\n\n"
                    f"üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫: {amount} ÿ±ŸäÿßŸÑ\n"
                    f"üìã ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: `{result['invoice_id']}`\n\n"
                    f"üëá ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑÿ≤ÿ± ÿ£ÿØŸÜÿßŸá ŸÑŸÑÿØŸÅÿπ:\n\n"
                    f"‚ö†Ô∏è ÿ®ÿπÿØ ÿßŸÑÿØŸÅÿπ ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ±ÿµŸäÿØ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã",
                    chat_id=wait_msg.chat.id,
                    message_id=wait_msg.message_id,
                    reply_markup=markup,
                    parse_mode="Markdown"
                )
                
                # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿßŸÑŸÉ
                try:
                    bot.send_message(ADMIN_ID,
                        f"üîî *ÿ∑ŸÑÿ® ÿ¥ÿ≠ŸÜ ÿ¨ÿØŸäÿØ*\n\n"
                        f"üë§ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: {user_name}\n"
                        f"üÜî ÿßŸÑÿ¢ŸäÿØŸä: {user_id}\n"
                        f"üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫: {amount} ÿ±ŸäÿßŸÑ\n"
                        f"üìã ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: `{result['invoice_id']}`",
                        parse_mode="Markdown"
                    )
                except:
                    pass
            else:
                bot.edit_message_text(
                    f"‚ùå *ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿ∑ŸÑÿ® ÿßŸÑÿØŸÅÿπ*\n\n"
                    f"ÿßŸÑÿ≥ÿ®ÿ®: {result['error']}\n\n"
                    f"ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ŸÑÿßÿ≠ŸÇÿßŸã ÿ£Ÿà ÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿØÿπŸÖ",
                    chat_id=wait_msg.chat.id,
                    message_id=wait_msg.message_id,
                    parse_mode="Markdown"
                )
        
        # === ÿ≠ÿßŸÑÿ© ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÉŸàÿØ ÿßŸÑÿ¥ÿ≠ŸÜ ===
        elif state == 'waiting_recharge_code':
            key_code = message.text.strip()
            user_name = message.from_user.first_name
            
            # ÿ•ÿ≤ÿßŸÑÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            del user_states[user_id]
            
            # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠
            if key_code not in charge_keys:
                return bot.reply_to(message, "‚ùå ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ ÿ£Ÿà ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©!")
            
            key_data = charge_keys[key_code]
            
            # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠
            if key_data['used']:
                return bot.reply_to(message, 
                    f"‚ùå Ÿáÿ∞ÿß ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸá ÿ®ÿßŸÑŸÅÿπŸÑ!\n\n"
                    f"üë§ ÿßÿ≥ÿ™ÿÆÿØŸÖŸá: {key_data.get('used_by', 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ')}")
            
            # ÿ¥ÿ≠ŸÜ ÿßŸÑÿ±ÿµŸäÿØ
            amount = key_data['amount']
            add_balance(user_id, amount)
            
            # ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖŸÅÿ™ÿßÿ≠
            charge_keys[key_code]['used'] = True
            charge_keys[key_code]['used_by'] = user_name
            charge_keys[key_code]['used_at'] = time.time()
            
            # ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase
            try:
                db.collection('charge_keys').document(key_code).update({
                    'used': True,
                    'used_by': user_name,
                    'used_at': time.time()
                })
            except Exception as e:
                print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ŸÅŸä Firebase: {e}")
            
            # ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠
            bot.reply_to(message,
                f"‚úÖ *ÿ™ŸÖ ÿ¥ÿ≠ŸÜ ÿ±ÿµŸäÿØŸÉ ÿ®ŸÜÿ¨ÿßÿ≠!*\n\n"
                f"üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ∂ÿßŸÅ: {amount} ÿ±ŸäÿßŸÑ\n"
                f"üíµ ÿ±ÿµŸäÿØŸÉ ÿßŸÑÿ≠ÿßŸÑŸä: {get_balance(user_id)} ÿ±ŸäÿßŸÑ\n\n"
                f"üéâ ÿßÿ≥ÿ™ŸÖÿ™ÿπ ÿ®ÿßŸÑÿ™ÿ≥ŸàŸÇ!",
                parse_mode="Markdown"
            )
            
            # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿßŸÑŸÉ
            try:
                bot.send_message(ADMIN_ID,
                    f"üîî *ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖŸÅÿ™ÿßÿ≠ ÿ¥ÿ≠ŸÜ*\n\n"
                    f"üë§ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: {user_name}\n"
                    f"üÜî ÿßŸÑÿ¢ŸäÿØŸä: {user_id}\n"
                    f"üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫: {amount} ÿ±ŸäÿßŸÑ\n"
                    f"üîë ÿßŸÑŸÖŸÅÿ™ÿßÿ≠: `{key_code}`",
                    parse_mode="Markdown"
                )
            except:
                pass
        
        # === ÿ≠ÿßŸÑÿ© ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ===
        elif state == 'waiting_invoice_amount':
            text = message.text.strip()
            merchant_name = state_data.get('merchant_name', message.from_user.first_name)
            
            # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿØÿÆŸÑ ÿ±ŸÇŸÖ
            try:
                amount = float(text)
            except ValueError:
                return bot.reply_to(message, "‚ùå ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿµÿ≠Ÿäÿ≠ ŸÅŸÇÿ∑ (ŸÖÿ´ÿßŸÑ: 100)")
            
            # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿØŸàÿØ
            if amount < 1:
                return bot.reply_to(message, "‚ùå ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸáŸà 1 ÿ±ŸäÿßŸÑ")
            if amount > 10000:
                return bot.reply_to(message, "‚ùå ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸáŸà 10,000 ÿ±ŸäÿßŸÑ")
            
            # ÿ•ÿ≤ÿßŸÑÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            del user_states[user_id]
            
            # ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿπÿ±ŸÅ ŸÅÿ±ŸäÿØ ŸÑŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
            invoice_id = generate_invoice_id()
            invoice_url = f"{SITE_URL}/invoice/{invoice_id}"
            
            # ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑŸÖÿπŸÑŸÇÿ© (ÿ®ÿØŸàŸÜ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ÿ®ÿπÿØ)
            merchant_invoices[invoice_id] = {
                'invoice_id': invoice_id,
                'merchant_id': user_id,
                'merchant_name': merchant_name,
                'amount': amount,
                'customer_phone': None,
                'status': 'waiting_payment',
                'created_at': time.time()
            }
            
            # ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
            try:
                db.collection('merchant_invoices').document(invoice_id).set({
                    'invoice_id': invoice_id,
                    'merchant_id': user_id,
                    'merchant_name': merchant_name,
                    'amount': amount,
                    'customer_phone': None,
                    'status': 'waiting_payment',
                    'created_at': firestore.SERVER_TIMESTAMP
                })
            except Exception as e:
                print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©: {e}")
            
            # ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÑŸÑÿ™ÿßÿ¨ÿ±
            bot.send_message(
                message.chat.id,
                f"‚úÖ *ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!*\n\n"
                f"üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫: {amount} ÿ±ŸäÿßŸÑ\n"
                f"üÜî ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©: `{invoice_id}`\n\n"
                f"üîó *ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:*\n`{invoice_url}`\n\n"
                f"üì§ ÿ£ÿ±ÿ≥ŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÑŸÑÿπŸÖŸäŸÑ ŸÑŸÑÿØŸÅÿπ",
                parse_mode="Markdown"
            )
                
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä handle_user_state_message: {e}")

# ÿ£ŸÖÿ± ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑŸÜÿ¥ÿ∑ÿ© (ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑)
@bot.message_handler(commands=['ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠'])
def list_keys(message):
    if message.from_user.id != ADMIN_ID:
        return bot.reply_to(message, "‚õî Ÿáÿ∞ÿß ÿßŸÑÿ£ŸÖÿ± ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑!")
    
    active_keys = [k for k, v in charge_keys.items() if not v['used']]
    used_keys = [k for k, v in charge_keys.items() if v['used']]
    
    if not charge_keys:
        return bot.reply_to(message, "üì≠ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÅÿßÿ™Ÿäÿ≠ ŸÖÿ≠ŸÅŸàÿ∏ÿ©!")
    
    response = f"üìä **ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠**\n\n"
    response += f"‚úÖ ŸÖŸÅÿßÿ™Ÿäÿ≠ ŸÜÿ¥ÿ∑ÿ©: {len(active_keys)}\n"
    response += f"üö´ ŸÖŸÅÿßÿ™Ÿäÿ≠ ŸÖÿ≥ÿ™ÿÆÿØŸÖÿ©: {len(used_keys)}\n"
    response += f"üìà ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: {len(charge_keys)}\n\n"
    
    if active_keys:
        total_value = sum([charge_keys[k]['amount'] for k in active_keys])
        response += f"üí∞ ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ© ŸÑŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑŸÜÿ¥ÿ∑ÿ©: {total_value} ÿ±ŸäÿßŸÑ"
    
    bot.reply_to(message, response, parse_mode="Markdown")

@bot.message_handler(commands=['web'])
def open_web_app(message):
    bot.send_message(message.chat.id, 
                     f"üè™ **ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä ÿßŸÑÿ≥ŸàŸÇ!**\n\n"
                     f"ÿßŸÅÿ™ÿ≠ ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ™ÿßŸÑŸä ŸÅŸä ŸÖÿ™ÿµŸÅÿ≠ŸÉ ŸÑÿ™ÿµŸÅÿ≠ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™:\n\n"
                     f"üîó {SITE_URL}\n\n"
                     f"üí° **ŸÜÿµŸäÿ≠ÿ©:** ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸàÿßŸÅÿ™ÿ≠Ÿá ŸÅŸä ŸÖÿ™ÿµŸÅÿ≠ ÿÆÿßÿ±ÿ¨Ÿä (Chrome/Safari) "
                     f"ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ£ŸÅÿ∂ŸÑ ÿ™ÿ¨ÿ±ÿ®ÿ©!",
                     parse_mode="Markdown")

# ============ ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ŸÑŸÑÿ™ÿ¨ÿßÿ± ============

@bot.message_handler(commands=['ŸÅÿßÿ™Ÿàÿ±ÿ©'])
def create_invoice_command(message):
    """ÿ£ŸÖÿ± ÿ•ŸÜÿ¥ÿßÿ° ŸÅÿßÿ™Ÿàÿ±ÿ© ŸÑŸÑÿπŸÖŸäŸÑ"""
    user_id = str(message.from_user.id)
    user_name = message.from_user.first_name
    
    # ÿ™ÿπŸäŸäŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ•ÿØÿÆÿßŸÑ ŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
    user_states[user_id] = {
        'state': 'waiting_invoice_amount',
        'created_at': time.time(),
        'merchant_name': user_name
    }
    
    # ÿ•ŸÜÿ¥ÿßÿ° ÿ≤ÿ± ÿ•ŸÑÿ∫ÿßÿ°
    markup = types.InlineKeyboardMarkup()
    btn_cancel = types.InlineKeyboardButton("‚ùå ÿ•ŸÑÿ∫ÿßÿ°", callback_data="cancel_invoice")
    markup.add(btn_cancel)
    
    bot.send_message(
        message.chat.id,
        "üßæ *ÿ•ŸÜÿ¥ÿßÿ° ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ¨ÿØŸäÿØÿ©*\n\n"
        "üí∞ ÿ£ÿØÿÆŸÑ ŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ®ÿßŸÑÿ±ŸäÿßŸÑ:\n\n"
        "_ŸÖÿ´ÿßŸÑ: 100_",
        parse_mode="Markdown",
        reply_markup=markup
    )

@bot.callback_query_handler(func=lambda call: call.data == "cancel_invoice")
def handle_cancel_invoice(call):
    """ÿ•ŸÑÿ∫ÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©"""
    user_id = str(call.from_user.id)
    
    if user_id in user_states:
        del user_states[user_id]
    
    bot.answer_callback_query(call.id, "ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°")
    bot.edit_message_text(
        "‚ùå ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©.",
        chat_id=call.message.chat.id,
        message_id=call.message.message_id
    )

def generate_invoice_id():
    """ÿ™ŸàŸÑŸäÿØ ŸÖÿπÿ±ŸÅ ŸÇÿµŸäÿ± ŸàŸÅÿ±ŸäÿØ ŸÑŸÑŸÅÿßÿ™Ÿàÿ±ÿ©"""
    chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'
    return ''.join(random.choice(chars) for _ in range(6))

def create_customer_invoice(merchant_id, merchant_name, amount, customer_phone, original_invoice_id=None):
    """ÿ•ŸÜÿ¥ÿßÿ° ŸÅÿßÿ™Ÿàÿ±ÿ© ÿØŸÅÿπ ŸÑŸÑÿπŸÖŸäŸÑ Ÿàÿ•ÿ±ÿ≥ÿßŸÑŸáÿß ŸÑŸÄ EdfaPay"""
    try:
        # ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ£ÿµŸÑŸä ÿ£Ÿà ÿ™ŸàŸÑŸäÿØ ÿ¨ÿØŸäÿØ
        invoice_id = original_invoice_id or f"INV{generate_invoice_id()}"
        order_id = f"{invoice_id}{int(time.time())}"
        order_description = f"Invoice {invoice_id} - {amount} SAR"
        
        # ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÄ Hash
        to_hash = f"{order_id}{amount}SAR{order_description}{EDFAPAY_PASSWORD}".upper()
        md5_hash = hashlib.md5(to_hash.encode()).hexdigest()
        final_hash = hashlib.sha1(md5_hash.encode()).hexdigest()
        
        # ÿ™ŸÜÿ∏ŸäŸÅ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ (ÿßŸÑÿ±ŸÇŸÖ Ÿäÿ£ÿ™Ÿä ŸÉÿßŸÖŸÑÿßŸã ŸÖÿπ ÿ±ŸÖÿ≤ ÿßŸÑÿØŸàŸÑÿ© ŸÖŸÜ ÿßŸÑÿµŸÅÿ≠ÿ©)
        phone = customer_phone.strip()
        # ÿ•ÿ≤ÿßŸÑÿ© + ÿ•ŸÜ Ÿàÿ¨ÿØÿ™
        phone = phone.replace('+', '')
        # ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™
        phone = phone.replace(' ', '')
        # ÿ•ÿ∞ÿß ÿ®ÿØÿ£ ÿ®ÿµŸÅÿ±ÿå ÿ£ÿ∂ŸÅ 966 (ŸÑŸÑÿ™ŸàÿßŸÅŸÇ ŸÖÿπ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸÇÿØŸäŸÖÿ©)
        if phone.startswith('0'):
            phone = '966' + phone[1:]
        
        # ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÑÿ®
        payload = {
            'action': 'SALE',
            'edfa_merchant_id': EDFAPAY_MERCHANT_ID,
            'order_id': order_id,
            'order_amount': str(amount),
            'order_currency': 'SAR',
            'order_description': order_description,
            'req_token': 'N',
            'payer_first_name': 'Customer',
            'payer_last_name': 'User',
            'payer_address': 'Saudi Arabia',
            'payer_country': 'SA',
            'payer_city': 'Riyadh',
            'payer_zip': '12221',
            'payer_email': f'customer{int(time.time())}@invoice.com',
            'payer_phone': phone,
            'payer_ip': '176.44.76.222',
            'term_url_3ds': f"{SITE_URL}/payment/success?order_id={order_id}&invoice={invoice_id}",
            'auth': 'N',
            'recurring_init': 'N',
            'hash': final_hash
        }
        
        print(f"üì§ EdfaPay Invoice Request: {payload}")
        
        response = requests.post(EDFAPAY_API_URL, data=payload, timeout=30)
        print(f"üì§ EdfaPay Response: {response.status_code} - {response.text[:500]}")
        
        result = response.json()
        
        if response.status_code == 200 and result.get('redirect_url'):
            payment_url = result.get('redirect_url')
            
            # ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© (ÿµŸÑÿßÿ≠Ÿäÿ© ÿ≥ÿßÿπÿ© Ÿàÿßÿ≠ÿØÿ©)
            expires_at = time.time() + 3600  # ÿ≥ÿßÿπÿ© Ÿàÿßÿ≠ÿØÿ©
            merchant_invoices[invoice_id] = {
                'invoice_id': invoice_id,
                'order_id': order_id,
                'merchant_id': merchant_id,
                'merchant_name': merchant_name,
                'amount': amount,
                'customer_phone': phone,
                'status': 'pending',
                'created_at': time.time(),
                'expires_at': expires_at
            }
            
            # ÿ≠ŸÅÿ∏ ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑŸÖÿπŸÑŸÇ (ŸÑÿ±ÿ®ÿ∑Ÿá ÿ®ÿßŸÑŸÄ webhook)
            pending_payments[order_id] = {
                'user_id': merchant_id,  # ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ±ÿµŸäÿØ ŸÑŸÑÿ™ÿßÿ¨ÿ±
                'amount': amount,
                'order_id': order_id,
                'invoice_id': invoice_id,
                'is_merchant_invoice': True,  # ÿπŸÑÿßŸÖÿ© ÿ£ŸÜŸáÿß ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ÿßÿ¨ÿ±
                'status': 'pending',
                'created_at': time.time()
            }
            
            # ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
            try:
                db.collection('merchant_invoices').document(invoice_id).set({
                    'invoice_id': invoice_id,
                    'order_id': order_id,
                    'merchant_id': merchant_id,
                    'merchant_name': merchant_name,
                    'amount': amount,
                    'customer_phone': phone,
                    'status': 'pending',
                    'created_at': firestore.SERVER_TIMESTAMP,
                    'expires_at': expires_at
                })
                
                db.collection('pending_payments').document(order_id).set({
                    'user_id': merchant_id,
                    'amount': amount,
                    'order_id': order_id,
                    'invoice_id': invoice_id,
                    'is_merchant_invoice': True,
                    'status': 'pending',
                    'created_at': firestore.SERVER_TIMESTAMP
                })
            except Exception as e:
                print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÅŸä Firebase: {e}")
            
            return {
                'success': True,
                'payment_url': payment_url,
                'invoice_id': invoice_id,
                'order_id': order_id
            }
        else:
            error_msg = result.get('message') or result.get('error') or str(result)
            return {'success': False, 'error': error_msg}
            
    except Exception as e:
        print(f"‚ùå Exception in create_customer_invoice: {e}")
        import traceback
        traceback.print_exc()
        return {'success': False, 'error': str(e)}

# ÿ≤ÿ± ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ∑ŸÑÿ® ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑŸÖÿ¥ÿ±ŸÅ (ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÇÿØŸäŸÖ - ŸÑŸÑÿ∑ŸÑÿ®ÿßÿ™ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©)
@bot.callback_query_handler(func=lambda call: call.data.startswith('claim_') and not call.data.startswith('claim_order_'))
def claim_order(call):
    order_id = call.data.replace('claim_', '')
    admin_id = call.from_user.id
    admin_name = call.from_user.first_name
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸáŸà ÿßŸÑŸÖÿßŸÑŸÉ
    if admin_id != ADMIN_ID:
        return bot.answer_callback_query(call.id, "‚õî ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠ ŸÑŸÉ!", show_alert=True)
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿ∑ŸÑÿ®
    if order_id not in active_orders:
        return bot.answer_callback_query(call.id, "‚ùå ÿßŸÑÿ∑ŸÑÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ÿ£Ÿà ÿ™ŸÖ ÿ≠ÿ∞ŸÅŸá!", show_alert=True)
    
    order = active_orders[order_id]
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ∑ŸÑÿ® ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖŸá ŸÖÿ≥ÿ®ŸÇÿßŸã
    if order['status'] == 'claimed':
        return bot.answer_callback_query(call.id, "‚ö†Ô∏è ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÑÿ® ŸÖÿ≥ÿ®ŸÇÿßŸã!", show_alert=True)
    
    # ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ® ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
    order['status'] = 'claimed'
    order['admin_id'] = admin_id
    
    # ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase
    try:
        db.collection('orders').document(order_id).update({
            'status': 'claimed',
            'admin_id': str(admin_id),
            'claimed_at': firestore.SERVER_TIMESTAMP
        })
    except Exception as e:
        print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∑ŸÑÿ® ŸÅŸä Firebase: {e}")
    
    # ÿ™ÿ≠ÿØŸäÿ´ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÖÿ¥ÿ±ŸÅ ÿßŸÑÿ∞Ÿä ÿßÿ≥ÿ™ŸÑŸÖ
    try:
        bot.edit_message_text(
            f"‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ∑ŸÑÿ® #{order_id}\n\n"
            f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {order['item_name']}\n"
            f"üí∞ ÿßŸÑÿ≥ÿπÿ±: {order['price']} ÿ±ŸäÿßŸÑ\n\n"
            f"üë®‚Äçüíº ÿ£ŸÜÿ™ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÑÿ®\n"
            f"‚è∞ ÿßŸÑÿ≠ÿßŸÑÿ©: ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞...\n\n"
            f"üîí ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿ© ŸÑŸÉ ÿßŸÑÿ¢ŸÜ...",
            chat_id=call.message.chat.id,
            message_id=call.message.message_id
        )
    except:
        pass
    
    # ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖÿ¥ÿ±ŸÅŸäŸÜ ÿßŸÑÿ¢ÿÆÿ±ŸäŸÜ
    if 'admin_messages' in order:
        for other_admin_id, msg_id in order['admin_messages'].items():
            if other_admin_id != admin_id:
                try:
                    bot.delete_message(other_admin_id, msg_id)
                except:
                    pass
    
    # ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿÆŸÅŸäÿ© ŸÑŸÑŸÖÿ¥ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿÆÿßÿµ
    hidden_info = order['hidden_data'] if order['hidden_data'] else "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿÆŸÅŸäÿ© ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨."
    
    # ÿ•ŸÜÿ¥ÿßÿ° ÿ≤ÿ± ŸÑÿ™ÿ£ŸÉŸäÿØ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ∑ŸÑÿ®
    markup = types.InlineKeyboardMarkup()
    complete_btn = types.InlineKeyboardButton("‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ŸÑŸÑÿπŸÖŸäŸÑ", callback_data=f"complete_{order_id}")
    markup.add(complete_btn)
    
    bot.send_message(
        admin_id,
        f"üîê ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑÿ≥ÿ±Ÿäÿ© #{order_id}\n\n"
        f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {order['item_name']}\n\n"
        f"üë§ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ:\n"
        f"‚Ä¢ ÿßŸÑÿßÿ≥ŸÖ: {order['buyer_name']}\n"
        f"‚Ä¢ ÿ¢ŸäÿØŸä ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ: {order['buyer_id']}\n"
        f"‚Ä¢ ÿ¢ŸäÿØŸä ÿßŸÑŸÑÿπÿ®ÿ©: {order['game_id']}\n"
        f"‚Ä¢ ÿßŸÑÿßÿ≥ŸÖ ŸÅŸä ÿßŸÑŸÑÿπÿ®ÿ©: {order['game_name']}\n\n"
        f"üîí ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÖŸäÿ©:\n"
        f"{hidden_info}\n\n"
        f"‚ö° ŸÇŸÖ ÿ®ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ∑ŸÑÿ® ÿ´ŸÖ ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑÿ≤ÿ± ÿ£ÿØŸÜÿßŸá!",
        reply_markup=markup
    )
    
    bot.answer_callback_query(call.id, "‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ∑ŸÑÿ®! ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ±ÿ≥ÿßÿ¶ŸÑŸÉ ÿßŸÑÿÆÿßÿµÿ©.")

# ÿ≤ÿ± ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ∑ŸÑÿ® ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑŸÖÿ¥ÿ±ŸÅ (ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÇÿØŸäŸÖ - ŸÑŸÑÿ∑ŸÑÿ®ÿßÿ™ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©)
@bot.callback_query_handler(func=lambda call: call.data.startswith('complete_') and not call.data.startswith('complete_order_'))
def complete_order(call):
    order_id = call.data.replace('complete_', '')
    admin_id = call.from_user.id
    
    if order_id not in active_orders:
        return bot.answer_callback_query(call.id, "‚ùå ÿßŸÑÿ∑ŸÑÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ!", show_alert=True)
    
    order = active_orders[order_id]
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ¥ÿ±ŸÅ ŸáŸà ŸÜŸÅÿ≥Ÿá ŸÖŸÜ ÿßÿ≥ÿ™ŸÑŸÖ ÿßŸÑÿ∑ŸÑÿ®
    if order['admin_id'] != admin_id:
        return bot.answer_callback_query(call.id, "‚õî ŸÑŸÖ ÿ™ÿ≥ÿ™ŸÑŸÖ Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÑÿ®!", show_alert=True)
    
    # ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸÖÿßŸÑ ŸÑŸÑÿ®ÿßÿ¶ÿπ
    add_balance(order['seller_id'], order['price'])
    
    # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ®ÿßÿ¶ÿπ
    bot.send_message(
        order['seller_id'],
        f"üí∞ ÿ™ŸÖ ÿ®Ÿäÿπ ŸÖŸÜÿ™ÿ¨ŸÉ!\n\n"
        f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {order['item_name']}\n"
        f"üíµ ÿßŸÑŸÖÿ®ŸÑÿ∫: {order['price']} ÿ±ŸäÿßŸÑ\n\n"
        f"‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ®ŸÑÿ∫ ŸÑÿ±ÿµŸäÿØŸÉ!"
    )
    
    # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿπŸÖŸäŸÑ
    markup = types.InlineKeyboardMarkup()
    confirm_btn = types.InlineKeyboardButton("‚úÖ ÿ£ŸÉÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ", callback_data=f"buyer_confirm_{order_id}")
    markup.add(confirm_btn)
    
    bot.send_message(
        order['buyer_id'],
        f"üéâ ÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ ÿ∑ŸÑÿ®ŸÉ!\n\n"
        f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {order['item_name']}\n\n"
        f"‚úÖ Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿ≥ÿßÿ®ŸÉ ŸàÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿÆÿØŸÖÿ©\n\n"
        f"‚ö†Ô∏è ÿ•ÿ∞ÿß ÿßÿ≥ÿ™ŸÑŸÖÿ™ ÿßŸÑÿÆÿØŸÖÿ© ÿ®ŸÜÿ¨ÿßÿ≠ÿå ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑÿ≤ÿ± ÿ£ÿØŸÜÿßŸá ŸÑÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ.",
        reply_markup=markup
    )
    
    # ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ®
    order['status'] = 'completed'
    
    # ÿ≠ÿ∞ŸÅ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿ© ŸÖŸÜ ÿÆÿßÿµ ÿßŸÑŸÖÿ¥ÿ±ŸÅ
    try:
        bot.edit_message_text(
            f"‚úÖ ÿ™ŸÖ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ∑ŸÑÿ® #{order_id}\n\nÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿ© ŸÑŸÑÿ£ŸÖÿßŸÜ.",
            chat_id=call.message.chat.id,
            message_id=call.message.message_id
        )
    except:
        pass
    
    bot.answer_callback_query(call.id, "‚úÖ ÿ™ŸÖ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠!")

# ÿ≤ÿ± ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ ŸÖŸÜ ÿßŸÑÿπŸÖŸäŸÑ
@bot.callback_query_handler(func=lambda call: call.data.startswith('buyer_confirm_'))
def buyer_confirm(call):
    order_id = call.data.replace('buyer_confirm_', '')
    
    if order_id not in active_orders:
        return bot.answer_callback_query(call.id, "‚úÖ ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÑÿ® ŸÖÿ≥ÿ®ŸÇÿßŸã!")
    
    order = active_orders[order_id]
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸáŸà ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä
    if str(call.from_user.id) != order['buyer_id']:
        return bot.answer_callback_query(call.id, "‚õî Ÿáÿ∞ÿß ŸÑŸäÿ≥ ÿ∑ŸÑÿ®ŸÉ!", show_alert=True)
    
    # ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ŸÑÿ® ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÜÿ¥ÿ∑ÿ©
    del active_orders[order_id]
    
    # ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase
    try:
        db.collection('orders').document(order_id).update({
            'status': 'confirmed',
            'confirmed_at': firestore.SERVER_TIMESTAMP
        })
    except Exception as e:
        print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∑ŸÑÿ® ŸÅŸä Firebase: {e}")
    
    bot.edit_message_text(
        f"‚úÖ ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ™ÿ£ŸÉŸäÿØŸÉ!\n\n"
        f"ÿ™ŸÖ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠ ‚ú®\n"
        f"ŸÜÿ™ŸÖŸÜŸâ ŸÑŸÉ ÿ™ÿ¨ÿ±ÿ®ÿ© ŸÖŸÖÿ™ÿπÿ©! üéÆ",
        chat_id=call.message.chat.id,
        message_id=call.message.message_id
    )
    
    bot.answer_callback_query(call.id, "‚úÖ ÿ¥ŸÉÿ±ÿßŸã ŸÑŸÉ!")

# ÿ≤ÿ± ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ (Ÿäÿ≠ÿ±ÿ± ÿßŸÑŸÖÿßŸÑ ŸÑŸÑÿ®ÿßÿ¶ÿπ) - ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÇÿØŸäŸÖ ŸÑŸÑÿ™ŸàÿßŸÅŸÇ
@bot.callback_query_handler(func=lambda call: call.data.startswith('confirm_'))
def confirm_transaction(call):
    trans_id = call.data.split('_')[1]
    
    if trans_id not in transactions:
        return bot.answer_callback_query(call.id, "Ÿáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©")
    
    trans = transactions[trans_id]
    
    # ÿßŸÑÿ™ÿ£ŸÉÿØ ÿ£ŸÜ ÿßŸÑÿ∞Ÿä Ÿäÿ∂ÿ∫ÿ∑ ŸáŸà ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä ŸÅŸÇÿ∑
    if str(call.from_user.id) != str(trans['buyer_id']):
        return bot.answer_callback_query(call.id, "ŸÅŸÇÿ∑ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä ŸäŸÖŸÉŸÜŸá ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ!", show_alert=True)

    # ÿ™ÿ≠ÿ±Ÿäÿ± ÿßŸÑŸÖÿßŸÑ ŸÑŸÑÿ®ÿßÿ¶ÿπ
    seller_id = trans['seller_id']
    amount = trans['amount']
    
    # ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ±ÿµŸäÿØ ŸÑŸÑÿ®ÿßÿ¶ÿπ
    add_balance(seller_id, amount)
    
    # ÿ≠ÿ∞ŸÅ ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÖŸÜ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±
    del transactions[trans_id]
    
    bot.edit_message_text(f"‚úÖ ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿÆÿØŸÖÿ©: {trans['item_name']}\nÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑ {amount} ÿ±ŸäÿßŸÑ ŸÑŸÑÿ®ÿßÿ¶ÿπ.", call.message.chat.id, call.message.message_id)
    bot.send_message(seller_id, f"ü§ë ŸÖÿ®ÿ±ŸàŸÉ! ŸÇÿßŸÖ ÿßŸÑÿπŸÖŸäŸÑ ÿ®ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ.\nüí∞ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© {amount} ÿ±ŸäÿßŸÑ ŸÑÿ±ÿµŸäÿØŸÉ.\nüì¶ ÿßŸÑÿ∑ŸÑÿ®: {trans['item_name']}\nüéÆ ÿ¢ŸäÿØŸä: {trans.get('game_id', 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ')}")

# ŸÖÿπÿßŸÑÿ¨ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸäÿØŸàŸäÿ©
@bot.callback_query_handler(func=lambda call: call.data.startswith('claim_order_'))
def claim_manual_order(call):
    """ŸÖÿπÿßŸÑÿ¨ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑŸäÿØŸàŸä ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑÿ£ÿØŸÖŸÜ"""
    order_id = call.data.replace('claim_order_', '')
    admin_id = call.from_user.id
    admin_name = call.from_user.first_name
    
    print(f"üìã ŸÖÿ≠ÿßŸàŸÑÿ© ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ∑ŸÑÿ®: {order_id} ÿ®Ÿàÿßÿ≥ÿ∑ÿ©: {admin_name} ({admin_id})")
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸáŸà ÿßŸÑŸÖÿßŸÑŸÉ
    if admin_id != ADMIN_ID:
        return bot.answer_callback_query(call.id, "‚õî ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠ ŸÑŸÉ!", show_alert=True)
    
    try:
        # ÿ¨ŸÑÿ® ÿßŸÑÿ∑ŸÑÿ® ŸÖŸÜ Firebase
        order_ref = db.collection('orders').document(order_id)
        order_doc = order_ref.get()
        
        print(f"üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ∑ŸÑÿ®: {order_id} - ŸÖŸàÿ¨ŸàÿØ: {order_doc.exists}")
        
        if not order_doc.exists:
            print(f"‚ùå ÿßŸÑÿ∑ŸÑÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä Firebase: {order_id}")
            return bot.answer_callback_query(call.id, "‚ùå ÿßŸÑÿ∑ŸÑÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ!", show_alert=True)
        
        order = order_doc.to_dict()
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ®
        if order.get('status') == 'completed':
            return bot.answer_callback_query(call.id, "‚úÖ ÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÑÿ® ŸÖÿ≥ÿ®ŸÇÿßŸã!", show_alert=True)
        
        if order.get('status') == 'claimed':
            claimed_by = order.get('claimed_by_name', 'ÿ£ÿØŸÖŸÜ ÿ¢ÿÆÿ±')
            return bot.answer_callback_query(call.id, f"‚ö†Ô∏è Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÑÿ® ŸÖÿ≥ÿ™ŸÑŸÖ ŸÖŸÜ ŸÇÿ®ŸÑ {claimed_by}!", show_alert=True)
        
        # ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ® ÿ•ŸÑŸâ ŸÖÿ≥ÿ™ŸÑŸÖ
        order_ref.update({
            'status': 'claimed',
            'claimed_by': str(admin_id),
            'claimed_by_name': admin_name,
            'claimed_at': firestore.SERVER_TIMESTAMP
        })
        
        # ÿ™ÿ≠ÿØŸäÿ´ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ£ÿØŸÖŸÜ
        try:
            buyer_details = order.get('buyer_details', '')
            
            # üîì ÿßŸÑÿ¢ŸÜ ŸÜŸÉÿ¥ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä ŸÑŸÑŸÖÿ¥ÿ±ŸÅ ÿßŸÑÿ∞Ÿä ÿßÿ≥ÿ™ŸÑŸÖ ÿßŸÑÿ∑ŸÑÿ®
            buyer_details_text = ""
            if buyer_details:
                buyer_details_text = f"\n\nüìù ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ∑ŸÑÿ® ŸÖŸÜ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä:\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n{buyer_details}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            # ÿ•ŸÜÿ¥ÿßÿ° ÿ≤ÿ± ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®
            complete_markup = telebot.types.InlineKeyboardMarkup()
            complete_markup.add(telebot.types.InlineKeyboardButton(
                "‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ", 
                callback_data=f"complete_order_{order_id}"
            ))
            
            bot.edit_message_text(
                f"‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ∑ŸÑÿ® ÿ®Ÿàÿßÿ≥ÿ∑ÿ™ŸÉ!\n\n"
                f"üÜî ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: #{order_id}\n"
                f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {order.get('item_name')}\n"
                f"üë§ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä: {order.get('buyer_name')}\n"
                f"üî¢ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä: {order.get('buyer_id')}\n"
                f"üí∞ ÿßŸÑÿ≥ÿπÿ±: {order.get('price')} ÿ±ŸäÿßŸÑ"
                f"{buyer_details_text}\n\n"
                f"üëá ÿ®ÿπÿØ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ∑ŸÑÿ® ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑÿ≤ÿ± ÿ£ÿØŸÜÿßŸá",
                chat_id=call.message.chat.id,
                message_id=call.message.message_id,
                reply_markup=complete_markup
            )
        except Exception as e:
            print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ£ÿØŸÖŸÜ: {e}")
        
        # üìå ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿßŸÑŸÉ ÿ®ÿ£ŸÜ ŸÖÿ¥ÿ±ŸÅ ÿßÿ≥ÿ™ŸÑŸÖ ÿßŸÑÿ∑ŸÑÿ®
        if admin_id != ADMIN_ID:
            try:
                bot.send_message(
                    ADMIN_ID,
                    f"üìå ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ∑ŸÑÿ®\n\n"
                    f"üÜî ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: #{order_id}\n"
                    f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {order.get('item_name')}\n"
                    f"üë§ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä: {order.get('buyer_name')}\n"
                    f"üë®‚Äçüíº ÿßŸÑŸÖÿ¥ÿ±ŸÅ ÿßŸÑŸÖŸÜŸÅÿ∞: {admin_name}\n"
                    f"üí∞ ÿßŸÑÿ≥ÿπÿ±: {order.get('price')} ÿ±ŸäÿßŸÑ"
                )
            except:
                pass
        
        # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä
        try:
            bot.send_message(
                int(order.get('buyer_id')),
                f"üë®‚Äçüíº ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ∑ŸÑÿ®ŸÉ!\n\n"
                f"üÜî ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: #{order_id}\n"
                f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {order.get('item_name')}\n"
                f"‚úÖ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ: {admin_name}\n\n"
                f"‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ŸÜŸÅŸäÿ∞ ÿ∑ŸÑÿ®ŸÉ..."
            )
        except:
            pass
        
        bot.answer_callback_query(call.id, "‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠!")
        
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ∑ŸÑÿ®: {e}")
        bot.answer_callback_query(call.id, f"‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: {str(e)}", show_alert=True)

# ŸÖÿπÿßŸÑÿ¨ ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑŸäÿØŸàŸä
@bot.callback_query_handler(func=lambda call: call.data.startswith('complete_order_'))
def complete_manual_order(call):
    """ŸÖÿπÿßŸÑÿ¨ ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑŸäÿØŸàŸä ÿ®ÿπÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞"""
    from datetime import datetime
    order_id = call.data.replace('complete_order_', '')
    admin_id = call.from_user.id
    admin_name = call.from_user.first_name
    
    try:
        # ÿ¨ŸÑÿ® ÿßŸÑÿ∑ŸÑÿ® ŸÖŸÜ Firebase
        order_ref = db.collection('orders').document(order_id)
        order_doc = order_ref.get()
        
        if not order_doc.exists:
            return bot.answer_callback_query(call.id, "‚ùå ÿßŸÑÿ∑ŸÑÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ!", show_alert=True)
        
        order = order_doc.to_dict()
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ£ÿØŸÖŸÜ ŸáŸà ŸÖŸÜ ÿßÿ≥ÿ™ŸÑŸÖ ÿßŸÑÿ∑ŸÑÿ®
        if order.get('claimed_by') != str(admin_id) and admin_id != ADMIN_ID:
            return bot.answer_callback_query(call.id, "‚õî Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÑÿ® ŸÑŸäÿ≥ ŸÖÿ≥ÿ™ŸÑŸÖÿßŸã ÿ®Ÿàÿßÿ≥ÿ∑ÿ™ŸÉ!", show_alert=True)
        
        if order.get('status') == 'completed':
            return bot.answer_callback_query(call.id, "‚úÖ ÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÑÿ® ŸÖÿ≥ÿ®ŸÇÿßŸã!", show_alert=True)
        
        # ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ® ÿ•ŸÑŸâ ŸÖŸÉÿ™ŸÖŸÑ
        order_ref.update({
            'status': 'completed',
            'completed_by': str(admin_id),
            'completed_by_name': admin_name,
            'completed_at': firestore.SERVER_TIMESTAMP
        })
        
        # ÿ™ÿ≠ÿØŸäÿ´ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ£ÿØŸÖŸÜ
        try:
            bot.edit_message_text(
                f"‚úÖ ÿ™ŸÖ ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠!\n\n"
                f"üÜî ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: #{order_id}\n"
                f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {order.get('item_name')}\n"
                f"üë§ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä: {order.get('buyer_name')}\n"
                f"üí∞ ÿßŸÑÿ≥ÿπÿ±: {order.get('price')} ÿ±ŸäÿßŸÑ\n\n"
                f"üë®‚Äçüíº ÿ™ŸÖ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞ ÿ®Ÿàÿßÿ≥ÿ∑ÿ©: {admin_name}\n"
                f"‚è∞ {datetime.now().strftime('%Y-%m-%d %H:%M')}",
                chat_id=call.message.chat.id,
                message_id=call.message.message_id
            )
        except:
            pass
        
        # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä ÿ®ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®
        try:
            hidden_data = order.get('hidden_data', '')
            if hidden_data:
                bot.send_message(
                    int(order.get('buyer_id')),
                    f"üéâ ÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ ÿ∑ŸÑÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠!\n\n"
                    f"üÜî ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: #{order_id}\n"
                    f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {order.get('item_name')}\n"
                    f"üë®‚Äçüíº ÿ™ŸÖ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞ ÿ®Ÿàÿßÿ≥ÿ∑ÿ©: {admin_name}\n\n"
                    f"üîê ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ:\n{hidden_data}\n\n"
                    f"‚ö†Ô∏è ÿßÿ≠ŸÅÿ∏ Ÿáÿ∞Ÿá ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÖŸÉÿßŸÜ ÿ¢ŸÖŸÜ!\n"
                    f"ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ™ÿ≥ŸàŸÇŸÉ ŸÖÿπŸÜÿß! üíô"
                )
            else:
                bot.send_message(
                    int(order.get('buyer_id')),
                    f"üéâ ÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ ÿ∑ŸÑÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠!\n\n"
                    f"üÜî ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: #{order_id}\n"
                    f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {order.get('item_name')}\n"
                    f"üë®‚Äçüíº ÿ™ŸÖ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞ ÿ®Ÿàÿßÿ≥ÿ∑ÿ©: {admin_name}\n\n"
                    f"ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ™ÿ≥ŸàŸÇŸÉ ŸÖÿπŸÜÿß! üíô"
                )
        except Exception as e:
            print(f"‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä: {e}")
        
        # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿßŸÑŸÉ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä
        try:
            if admin_id != ADMIN_ID:
                bot.send_message(
                    ADMIN_ID,
                    f"‚úÖ ÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ ÿ∑ŸÑÿ® ŸäÿØŸàŸä\n\n"
                    f"üÜî ÿßŸÑÿ∑ŸÑÿ®: #{order_id}\n"
                    f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {order.get('item_name')}\n"
                    f"üë®‚Äçüíº ÿßŸÑŸÖŸÜŸÅÿ∞: {admin_name}\n"
                    f"üë§ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä: {order.get('buyer_name')}"
                )
        except:
            pass
        
        bot.answer_callback_query(call.id, "‚úÖ ÿ™ŸÖ ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿ∑ŸÑÿ® Ÿàÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä!")
        
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®: {e}")
        bot.answer_callback_query(call.id, f"‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: {str(e)}", show_alert=True)

# --- ŸÖÿ≥ÿßÿ±ÿßÿ™ ÿßŸÑŸÖŸàŸÇÿπ (Flask) ---

# ŸÖÿ≥ÿßÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
@app.route('/logout', methods=['POST'])
def logout():
    session.clear()
    return {'success': True}

# ŸÖÿ≥ÿßÿ± ÿ¨ŸÑÿ® ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
@app.route('/get_orders')
def get_user_orders():
    # ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ŸÅŸÇÿ∑ ŸÑŸÑÿ£ŸÖÿßŸÜ - ŸÑÿß ŸÜŸÇÿ®ŸÑ user_id ŸÖŸÜ ÿßŸÑÿ±ÿßÿ®ÿ∑
    user_id = session.get('user_id')
    
    if not user_id:
        return {'orders': []}
    
    user_id = str(user_id)
    
    # ÿ¨ŸÑÿ® ÿ¨ŸÖŸäÿπ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿÆÿßÿµÿ© ÿ®ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ Firebase
    user_orders = []
    
    try:
        orders_ref = query_where(db.collection('orders'), 'buyer_id', '==', user_id)
        for doc in orders_ref.stream():
            order = doc.to_dict()
            order_id = doc.id
            
            # ÿ•ÿ∂ÿßŸÅÿ© ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±ŸÅ ÿ•ÿ∞ÿß ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ∑ŸÑÿ®
            admin_name = None
            if order.get('admin_id'):
                try:
                    admin_info = bot.get_chat(order['admin_id'])
                    admin_name = admin_info.first_name
                except:
                    admin_name = "ŸÖÿ¥ÿ±ŸÅ"
            
            user_orders.append({
                'order_id': order_id,
                'item_name': order.get('item_name', 'ŸÖŸÜÿ™ÿ¨'),
                'price': order.get('price', 0),
                'game_id': order.get('buyer_details', ''),  # ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä
                'game_name': '',
                'status': order.get('status', 'completed'),
                'delivery_type': order.get('delivery_type', 'instant'),
                'admin_name': admin_name
            })
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™: {e}")
        # fallback ŸÑŸÑÿ∞ÿßŸÉÿ±ÿ©
        for order_id, order in active_orders.items():
            if str(order.get('buyer_id')) == user_id:
                admin_name = None
                if order.get('admin_id'):
                    try:
                        admin_info = bot.get_chat(order['admin_id'])
                        admin_name = admin_info.first_name
                    except:
                        admin_name = "ŸÖÿ¥ÿ±ŸÅ"
                
                user_orders.append({
                    'order_id': order_id,
                    'item_name': order.get('item_name', 'ŸÖŸÜÿ™ÿ¨'),
                    'price': order.get('price', 0),
                    'game_id': order.get('game_id', ''),
                    'game_name': order.get('game_name', ''),
                    'status': order.get('status', 'completed'),
                    'delivery_type': order.get('delivery_type', 'instant'),
                    'admin_name': admin_name
                })
    
    # ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ŸÖŸÜ ÿßŸÑÿ£ÿ≠ÿØÿ´ ŸÑŸÑÿ£ŸÇÿØŸÖ
    user_orders.reverse()
    
    return {'orders': user_orders}

# ŸÖÿ≥ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÉŸàÿØ Ÿàÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
@app.route('/verify', methods=['POST'])
@limiter.limit("5 per minute")  # üîí Rate Limiting: 5 ŸÖÿ≠ÿßŸàŸÑÿßÿ™/ÿØŸÇŸäŸÇÿ©
def verify_login():
    data = request.get_json()
    user_id = data.get('user_id')
    code = data.get('code')
    
    if not user_id or not code:
        return {'success': False, 'message': 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ¢ŸäÿØŸä ŸàÿßŸÑŸÉŸàÿØ'}
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑŸÉŸàÿØ
    code_data = verify_code(user_id, code)
    
    if not code_data:
        return {'success': False, 'message': 'ÿßŸÑŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ ÿ£Ÿà ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©'}
    
    # ÿ™ÿ¨ÿØŸäÿØ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ŸÑŸÖŸÜÿπ Session Fixation
    regenerate_session()
    
    # ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    session.permanent = True  # ÿ™ŸÅÿπŸäŸÑ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
    session['user_id'] = user_id
    session['user_name'] = code_data['name']
    session['login_time'] = time.time()  # ŸàŸÇÿ™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ

    # ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉŸàÿØ ÿ®ÿπÿØ ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ
    del verification_codes[str(user_id)]

    # ÿ¨ŸÑÿ® ÿßŸÑÿ±ÿµŸäÿØ
    balance = get_balance(user_id)

    # ÿ¨ŸÑÿ® ÿµŸàÿ±ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖŸÜ ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ ÿ£Ÿà Firebase
    profile_photo_url = None
    try:
        # ÿ£ŸàŸÑÿßŸã: ŸÖÿ≠ÿßŸàŸÑÿ© ÿ¨ŸÑÿ® ŸÖŸÜ Firebase
        user_doc = db.collection('users').document(str(user_id)).get()
        if user_doc.exists:
            profile_photo_url = user_doc.to_dict().get('profile_photo')
        
        # ÿ´ÿßŸÜŸäÿßŸã: ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØÿå ÿ¨ŸÑÿ® ŸÖŸÜ ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ ŸÖÿ®ÿßÿ¥ÿ±ÿ©
        if not profile_photo_url:
            photos = bot.get_user_profile_photos(int(user_id), limit=1)
            if photos.total_count > 0:
                file_id = photos.photos[0][0].file_id
                file_info = bot.get_file(file_id)
                token = bot.token
                profile_photo_url = f"https://api.telegram.org/file/bot{token}/{file_info.file_path}"
                # ÿ≠ŸÅÿ∏ ŸÅŸä Firebase ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÑÿßÿ≠ŸÇÿßŸã
                db.collection('users').document(str(user_id)).update({'profile_photo': profile_photo_url})
    except Exception as e:
        print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿµŸàÿ±ÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®: {e}")
    
    # ÿ≠ŸÅÿ∏ ŸÅŸä ÿßŸÑÿ¨ŸÑÿ≥ÿ©
    if profile_photo_url:
        session['profile_photo'] = profile_photo_url

    return {
        'success': True,
        'message': 'ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠',
        'user_name': code_data['name'],
        'balance': balance,
        'profile_photo_url': profile_photo_url
    }

# --- ÿ≠ŸÖÿßŸäÿ© ÿ•ÿ∂ÿßŸÅŸäÿ©: ÿ±ÿ§Ÿàÿ≥ ÿ£ŸÖŸÜŸäÿ© ---
@app.after_request
def add_security_headers(response):
    """ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿ§Ÿàÿ≥ ÿ£ŸÖŸÜŸäÿ© ŸÑŸÉŸÑ ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©"""
    # ŸÖŸÜÿπ ÿ™ÿ∂ŸÖŸäŸÜ ÿßŸÑŸÖŸàŸÇÿπ ŸÅŸä iframe
    response.headers['X-Frame-Options'] = 'SAMEORIGIN'
    # ÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ XSS
    response.headers['X-XSS-Protection'] = '1; mode=block'
    # ŸÖŸÜÿπ ÿ™ÿÆŸÖŸäŸÜ ŸÜŸàÿπ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
    response.headers['X-Content-Type-Options'] = 'nosniff'
    # ÿ≥Ÿäÿßÿ≥ÿ© ÿßŸÑÿ•ÿ≠ÿßŸÑÿ©
    response.headers['Referrer-Policy'] = 'strict-origin-when-cross-origin'
    # ŸÖŸÜÿπ ÿßŸÑŸÉÿ¥ŸÅ ÿπŸÜ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
    response.headers['Server'] = 'Protected'
    return response

# --- ÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ ŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑÿßÿÆÿ™ÿ±ÿßŸÇ ---
BLOCKED_PATHS = [
    '/wp-admin', '/wp-login', '/wp-content', '/wp-includes',
    '/wordpress', '/.env', '/.git', '/phpmyadmin', '/pma',
    '/admin.php', '/xmlrpc.php', '/wp-config', '/config.php',
    '/shell', '/c99', '/r57', '/webshell', '/backdoor',
    '/.htaccess', '/.htpasswd', '/cgi-bin', '/admin/config',
    '/phpinfo', '/info.php', '/test.php', '/debug',
    '/backup', '/.bak', '/.sql', '/.zip', '/.tar',
    '/vendor/', '/node_modules/', '/.DS_Store'
]

@app.before_request
def block_suspicious_requests():
    """ÿ≠ÿ∏ÿ± ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖÿ¥ÿ®ŸàŸáÿ©"""
    path = request.path.lower()
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑ ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ±ÿ©
    for blocked in BLOCKED_PATHS:
        if blocked in path:
            # ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©
            print(f"üö´ ŸÖÿ≠ÿßŸàŸÑÿ© ÿßÿÆÿ™ÿ±ÿßŸÇ ŸÖÿ≠ÿ∏Ÿàÿ±ÿ©: {request.path} ŸÖŸÜ {request.remote_addr}")
            return "Forbidden", 403
    
    return None

# --- ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ¨ŸÑÿ≥ÿ© ---
@app.before_request
def check_session_validity():
    """ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ¨ŸÑÿ≥ÿ© ŸÇÿ®ŸÑ ŸÉŸÑ ÿ∑ŸÑÿ®"""
    if 'user_id' in session:
        login_time = session.get('login_time', 0)
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ© (30 ÿØŸÇŸäŸÇÿ©)
        if time.time() - login_time > 1800:  # 30 * 60 = 1800 ÿ´ÿßŸÜŸäÿ©
            session.clear()
            print("‚è∞ ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ¨ŸÑÿ≥ÿ©")

@app.route('/robots.txt')
def robots_txt():
    """ŸÖŸÑŸÅ robots.txt ŸÑŸÑŸÖÿ≠ÿ±ŸÉÿßÿ™ ÿßŸÑÿ®ÿ≠ÿ´"""
    return """User-agent: *
Allow: /
Disallow: /admin
Disallow: /webhook
Disallow: /payment/
Disallow: /api/
""", 200, {'Content-Type': 'text/plain'}

@app.route('/favicon.ico')
def favicon():
    """ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑŸÖŸàŸÇÿπ"""
    return '', 204

@app.route('/')
def index():
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ¨ŸÑÿ≥ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ - ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ŸÅŸÇÿ∑ ŸÑŸÑÿ£ŸÖÿßŸÜ
    user_id = session.get('user_id')
    user_name = session.get('user_name', 'ÿ∂ŸäŸÅ')
    profile_photo = session.get('profile_photo', '')
    
    # 1. ÿ¨ŸÑÿ® ÿßŸÑÿ±ÿµŸäÿØ ŸàÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ (ŸÖÿ≠ÿØÿ´ ŸÖŸÜ Firebase)
    balance = 0.0
    if user_id:
        try:
            user_doc = db.collection('users').document(str(user_id)).get()
            if user_doc.exists:
                user_data = user_doc.to_dict()
                balance = user_data.get('balance', 0.0)
                if not profile_photo:
                    profile_photo = user_data.get('profile_photo', '')
        except:
            balance = get_balance(user_id)
    
    # 2. ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ (ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÖŸÜ Firebase ŸÑÿ∂ŸÖÿßŸÜ ÿ∏ŸáŸàÿ±Ÿáÿß)
    items = []
    try:
        # ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ™Ÿä ŸÑŸÖ ÿ™Ÿèÿ®ÿπ (sold == False)
        docs = query_where(db.collection('products'), 'sold', '==', False).stream()
        
        for doc in docs:
            p = doc.to_dict()
            p['id'] = doc.id  # ŸÖŸáŸÖ ÿ¨ÿØÿßŸã ŸÑÿπŸÖŸÑŸäÿ© ÿßŸÑÿ¥ÿ±ÿßÿ°
            items.append(p)
        
        print(f"‚úÖ ÿ™ŸÖ ÿ¨ŸÑÿ® {len(items)} ŸÖŸÜÿ™ÿ¨ ŸÖŸÜ Firebase ŸÑŸÑŸÖÿ™ÿ¨ÿ±")
            
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÑŸÖÿ™ÿ¨ÿ±: {e}")
        # ŸÅŸä ÿ≠ÿßŸÑ ÿßŸÑŸÅÿ¥ŸÑÿå ŸÜÿπŸàÿØ ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ŸÉÿßÿ≠ÿ™Ÿäÿßÿ∑
        items = [i for i in marketplace_items if not i.get('sold')]

    # 3. ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿπÿ© (ŸÑÿπÿ±ÿ∂Ÿáÿß ŸÅŸä ŸÇÿ≥ŸÖ ŸÖŸÜŸÅÿµŸÑ)
    sold_items = []
    try:
        sold_docs = query_where(db.collection('products'), 'sold', '==', True).stream()
        for doc in sold_docs:
            p = doc.to_dict()
            p['id'] = doc.id
            sold_items.append(p)
        print(f"‚úÖ ÿ™ŸÖ ÿ¨ŸÑÿ® {len(sold_items)} ŸÖŸÜÿ™ÿ¨ ŸÖÿ®ÿßÿπ ŸÖŸÜ Firebase")
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿπÿ©: {e}")
        sold_items = [i for i in marketplace_items if i.get('sold')]

    # 4. ÿ¨ŸÑÿ® ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä
    my_purchases = []
    if user_id:
        try:
            purchases_docs = query_where(db.collection('orders'), 'buyer_id', '==', str(user_id)).stream()
            for doc in purchases_docs:
                p = doc.to_dict()
                p['order_id'] = doc.id
                my_purchases.append(p)
            print(f"‚úÖ ÿ™ŸÖ ÿ¨ŸÑÿ® {len(my_purchases)} ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ {user_id}")
        except Exception as e:
            print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: {e}")

    # ÿ¨ŸÑÿ® ÿπÿØÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ≥ŸÑÿ©
    cart_count = 0
    if user_id:
        cart = user_carts.get(str(user_id), {})
        cart_count = len(cart.get('items', []))

    # ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿ©
    return render_template('index.html', 
                                  items=items,
                                  sold_items=sold_items,
                                  my_purchases=my_purchases,
                                  balance=balance, 
                                  current_user_id=user_id or 0, 
                                  current_user=user_id,
                                  user_name=user_name,
                                  profile_photo=profile_photo,
                                  cart_count=cart_count)

# ============================================
# üõí ŸÜÿ∏ÿßŸÖ ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ
# ============================================

CART_PAGE = """
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üõí ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --primary-light: #a29bfe;
            --bg-color: #0f0f1a;
            --card-bg: #1a1a2e;
            --text-color: #ffffff;
            --green: #00b894;
            --red: #e74c3c;
            --gold: #f1c40f;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Tajawal', sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color); 
            min-height: 100vh;
            padding-bottom: 100px;
        }
        
        /* ÿßŸÑŸáŸäÿØÿ± */
        .page-header {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(108, 92, 231, 0.4);
        }
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 600px;
            margin: 0 auto;
        }
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            text-decoration: none;
        }
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        .page-title {
            font-size: 20px;
            font-weight: bold;
        }
        .header-spacer {
            width: 40px;
        }
        
        /* ÿßŸÑÿπÿØÿßÿØ ÿßŸÑÿ™ŸÜÿßÿ≤ŸÑŸä */
        .timer-bar {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.2), rgba(241, 196, 15, 0.2));
            padding: 12px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .timer-text {
            color: #f39c12;
            font-size: 14px;
        }
        .timer-countdown {
            font-weight: bold;
            color: #e74c3c;
            font-size: 16px;
        }
        
        /* ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ */
        .content {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ© */
        .empty-cart {
            text-align: center;
            padding: 60px 20px;
        }
        .empty-cart-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .empty-cart-text {
            color: #888;
            font-size: 18px;
            margin-bottom: 20px;
        }
        .shop-btn {
            display: inline-block;
            padding: 15px 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .shop-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(108, 92, 231, 0.4);
        }
        
        /* ŸÖŸÜÿ™ÿ¨ ŸÅŸä ÿßŸÑÿ≥ŸÑÿ© */
        .cart-item {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            gap: 15px;
            align-items: center;
            position: relative;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .cart-item.unavailable {
            opacity: 0.6;
            border: 2px solid var(--red);
        }
        .cart-item.price-changed {
            border: 2px solid var(--gold);
        }
        .item-image {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: rgba(108, 92, 231, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            flex-shrink: 0;
        }
        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }
        .item-info {
            flex: 1;
            min-width: 0;
        }
        .item-name {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .item-category {
            color: #888;
            font-size: 12px;
            margin-bottom: 6px;
        }
        .item-price {
            color: var(--green);
            font-weight: bold;
            font-size: 16px;
        }
        .item-status {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
            margin-top: 4px;
        }
        .status-available {
            background: rgba(0, 184, 148, 0.2);
            color: var(--green);
        }
        .status-sold {
            background: rgba(231, 76, 60, 0.2);
            color: var(--red);
        }
        .status-price-changed {
            background: rgba(241, 196, 15, 0.2);
            color: var(--gold);
        }
        .delete-btn {
            background: rgba(231, 76, 60, 0.2);
            border: none;
            color: var(--red);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .delete-btn:hover {
            background: var(--red);
            color: white;
            transform: scale(1.1);
        }
        
        /* ÿßŸÑŸÖŸÑÿÆÿµ */
        .cart-summary {
            background: linear-gradient(135deg, var(--card-bg), rgba(108, 92, 231, 0.1));
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(108, 92, 231, 0.3);
        }
        .summary-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 16px;
            text-align: center;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .summary-row:last-child {
            border-bottom: none;
        }
        .summary-label {
            color: #888;
        }
        .summary-value {
            font-weight: bold;
        }
        .summary-total {
            font-size: 20px;
            color: var(--green);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid rgba(255,255,255,0.1);
        }
        .balance-info {
            text-align: center;
            padding: 15px;
            background: rgba(0, 184, 148, 0.1);
            border-radius: 12px;
            margin-top: 15px;
        }
        .balance-current {
            color: #888;
            font-size: 14px;
        }
        .balance-amount {
            color: var(--green);
            font-size: 24px;
            font-weight: bold;
        }
        .balance-after {
            color: #888;
            font-size: 13px;
            margin-top: 8px;
        }
        .insufficient-balance {
            background: rgba(231, 76, 60, 0.1);
            color: var(--red);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
        }
        
        /* ÿ≤ÿ± ÿßŸÑÿ¥ÿ±ÿßÿ° */
        .checkout-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--green), #00cec9);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
            font-family: 'Tajawal', sans-serif;
        }
        .checkout-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 184, 148, 0.4);
        }
        .checkout-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .charge-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            text-align: center;
            text-decoration: none;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s;
        }
        
        /* ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ£ŸÉŸäÿØ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        .modal-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .modal-text {
            color: #888;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .modal-items {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: right;
            max-height: 200px;
            overflow-y: auto;
        }
        .modal-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 14px;
        }
        .modal-item:last-child {
            border-bottom: none;
        }
        .modal-total {
            font-size: 18px;
            font-weight: bold;
            padding-top: 10px;
            margin-top: 10px;
            border-top: 2px solid rgba(255,255,255,0.1);
            color: var(--green);
        }
        .modal-btns {
            display: flex;
            gap: 10px;
        }
        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s;
        }
        .btn-confirm {
            background: linear-gradient(135deg, var(--green), #00cec9);
            color: white;
        }
        .btn-cancel {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        /* ÿßŸÑÿ™Ÿàÿ≥ÿ™ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--card-bg);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1001;
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast.success {
            border-left: 4px solid var(--green);
        }
        .toast.error {
            border-left: 4px solid var(--red);
        }
        
        /* ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ */
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(108, 92, 231, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="header-content">
            <a href="/" class="back-btn">‚Üí</a>
            <div class="page-title">üõí ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ</div>
            <div class="header-spacer"></div>
        </div>
    </div>
    
    <div class="timer-bar" id="timerBar" style="display: none;">
        <span class="timer-text">‚è∞ ÿ™ŸÜÿ™ŸáŸä ÿßŸÑÿ≥ŸÑÿ© ÿÆŸÑÿßŸÑ: </span>
        <span class="timer-countdown" id="timerCountdown">--:--:--</span>
    </div>
    
    <div class="content">
        <div class="loading" id="loadingDiv">
            <div class="spinner"></div>
            <p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ŸÑÿ©...</p>
        </div>
        
        <div id="cartContent" style="display: none;">
            <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®ŸÄ JavaScript -->
        </div>
    </div>
    
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ£ŸÉŸäÿØ -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-icon">‚ö†Ô∏è</div>
            <div class="modal-title">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ¥ÿ±ÿßÿ°</div>
            <div class="modal-text">ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ¥ÿ±ÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑÿ≥ŸÑÿ©ÿü</div>
            <div class="modal-items" id="modalItems"></div>
            <div class="modal-total" id="modalTotal"></div>
            <div class="modal-btns">
                <button class="modal-btn btn-confirm" onclick="processCheckout()">‚úÖ ÿ™ÿ£ŸÉŸäÿØ</button>
                <button class="modal-btn btn-cancel" onclick="closeModal()">‚ùå ÿ•ŸÑÿ∫ÿßÿ°</button>
            </div>
        </div>
    </div>
    
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠ -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="modal-icon">üéâ</div>
            <div class="modal-title">ÿ™ŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ° ÿ®ŸÜÿ¨ÿßÿ≠!</div>
            <div class="modal-text" id="successText"></div>
            <button class="modal-btn btn-confirm" onclick="window.location.href='/my_purchases'" style="width: 100%;">üì¶ ÿπÿ±ÿ∂ ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™Ÿä</button>
        </div>
    </div>
    
    <!-- ÿ™Ÿàÿ≥ÿ™ -->
    <div class="toast" id="toast"></div>
    
    <script>
        const userId = '{{ user_id }}';
        const userBalance = {{ balance }};
        let cartData = null;
        let countdownInterval = null;
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ŸÑÿ©
        async function loadCart() {
            try {
                const response = await fetch('/api/cart/get?user_id=' + userId);
                const data = await response.json();
                
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('cartContent').style.display = 'block';
                
                if (data.status === 'success') {
                    cartData = data.cart;
                    renderCart();
                    startCountdown(data.cart.expires_at);
                } else {
                    renderEmptyCart();
                }
            } catch (error) {
                console.error('Error loading cart:', error);
                document.getElementById('loadingDiv').style.display = 'none';
                document.getElementById('cartContent').innerHTML = '<div class="empty-cart"><div class="empty-cart-icon">‚ùå</div><div class="empty-cart-text">ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ŸÑÿ©</div></div>';
            }
        }
        
        // ÿπÿ±ÿ∂ ÿßŸÑÿ≥ŸÑÿ©
        function renderCart() {
            const content = document.getElementById('cartContent');
            
            if (!cartData || !cartData.items || cartData.items.length === 0) {
                renderEmptyCart();
                return;
            }
            
            let html = '';
            let total = 0;
            let availableCount = 0;
            let hasUnavailable = false;
            
            cartData.items.forEach((item, index) => {
                const statusClass = item.sold ? 'unavailable' : (item.price_changed ? 'price-changed' : '');
                const statusBadge = item.sold ? 
                    '<span class="item-status status-sold">‚ùå ŸÜŸÅÿØ</span>' : 
                    (item.price_changed ? 
                        '<span class="item-status status-price-changed">üí∞ ÿ™ÿ∫Ÿäÿ± ÿßŸÑÿ≥ÿπÿ±</span>' : 
                        '<span class="item-status status-available">‚úÖ ŸÖÿ™ÿßÿ≠</span>');
                
                if (!item.sold) {
                    total += item.current_price || item.price;
                    availableCount++;
                } else {
                    hasUnavailable = true;
                }
                
                html += `
                    <div class="cart-item ${statusClass}" data-id="${item.product_id}">
                        <div class="item-image">
                            ${item.image_url ? `<img src="${item.image_url}" onerror="this.parentElement.innerHTML='üéÅ'">` : 'üéÅ'}
                        </div>
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-category">${item.category || 'ÿπÿßŸÖ'} ${item.delivery_type === 'manual' ? '<span style="color:#f39c12;font-size:11px;">üë®‚Äçüíº ŸäÿØŸàŸä</span>' : ''}</div>
                            <div class="item-price">${item.current_price || item.price} ÿ±.ÿ≥</div>
                            ${statusBadge}
                            ${item.delivery_type === 'manual' && item.buyer_details ? `
                                <div style="margin-top:8px;padding:8px;background:rgba(241,196,15,0.1);border-radius:8px;font-size:12px;color:#f39c12;">
                                    üìù ${item.buyer_details}
                                </div>
                            ` : ''}
                        </div>
                        <button class="delete-btn" onclick="removeItem('${item.product_id}')">üóëÔ∏è</button>
                    </div>
                `;
            });
            
            // ÿßŸÑŸÖŸÑÿÆÿµ
            const balanceAfter = userBalance - total;
            const canCheckout = balanceAfter >= 0 && availableCount > 0;
            
            html += `
                <div class="cart-summary">
                    <div class="summary-title">üìã ŸÖŸÑÿÆÿµ ÿßŸÑÿ∑ŸÑÿ®</div>
                    <div class="summary-row">
                        <span class="summary-label">üì¶ ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™:</span>
                        <span class="summary-value">${availableCount}</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span class="summary-label">üí∞ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</span>
                        <span class="summary-value">${total.toFixed(2)} ÿ±.ÿ≥</span>
                    </div>
                    <div class="balance-info">
                        <div class="balance-current">ÿ±ÿµŸäÿØŸÉ ÿßŸÑÿ≠ÿßŸÑŸä</div>
                        <div class="balance-amount">${userBalance.toFixed(2)} ÿ±.ÿ≥</div>
                        <div class="balance-after">ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ÿ®ÿπÿØ ÿßŸÑÿ¥ÿ±ÿßÿ°: ${balanceAfter.toFixed(2)} ÿ±.ÿ≥</div>
                    </div>
                    ${balanceAfter < 0 ? `
                        <div class="insufficient-balance">
                            ‚ö†Ô∏è ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä! ÿ™ÿ≠ÿ™ÿßÿ¨ ${Math.abs(balanceAfter).toFixed(2)} ÿ±.ÿ≥ ÿ•ÿ∂ÿßŸÅŸäÿ©
                        </div>
                        <a href="/wallet?user_id=${userId}" class="charge-btn">üí≥ ÿ¥ÿ≠ŸÜ ÿßŸÑÿ±ÿµŸäÿØ</a>
                    ` : ''}
                    ${hasUnavailable ? `
                        <div class="insufficient-balance" style="background: rgba(241, 196, 15, 0.1); color: #f39c12;">
                            ‚ö†Ô∏è ÿ®ÿπÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ÿ© Ÿàÿ≥Ÿäÿ™ŸÖ ÿ™ÿ¨ÿßŸáŸÑŸáÿß
                        </div>
                    ` : ''}
                    <button class="checkout-btn" onclick="showConfirmModal()" ${!canCheckout ? 'disabled' : ''}>
                        ${canCheckout ? '‚úÖ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ°' : (balanceAfter < 0 ? 'üí≥ ÿßÿ¥ÿ≠ŸÜ ÿ£ŸàŸÑÿßŸã' : 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©')}
                    </button>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        // ÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©
        function renderEmptyCart() {
            document.getElementById('timerBar').style.display = 'none';
            document.getElementById('cartContent').innerHTML = `
                <div class="empty-cart">
                    <div class="empty-cart-icon">üõí</div>
                    <div class="empty-cart-text">ÿ≥ŸÑÿ™ŸÉ ŸÅÿßÿ±ÿ∫ÿ©</div>
                    <a href="/" class="shop-btn">üè™ ÿ™ÿµŸÅÿ≠ ÿßŸÑŸÖÿ™ÿ¨ÿ±</a>
                </div>
            `;
        }
        
        // ÿ≠ÿ∞ŸÅ ŸÖŸÜÿ™ÿ¨
        async function removeItem(productId) {
            try {
                const response = await fetch('/api/cart/remove', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: userId, product_id: productId })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showToast('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÖŸÜ ÿßŸÑÿ≥ŸÑÿ©', 'success');
                    loadCart();
                } else {
                    showToast(data.message || 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£', 'error');
                }
            } catch (error) {
                showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ', 'error');
            }
        }
        
        // ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ£ŸÉŸäÿØ
        function showConfirmModal() {
            if (!cartData || !cartData.items) return;
            
            const availableItems = cartData.items.filter(i => !i.sold);
            let total = 0;
            
            let itemsHtml = '';
            availableItems.forEach(item => {
                const price = item.current_price || item.price;
                total += price;
                itemsHtml += `
                    <div class="modal-item">
                        <span>${item.name}</span>
                        <span>${price} ÿ±.ÿ≥</span>
                    </div>
                `;
            });
            
            document.getElementById('modalItems').innerHTML = itemsHtml;
            document.getElementById('modalTotal').innerHTML = `ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${total.toFixed(2)} ÿ±.ÿ≥`;
            document.getElementById('confirmModal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('confirmModal').classList.remove('show');
        }
        
        // ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ¥ÿ±ÿßÿ°
        async function processCheckout() {
            closeModal();
            
            const checkoutBtn = document.querySelector('.checkout-btn');
            checkoutBtn.textContent = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ¥ÿ±ÿßÿ°...';
            checkoutBtn.disabled = true;
            
            try {
                const response = await fetch('/api/cart/checkout', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('successText').innerHTML = `
                        ÿ™ŸÖ ÿ¥ÿ±ÿßÿ° ${data.purchased_count} ŸÖŸÜÿ™ÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠!<br>
                        <small style="color: #888;">ÿ≥ÿ™ÿ¨ÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿµŸÅÿ≠ÿ© ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™Ÿä ŸàŸÅŸä ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ®Ÿàÿ™</small>
                    `;
                    document.getElementById('successModal').classList.add('show');
                } else {
                    showToast(data.message || 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£', 'error');
                    checkoutBtn.textContent = '‚úÖ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ°';
                    checkoutBtn.disabled = false;
                }
            } catch (error) {
                showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ', 'error');
                checkoutBtn.textContent = '‚úÖ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ°';
                checkoutBtn.disabled = false;
            }
        }
        
        // ÿßŸÑÿπÿØÿßÿØ ÿßŸÑÿ™ŸÜÿßÿ≤ŸÑŸä
        function startCountdown(expiresAt) {
            if (!expiresAt) return;
            
            document.getElementById('timerBar').style.display = 'block';
            
            function updateTimer() {
                const now = new Date().getTime();
                const expiry = new Date(expiresAt).getTime();
                const diff = expiry - now;
                
                if (diff <= 0) {
                    document.getElementById('timerCountdown').textContent = 'ÿßŸÜÿ™Ÿáÿ™!';
                    clearInterval(countdownInterval);
                    loadCart();
                    return;
                }
                
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                document.getElementById('timerCountdown').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }
        
        // ÿßŸÑÿ™Ÿàÿ≥ÿ™
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ŸÑÿ© ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿµŸÅÿ≠ÿ©
        window.addEventListener('DOMContentLoaded', loadCart);
    </script>
</body>
</html>
"""

@app.route('/cart')
def cart_page():
    """ÿµŸÅÿ≠ÿ© ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ"""
    user_id = session.get('user_id')
    if not user_id:
        return redirect('/')
    
    balance = get_balance(user_id)
    return render_template('cart.html', user_id=user_id, balance=balance)

# --- API ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ ---

@app.route('/api/cart/add', methods=['POST'])
@limiter.limit("30 per minute")
def api_cart_add():
    """ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ŸÑŸÑÿ≥ŸÑÿ©"""
    try:
        data = request.json
        user_id = str(data.get('user_id'))
        product_id = data.get('product_id')
        buyer_details = data.get('buyer_details', '')  # ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä ŸÑŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸäÿØŸàŸä
        
        if not user_id or not product_id:
            return jsonify({'status': 'error', 'message': 'ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿßŸÇÿµÿ©'})
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖŸÜÿ™ÿ¨
        product_doc = db.collection('products').document(product_id).get()
        if not product_doc.exists:
            return jsonify({'status': 'error', 'message': 'ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ'})
        
        product = product_doc.to_dict()
        
        # ŸÖŸÜÿπ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ŸÖÿ®ÿßÿπ
        if product.get('sold', False):
            return jsonify({'status': 'error', 'message': 'ÿπÿ∞ÿ±ÿßŸãÿå Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ™ŸÖ ÿ®ŸäÿπŸá! üö´'})
        
        # ÿ¨ŸÑÿ® ÿ£Ÿà ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≥ŸÑÿ©
        from datetime import datetime, timedelta
        
        cart = user_carts.get(user_id, {})
        now = datetime.utcnow()
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿ≥ŸÑÿ©
        if cart.get('expires_at'):
            expires = cart['expires_at']
            if isinstance(expires, str):
                expires = datetime.fromisoformat(expires.replace('Z', ''))
            if expires < now:
                cart = {}  # ÿßŸÑÿ≥ŸÑÿ© ÿßŸÜÿ™Ÿáÿ™
        
        # ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ŸÑÿ© ÿ¨ÿØŸäÿØÿ© ÿ£Ÿà ÿ™ÿ≠ÿØŸäÿ´
        if not cart.get('items'):
            cart = {
                'items': [],
                'created_at': now.isoformat(),
                'expires_at': (now + timedelta(hours=3)).isoformat(),
                'status': 'active'
            }
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÅŸä ÿßŸÑÿ≥ŸÑÿ©
        existing_ids = [item['product_id'] for item in cart.get('items', [])]
        if product_id in existing_ids:
            return jsonify({'status': 'error', 'message': 'ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑÿ≥ŸÑÿ© ÿ®ÿßŸÑŸÅÿπŸÑ!'})
        
        # ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨
        cart_item = {
            'product_id': product_id,
            'name': product.get('item_name', 'ŸÖŸÜÿ™ÿ¨'),
            'price': float(product.get('price', 0)),
            'category': product.get('category', ''),
            'image_url': product.get('image_url', ''),
            'delivery_type': product.get('delivery_type', 'instant'),
            'buyer_instructions': product.get('buyer_instructions', ''),
            'buyer_details': buyer_details,  # ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä ÿßŸÑŸÖÿØÿÆŸÑÿ©
            'added_at': now.isoformat()
        }
        cart['items'].append(cart_item)
        cart['updated_at'] = now.isoformat()
        
        # ÿ≠ŸÅÿ∏ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© Ÿà Firebase
        user_carts[user_id] = cart
        
        if db:
            db.collection('carts').document(user_id).set(cart)
        
        # ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨
        try:
            stats_ref = db.collection('cart_stats').document(product_id)
            stats_doc = stats_ref.get()
            if stats_doc.exists:
                stats_ref.update({'add_to_cart_count': firestore.Increment(1)})
            else:
                stats_ref.set({'product_id': product_id, 'add_to_cart_count': 1, 'purchase_count': 0})
        except:
            pass
        
        return jsonify({
            'status': 'success',
            'message': 'ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ©! üõí',
            'cart_count': len(cart['items'])
        })
        
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ©: {e}")
        return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£'})

@app.route('/api/cart/get')
def api_cart_get():
    """ÿ¨ŸÑÿ® ŸÖÿ≠ÿ™ŸàŸäÿßÿ™ ÿßŸÑÿ≥ŸÑÿ©"""
    try:
        user_id = request.args.get('user_id')
        if not user_id:
            return jsonify({'status': 'error', 'message': 'ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ∑ŸÑŸàÿ®'})
        
        from datetime import datetime
        
        cart = user_carts.get(str(user_id), {})
        
        if not cart or not cart.get('items'):
            return jsonify({'status': 'empty', 'message': 'ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©'})
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©
        now = datetime.utcnow()
        expires_at = cart.get('expires_at')
        if expires_at:
            if isinstance(expires_at, str):
                expires = datetime.fromisoformat(expires_at.replace('Z', ''))
            else:
                expires = expires_at
            if expires < now:
                # ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≥ŸÑÿ© ÿßŸÑŸÖŸÜÿ™ŸáŸäÿ©
                user_carts.pop(str(user_id), None)
                if db:
                    db.collection('carts').document(str(user_id)).delete()
                return jsonify({'status': 'expired', 'message': 'ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ≥ŸÑÿ©'})
        
        # ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
        updated_items = []
        for item in cart['items']:
            product_doc = db.collection('products').document(item['product_id']).get()
            if product_doc.exists:
                product = product_doc.to_dict()
                item['sold'] = product.get('sold', False)
                item['current_price'] = float(product.get('price', item['price']))
                item['price_changed'] = item['current_price'] != item['price']
                updated_items.append(item)
            else:
                item['sold'] = True  # ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÖÿ≠ÿ∞ŸàŸÅ
                updated_items.append(item)
        
        cart['items'] = updated_items
        
        return jsonify({
            'status': 'success',
            'cart': cart
        })
        
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿßŸÑÿ≥ŸÑÿ©: {e}")
        return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£'})

@app.route('/api/cart/remove', methods=['POST'])
def api_cart_remove():
    """ÿ≠ÿ∞ŸÅ ŸÖŸÜÿ™ÿ¨ ŸÖŸÜ ÿßŸÑÿ≥ŸÑÿ©"""
    try:
        data = request.json
        user_id = str(data.get('user_id'))
        product_id = data.get('product_id')
        
        if not user_id or not product_id:
            return jsonify({'status': 'error', 'message': 'ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿßŸÇÿµÿ©'})
        
        cart = user_carts.get(user_id, {})
        if not cart or not cart.get('items'):
            return jsonify({'status': 'error', 'message': 'ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©'})
        
        # ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨
        cart['items'] = [i for i in cart['items'] if i['product_id'] != product_id]
        
        from datetime import datetime
        cart['updated_at'] = datetime.utcnow().isoformat()
        
        # ÿ≠ŸÅÿ∏
        user_carts[user_id] = cart
        if db:
            db.collection('carts').document(user_id).set(cart)
        
        return jsonify({
            'status': 'success',
            'message': 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨',
            'cart_count': len(cart['items'])
        })
        
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ŸÖŸÜ ÿßŸÑÿ≥ŸÑÿ©: {e}")
        return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£'})

@app.route('/api/cart/checkout', methods=['POST'])
@limiter.limit("5 per minute")
def api_cart_checkout():
    """ÿ•ÿ™ŸÖÿßŸÖ ÿ¥ÿ±ÿßÿ° ÿßŸÑÿ≥ŸÑÿ©"""
    try:
        data = request.json
        user_id = str(data.get('user_id'))
        
        if not user_id:
            return jsonify({'status': 'error', 'message': 'ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ∑ŸÑŸàÿ®'})
        
        # ÿ¨ŸÑÿ® ÿßŸÑÿ≥ŸÑÿ©
        cart = user_carts.get(user_id, {})
        if not cart or not cart.get('items'):
            return jsonify({'status': 'error', 'message': 'ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©'})
        
        # ÿ™ÿµŸÅŸäÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©
        available_items = []
        total = 0
        
        for item in cart['items']:
            product_doc = db.collection('products').document(item['product_id']).get()
            if product_doc.exists:
                product = product_doc.to_dict()
                if not product.get('sold', False):
                    item['product_data'] = product
                    item['current_price'] = float(product.get('price', item['price']))
                    total += item['current_price']
                    available_items.append(item)
        
        if not available_items:
            return jsonify({'status': 'error', 'message': 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ŸÅŸä ÿßŸÑÿ≥ŸÑÿ©'})
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ
        user_doc = db.collection('users').document(user_id).get()
        if not user_doc.exists:
            return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ'})
        
        user_data = user_doc.to_dict()
        balance = float(user_data.get('balance', 0))
        
        if balance < total:
            return jsonify({'status': 'error', 'message': f'ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä! ÿ™ÿ≠ÿ™ÿßÿ¨ {total - balance:.2f} ÿ±.ÿ≥ ÿ•ÿ∂ÿßŸÅŸäÿ©'})
        
        # ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ¥ÿ±ÿßÿ° ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ batch
        batch = db.batch()
        new_balance = balance - total
        purchased_items = []
        order_ids = []
        
        # ÿ¨ŸÑÿ® ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä
        buyer_name = user_data.get('first_name', 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ')
        
        for item in available_items:
            product = item['product_data']
            product_id = item['product_id']
            delivery_type = item.get('delivery_type', product.get('delivery_type', 'instant'))
            order_status = 'completed' if delivery_type == 'instant' else 'pending'
            
            # ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÉŸÖÿ®ÿßÿπ
            product_ref = db.collection('products').document(product_id)
            batch.update(product_ref, {
                'sold': True,
                'buyer_id': user_id,
                'buyer_name': buyer_name,
                'sold_at': firestore.SERVER_TIMESTAMP
            })
            
            # ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∑ŸÑÿ®
            import random
            order_id = f"ORD_{random.randint(100000, 999999)}"
            order_ref = db.collection('orders').document(order_id)
            batch.set(order_ref, {
                'buyer_id': user_id,
                'buyer_name': buyer_name,
                'item_name': product.get('item_name'),
                'price': item['current_price'],
                'hidden_data': product.get('hidden_data'),
                'details': product.get('details', ''),
                'category': product.get('category', ''),
                'delivery_type': delivery_type,
                'buyer_details': item.get('buyer_details', ''),  # ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä ŸÑŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸäÿØŸàŸä
                'buyer_instructions': item.get('buyer_instructions', ''),
                'status': order_status,
                'from_cart': True,
                'created_at': firestore.SERVER_TIMESTAMP
            })
            
            order_ids.append(order_id)
            purchased_items.append({
                'name': product.get('item_name'),
                'price': item['current_price'],
                'hidden_data': product.get('hidden_data'),
                'order_id': order_id,
                'delivery_type': delivery_type,
                'buyer_details': item.get('buyer_details', '')
            })
            
            # ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
            try:
                stats_ref = db.collection('cart_stats').document(product_id)
                batch.update(stats_ref, {'purchase_count': firestore.Increment(1)})
            except:
                pass
        
        # ÿ™ÿ≠ÿØŸäÿ´ ÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        user_ref = db.collection('users').document(user_id)
        batch.update(user_ref, {'balance': new_balance})
        
        # ÿ™ŸÜŸÅŸäÿ∞ ŸÉŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™
        batch.commit()
        
        # ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
        users_wallets[user_id] = new_balance
        
        # ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≥ŸÑÿ©
        user_carts.pop(user_id, None)
        db.collection('carts').document(user_id).delete()
        
        # ŸÅÿµŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÅŸàÿ±Ÿäÿ© ÿπŸÜ ÿßŸÑŸäÿØŸàŸäÿ©
        instant_items = [i for i in purchased_items if i.get('delivery_type') == 'instant']
        manual_items = [i for i in purchased_items if i.get('delivery_type') == 'manual']
        
        # ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑŸÖÿ¥ÿ™ÿ±Ÿä ÿπÿ®ÿ± ÿßŸÑÿ®Ÿàÿ™
        try:
            msg = "üéâ ÿ™ŸÖ ÿ¥ÿ±ÿßÿ° ÿ≥ŸÑÿ™ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠!\n\n"
            
            # ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÅŸàÿ±Ÿäÿ©
            if instant_items:
                msg += "‚ö° ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ™ÿ≥ŸÑŸäŸÖ ŸÅŸàÿ±Ÿä:\n"
                for item in instant_items:
                    msg += f"üì¶ {item['name']}\n"
                    msg += f"üí∞ {item['price']} ÿ±.ÿ≥\n"
                    msg += f"üÜî #{item['order_id']}\n"
                    if item.get('hidden_data'):
                        msg += f"üîê ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:\n{item['hidden_data']}\n"
                    msg += "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
            
            # ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸäÿØŸàŸäÿ©
            if manual_items:
                msg += "\nüë®‚Äçüíº ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ™ÿ≥ŸÑŸäŸÖ ŸäÿØŸàŸä (ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÜŸÅŸäÿ∞):\n"
                for item in manual_items:
                    msg += f"üì¶ {item['name']}\n"
                    msg += f"üí∞ {item['price']} ÿ±.ÿ≥\n"
                    msg += f"üÜî #{item['order_id']}\n"
                    msg += "‚è≥ ÿ≥Ÿäÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞Ÿá ŸÇÿ±Ÿäÿ®ÿßŸã\n"
                    msg += "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
            
            msg += f"\nüí≥ ÿ±ÿµŸäÿØŸÉ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä: {new_balance:.2f} ÿ±.ÿ≥"
            
            bot.send_message(int(user_id), msg)
        except Exception as e:
            print(f"‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÑŸÑŸÖÿ¥ÿ™ÿ±Ÿä: {e}")
        
        # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ£ÿØŸÖŸÜ ŸÑŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸäÿØŸàŸäÿ©
        if manual_items:
            try:
                for item in manual_items:
                    claim_markup = telebot.types.InlineKeyboardMarkup()
                    claim_markup.add(telebot.types.InlineKeyboardButton(
                        "üìã ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ∑ŸÑÿ®", 
                        callback_data=f"claim_order_{item['order_id']}"
                    ))
                    
                    admin_msg = f"üÜï ÿ∑ŸÑÿ® ŸäÿØŸàŸä ÿ¨ÿØŸäÿØ ŸÖŸÜ ÿßŸÑÿ≥ŸÑÿ©!\n\n"
                    admin_msg += f"üÜî ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: #{item['order_id']}\n"
                    admin_msg += f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {item['name']}\n"
                    admin_msg += f"üë§ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä: {buyer_name} ({user_id})\n"
                    admin_msg += f"üí∞ ÿßŸÑÿ≥ÿπÿ±: {item['price']} ÿ±.ÿ≥\n"
                    if item.get('buyer_details'):
                        admin_msg += f"\nüìù ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä:\n{item['buyer_details']}\n"
                    admin_msg += f"\nüëá ÿßÿ∂ÿ∫ÿ∑ ŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ∑ŸÑÿ®"
                    
                    bot.send_message(ADMIN_ID, admin_msg, reply_markup=claim_markup)
            except Exception as e:
                print(f"‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ£ÿØŸÖŸÜ: {e}")
        
        # ÿ•ÿ¥ÿπÿßÿ± ÿπÿßŸÖ ŸÑŸÑÿ£ÿØŸÖŸÜ
        try:
            admin_msg = f"üõí ÿ¥ÿ±ÿßÿ° ÿ≥ŸÑÿ© ÿ¨ÿØŸäÿØ!\n\n"
            admin_msg += f"üë§ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä: {buyer_name} ({user_id})\n"
            admin_msg += f"üì¶ ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™: {len(purchased_items)}\n"
            admin_msg += f"‚ö° ŸÅŸàÿ±Ÿä: {len(instant_items)} | üë®‚Äçüíº ŸäÿØŸàŸä: {len(manual_items)}\n"
            admin_msg += f"üí∞ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: {total:.2f} ÿ±.ÿ≥"
            bot.send_message(ADMIN_ID, admin_msg)
        except:
            pass
        
        return jsonify({
            'status': 'success',
            'message': 'ÿ™ŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ° ÿ®ŸÜÿ¨ÿßÿ≠!',
            'purchased_count': len(purchased_items),
            'total': total,
            'new_balance': new_balance,
            'order_ids': order_ids
        })
        
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ°: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ°'})

@app.route('/api/cart/count')
def api_cart_count():
    """ÿ¨ŸÑÿ® ÿπÿØÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ≥ŸÑÿ©"""
    user_id = request.args.get('user_id')
    if not user_id:
        return jsonify({'count': 0})
    
    cart = user_carts.get(str(user_id), {})
    count = len(cart.get('items', []))
    return jsonify({'count': count})

# ÿµŸÅÿ≠ÿ© ÿßŸÑÿ¥ÿ≠ŸÜ ÿßŸÑŸÖŸÜŸÅÿµŸÑÿ©
CHARGE_PAGE = """
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üí≥ ŸÖÿ≠ŸÅÿ∏ÿ™Ÿä - ÿ≥ŸàŸÇ ÿßŸÑÿ™ÿ¨ÿßÿ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --primary-light: #a29bfe;
            --bg-color: #0f0f1a;
            --card-bg: #1a1a2e;
            --text-color: #ffffff;
            --green: #00b894;
            --gold: #f1c40f;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Tajawal', sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color); 
            min-height: 100vh;
        }
        
        /* ÿßŸÑŸáŸäÿØÿ± */
        .page-header {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(108, 92, 231, 0.4);
        }
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 600px;
            margin: 0 auto;
        }
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            text-decoration: none;
        }
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        .page-title {
            font-size: 20px;
            font-weight: bold;
        }
        .header-spacer {
            width: 40px;
        }
        
        /* ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ */
        .page-content {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 100px;
        }
        
        /* ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ±ÿµŸäÿØ */
        .balance-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #2d2d44 100%);
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            margin-bottom: 25px;
            border: 2px solid rgba(108, 92, 231, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(108, 92, 231, 0.1) 0%, transparent 70%);
        }
        .balance-label {
            color: #888;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .balance-amount {
            font-size: 48px;
            font-weight: bold;
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }
        .balance-currency {
            color: #888;
            font-size: 16px;
        }
        
        /* ŸÇÿ≥ŸÖ ÿßŸÑÿ¥ÿ≠ŸÜ ÿ®ÿßŸÑŸÉŸàÿØ */
        .section-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--primary-light);
        }
        .section-title span {
            font-size: 24px;
        }
        
        /* ÿ≠ŸÇŸÑ ÿßŸÑŸÉŸàÿØ */
        .code-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .code-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #333;
            border-radius: 12px;
            background: #0f0f1a;
            color: white;
            font-size: 16px;
            text-align: center;
            font-family: monospace;
            letter-spacing: 2px;
            transition: border-color 0.3s;
        }
        .code-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .code-input::placeholder {
            color: #555;
            letter-spacing: 1px;
        }
        .activate-btn {
            padding: 15px 25px;
            background: linear-gradient(135deg, var(--green), #55efc4);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Tajawal', sans-serif;
        }
        .activate-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 184, 148, 0.4);
        }
        .activate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .code-hint {
            color: #666;
            font-size: 13px;
            text-align: center;
        }
        .code-hint a {
            color: var(--primary-light);
            text-decoration: none;
        }
        
        /* ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™ */
        .transaction-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        .transaction-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }
        .transaction-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .transaction-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .transaction-icon.income {
            background: linear-gradient(135deg, rgba(0, 184, 148, 0.2), rgba(85, 239, 196, 0.1));
            color: #55efc4;
        }
        .transaction-icon.expense {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.2), rgba(255, 118, 117, 0.1));
            color: #ff7675;
        }
        .transaction-details h4 {
            font-size: 15px;
            margin-bottom: 4px;
        }
        .transaction-details p {
            font-size: 12px;
            color: #666;
        }
        .transaction-amount {
            font-weight: bold;
            font-size: 16px;
        }
        .transaction-amount.income {
            color: #55efc4;
        }
        .transaction-amount.expense {
            color: #ff7675;
        }
        
        /* ÿ±ÿ≥ÿßŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ© */
        .empty-transactions {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .empty-transactions .icon {
            font-size: 50px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-light);
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 11px;
            color: #666;
        }
        
        /* ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠ */
        .success-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, var(--green), #55efc4);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            box-shadow: 0 5px 25px rgba(0, 184, 148, 0.4);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        .success-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* ÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        .balance-card {
            animation: pulse 3s infinite;
        }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="header-content">
            <a href="/" class="back-btn">‚Üê</a>
            <h1 class="page-title">üí≥ ŸÖÿ≠ŸÅÿ∏ÿ™Ÿä</h1>
            <div class="header-spacer"></div>
        </div>
    </div>
    
    <div class="page-content">
        <!-- ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ±ÿµŸäÿØ -->
        <div class="balance-card">
            <div class="balance-label">üí∞ ÿ±ÿµŸäÿØŸÉ ÿßŸÑÿ≠ÿßŸÑŸä</div>
            <div class="balance-amount" id="currentBalance">{{ balance }}</div>
            <div class="balance-currency">ÿ±ŸäÿßŸÑ ÿ≥ÿπŸàÿØŸä</div>
        </div>
        
        <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ© -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value">{{ total_charges }}</div>
                <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ¥ÿ≠ŸÜ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ charges_count }}</div>
                <div class="stat-label">ÿπÿØÿØ ÿßŸÑÿ¥ÿ≠ŸÜÿßÿ™</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ purchases_count }}</div>
                <div class="stat-label">ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™</div>
            </div>
        </div>
        
        <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿ¥ÿ≠ŸÜ ÿ®ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© -->
        <div class="section-card">
            <div class="section-title">
                <span>üí≥</span>
                ÿ¥ÿ≠ŸÜ ÿ±ÿµŸäÿØŸÉ
            </div>
            
            <form id="chargeForm" onsubmit="processPayment(event)">
                <!-- ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #dfe6e9; font-size: 14px; margin-bottom: 8px;">üì± ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ</label>
                    <div style="display: flex; gap: 10px; direction: ltr;">
                        <select id="countryCode" style="width: 100px; padding: 12px 8px; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(255,255,255,0.05); color: #fff; font-size: 14px; font-family: 'Tajawal', sans-serif; cursor: pointer;">
                            <option value="966">üá∏üá¶ +966</option>
                            <option value="971">üá¶üá™ +971</option>
                            <option value="965">üá∞üáº +965</option>
                            <option value="973">üáßüá≠ +973</option>
                            <option value="974">üá∂üá¶ +974</option>
                            <option value="968">üá¥üá≤ +968</option>
                            <option value="962">üáØüá¥ +962</option>
                            <option value="20">üá™üá¨ +20</option>
                            <option value="212">üá≤üá¶ +212</option>
                            <option value="216">üáπüá≥ +216</option>
                            <option value="213">üá©üáø +213</option>
                            <option value="964">üáÆüá∂ +964</option>
                            <option value="963">üá∏üáæ +963</option>
                            <option value="961">üá±üáß +961</option>
                            <option value="967">üáæüá™ +967</option>
                            <option value="90">üáπüá∑ +90</option>
                        </select>
                        <input type="tel" id="phoneNumber" placeholder="5xxxxxxxx" required maxlength="10"
                               style="flex: 1; padding: 12px; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(255,255,255,0.05); color: #fff; font-size: 16px; text-align: center; font-family: 'Tajawal', sans-serif;">
                    </div>
                </div>
                
                <!-- ÿßŸÑŸÖÿ®ŸÑÿ∫ -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #dfe6e9; font-size: 14px; margin-bottom: 8px;">üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ±ÿßÿØ ÿ¥ÿ≠ŸÜŸá</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="chargeAmount" placeholder="100" min="10" max="5000" required
                               style="flex: 1; padding: 12px; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(255,255,255,0.05); color: #fff; font-size: 18px; text-align: center; font-family: 'Tajawal', sans-serif;">
                        <span style="color: #b2bec3; font-size: 16px;">ÿ±ŸäÿßŸÑ</span>
                    </div>
                    <p style="color: #636e72; font-size: 12px; margin-top: 8px; text-align: center;">ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ: 10 ÿ±ŸäÿßŸÑ | ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ: 5000 ÿ±ŸäÿßŸÑ</p>
                </div>
                
                <!-- ÿ£ÿ≤ÿ±ÿßÿ± ŸÖÿ®ÿßŸÑÿ∫ ÿ≥ÿ±Ÿäÿπÿ© -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px;">
                    <button type="button" onclick="setAmount(25)" style="padding: 10px; border: 2px solid #333; border-radius: 10px; background: transparent; color: #a29bfe; font-size: 14px; cursor: pointer; transition: all 0.3s;">25</button>
                    <button type="button" onclick="setAmount(50)" style="padding: 10px; border: 2px solid #333; border-radius: 10px; background: transparent; color: #a29bfe; font-size: 14px; cursor: pointer; transition: all 0.3s;">50</button>
                    <button type="button" onclick="setAmount(100)" style="padding: 10px; border: 2px solid #333; border-radius: 10px; background: transparent; color: #a29bfe; font-size: 14px; cursor: pointer; transition: all 0.3s;">100</button>
                    <button type="button" onclick="setAmount(200)" style="padding: 10px; border: 2px solid #333; border-radius: 10px; background: transparent; color: #a29bfe; font-size: 14px; cursor: pointer; transition: all 0.3s;">200</button>
                </div>
                
                <!-- ÿ≤ÿ± ÿßŸÑÿØŸÅÿπ -->
                <button type="submit" id="payBtn" style="width: 100%; padding: 16px; border: none; border-radius: 12px; background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: white; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; font-family: 'Tajawal', sans-serif;">
                    üí≥ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿØŸÅÿπ
                </button>
            </form>
            
            <p style="text-align: center; color: #666; font-size: 12px; margin-top: 15px;">
                üîí ÿØŸÅÿπ ÿ¢ŸÖŸÜ ÿπÿ®ÿ± <span style="color: #00cec9;">EdfaPay</span>
            </p>
        </div>
        
        <!-- ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™ -->
        <div class="section-card">
            <div class="section-title">
                <span>üìú</span>
                ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™
            </div>
            
            {% if transactions %}
                {% for t in transactions %}
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-icon {{ t.type }}">
                            {% if t.type == 'income' %}‚¨ÜÔ∏è{% else %}‚¨áÔ∏è{% endif %}
                        </div>
                        <div class="transaction-details">
                            <h4>{{ t.title }}</h4>
                            <p>{{ t.date }}</p>
                        </div>
                    </div>
                    <div class="transaction-amount {{ t.type }}">
                        {% if t.type == 'income' %}+{% else %}-{% endif %}{{ t.amount }} ÿ±.ÿ≥
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-transactions">
                    <div class="icon">üìã</div>
                    <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿπÿßŸÖŸÑÿßÿ™ ÿ®ÿπÿØ</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠ -->
    <div class="success-toast" id="successToast">‚úÖ ÿ™ŸÖ ÿßŸÑÿ¥ÿ≠ŸÜ ÿ®ŸÜÿ¨ÿßÿ≠!</div>
    
    <script>
        const userId = '{{ user_id }}';
        
        function setAmount(amount) {
            document.getElementById('chargeAmount').value = amount;
        }
        
        async function processPayment(event) {
            event.preventDefault();
            
            const phone = document.getElementById('phoneNumber').value.trim();
            const countryCode = document.getElementById('countryCode').value;
            const amount = document.getElementById('chargeAmount').value;
            const btn = document.getElementById('payBtn');
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ
            if(!phone || phone.length < 7) {
                alert('‚ùå ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿ¨ŸàÿßŸÑ ÿµÿ≠Ÿäÿ≠');
                return;
            }
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫
            if(!amount || amount < 10 || amount > 5000) {
                alert('‚ùå ÿßŸÑŸÖÿ®ŸÑÿ∫ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ®ŸäŸÜ 10 Ÿà 5000 ÿ±ŸäÿßŸÑ');
                return;
            }
            
            // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿµŸÅÿ± ŸÖŸÜ ÿßŸÑÿ®ÿØÿßŸäÿ©
            let cleanPhone = phone;
            if(cleanPhone.startsWith('0')) {
                cleanPhone = cleanPhone.substring(1);
            }
            
            const fullPhone = countryCode + cleanPhone;
            
            btn.disabled = true;
            btn.textContent = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ...';
            
            try {
                const response = await fetch('/wallet/pay', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        phone: fullPhone,
                        amount: parseFloat(amount)
                    })
                });
                
                const result = await response.json();
                
                if(result.success && result.payment_url) {
                    // ÿ™Ÿàÿ¨ŸäŸá ŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿØŸÅÿπ
                    window.location.href = result.payment_url;
                } else {
                    alert('‚ùå ' + (result.message || 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£'));
                    btn.disabled = false;
                    btn.textContent = 'üí≥ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿØŸÅÿπ';
                }
            } catch(error) {
                alert('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ');
                btn.disabled = false;
                btn.textContent = 'üí≥ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿØŸÅÿπ';
            }
        }
        
        function showToast(message) {
            const toast = document.getElementById('successToast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
"""

@app.route('/wallet')
def wallet_page():
    """ÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ© ŸàÿßŸÑÿ¥ÿ≠ŸÜ"""
    # ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ŸÅŸÇÿ∑ ŸÑŸÖŸÜÿπ ÿ™ÿ≥ÿ±Ÿäÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
    user_id = session.get('user_id')
    
    if not user_id:
        return redirect('/')
    
    # ÿ¨ŸÑÿ® ÿßŸÑÿ±ÿµŸäÿØ
    balance = get_balance(user_id)
    
    # ÿ¨ŸÑÿ® ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™ ŸÖŸÜ Firebase
    transactions = []
    total_charges = 0
    charges_count = 0
    purchases_count = 0
    
    try:
        # ÿ¨ŸÑÿ® ÿßŸÑÿ¥ÿ≠ŸÜÿßÿ™
        charges_ref = query_where(db.collection('charge_history'), 'user_id', '==', str(user_id))
        for doc in charges_ref.stream():
            data = doc.to_dict()
            amount = data.get('amount', 0)
            total_charges += amount
            charges_count += 1
            transactions.append({
                'type': 'income',
                'title': 'ÿ¥ÿ≠ŸÜ ÿ±ÿµŸäÿØ',
                'amount': amount,
                'date': data.get('date', 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'),
                'timestamp': data.get('timestamp', 0)
            })
        
        # ÿ¨ŸÑÿ® ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ (ŸÑŸÑÿ≥ÿ¨ŸÑ ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™)
        orders_ref = query_where(db.collection('orders'), 'buyer_id', '==', str(user_id))
        for doc in orders_ref.stream():
            data = doc.to_dict()
            purchases_count += 1
            
            # ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
            date_str = 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'
            timestamp_val = 0
            if data.get('created_at'):
                try:
                    created = data['created_at']
                    if hasattr(created, 'seconds'):
                        timestamp_val = created.seconds
                        from datetime import datetime, timedelta, timezone
                        utc_time = datetime.fromtimestamp(created.seconds, tz=timezone.utc)
                        saudi_time = utc_time + timedelta(hours=3)
                        date_str = saudi_time.strftime('%Y-%m-%d %H:%M')
                    elif isinstance(created, datetime):
                        timestamp_val = created.timestamp()
                        saudi_time = created + timedelta(hours=3)
                        date_str = saudi_time.strftime('%Y-%m-%d %H:%M')
                except:
                    pass
            
            # ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ÿ¨ŸÑ ŸÉÿÆÿµŸÖ
            transactions.append({
                'type': 'expense',
                'title': f"ÿ¥ÿ±ÿßÿ° {data.get('item_name', 'ŸÖŸÜÿ™ÿ¨')}",
                'amount': data.get('price', 0),
                'date': date_str,
                'timestamp': timestamp_val
            })
        
        # ÿ™ÿ±ÿ™Ÿäÿ® ŸÖŸÜ ÿßŸÑÿ£ÿ≠ÿØÿ´
        transactions.sort(key=lambda x: x.get('timestamp', 0), reverse=True)
        transactions = transactions[:15]  # ÿ¢ÿÆÿ± 15 ŸÖÿπÿßŸÖŸÑÿ©
        
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™: {e}")
    
    return render_template('wallet.html', 
                                  user_id=user_id,
                                  balance=balance,
                                  transactions=transactions,
                                  total_charges=total_charges,
                                  charges_count=charges_count,
                                  purchases_count=purchases_count)

# ===== ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿØŸÅÿπ ŸÖŸÜ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ© =====
@app.route('/wallet/pay', methods=['POST'])
@limiter.limit("5 per minute")
def wallet_pay():
    """ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ® ÿßŸÑÿ¥ÿ≠ŸÜ ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©"""
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
    user_id = session.get('user_id')
    if not user_id:
        return jsonify({'success': False, 'message': 'Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã'})
    
    try:
        data = request.json
        phone = data.get('phone', '').strip()
        amount = float(data.get('amount', 0))
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        if not phone or len(phone) < 10:
            return jsonify({'success': False, 'message': 'ÿ±ŸÇŸÖ ÿ¨ŸàÿßŸÑ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠'})
        
        if amount < 10 or amount > 5000:
            return jsonify({'success': False, 'message': 'ÿßŸÑŸÖÿ®ŸÑÿ∫ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ®ŸäŸÜ 10 Ÿà 5000 ÿ±ŸäÿßŸÑ'})
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ EdfaPay
        if not EDFAPAY_MERCHANT_ID or not EDFAPAY_PASSWORD:
            return jsonify({'success': False, 'message': 'ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿØŸÅÿπ ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©'})
        
        # ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÜŸÅÿ≥ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ ÿ®ÿßŸÑÿ∂ÿ®ÿ∑
        amount_int = int(amount)
        order_id = f"TR{user_id}{int(time.time())}"
        order_description = f"Recharge {amount_int} SAR"
        
        # ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÄ hash - ŸÜŸÅÿ≥ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ ÿ®ÿßŸÑÿ∂ÿ®ÿ∑
        to_hash = f"{order_id}{amount_int}SAR{order_description}{EDFAPAY_PASSWORD}".upper()
        md5_hash = hashlib.md5(to_hash.encode()).hexdigest()
        final_hash = hashlib.sha1(md5_hash.encode()).hexdigest()
        
        # ÿ•ŸÜÿ¥ÿßÿ° ÿ∑ŸÑÿ® EdfaPay - ŸÜŸÅÿ≥ ÿßŸÑÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ
        payload = {
            'action': 'SALE',
            'edfa_merchant_id': EDFAPAY_MERCHANT_ID,
            'order_id': order_id,
            'order_amount': str(amount_int),
            'order_currency': 'SAR',
            'order_description': order_description,
            'req_token': 'N',
            'payer_first_name': 'Customer',
            'payer_last_name': 'User',
            'payer_address': 'Riyadh',
            'payer_country': 'SA',
            'payer_city': 'Riyadh',
            'payer_zip': '12221',
            'payer_email': f'user{user_id}@telegram.com',
            'payer_phone': '966500000000',
            'payer_ip': '176.44.76.222',
            'term_url_3ds': f"{SITE_URL}/payment/success?order_id={order_id}",
            'auth': 'N',
            'recurring_init': 'N',
            'hash': final_hash
        }
        
        print(f"üì§ Wallet Pay Request: {payload}")
        
        response = requests.post(EDFAPAY_API_URL, data=payload, timeout=30)
        
        print(f"üì• EdfaPay Raw Response: {response.text}")
        
        try:
            result = response.json()
        except:
            print(f"‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ JSON: {response.text}")
            return jsonify({'success': False, 'message': 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿØŸÅÿπ - ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ'})
        
        print(f"üì• EdfaPay Response: {result}")
        
        if response.status_code == 200 and result.get('redirect_url'):
            payment_url = result.get('redirect_url')
            
            # ÿ≠ŸÅÿ∏ ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑŸÖÿπŸÑŸÇ
            pending_payments[order_id] = {
                'user_id': str(user_id),
                'amount': amount,
                'order_id': order_id,
                'phone': phone,
                'status': 'pending',
                'created_at': time.time()
            }
            
            # ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
            try:
                db.collection('pending_payments').document(order_id).set({
                    'user_id': str(user_id),
                    'amount': amount,
                    'order_id': order_id,
                    'phone': phone,
                    'status': 'pending',
                    'created_at': firestore.SERVER_TIMESTAMP
                })
            except Exception as e:
                print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ∑ŸÑÿ®: {e}")
            
            return jsonify({
                'success': True,
                'payment_url': payment_url,
                'order_id': order_id
            })
        else:
            error_msg = result.get('message') or result.get('error') or result.get('error_message') or 'ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿ∑ŸÑÿ® ÿßŸÑÿØŸÅÿπ'
            print(f"‚ùå EdfaPay Error: {error_msg}")
            return jsonify({'success': False, 'message': error_msg})
            
    except requests.exceptions.Timeout:
        print(f"‚ùå Wallet Pay Timeout")
        return jsonify({'success': False, 'message': 'ÿßŸÜÿ™ŸáŸâ ŸàŸÇÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ - ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ'})
    except requests.exceptions.RequestException as e:
        print(f"‚ùå Wallet Pay Request Error: {e}")
        return jsonify({'success': False, 'message': 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿØŸÅÿπ'})
    except Exception as e:
        print(f"‚ùå Wallet Pay Error: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'message': f'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: {str(e)}'})

# ÿµŸÅÿ≠ÿ© ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™Ÿä ÿßŸÑŸÖŸÜŸÅÿµŸÑÿ©
MY_PURCHASES_PAGE = """
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™Ÿä - ÿ≥ŸàŸÇ ÿßŸÑÿ™ÿ¨ÿßÿ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --bg-color: #0f0f0f;
            --text-color: #ffffff;
            --card-bg: #1a1a2e;
            --green: #00b894;
            --accent: #a29bfe;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Tajawal', sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color); 
            min-height: 100vh;
        }
        
        /* ÿßŸÑŸáŸäÿØÿ± */
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 800px;
            margin: 0 auto;
        }
        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            text-decoration: none;
        }
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        .page-title {
            font-size: 24px;
            font-weight: bold;
        }
        .purchases-count {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ */
        .page-content {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 40px;
        }
        
        /* ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© */
        .purchase-card {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 16px;
            border: 1px solid rgba(162, 155, 254, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .purchase-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.2);
        }
        .card-main {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .card-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }
        .card-info {
            flex: 1;
            min-width: 0;
        }
        .card-title {
            font-size: 17px;
            font-weight: bold;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        .meta-item {
            font-size: 13px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .meta-item.price {
            color: #00b894;
            font-weight: bold;
            font-size: 15px;
        }
        .card-badge {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }
        .card-badge.pending {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
        }
        .card-badge.claimed {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
        }
        .card-badge.completed {
            background: linear-gradient(135deg, #00b894, #00cec9);
        }
        
        /* ÿ≤ÿ± ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÑÿ® */
        .view-details-btn {
            width: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border: none;
            border-top: 1px solid rgba(162, 155, 254, 0.1);
            color: #a29bfe;
            padding: 14px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .view-details-btn:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            color: white;
        }
        
        /* ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ© (Modal) */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(162, 155, 254, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        .modal-body {
            padding: 20px;
        }
        
        /* ÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© */
        .modal-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .modal-section:last-child {
            margin-bottom: 0;
        }
        .section-title {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-content {
            font-size: 15px;
            line-height: 1.6;
        }
        
        /* ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÅŸä ÿßŸÑŸÜÿßŸÅÿ∞ÿ© */
        .hidden-data-box {
            background: linear-gradient(135deg, rgba(0, 184, 148, 0.1), rgba(85, 239, 196, 0.05));
            border: 2px dashed #00b894;
            border-radius: 12px;
            padding: 16px;
            position: relative;
        }
        .hidden-data-content {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #55efc4;
            word-break: break-all;
            white-space: pre-wrap;
            margin-bottom: 12px;
            min-height: 60px;
        }
        .copy-data-btn {
            width: 100%;
            background: linear-gradient(135deg, #00b894, #00cec9);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .copy-data-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(0, 184, 148, 0.4);
        }
        
        /* ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ∑ŸÑÿ® */
        .order-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .order-info-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        .order-info-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .order-info-value {
            font-size: 15px;
            font-weight: bold;
        }
        .order-info-value.price {
            color: #00b894;
        }
        .order-info-value.category {
            color: #a29bfe;
        }
        
        /* ÿ±ÿ≥ÿßŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ© */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }
        .empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        .empty-text {
            color: #666;
            font-size: 18px;
            margin-bottom: 25px;
        }
        .shop-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 14px 35px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            transition: all 0.3s;
        }
        .shop-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 9999;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="header-content">
            <a href="/" class="back-btn">‚Üí</a>
            <h1 class="page-title">üõçÔ∏è ÿ∑ŸÑÿ®ÿßÿ™Ÿä</h1>
            <span class="purchases-count">{{ purchases|length }}</span>
        </div>
    </div>
    
    <div class="page-content">
        {% if purchases %}
            {% for purchase in purchases %}
            <div class="purchase-card">
                <div class="card-main">
                    <div class="card-icon">üì¶</div>
                    <div class="card-info">
                        <div class="card-title">{{ purchase.get('item_name', 'ŸÖŸÜÿ™ÿ¨') }}</div>
                        <div class="card-meta">
                            <span class="meta-item price">{{ purchase.get('price', 0) }} ÿ±.ÿ≥</span>
                            <span class="meta-item">üìÖ {{ purchase.get('sold_at', 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ') }}</span>
                        </div>
                    </div>
                    {% set status = purchase.get('status', 'completed') %}
                    {% if status == 'pending' %}
                    <div class="card-badge pending">‚è≥ ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©</div>
                    {% elif status == 'claimed' %}
                    <div class="card-badge claimed">üîÑ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸÜŸÅŸäÿ∞</div>
                    {% else %}
                    <div class="card-badge completed">‚úì ŸÖŸÉÿ™ŸÖŸÑ</div>
                    {% endif %}
                </div>
                <button class="view-details-btn" onclick="openModal({{ loop.index }})">
                    üìã ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÑÿ®
                </button>
            </div>
            
            <!-- Modal ŸÑŸÑÿ∑ŸÑÿ® -->
            <div class="modal-overlay" id="modal-{{ loop.index }}" onclick="closeModalOnOverlay(event, {{ loop.index }})">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <div class="modal-title">üì¶ {{ purchase.get('item_name', 'ŸÖŸÜÿ™ÿ¨') }}</div>
                        <button class="close-btn" onclick="closeModal({{ loop.index }})">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ∑ŸÑÿ® -->
                        <div class="modal-section">
                            <div class="section-title">üìä ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ∑ŸÑÿ®</div>
                            <div class="order-info-grid">
                                <div class="order-info-item">
                                    <div class="order-info-label">ÿßŸÑÿ≥ÿπÿ±</div>
                                    <div class="order-info-value price">{{ purchase.get('price', 0) }} ÿ±.ÿ≥</div>
                                </div>
                                <div class="order-info-item">
                                    <div class="order-info-label">ÿßŸÑŸÅÿ¶ÿ©</div>
                                    <div class="order-info-value category">{{ purchase.get('category', 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ') }}</div>
                                </div>
                                <div class="order-info-item">
                                    <div class="order-info-label">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</div>
                                    <div class="order-info-value">{{ purchase.get('sold_at', 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ') }}</div>
                                </div>
                                <div class="order-info-item">
                                    <div class="order-info-label">ÿßŸÑÿ≠ÿßŸÑÿ©</div>
                                    {% set status = purchase.get('status', 'completed') %}
                                    {% if status == 'pending' %}
                                    <div class="order-info-value" style="color: #e17055;">‚è≥ ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©</div>
                                    {% elif status == 'claimed' %}
                                    <div class="order-info-value" style="color: #0984e3;">üîÑ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸÜŸÅŸäÿ∞</div>
                                    {% else %}
                                    <div class="order-info-value" style="color: #00b894;">‚úì ŸÖŸÉÿ™ŸÖŸÑ</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        {% if purchase.get('details') %}
                        <!-- ÿßŸÑŸàÿµŸÅ -->
                        <div class="modal-section">
                            <div class="section-title">üìù ŸàÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨</div>
                            <div class="section-content">{{ purchase.get('details') }}</div>
                        </div>
                        {% endif %}
                        
                        {% if purchase.get('hidden_data') %}
                        <!-- ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ -->
                        <div class="modal-section">
                            <div class="section-title">üîê ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ</div>
                            <div class="hidden-data-box">
                                <div class="hidden-data-content" id="data-{{ loop.index }}">{{ purchase.get('hidden_data') }}</div>
                                <button class="copy-data-btn" onclick="copyData({{ loop.index }})">
                                    üìã ŸÜÿ≥ÿÆ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">üõí</div>
                <p class="empty-text">ŸÑŸÖ ÿ™ŸÇŸÖ ÿ®ÿ£Ÿä ÿπŸÖŸÑŸäÿ© ÿ¥ÿ±ÿßÿ° ÿ®ÿπÿØ</p>
                <a href="/" class="shop-btn">üõçÔ∏è ÿ™ÿµŸÅÿ≠ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</a>
            </div>
        {% endif %}
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast">‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™!</div>
    
    <script>
        // ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
        function openModal(index) {
            const modal = document.getElementById('modal-' + index);
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
        function closeModal(index) {
            const modal = document.getElementById('modal-' + index);
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        // ÿ•ÿ∫ŸÑÿßŸÇ ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿÆŸÑŸÅŸäÿ©
        function closeModalOnOverlay(event, index) {
            if (event.target.classList.contains('modal-overlay')) {
                closeModal(index);
            }
        }
        
        // ÿ•ÿ∫ŸÑÿßŸÇ ÿ®ÿ≤ÿ± Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
                document.body.style.overflow = 'auto';
            }
        });
        
        // ŸÜÿ≥ÿÆ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        function copyData(index) {
            const textElement = document.getElementById('data-' + index);
            const text = textElement.innerText || textElement.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast();
            }).catch(() => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast();
                } catch(e) {
                    alert('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ');
                }
                document.body.removeChild(textArea);
            });
        }
        
        // ÿ•ÿ∏Ÿáÿßÿ± Toast
        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
    </script>
</body>
</html>
"""

@app.route('/my_purchases')
def my_purchases_page():
    """ÿµŸÅÿ≠ÿ© ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™Ÿä ÿßŸÑŸÖŸÜŸÅÿµŸÑÿ©"""
    # ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ŸÅŸÇÿ∑ ŸÑŸÖŸÜÿπ ÿ™ÿ≥ÿ±Ÿäÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
    user_id = session.get('user_id')
    
    if not user_id:
        return redirect('/')
    
    # ÿ¨ŸÑÿ® ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ Firebase
    purchases = []
    try:
        from datetime import datetime, timedelta, timezone
        orders_ref = query_where(db.collection('orders'), 'buyer_id', '==', str(user_id))
        for doc in orders_ref.stream():
            data = doc.to_dict()
            data['id'] = doc.id
            # ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸàŸÇÿ™ ÿ•ŸÑŸâ ÿ™ŸàŸÇŸäÿ™ ÿßŸÑÿ≥ÿπŸàÿØŸäÿ© (UTC+3)
            if data.get('created_at'):
                try:
                    created = data['created_at']
                    # ÿ•ÿ∞ÿß ŸÉÿßŸÜ Firestore Timestamp
                    if hasattr(created, 'seconds'):
                        utc_time = datetime.fromtimestamp(created.seconds, tz=timezone.utc)
                    elif isinstance(created, datetime):
                        utc_time = created
                    else:
                        utc_time = datetime.now(tz=timezone.utc)
                    
                    # ÿ•ÿ∂ÿßŸÅÿ© 3 ÿ≥ÿßÿπÿßÿ™ ŸÑÿ™ŸàŸÇŸäÿ™ ÿßŸÑÿ≥ÿπŸàÿØŸäÿ©
                    saudi_time = utc_time + timedelta(hours=3)
                    data['sold_at'] = saudi_time.strftime('%Y-%m-%d %H:%M')
                    data['sort_time'] = saudi_time.timestamp()
                except Exception as e:
                    print(f"ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸàŸÇÿ™: {e}")
                    data['sold_at'] = 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'
                    data['sort_time'] = 0
            else:
                data['sold_at'] = 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'
                data['sort_time'] = 0
            purchases.append(data)
        # ÿ™ÿ±ÿ™Ÿäÿ® ŸÖŸÜ ÿßŸÑÿ£ÿ≠ÿØÿ´ ŸÑŸÑÿ£ŸÇÿØŸÖ
        purchases.sort(key=lambda x: x.get('sort_time', 0), reverse=True)
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™: {e}")
    
    return render_template('purchases.html', purchases=purchases)

@app.route('/get_balance')
def get_balance_api():
    # ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ŸÅŸÇÿ∑ ŸÑŸÖŸÜÿπ ŸÉÿ¥ŸÅ ÿ£ÿ±ÿµÿØÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
    user_id = session.get('user_id')
    
    if not user_id:
        return {'balance': 0}
    
    balance = get_balance(user_id)
    return {'balance': balance}

@app.route('/charge_balance', methods=['POST'])
@limiter.limit("5 per minute")  # üîí Rate Limiting: ŸÖŸÜÿπ ÿ™ÿÆŸÖŸäŸÜ ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑÿ¥ÿ≠ŸÜ
def charge_balance_api():
    """ÿ¥ÿ≠ŸÜ ÿßŸÑÿ±ÿµŸäÿØ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÉŸàÿØ ÿßŸÑÿ¥ÿ≠ŸÜ"""
    data = request.json
    key_code = data.get('charge_key', '').strip()
    
    # ===== ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ¢ŸÖŸÜ ŸÖŸÜ ŸáŸàŸäÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ =====
    if not session.get('user_id'):
        return jsonify({'success': False, 'message': 'Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã!'})
    
    user_id = str(session.get('user_id'))
    
    if not key_code:
        return jsonify({'success': False, 'message': 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ¥ÿ≠ŸÜ'})
    
    # ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÉŸàÿØ ŸÅŸä Firebase ŸÖÿ®ÿßÿ¥ÿ±ÿ©
    key_data = None
    
    # ÿ£ŸàŸÑÿßŸã: ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
    if key_code in charge_keys:
        key_data = charge_keys[key_code]
    else:
        # ÿ´ÿßŸÜŸäÿßŸã: ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä Firebase
        try:
            doc_ref = db.collection('charge_keys').document(key_code)
            doc = doc_ref.get()
            if doc.exists:
                key_data = doc.to_dict()
                # ÿ•ÿ∂ÿßŸÅÿ™Ÿá ŸÑŸÑÿ∞ÿßŸÉÿ±ÿ©
                charge_keys[key_code] = key_data
        except Exception as e:
            print(f"ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÉŸàÿØ ŸÅŸä Firebase: {e}")
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÉŸàÿØ
    if not key_data:
        return jsonify({'success': False, 'message': 'ŸÉŸàÿØ ÿßŸÑÿ¥ÿ≠ŸÜ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ ÿ£Ÿà ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ'})
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÉŸàÿØ ŸÑŸÖ Ÿäÿ≥ÿ™ÿÆÿØŸÖ
    if key_data.get('used', False):
        return jsonify({'success': False, 'message': 'Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸá ŸÖÿ≥ÿ®ŸÇÿßŸã'})
    
    # ÿ¥ÿ≠ŸÜ ÿßŸÑÿ±ÿµŸäÿØ
    amount = key_data['amount']
    current_balance = get_balance(user_id)
    new_balance = current_balance + amount
    
    # ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
    users_wallets[user_id] = new_balance
    
    # ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉŸàÿØ ŸÉŸÖÿ≥ÿ™ÿÆÿØŸÖ
    charge_keys[key_code]['used'] = True
    charge_keys[key_code]['used_by'] = user_id
    charge_keys[key_code]['used_at'] = time.time()
    
    # ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase
    if db:
        try:
            # ÿ™ÿ≠ÿØŸäÿ´ ÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            user_ref = db.collection('users').document(user_id)
            user_doc = user_ref.get()
            if user_doc.exists:
                user_ref.update({'balance': new_balance})
            else:
                user_ref.set({'user_id': user_id, 'balance': new_balance})
            
            # ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÉŸàÿØ
            db.collection('charge_keys').document(key_code).update({
                'used': True,
                'used_by': user_id,
                'used_at': time.time()
            })
            
            # ÿ≠ŸÅÿ∏ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ¥ÿ≠ŸÜÿ©
            from datetime import datetime
            db.collection('charge_history').add({
                'user_id': user_id,
                'amount': amount,
                'key_code': key_code,
                'date': datetime.now().strftime('%Y-%m-%d %H:%M'),
                'timestamp': time.time(),
                'type': 'charge'
            })
        except Exception as e:
            print(f"ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ Firebase: {e}")
    
    return jsonify({
        'success': True, 
        'message': f'ÿ™ŸÖ ÿ¥ÿ≠ŸÜ {amount} ÿ±ŸäÿßŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!',
        'new_balance': new_balance
    })

@app.route('/sell', methods=['POST'])
def sell_item():
    data = request.json
    seller_id = str(data.get('seller_id'))
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ®ÿßÿ¶ÿπ ŸáŸà ÿßŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑
    if int(seller_id) != ADMIN_ID:
        return {'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠ ŸÑŸÉ ÿ®ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ÿßÿ™! ŸÅŸÇÿ∑ ÿßŸÑŸÖÿßŸÑŸÉ ŸäŸÖŸÉŸÜŸá ÿ∞ŸÑŸÉ.'}
    
    # ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿÆŸÅŸäÿ© ÿ®ÿ¥ŸÉŸÑ ÿ¢ŸÖŸÜ
    item = {
        'id': str(uuid.uuid4()),  # ÿ±ŸÇŸÖ ŸÅÿ±ŸäÿØ ŸÑÿß Ÿäÿ™ŸÉÿ±ÿ±
        'item_name': data.get('item_name'),
        'price': data.get('price'),
        'seller_id': seller_id,
        'seller_name': data.get('seller_name'),
        'hidden_data': data.get('hidden_data', ''),  # ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿÆŸÅŸäÿ©
        'category': data.get('category', ''),  # ÿßŸÑŸÅÿ¶ÿ©
        'image_url': data.get('image_url', '')  # ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©
    }
    marketplace_items.append(item)
    return {'status': 'success'}

@app.route('/buy', methods=['POST'])
@limiter.limit("10 per minute")  # üîí Rate Limiting: ŸÖŸÜÿπ ÿßŸÑÿ¥ÿ±ÿßÿ° ÿßŸÑÿ¢ŸÑŸä
def buy_item():
    try:
        data = request.json
        item_id = str(data.get('item_id'))  # ÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸá ŸÜÿµ
        buyer_details = sanitize(data.get('buyer_details', ''))  # ‚úÖ ÿ™ŸÜÿ∏ŸäŸÅ XSS

        # ===== ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ¢ŸÖŸÜ ŸÖŸÜ ŸáŸàŸäÿ© ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä =====
        # ŸÑÿß ŸÜÿ´ŸÇ ÿ®ŸÄ buyer_id ÿßŸÑŸÇÿßÿØŸÖ ŸÖŸÜ ÿßŸÑÿ∑ŸÑÿ®!
        # ŸÜÿ£ÿÆÿ∞Ÿá ŸÅŸÇÿ∑ ŸÖŸÜ ÿßŸÑŸÄ session (ÿ®ÿπÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ)
        
        buyer_id = None
        buyer_name = None
        
        # 1Ô∏è‚É£ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ© (ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ)
        if session.get('user_id'):
            buyer_id = str(session.get('user_id'))
            buyer_name = session.get('user_name', 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ')
            print(f"‚úÖ ŸÖÿ¥ÿ™ÿ±Ÿä ŸÖŸàÿ´ŸÇ ŸÖŸÜ ÿßŸÑÿ¨ŸÑÿ≥ÿ©: {buyer_id}")
        else:
            # 2Ô∏è‚É£ ŸÑŸÖ Ÿäÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ - ŸÜÿ±ŸÅÿ∂ ÿßŸÑÿ∑ŸÑÿ®
            print(f"‚ùå ŸÖÿ≠ÿßŸàŸÑÿ© ÿ¥ÿ±ÿßÿ° ÿ®ÿØŸàŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ!")
            return {'status': 'error', 'message': 'Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã!'}
        
        print(f"üõí ŸÖÿ≠ÿßŸàŸÑÿ© ÿ¥ÿ±ÿßÿ° - item_id: {item_id}, buyer_id: {buyer_id}")

        # 1. ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÅŸä Firebase ŸÖÿ®ÿßÿ¥ÿ±ÿ©
        doc_ref = db.collection('products').document(item_id)
        doc = doc_ref.get()

        if not doc.exists:
            print(f"‚ùå ÿßŸÑŸÖŸÜÿ™ÿ¨ {item_id} ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä Firebase")
            # ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ŸÉÿßÿ≠ÿ™Ÿäÿßÿ∑
            item = None
            for prod in marketplace_items:
                if prod.get('id') == item_id:
                    item = prod
                    print(f"‚úÖ ÿ™ŸÖ ÿ•Ÿäÿ¨ÿßÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©: {item.get('item_name')}")
                    break
            
            if not item:
                return {'status': 'error', 'message': 'ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ÿ£Ÿà ÿ™ŸÖ ÿ≠ÿ∞ŸÅŸá!'}
        else:
            item = doc.to_dict()
            item['id'] = doc.id
            print(f"‚úÖ ÿ™ŸÖ ÿ•Ÿäÿ¨ÿßÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÅŸä Firebase: {item.get('item_name')}")

        # 2. ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÑŸÖ ŸäŸèÿ®ÿßÿπ
        if item.get('sold', False):
            return {'status': 'error', 'message': 'ÿπÿ∞ÿ±ÿßŸãÿå Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ™ŸÖ ÿ®ŸäÿπŸá ŸÑŸÑÿ™Ÿà! üö´'}

        price = float(item.get('price', 0))

        # 3. ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑŸÅÿπŸÑŸä ŸÖŸÜ ÿ•ŸÖŸÉÿßŸÜŸäÿ© ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÑŸÑŸÖÿ¥ÿ™ÿ±Ÿä (ŸÇÿ®ŸÑ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ°)
        # ŸÜÿ±ÿ≥ŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿ≠ŸÇŸäŸÇŸäÿ© ŸÑÿ£ŸÜ chat_action ŸÑÿß ÿ™ŸÅÿ¥ŸÑ ÿ≠ÿ™Ÿâ ŸÑŸà ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ≠ÿ∏ÿ± ÿßŸÑÿ®Ÿàÿ™
        try:
            test_msg = bot.send_message(
                int(buyer_id),
                "üõí",  # ÿ±ÿ≥ÿßŸÑÿ© ŸÇÿµŸäÿ±ÿ© ÿ¨ÿØÿßŸã
                disable_notification=True  # ÿ®ÿØŸàŸÜ ÿµŸàÿ™ ÿ•ÿ¥ÿπÿßÿ±
            )
            bot.delete_message(int(buyer_id), test_msg.message_id)
            print(f"‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ•ŸÖŸÉÿßŸÜŸäÿ© ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ŸÑŸÑŸÖÿ¥ÿ™ÿ±Ÿä {buyer_id}")
        except Exception as e:
            print(f"‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä {buyer_id}: {e}")
            # ÿ•ŸÜÿ¥ÿßÿ° ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£ ŸÖÿπ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ®Ÿàÿ™
            bot_link = f"@{BOT_USERNAME}" if BOT_USERNAME else "ÿßŸÑÿ®Ÿàÿ™"
            error_msg = f'‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÉ!\n\nÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ:\n1. ŸÑŸÖ ÿ™ÿ≠ÿ∏ÿ± ÿßŸÑÿ®Ÿàÿ™ {bot_link}\n2. ŸÑŸÖ ÿ™ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ© ŸÖÿπŸá\n\nÿ£Ÿà ÿßÿ∞Ÿáÿ® ŸÑŸÑÿ®Ÿàÿ™ Ÿàÿßÿ∂ÿ∫ÿ∑ /start ÿ´ŸÖ ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ'
            return {'status': 'error', 'message': error_msg}

        # 4. ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä (ŸÖŸÜ Firebase ŸÖÿ®ÿßÿ¥ÿ±ÿ©)
        user_ref = db.collection('users').document(buyer_id)
        user_doc = user_ref.get()
        
        if not user_doc.exists:
            return {'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£! ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'}
        
        user_data = user_doc.to_dict()
        current_balance = user_data.get('balance', 0.0)

        if current_balance < price:
            return {'status': 'error', 'message': 'ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä ŸÑŸÑÿ¥ÿ±ÿßÿ°!'}

        # 4. ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿπŸÖŸÑŸäÿ© (ÿÆÿµŸÖ + ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨)
        # ŸÜÿ≥ÿ™ÿÆÿØŸÖ batch ŸÑÿ∂ŸÖÿßŸÜ ÿ™ŸÜŸÅŸäÿ∞ ŸÉŸÑ ÿßŸÑÿÆÿ∑Ÿàÿßÿ™ ŸÖÿπÿßŸã ÿ£Ÿà ŸÅÿ¥ŸÑŸáÿß ŸÖÿπÿßŸã
        batch = db.batch()

        # ÿÆÿµŸÖ ÿßŸÑÿ±ÿµŸäÿØ
        new_balance = current_balance - price
        batch.update(user_ref, {'balance': new_balance})

        # ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÉŸÖÿ®ÿßÿπ (ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ document reference ÿßŸÑÿµÿ≠Ÿäÿ≠)
        product_doc_ref = db.collection('products').document(item_id)
        batch.set(product_doc_ref, {
            'sold': True,
            'buyer_id': buyer_id,
            'buyer_name': buyer_name,
            'sold_at': firestore.SERVER_TIMESTAMP
        }, merge=True)

        # ÿ≠ŸÅÿ∏ ÿßŸÑÿ∑ŸÑÿ®
        order_id = f"ORD_{random.randint(100000, 999999)}"
        order_ref = db.collection('orders').document(order_id)
        
        # ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
        delivery_type = item.get('delivery_type', 'instant')
        order_status = 'completed' if delivery_type == 'instant' else 'pending'
        
        batch.set(order_ref, {
            'buyer_id': buyer_id,
            'buyer_name': buyer_name,
            'item_name': item.get('item_name'),
            'price': price,
            'hidden_data': item.get('hidden_data'),
            'buyer_details': buyer_details,  # ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä ŸÑŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸäÿØŸàŸä
            'buyer_instructions': item.get('buyer_instructions', ''),  # ŸÖÿß ŸÉÿßŸÜ ŸÖÿ∑ŸÑŸàÿ® ŸÖŸÜ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä
            'details': item.get('details', ''),
            'category': item.get('category', ''),
            'image_url': item.get('image_url', ''),
            'seller_id': item.get('seller_id'),
            'delivery_type': delivery_type,
            'status': order_status,
            'created_at': firestore.SERVER_TIMESTAMP
        })

        # ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
        try:
            batch.commit()
            print(f"‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ∑ŸÑÿ® ŸÅŸä Firebase: {order_id} (ŸÜŸàÿπ: {delivery_type})")
        except Exception as batch_error:
            print(f"‚ùå ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ∑ŸÑÿ® ŸÅŸä Firebase: {batch_error}")
            return {'status': 'error', 'message': 'ŸÅÿ¥ŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ∑ŸÑÿ®! ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ'}
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ŸÅÿ∏ ÿßŸÑÿ∑ŸÑÿ® (ŸÑŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸäÿØŸàŸä ŸÅŸÇÿ∑)
        if delivery_type == 'manual':
            try:
                verify_order = db.collection('orders').document(order_id).get()
                if verify_order.exists:
                    print(f"‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿ∑ŸÑÿ®: {order_id}")
                else:
                    print(f"‚ö†Ô∏è ÿßŸÑÿ∑ŸÑÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ÿ®ÿπÿØ ÿßŸÑÿ≠ŸÅÿ∏: {order_id}")
            except Exception as verify_error:
                print(f"‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ∑ŸÑÿ®: {verify_error}")

        # 5. ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä ŸÑŸÉŸÜ ÿ¨ŸäÿØ ŸÑŸÑÿ≥ÿ±ÿπÿ©)
        users_wallets[buyer_id] = new_balance
        # ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ© Ÿàÿ™ÿ≠ÿØŸäÿ´Ÿá
        for prod in marketplace_items:
            if prod.get('id') == item_id:
                prod['sold'] = True
                break

        # 6. ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÑŸÑŸÖÿ¥ÿ™ÿ±Ÿä ÿ£Ÿà ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ£ÿØŸÖŸÜ
        hidden_info = item.get('hidden_data', 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™')
        message_sent = False
        
        if delivery_type == 'instant':
            # ÿ™ÿ≥ŸÑŸäŸÖ ŸÅŸàÿ±Ÿä - ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÑŸÑŸÖÿ¥ÿ™ÿ±Ÿä
            try:
                bot.send_message(
                    int(buyer_id),
                    f"‚úÖ ÿ™ŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ° ÿ®ŸÜÿ¨ÿßÿ≠!\n\n"
                    f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {item.get('item_name')}\n"
                    f"üí∞ ÿßŸÑÿ≥ÿπÿ±: {price} ÿ±ŸäÿßŸÑ\n"
                    f"üÜî ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: #{order_id}\n\n"
                    f"üîê ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ:\n{hidden_info}\n\n"
                    f"‚ö†Ô∏è ÿßÿ≠ŸÅÿ∏ Ÿáÿ∞Ÿá ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÖŸÉÿßŸÜ ÿ¢ŸÖŸÜ!"
                )
                message_sent = True
                print(f"‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÑŸÑŸÖÿ¥ÿ™ÿ±Ÿä {buyer_id}")
                
                # ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖÿßŸÑŸÉ
                bot.send_message(
                    ADMIN_ID,
                    f"üîî ÿπŸÖŸÑŸäÿ© ÿ®Ÿäÿπ ÿ¨ÿØŸäÿØÿ©!\n"
                    f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {item.get('item_name')}\n"
                    f"üë§ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä: {buyer_name} ({buyer_id})\n"
                    f"üí∞ ÿßŸÑÿ≥ÿπÿ±: {price} ÿ±ŸäÿßŸÑ\n"
                    f"‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑŸÖÿ¥ÿ™ÿ±Ÿä"
                )
            except Exception as e:
                print(f"‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÑŸÑŸÖÿ¥ÿ™ÿ±Ÿä {buyer_id}: {e}")
                # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿßŸÑŸÉ ÿ®ÿßŸÑŸÅÿ¥ŸÑ
                try:
                    bot.send_message(
                        ADMIN_ID,
                        f"‚ö†Ô∏è ÿ™ŸÜÿ®ŸäŸá: ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨!\n"
                        f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {item.get('item_name')}\n"
                        f"üë§ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä: {buyer_name} ({buyer_id})\n"
                        f"üîê ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: {hidden_info}\n"
                        f"‚ùå ÿßŸÑÿ≥ÿ®ÿ®: {str(e)}"
                    )
                except:
                    pass
        else:
            # ÿ™ÿ≥ŸÑŸäŸÖ ŸäÿØŸàŸä - ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÜŸÅŸäÿ∞ Ÿàÿ•ÿ±ÿ≥ÿßŸÑ ŸÑŸÑÿ£ÿØŸÖŸÜÿ≤
            try:
                bot.send_message(
                    int(buyer_id),
                    f"‚è≥ ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ∑ŸÑÿ®ŸÉ!\n\n"
                    f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {item.get('item_name')}\n"
                    f"üí∞ ÿßŸÑÿ≥ÿπÿ±: {price} ÿ±ŸäÿßŸÑ\n"
                    f"üÜî ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: #{order_id}\n\n"
                    f"üë®‚Äçüíº ÿ∑ŸÑÿ®ŸÉ ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÜŸÅŸäÿ∞ ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿØÿßÿ±ÿ©\n"
                    f"üì≤ ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÉ ŸÅŸàÿ± ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ∑ŸÑÿ®"
                )
                message_sent = True
                print(f"‚úÖ ÿ™ŸÖ ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä {buyer_id} ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÜŸÅŸäÿ∞")
            except Exception as e:
                print(f"‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ŸÑŸÑŸÖÿ¥ÿ™ÿ±Ÿä {buyer_id}: {e}")
            
            # ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿØŸÖŸÜÿ≤ ŸÖÿπ ÿ≤ÿ± ÿßŸÑÿ™ŸÜŸÅŸäÿ∞
            claim_markup = telebot.types.InlineKeyboardMarkup()
            claim_markup.add(telebot.types.InlineKeyboardButton(
                "üìã ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ∑ŸÑÿ®", 
                callback_data=f"claim_order_{order_id}"
            ))
            
            # üîí ÿ•ÿÆŸÅÿßÿ° ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä ŸÅŸä ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ£ŸàŸÑŸä ŸÑŸÑÿ≠ŸÖÿßŸäÿ©
            # ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ∏Ÿáÿ± ŸÅŸÇÿ∑ ŸÑŸÑŸÖÿ¥ÿ±ŸÅ ÿßŸÑÿ∞Ÿä Ÿäÿ≥ÿ™ŸÑŸÖ ÿßŸÑÿ∑ŸÑÿ®
            hidden_buyer_details = ""
            if buyer_details:
                hidden_buyer_details = f"\n\nüìù ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä: üîí ******** (ÿ™ÿ∏Ÿáÿ± ÿπŸÜÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ)"
            
            admin_message = (
                f"üÜï ÿ∑ŸÑÿ® ÿ¨ÿØŸäÿØ ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ŸÜŸÅŸäÿ∞!\n\n"
                f"üÜî ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®: #{order_id}\n"
                f"üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨: {item.get('item_name')}\n"
                f"üë§ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä: {buyer_name}\n"
                f"üí∞ ÿßŸÑÿ≥ÿπÿ±: {price} ÿ±ŸäÿßŸÑ"
                f"{hidden_buyer_details}\n\n"
                f"üëá ÿßÿ∂ÿ∫ÿ∑ ŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ Ÿàÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ"
            )
            
            # ÿ•ÿ±ÿ≥ÿßŸÑ ŸÑŸÑŸÖÿßŸÑŸÉ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä
            try:
                bot.send_message(ADMIN_ID, admin_message, reply_markup=claim_markup)
            except:
                pass
            


        # ÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑŸÖŸàŸÇÿπ
        return {
            'status': 'success',
            'hidden_data': hidden_info if delivery_type == 'instant' else None,
            'order_id': order_id,
            'message_sent': message_sent,
            'new_balance': new_balance,
            'delivery_type': delivery_type
        }

    except Exception as e:
        print(f"‚ùå Error in buy_item: {e}")
        return {'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ¥ÿ±ÿßÿ°ÿå ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'}

# ============================================
# === ŸÜŸÇÿßÿ∑ ÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿØŸÅÿπ EdfaPay ===
# ============================================

# Webhook ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸä ŸÑŸÄ EdfaPay (Ÿäÿ≥ÿ™ÿÆÿØŸÖ merchant_id ŸÅŸä ÿßŸÑÿ±ÿßÿ®ÿ∑)
@app.route('/merchant_webhook/<merchant_id>', methods=['GET', 'POST'])
def merchant_webhook(merchant_id):
    """ÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿØŸÅÿπ ŸÖŸÜ EdfaPay ÿπŸÑŸâ ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸä"""
    # ÿ™ÿ¨ÿßŸáŸÑ ÿ±ÿ≥ÿßÿ¶ŸÑ Telegram (ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ update_id)
    if request.method == 'POST':
        data = request.json or request.form.to_dict()
        if data.get('update_id') or data.get('message'):
            # Ÿáÿ∞Ÿá ÿ±ÿ≥ÿßŸÑÿ© ŸÖŸÜ Telegram ŸàŸÑŸäÿ≥ÿ™ ŸÖŸÜ EdfaPay
            print(f"‚ö†Ô∏è ÿ™ŸÖ ÿ™ÿ¨ÿßŸáŸÑ ÿ±ÿ≥ÿßŸÑÿ© Telegram ÿπŸÑŸâ merchant_webhook")
            return jsonify({'status': 'ok', 'message': 'Telegram message ignored'}), 200
    return process_edfapay_callback(request, f"merchant_webhook/{merchant_id}")

# ÿØÿπŸÖ ŸÉŸÑÿß ÿßŸÑÿµŸäÿ∫ÿ™ŸäŸÜ: edfapay_webhook Ÿà edfapay-webhook
@app.route('/payment/edfapay_webhook', methods=['GET', 'POST'])
@app.route('/payment/edfapay-webhook', methods=['GET', 'POST'])
@limiter.limit("30 per minute")  # üîí Rate Limiting: ŸÖŸÜÿπ Ÿáÿ¨ŸÖÿßÿ™ ÿßŸÑŸÄ webhook
def edfapay_webhook():
    """ÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿØŸÅÿπ ŸÖŸÜ EdfaPay"""
    return process_edfapay_callback(request, "edfapay_webhook")

def process_edfapay_callback(req, source):
    """ŸÖÿπÿßŸÑÿ¨ÿ© callback ŸÖŸÜ EdfaPay"""
    
    # ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ∑ŸÑÿ® GET (ŸÅÿ™ÿ≠ ŸÖŸÜ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠) - ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ©
    if req.method == 'GET':
        return jsonify({
            'status': 'ok',
            'message': 'EdfaPay Webhook Endpoint',
            'description': 'This endpoint receives payment notifications from EdfaPay',
            'source': source,
            'method': 'POST only'
        })
    
    try:
        # ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ (ÿ™ÿØÿπŸÖ JSON Ÿà form-data)
        data = {}
        if req.is_json:
            data = req.json or {}
        else:
            data = req.form.to_dict() or {}
        
        # ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅÿßÿ±ÿ∫ÿ©ÿå ÿ¨ÿ±ÿ® query parameters
        if not data:
            data = req.args.to_dict() or {}
        
        print(f"üì© EdfaPay Webhook ({source}): {data}")
        
        # ===== üîê ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ∑ŸÑÿ® (Signature Verification) =====
        order_id = data.get('order_id', '')
        trans_id = data.get('trans_id', '')
        status = data.get('status', '') or data.get('result', '')
        amount = data.get('order_amount', '') or data.get('amount', '') or data.get('trans_amount', '')
        received_hash = data.get('hash', '')
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ∑ŸÑÿ® ŸÖŸÜ EdfaPay ŸàŸÑŸäÿ≥ ŸÖÿ≤ŸäŸÅ
        if order_id and EDFAPAY_PASSWORD:
            # 1Ô∏è‚É£ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿ∑ŸÑÿ® ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ ÿ£ŸàŸÑÿßŸã
            payment_exists = order_id in pending_payments
            if not payment_exists:
                try:
                    doc = db.collection('pending_payments').document(order_id).get()
                    payment_exists = doc.exists
                except:
                    pass
            
            if not payment_exists:
                print(f"üö´ ŸÖÿ≠ÿßŸàŸÑÿ© webhook ŸÖÿ≤ŸäŸÅÿ©! order_id ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ: {order_id}")
                # ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÜÿ®ŸäŸá ÿ£ŸÖŸÜŸä ŸÑŸÑŸÖÿßŸÑŸÉ
                try:
                    if BOT_ACTIVE:
                        client_ip = req.headers.get('X-Forwarded-For', req.remote_addr)
                        alert_msg = f"""
‚ö†Ô∏è *ÿ™ŸÜÿ®ŸäŸá ÿ£ŸÖŸÜŸä - Webhook ŸÖÿ¥ÿ®ŸàŸá!*

üî¥ ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ÿ±ÿ≥ÿßŸÑ webhook ŸÑÿ∑ŸÑÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ!

üìã Order ID: `{order_id}`
üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ≤ÿπŸàŸÖ: {amount}
üåê IP: `{client_ip}`
‚è∞ ÿßŸÑŸàŸÇÿ™: {time.strftime('%Y-%m-%d %H:%M:%S')}

_ŸÇÿØ ÿ™ŸÉŸàŸÜ ŸÖÿ≠ÿßŸàŸÑÿ© ÿßÿÆÿ™ÿ±ÿßŸÇ!_
                        """
                        bot.send_message(ADMIN_ID, alert_msg, parse_mode='Markdown')
                except:
                    pass
                return jsonify({'status': 'error', 'message': 'Invalid order'}), 403
            
            # 2Ô∏è‚É£ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ±ÿ≥ŸÑ Ÿäÿ∑ÿßÿ®ŸÇ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä
            original_payment = pending_payments.get(order_id)
            if not original_payment:
                try:
                    doc = db.collection('pending_payments').document(order_id).get()
                    if doc.exists:
                        original_payment = doc.to_dict()
                except:
                    pass
            
            if original_payment and amount:
                original_amount = float(original_payment.get('amount', 0))
                received_amount = float(amount) if amount else 0
                
                if original_amount != received_amount:
                    print(f"üö´ ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≤ŸàŸäÿ± ÿßŸÑŸÖÿ®ŸÑÿ∫! ÿßŸÑÿ£ÿµŸÑŸä: {original_amount}, ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ: {received_amount}")
                    try:
                        if BOT_ACTIVE:
                            client_ip = req.headers.get('X-Forwarded-For', req.remote_addr)
                            alert_msg = f"""
‚ö†Ô∏è *ÿ™ŸÜÿ®ŸäŸá ÿ£ŸÖŸÜŸä - ÿ™ÿ≤ŸàŸäÿ± ŸÖÿ®ŸÑÿ∫!*

üî¥ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ±ÿ≥ŸÑ ŸÑÿß Ÿäÿ∑ÿßÿ®ŸÇ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä!

üìã Order ID: `{order_id}`
üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ£ÿµŸÑŸä: {original_amount} ÿ±ŸäÿßŸÑ
üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ≤ŸäŸÅ: {received_amount} ÿ±ŸäÿßŸÑ
üåê IP: `{client_ip}`

_ŸÖÿ≠ÿßŸàŸÑÿ© ÿßÿÆÿ™ÿ±ÿßŸÇ Ÿàÿßÿ∂ÿ≠ÿ©!_
                            """
                            bot.send_message(ADMIN_ID, alert_msg, parse_mode='Markdown')
                    except:
                        pass
                    return jsonify({'status': 'error', 'message': 'Amount mismatch'}), 403
        
        print(f"üìã Parsed: order_id={order_id}, trans_id={trans_id}, status={status}, amount={amount}")
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ order_id
        if not order_id:
            print("‚ö†Ô∏è EdfaPay Webhook: ŸÑÿß ŸäŸàÿ¨ÿØ order_id - ŸÇÿØ ŸäŸÉŸàŸÜ ÿ•ÿ¥ÿπÿßÿ± ÿ£ŸàŸÑŸä")
            return jsonify({'status': 'ok', 'message': 'No order_id provided'}), 200
        
        # ===== ÿ™ÿ≠ÿØŸäÿØ ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ =====
        status_upper = str(status).upper().strip()
        
        # ÿßŸÑÿ≠ÿßŸÑÿßÿ™ ÿßŸÑŸÜÿßÿ¨ÿ≠ÿ©
        SUCCESS_STATUSES = ['SUCCESS', 'SETTLED', 'CAPTURED', 'APPROVED', '3DS_SUCCESS']
        
        # ÿßŸÑÿ≠ÿßŸÑÿßÿ™ ÿßŸÑŸÖÿ±ŸÅŸàÿ∂ÿ©/ÿßŸÑŸÅÿßÿ¥ŸÑÿ©
        FAILED_STATUSES = ['DECLINED', 'FAILURE', 'FAILED', 'TXN_FAILURE', 'REJECTED', 'CANCELLED', 'ERROR', '3DS_FAILURE']
        
        # ÿßŸÑÿ≠ÿßŸÑÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ© (ÿ™ÿ≠ÿ™ÿßÿ¨ ÿßŸÜÿ™ÿ∏ÿßÿ±)
        PENDING_STATUSES = ['PENDING', 'PROCESSING', 'REDIRECT', '3DS_REQUIRED']
        
        # ===== ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ≠ÿßŸÑÿßÿ™ =====
        
        # 1Ô∏è‚É£ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠
        if status_upper in SUCCESS_STATUSES:
            print(f"‚úÖ EdfaPay: ÿπŸÖŸÑŸäÿ© ŸÜÿßÿ¨ÿ≠ÿ© - {status}")
            
            # ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ∑ŸÑÿ® ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
            payment_data = pending_payments.get(order_id)
            
            # ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä Firebase ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸàÿ¨ÿØ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
            if not payment_data:
                try:
                    doc = db.collection('pending_payments').document(order_id).get()
                    if doc.exists:
                        payment_data = doc.to_dict()
                        print(f"üì• ÿ™ŸÖ ÿ¨ŸÑÿ® ÿßŸÑÿ∑ŸÑÿ® ŸÖŸÜ Firebase")
                except Exception as e:
                    print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä Firebase: {e}")
            
            # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ∑ŸÑÿ® ŸÑŸÖ ŸäŸèÿπÿßŸÑÿ¨ ŸÖÿ≥ÿ®ŸÇÿßŸã (ÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ Replay Attack)
            if payment_data and payment_data.get('status') == 'completed':
                print(f"‚ö†Ô∏è ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ÿπÿßÿØÿ© ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ webhook! ÿßŸÑÿ∑ŸÑÿ® {order_id} ÿ™ŸÖ ŸÖÿπÿßŸÑÿ¨ÿ™Ÿá ŸÖÿ≥ÿ®ŸÇÿßŸã")
                return jsonify({'status': 'ok', 'message': 'Already processed'}), 200
            
            if payment_data and payment_data.get('status') != 'completed':
                user_id = str(payment_data.get('user_id', ''))
                pay_amount = float(payment_data.get('amount', amount or 0))
                is_merchant_invoice = payment_data.get('is_merchant_invoice', False)
                invoice_id = payment_data.get('invoice_id', '')
                
                if not user_id:
                    print(f"‚ùå ŸÑÿß ŸäŸàÿ¨ÿØ user_id ŸÅŸä ÿßŸÑÿ∑ŸÑÿ®")
                    return jsonify({'status': 'error', 'message': 'Missing user_id'}), 400
                
                # ‚úÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ±ÿµŸäÿØ
                add_balance(user_id, pay_amount)
                print(f"‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© {pay_amount} ÿ±ŸäÿßŸÑ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ {user_id}")
                
                # ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
                if order_id in pending_payments:
                    pending_payments[order_id]['status'] = 'completed'
                
                # ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase
                try:
                    db.collection('pending_payments').document(order_id).update({
                        'status': 'completed',
                        'completed_at': firestore.SERVER_TIMESTAMP,
                        'trans_id': trans_id,
                        'edfapay_status': status,
                        'payment_data': data
                    })
                except Exception as e:
                    print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ Firebase: {e}")
                
                # ===== ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ© ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿØŸÅÿπ =====
                
                if is_merchant_invoice and invoice_id:
                    # üîπ ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ÿßÿ¨ÿ± - ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ™ÿßÿ¨ÿ±
                    try:
                        # ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                        if invoice_id in merchant_invoices:
                            merchant_invoices[invoice_id]['status'] = 'completed'
                        
                        db.collection('merchant_invoices').document(invoice_id).update({
                            'status': 'completed',
                            'completed_at': firestore.SERVER_TIMESTAMP
                        })
                    except:
                        pass
                    
                    # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿ™ÿßÿ¨ÿ±
                    try:
                        new_balance = get_balance(user_id)
                        # ÿ¨ŸÑÿ® ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸäŸÑ ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑
                        customer_phone = ''
                        if invoice_id:
                            if invoice_id in merchant_invoices:
                                customer_phone = merchant_invoices[invoice_id].get('customer_phone', '')
                            if not customer_phone:
                                try:
                                    inv_doc = db.collection('merchant_invoices').document(invoice_id).get()
                                    if inv_doc.exists:
                                        customer_phone = inv_doc.to_dict().get('customer_phone', '')
                                except:
                                    pass
                        if not customer_phone:
                            customer_phone = 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'
                        
                        # ÿ±ÿ≥ÿßŸÑÿ© ŸÑŸÑÿ™ÿßÿ¨ÿ± (ÿ®ÿØŸàŸÜ ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸäŸÑ)
                        bot.send_message(
                            int(user_id),
                            f"üí∞ *ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿØŸÅÿπÿ© ÿ¨ÿØŸäÿØÿ©!*\n\n"
                            f"üßæ ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©: `{invoice_id}`\n"
                            f"üíµ ÿßŸÑŸÖÿ®ŸÑÿ∫: {pay_amount} ÿ±ŸäÿßŸÑ\n\n"
                            f"üí≥ ÿ±ÿµŸäÿØŸÉ ÿßŸÑÿ≠ÿßŸÑŸä: {new_balance} ÿ±ŸäÿßŸÑ\n\n"
                            f"‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ®ŸÑÿ∫ ŸÑÿ±ÿµŸäÿØŸÉ",
                            parse_mode="Markdown"
                        )
                    except Exception as e:
                        print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑÿ™ÿßÿ¨ÿ±: {e}")
                    
                    # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿßŸÑŸÉ (ŸÖŸÅÿµŸëŸÑ ŸÑŸÑÿ≠ŸÖÿßŸäÿ© ŸàÿßŸÑÿ™Ÿàÿ´ŸäŸÇ)
                    try:
                        merchant_name = merchant_invoices.get(invoice_id, {}).get('merchant_name', 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ')
                        bot.send_message(
                            ADMIN_ID,
                            f"üßæ *ÿØŸÅÿπ ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ÿßÿ¨ÿ±!*\n\n"
                            f"üë§ ÿßŸÑÿ™ÿßÿ¨ÿ±: {merchant_name}\n"
                            f"üÜî ÿ¢ŸäÿØŸä: `{user_id}`\n"
                            f"üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫: {pay_amount} ÿ±ŸäÿßŸÑ\n"
                            f"üìã ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©: `{invoice_id}`\n"
                            f"üì± ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸäŸÑ: `{customer_phone}`\n"
                            f"üîó EdfaPay: `{trans_id}`",
                            parse_mode="Markdown"
                        )
                    except:
                        pass
                else:
                    # üîπ ÿ¥ÿ≠ŸÜ ÿπÿßÿØŸä - ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                    try:
                        new_balance = get_balance(user_id)
                        bot.send_message(
                            int(user_id),
                            f"‚úÖ *ÿ™ŸÖ ÿ¥ÿ≠ŸÜ ÿ±ÿµŸäÿØŸÉ ÿ®ŸÜÿ¨ÿßÿ≠!*\n\n"
                            f"üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ∂ÿßŸÅ: {pay_amount} ÿ±ŸäÿßŸÑ\n"
                            f"üíµ ÿ±ÿµŸäÿØŸÉ ÿßŸÑÿ≠ÿßŸÑŸä: {new_balance} ÿ±ŸäÿßŸÑ\n\n"
                            f"üìã ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸÑŸäÿ©: `{order_id}`\n\n"
                            f"üéâ ÿßÿ≥ÿ™ŸÖÿ™ÿπ ÿ®ÿßŸÑÿ™ÿ≥ŸàŸÇ!",
                            parse_mode="Markdown"
                        )
                    except Exception as e:
                        print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±: {e}")
                    
                    # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿßŸÑŸÉ
                    try:
                        bot.send_message(
                            ADMIN_ID,
                            f"üí≥ *ÿØŸÅÿπÿ© ÿ¨ÿØŸäÿØÿ© ŸÜÿßÿ¨ÿ≠ÿ©!*\n\n"
                            f"üë§ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: `{user_id}`\n"
                            f"üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫: {pay_amount} ÿ±ŸäÿßŸÑ\n"
                            f"üìã ÿßŸÑÿ∑ŸÑÿ®: `{order_id}`\n"
                            f"üîó EdfaPay: `{trans_id}`",
                            parse_mode="Markdown"
                        )
                    except:
                        pass
                
                return jsonify({'status': 'success', 'message': 'Payment processed'})
            
            elif payment_data and payment_data.get('status') == 'completed':
                print(f"‚ö†Ô∏è ÿßŸÑÿ∑ŸÑÿ® {order_id} ÿ™ŸÖ ŸÖÿπÿßŸÑÿ¨ÿ™Ÿá ŸÖÿ≥ÿ®ŸÇÿßŸã")
                return jsonify({'status': 'success', 'message': 'Already processed'})
            
            else:
                print(f"‚ùå ÿßŸÑÿ∑ŸÑÿ® {order_id} ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ")
                return jsonify({'status': 'error', 'message': 'Order not found'}), 404
        
        # 2Ô∏è‚É£ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿ¥ŸÑ/ÿßŸÑÿ±ŸÅÿ∂
        elif status_upper in FAILED_STATUSES:
            print(f"‚ùå EdfaPay: ÿπŸÖŸÑŸäÿ© ŸÖÿ±ŸÅŸàÿ∂ÿ© - {status}")
            
            # ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÑÿ® ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑÿπŸÖŸäŸÑ
            payment_data = pending_payments.get(order_id)
            if not payment_data:
                try:
                    doc = db.collection('pending_payments').document(order_id).get()
                    if doc.exists:
                        payment_data = doc.to_dict()
                except:
                    pass
            
            # ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ®
            try:
                db.collection('pending_payments').document(order_id).update({
                    'status': 'failed',
                    'failed_at': firestore.SERVER_TIMESTAMP,
                    'failure_reason': data.get('decline_reason', status),
                    'payment_data': data
                })
            except:
                pass
            
            # ‚úÖ ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿπŸÖŸäŸÑ ÿ®ÿßŸÑŸÅÿ¥ŸÑ
            if payment_data:
                try:
                    user_id = payment_data.get('user_id')
                    pay_amount = payment_data.get('amount', 0)
                    is_merchant_invoice = payment_data.get('is_merchant_invoice', False)
                    
                    # ÿ™ŸÜÿ∏ŸäŸÅ ÿ≥ÿ®ÿ® ÿßŸÑÿ±ŸÅÿ∂ ŸÖŸÜ ÿßŸÑÿ£ÿ≠ÿ±ŸÅ ÿßŸÑÿÆÿßÿµÿ©
                    decline_reason = data.get('decline_reason', 'ŸÅÿ¥ŸÑÿ™ ÿßŸÑÿπŸÖŸÑŸäÿ©')
                    # ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ£ÿ≠ÿ±ŸÅ ÿßŸÑÿ™Ÿä ÿ™ÿ≥ÿ®ÿ® ŸÖÿ¥ÿßŸÉŸÑ ŸÅŸä Markdown
                    decline_reason = decline_reason.replace('_', ' ').replace('*', '').replace('`', '').replace('[', '').replace(']', '')
                    # ÿßÿÆÿ™ÿµÿßÿ± ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿ∑ŸàŸäŸÑÿ©
                    if len(decline_reason) > 50:
                        decline_reason = 'ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©'
                    
                    # ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿÆÿ™ŸÑŸÅÿ© ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿØŸÅÿπ
                    if is_merchant_invoice:
                        msg_text = f"‚ùå ŸÅÿ¥ŸÑÿ™ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿØŸÅÿπ\n\nüí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫: {pay_amount} ÿ±ŸäÿßŸÑ\n‚ùó ÿßŸÑÿ≥ÿ®ÿ®: {decline_reason}\n\nüí° ÿ£ÿÆÿ®ÿ± ÿßŸÑÿπŸÖŸäŸÑ ÿ®ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ"
                    else:
                        msg_text = f"‚ùå ŸÅÿ¥ŸÑÿ™ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ¥ÿ≠ŸÜ\n\nüí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫: {pay_amount} ÿ±ŸäÿßŸÑ\n‚ùó ÿßŸÑÿ≥ÿ®ÿ®: {decline_reason}\n\nüí° ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ±ÿµŸäÿØ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿ£Ÿà ÿ¨ÿ±ÿ® ÿ®ÿ∑ÿßŸÇÿ© ÿ£ÿÆÿ±Ÿâ"
                    
                    bot.send_message(int(user_id), msg_text)
                except Exception as e:
                    print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑÿπŸÖŸäŸÑ: {e}")
            
            # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿßŸÑŸÉ ÿ®ÿßŸÑŸÅÿ¥ŸÑ
            try:
                raw_reason = data.get('decline_reason', status)
                clean_reason = str(raw_reason).replace('_', ' ').replace('*', '').replace('`', '')[:100]
                
                # ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑŸÖÿßŸÑŸÉ
                merchant_id = payment_data.get('user_id', 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ') if payment_data else 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'
                invoice_id = payment_data.get('invoice_id', '') if payment_data else ''
                is_merchant_inv = payment_data.get('is_merchant_invoice', False) if payment_data else False
                
                # ÿ¨ŸÑÿ® ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸäŸÑ ÿ•ŸÜ Ÿàÿ¨ÿØ
                customer_phone = 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'
                if invoice_id and invoice_id in merchant_invoices:
                    customer_phone = merchant_invoices[invoice_id].get('customer_phone', 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ')
                
                if is_merchant_inv:
                    bot.send_message(
                        ADMIN_ID,
                        f"‚ùå ŸÅÿ¥ŸÑ ÿØŸÅÿπ ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ÿßÿ¨ÿ±\n\n"
                        f"üë§ ÿßŸÑÿ™ÿßÿ¨ÿ±: {merchant_id}\n"
                        f"üßæ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©: {invoice_id}\n"
                        f"üì± ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸäŸÑ: {customer_phone}\n"
                        f"‚ùó ÿßŸÑÿ≥ÿ®ÿ®: {clean_reason}"
                    )
                else:
                    bot.send_message(
                        ADMIN_ID,
                        f"‚ùå ÿπŸÖŸÑŸäÿ© ÿ¥ÿ≠ŸÜ ŸÖÿ±ŸÅŸàÿ∂ÿ©\n\n"
                        f"üë§ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: {merchant_id}\n"
                        f"üìã ÿßŸÑÿ∑ŸÑÿ®: {order_id}\n"
                        f"‚ùó ÿßŸÑÿ≥ÿ®ÿ®: {clean_reason}"
                    )
            except:
                pass
            
            return jsonify({'status': 'success', 'message': f'Payment failed: {status}'})
        
        # 3Ô∏è‚É£ ÿ≠ÿßŸÑÿ© ŸÖÿπŸÑŸÇÿ©
        elif status_upper in PENDING_STATUSES:
            print(f"‚è≥ EdfaPay: ÿπŸÖŸÑŸäÿ© ŸÖÿπŸÑŸÇÿ© - {status}")
            return jsonify({'status': 'success', 'message': f'Payment pending: {status}'})
        
        # 4Ô∏è‚É£ ÿ≠ÿßŸÑÿ© ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅÿ©
        else:
            print(f"‚ùì EdfaPay: ÿ≠ÿßŸÑÿ© ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅÿ© - {status}")
            # ŸÑÿß ŸÜÿ∂ŸäŸÅ ÿ±ÿµŸäÿØ ŸÑÿ≠ÿßŸÑÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅÿ©
            return jsonify({'status': 'success', 'message': f'Unknown status: {status}'})
            
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© webhook: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'status': 'error', 'message': str(e)}), 500

# ============================================
# === ŸÜŸÇÿßÿ∑ ÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑÿØŸÅÿπ (Legacy) ===
# ============================================

@app.route('/payment/adfaly_webhook', methods=['GET', 'POST'])
def adfaly_webhook():
    """ÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿØŸÅÿπ ŸÖŸÜ Adfaly Pay"""
    
    # ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ∑ŸÑÿ® GET (ŸÅÿ™ÿ≠ ŸÖŸÜ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠) - ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ©
    if request.method == 'GET':
        return jsonify({
            'status': 'ok',
            'message': 'Adfaly Pay Webhook Endpoint',
            'description': 'This endpoint receives payment notifications from Adfaly Pay',
            'method': 'POST only'
        })
    
    try:
        # ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        data = request.json or request.form.to_dict()
        print(f"üì© Adfaly Webhook: {data}")
        
        # ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸáŸÖÿ©
        invoice_id = data.get('invoice_id') or data.get('order_id') or data.get('id')
        status = data.get('status') or data.get('payment_status')
        amount = data.get('amount') or data.get('paid_amount')
        
        if not invoice_id:
            print("‚ùå Adfaly Webhook: ŸÑÿß ŸäŸàÿ¨ÿØ invoice_id")
            return jsonify({'status': 'error', 'message': 'Missing invoice_id'}), 400
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ
        if status and status.lower() in ['paid', 'success', 'completed', 'successful']:
            # ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ∑ŸÑÿ®
            payment_data = pending_payments.get(invoice_id)
            
            if not payment_data:
                # ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä Firebase
                try:
                    doc = db.collection('pending_payments').document(invoice_id).get()
                    if doc.exists:
                        payment_data = doc.to_dict()
                except:
                    pass
            
            if payment_data and payment_data.get('status') != 'completed':
                user_id = payment_data['user_id']
                pay_amount = float(payment_data.get('amount', amount or 0))
                
                # ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ±ÿµŸäÿØ
                add_balance(user_id, pay_amount)
                
                # ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ®
                if invoice_id in pending_payments:
                    pending_payments[invoice_id]['status'] = 'completed'
                
                # ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase
                try:
                    db.collection('pending_payments').document(invoice_id).update({
                        'status': 'completed',
                        'completed_at': firestore.SERVER_TIMESTAMP
                    })
                except Exception as e:
                    print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ Firebase: {e}")
                
                # ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπÿ®ÿ± ÿßŸÑÿ®Ÿàÿ™
                try:
                    new_balance = get_balance(user_id)
                    bot.send_message(
                        int(user_id),
                        f"‚úÖ *ÿ™ŸÖ ÿ¥ÿ≠ŸÜ ÿ±ÿµŸäÿØŸÉ ÿ®ŸÜÿ¨ÿßÿ≠!*\n\n"
                        f"üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ∂ÿßŸÅ: {pay_amount} ÿ±ŸäÿßŸÑ\n"
                        f"üíµ ÿ±ÿµŸäÿØŸÉ ÿßŸÑÿ≠ÿßŸÑŸä: {new_balance} ÿ±ŸäÿßŸÑ\n\n"
                        f"üìã ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸÑŸäÿ©: `{invoice_id}`\n\n"
                        f"üéâ ÿßÿ≥ÿ™ŸÖÿ™ÿπ ÿ®ÿßŸÑÿ™ÿ≥ŸàŸÇ!",
                        parse_mode="Markdown"
                    )
                except Exception as e:
                    print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: {e}")
                
                # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿßŸÑŸÉ
                try:
                    bot.send_message(
                        ADMIN_ID,
                        f"üí≥ *ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿØŸÅÿπÿ© ÿ¨ÿØŸäÿØÿ©!*\n\n"
                        f"üë§ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: {user_id}\n"
                        f"üí∞ ÿßŸÑŸÖÿ®ŸÑÿ∫: {pay_amount} ÿ±ŸäÿßŸÑ\n"
                        f"üìã ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸÑŸäÿ©: `{invoice_id}`\n"
                        f"‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ±ÿµŸäÿØ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã",
                        parse_mode="Markdown"
                    )
                except:
                    pass
                
                print(f"‚úÖ ÿ™ŸÖ ÿ¥ÿ≠ŸÜ {pay_amount} ÿ±ŸäÿßŸÑ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ {user_id}")
                return jsonify({'status': 'success', 'message': 'Payment processed'})
            
            else:
                print(f"‚ö†Ô∏è ÿßŸÑÿ∑ŸÑÿ® {invoice_id} ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ÿ£Ÿà ÿ™ŸÖ ŸÖÿπÿßŸÑÿ¨ÿ™Ÿá ŸÖÿ≥ÿ®ŸÇÿßŸã")
                return jsonify({'status': 'success', 'message': 'Already processed or not found'})
        
        else:
            print(f"‚ÑπÔ∏è Adfaly Webhook: ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ: {status}")
            return jsonify({'status': 'success', 'message': f'Status: {status}'})
            
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä adfaly_webhook: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'status': 'error', 'message': str(e)}), 500

@app.route('/payment/success', methods=['GET', 'POST'])
def payment_success():
    """ÿµŸÅÿ≠ÿ© ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿØŸÅÿπ - ÿ™ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿπŸÑŸäÿ©"""
    
    # ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ŸÖŸÜ EdfaPay
    data = {}
    if request.method == 'POST':
        data = request.form.to_dict() or request.json or {}
    else:
        data = request.args.to_dict() or {}
    
    print(f"üìÑ Payment Result Page: {data}")
    
    # ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ≠ÿßŸÑÿ©
    status = data.get('status', '') or data.get('result', '')
    order_id = data.get('order_id', '')
    decline_reason = data.get('decline_reason', '')
    
    status_upper = str(status).upper().strip()
    
    # ÿ™ÿ≠ÿØŸäÿØ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÜÿßÿ¨ÿ≠ÿ© ÿ£ŸÖ ŸÑÿß
    SUCCESS_STATUSES = ['SUCCESS', 'SETTLED', 'CAPTURED', 'APPROVED', '3DS_SUCCESS']
    FAILED_STATUSES = ['DECLINED', 'FAILURE', 'FAILED', 'TXN_FAILURE', 'REJECTED', 'CANCELLED', 'ERROR', '3DS_FAILURE']
    
    is_success = status_upper in SUCCESS_STATUSES
    is_failed = status_upper in FAILED_STATUSES
    
    # ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ result=DECLINED ŸÖÿπ status ŸÖÿÆÿ™ŸÑŸÅ
    result = data.get('result', '').upper()
    if result == 'DECLINED' or result == 'FAILURE':
        is_success = False
        is_failed = True
    
    # ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ÿå ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Firebase ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ order_id
    if not status and order_id:
        try:
            doc = db.collection('pending_payments').document(order_id).get()
            if doc.exists:
                payment_data = doc.to_dict()
                payment_status = payment_data.get('status', '')
                if payment_status == 'completed':
                    is_success = True
                    is_failed = False
                elif payment_status == 'failed':
                    is_success = False
                    is_failed = True
                    decline_reason = payment_data.get('failure_reason', 'ŸÅÿ¥ŸÑÿ™ ÿßŸÑÿπŸÖŸÑŸäÿ©')
        except Exception as e:
            print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Firebase: {e}")
    
    # ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸàŸÑÿß order_idÿå ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ¢ÿÆÿ± ÿ∑ŸÑÿ® ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    if not status and not order_id:
        # ŸÜÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿπÿßŸÖÿ© ŸÖÿπ ÿ≤ÿ± ÿßŸÑÿπŸàÿØÿ©
        pass
    
    if is_success:
        # ‚úÖ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠
        return render_template_string('''
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ÿ™ŸÖ ÿßŸÑÿØŸÅÿπ ÿ®ŸÜÿ¨ÿßÿ≠</title>
            <style>
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { 
                    font-family: 'Tajawal', sans-serif; 
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                }
                .container {
                    background: rgba(255,255,255,0.1);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    padding: 40px;
                    text-align: center;
                    max-width: 400px;
                    border: 1px solid rgba(255,255,255,0.2);
                }
                .icon { font-size: 80px; margin-bottom: 20px; animation: bounce 1s ease infinite; }
                @keyframes bounce {
                    0%, 100% { transform: translateY(0); }
                    50% { transform: translateY(-10px); }
                }
                h1 { color: #55efc4; margin-bottom: 15px; font-size: 24px; }
                p { color: #dfe6e9; margin-bottom: 25px; line-height: 1.6; }
                .btn {
                    display: inline-block;
                    background: linear-gradient(135deg, #00b894, #55efc4);
                    color: white;
                    padding: 15px 40px;
                    border-radius: 30px;
                    text-decoration: none;
                    font-weight: bold;
                    transition: transform 0.3s;
                }
                .btn:hover { transform: scale(1.05); }
            </style>
            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
        </head>
        <body>
            <div class="container">
                <div class="icon">‚úÖ</div>
                <h1>ÿ™ŸÖ ÿßŸÑÿØŸÅÿπ ÿ®ŸÜÿ¨ÿßÿ≠!</h1>
                <p>ÿ™ŸÖ ÿ¥ÿ≠ŸÜ ÿ±ÿµŸäÿØŸÉ ÿ®ŸÜÿ¨ÿßÿ≠.<br>ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ®Ÿàÿ™ ŸàÿßŸÑÿ™ÿ≥ŸàŸÇ.</p>
                <a href="https://t.me/{{ bot_username }}" class="btn">ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ®Ÿàÿ™</a>
            </div>
        </body>
        </html>
        ''', bot_username=BOT_USERNAME)
    
    elif is_failed:
        # ‚ùå ÿµŸÅÿ≠ÿ© ÿßŸÑŸÅÿ¥ŸÑ
        error_msg = decline_reason or status or "ŸÅÿ¥ŸÑÿ™ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿØŸÅÿπ"
        return render_template_string('''
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ŸÅÿ¥ŸÑ ÿßŸÑÿØŸÅÿπ</title>
            <style>
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { 
                    font-family: 'Tajawal', sans-serif; 
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                }
                .container {
                    background: rgba(255,255,255,0.1);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    padding: 40px;
                    text-align: center;
                    max-width: 400px;
                    border: 1px solid rgba(255,255,255,0.2);
                }
                .icon { font-size: 80px; margin-bottom: 20px; }
                h1 { color: #ff7675; margin-bottom: 15px; font-size: 24px; }
                p { color: #dfe6e9; margin-bottom: 15px; line-height: 1.6; }
                .error-box {
                    background: rgba(255, 118, 117, 0.2);
                    border: 1px solid rgba(255, 118, 117, 0.5);
                    border-radius: 10px;
                    padding: 15px;
                    margin-bottom: 25px;
                }
                .error-text { color: #ff7675; font-size: 14px; }
                .btn {
                    display: inline-block;
                    background: linear-gradient(135deg, #6c5ce7, #a29bfe);
                    color: white;
                    padding: 15px 40px;
                    border-radius: 30px;
                    text-decoration: none;
                    font-weight: bold;
                    transition: transform 0.3s;
                }
                .btn:hover { transform: scale(1.05); }
            </style>
            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
        </head>
        <body>
            <div class="container">
                <div class="icon">‚ùå</div>
                <h1>ŸÅÿ¥ŸÑ ÿßŸÑÿØŸÅÿπ!</h1>
                <p>ŸÑŸÖ ÿ™ÿ™ŸÖ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿØŸÅÿπ.</p>
                <div class="error-box">
                    <p class="error-text">{{ error_msg }}</p>
                </div>
                <p>ŸäŸÖŸÉŸÜŸÉ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.</p>
                <a href="https://t.me/{{ bot_username }}" class="btn">ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ®Ÿàÿ™</a>
            </div>
        </body>
        </html>
        ''', bot_username=BOT_USERNAME, error_msg=error_msg)
    
    else:
        # ‚è≥ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ - ŸÜÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿ™ŸÜÿ™ÿ∏ÿ± Ÿàÿ™ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Firebase
        # ÿ´ŸÖ ÿ™ÿ≠ŸàŸÑ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿπÿØ ÿ´ÿßŸÜŸäÿ™ŸäŸÜ
        return render_template_string('''
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ...</title>
            <style>
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { 
                    font-family: 'Tajawal', sans-serif; 
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                }
                .container {
                    background: rgba(255,255,255,0.1);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    padding: 40px;
                    text-align: center;
                    max-width: 400px;
                    border: 1px solid rgba(255,255,255,0.2);
                }
                .icon { font-size: 80px; margin-bottom: 20px; }
                .spinner {
                    width: 60px;
                    height: 60px;
                    border: 4px solid rgba(255,255,255,0.1);
                    border-top-color: #6c5ce7;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                }
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
                h1 { color: #a29bfe; margin-bottom: 15px; font-size: 24px; }
                p { color: #dfe6e9; margin-bottom: 25px; line-height: 1.6; }
                .btn {
                    display: inline-block;
                    background: linear-gradient(135deg, #6c5ce7, #a29bfe);
                    color: white;
                    padding: 15px 40px;
                    border-radius: 30px;
                    text-decoration: none;
                    font-weight: bold;
                    transition: transform 0.3s;
                }
                .btn:hover { transform: scale(1.05); }
                #status-msg { 
                    background: rgba(255,255,255,0.1);
                    padding: 15px;
                    border-radius: 10px;
                    margin-bottom: 20px;
                }
            </style>
            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
        </head>
        <body>
            <div class="container">
                <div class="spinner"></div>
                <h1>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿØŸÅÿπ...</h1>
                <div id="status-msg">
                    <p>‚è≥ Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿπŸÖŸÑŸäÿ©</p>
                </div>
                <p>ÿ≥ŸäÿµŸÑŸÉ ÿ•ÿ¥ÿπÿßÿ± ŸÅŸä ÿßŸÑÿ®Ÿàÿ™ ÿ®ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©</p>
                <a href="https://t.me/{{ bot_username }}" class="btn">ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ®Ÿàÿ™</a>
            </div>
            <script>
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿßŸÑÿ© ÿ®ÿπÿØ 3 ÿ´ŸàÿßŸÜŸä
                setTimeout(function() {
                    var orderId = '{{ order_id }}';
                    if (orderId) {
                        // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Firebase
                        window.location.reload();
                    }
                }, 3000);
                
                // ÿ®ÿπÿØ 10 ÿ´ŸàÿßŸÜŸäÿå ÿ™Ÿàÿ¨ŸäŸá ŸÑŸÑÿ®Ÿàÿ™
                setTimeout(function() {
                    document.getElementById('status-msg').innerHTML = '<p>‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ®ŸÉ - ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®Ÿàÿ™</p>';
                }, 10000);
            </script>
        </body>
        </html>
        ''', bot_username=BOT_USERNAME, order_id=order_id)

# ============ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÑŸÑÿπŸÖŸäŸÑ ============
@app.route('/invoice/<invoice_id>')
def show_invoice(invoice_id):
    """ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÑŸÑÿπŸÖŸäŸÑ"""
    
    # ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
    invoice_data = merchant_invoices.get(invoice_id)
    
    # ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä Firebase ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ
    if not invoice_data:
        try:
            doc = db.collection('merchant_invoices').document(invoice_id).get()
            if doc.exists:
                invoice_data = doc.to_dict()
                merchant_invoices[invoice_id] = invoice_data
        except Exception as e:
            print(f"‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©: {e}")
    
    # ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
    if not invoice_data:
        return render_template_string('''
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©</title>
            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
            <style>
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { 
                    font-family: 'Tajawal', sans-serif; 
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                }
                .container {
                    background: rgba(255,255,255,0.1);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    padding: 40px;
                    text-align: center;
                    max-width: 400px;
                    border: 1px solid rgba(255,255,255,0.2);
                }
                .icon { font-size: 80px; margin-bottom: 20px; }
                h1 { color: #ff7675; margin-bottom: 15px; font-size: 24px; }
                p { color: #dfe6e9; line-height: 1.6; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="icon">‚ùå</div>
                <h1>ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©</h1>
                <p>ÿπÿ∞ÿ±ÿßŸãÿå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ Ÿáÿ∞Ÿá ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ£Ÿà ÿ£ŸÜŸáÿß ŸÖŸÜÿ™ŸáŸäÿ© ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©.</p>
            </div>
        </body>
        </html>
        '''), 404
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÜÿ™Ÿáÿßÿ° ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© (ÿ≥ÿßÿπÿ© Ÿàÿßÿ≠ÿØÿ©)
    expires_at = invoice_data.get('expires_at', 0)
    current_time = time.time()
    
    # ÿ•ÿ∞ÿß ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
    if expires_at > 0 and current_time > expires_at and invoice_data.get('status') != 'completed':
        # ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿßŸÑÿ© ÿ•ŸÑŸâ ŸÖŸÜÿ™ŸáŸäÿ©
        try:
            invoice_data['status'] = 'expired'
            merchant_invoices[invoice_id] = invoice_data
            db.collection('merchant_invoices').document(invoice_id).update({'status': 'expired'})
        except:
            pass
        
        return render_template_string('''
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</title>
            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
            <style>
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { 
                    font-family: 'Tajawal', sans-serif; 
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                }
                .container {
                    background: rgba(255,255,255,0.1);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    padding: 40px;
                    text-align: center;
                    max-width: 400px;
                    border: 1px solid rgba(255,255,255,0.2);
                }
                .icon { font-size: 80px; margin-bottom: 20px; }
                h1 { color: #fdcb6e; margin-bottom: 15px; font-size: 24px; }
                p { color: #dfe6e9; line-height: 1.8; }
                .invoice-info {
                    background: rgba(253,203,110,0.1);
                    border-radius: 10px;
                    padding: 15px;
                    margin-top: 20px;
                }
                .invoice-info div {
                    color: #b2bec3;
                    font-size: 14px;
                    margin: 5px 0;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="icon">‚è∞</div>
                <h1>ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</h1>
                <p>ÿπÿ∞ÿ±ÿßŸãÿå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿØŸÅÿπ ÿÆŸÑÿßŸÑ ÿßŸÑŸÖÿØÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ© (ÿ≥ÿßÿπÿ© Ÿàÿßÿ≠ÿØÿ©).<br>ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿ™ÿßÿ¨ÿ± ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ¨ÿØŸäÿØÿ©.</p>
                <div class="invoice-info">
                    <div>ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©: <strong>{{ invoice_id }}</strong></div>
                    <div>ÿßŸÑŸÖÿ®ŸÑÿ∫: <strong>{{ amount }} ÿ±ŸäÿßŸÑ</strong></div>
                </div>
            </div>
        </body>
        </html>
        ''', invoice_id=invoice_id, amount=invoice_data.get('amount', 0)), 410
    
    # ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿ±ŸÅŸàÿ∂ÿ© ÿ£Ÿà ŸÅÿßÿ¥ŸÑÿ©
    if invoice_data.get('status') in ['failed', 'declined']:
        return render_template_string('''
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿ±ŸÅŸàÿ∂ÿ©</title>
            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
            <style>
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { 
                    font-family: 'Tajawal', sans-serif; 
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                }
                .container {
                    background: rgba(255,255,255,0.1);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    padding: 40px;
                    text-align: center;
                    max-width: 400px;
                    border: 1px solid rgba(255,255,255,0.2);
                }
                .icon { font-size: 80px; margin-bottom: 20px; }
                h1 { color: #ff7675; margin-bottom: 15px; font-size: 24px; }
                p { color: #dfe6e9; line-height: 1.8; }
                .invoice-info {
                    background: rgba(255,118,117,0.1);
                    border-radius: 10px;
                    padding: 15px;
                    margin-top: 20px;
                }
                .invoice-info div {
                    color: #b2bec3;
                    font-size: 14px;
                    margin: 5px 0;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="icon">‚ùå</div>
                <h1>ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿØŸÅÿπ</h1>
                <p>ÿπÿ∞ÿ±ÿßŸãÿå ŸÅÿ¥ŸÑÿ™ ÿπŸÖŸÑŸäÿ© ÿßŸÑÿØŸÅÿπ ŸÑŸáÿ∞Ÿá ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©.<br>ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿ™ÿßÿ¨ÿ± ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ¨ÿØŸäÿØÿ©.</p>
                <div class="invoice-info">
                    <div>ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©: <strong>{{ invoice_id }}</strong></div>
                    <div>ÿßŸÑŸÖÿ®ŸÑÿ∫: <strong>{{ amount }} ÿ±ŸäÿßŸÑ</strong></div>
                </div>
            </div>
        </body>
        </html>
        ''', invoice_id=invoice_id, amount=invoice_data.get('amount', 0)), 410
    
    # ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿØŸÅŸàÿπÿ© ŸÖÿ≥ÿ®ŸÇÿßŸã
    if invoice_data.get('status') == 'completed':
        return render_template_string('''
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿØŸÅŸàÿπÿ©</title>
            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
            <style>
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { 
                    font-family: 'Tajawal', sans-serif; 
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                }
                .container {
                    background: rgba(255,255,255,0.1);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    padding: 40px;
                    text-align: center;
                    max-width: 400px;
                    border: 1px solid rgba(255,255,255,0.2);
                }
                .icon { font-size: 80px; margin-bottom: 20px; }
                h1 { color: #00cec9; margin-bottom: 15px; font-size: 24px; }
                p { color: #dfe6e9; line-height: 1.6; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="icon">‚úÖ</div>
                <h1>ÿ™ŸÖ ÿØŸÅÿπ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</h1>
                <p>Ÿáÿ∞Ÿá ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ™ŸÖ ÿØŸÅÿπŸáÿß ŸÖÿ≥ÿ®ŸÇÿßŸã.</p>
            </div>
        </body>
        </html>
        ''')
    
    # ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
    merchant_name = invoice_data.get('merchant_name', 'ÿßŸÑÿ™ÿßÿ¨ÿ±')
    amount = invoice_data.get('amount', 0)
    
    # ÿ¨ŸÑÿ® ŸàŸÇÿ™ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ (ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸàÿ¨ÿØ = ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÇÿØŸäŸÖÿ©ÿå ŸÜÿ≠ÿ≥ÿ® ŸÖŸÜ created_at)
    expires_at_ts = invoice_data.get('expires_at')
    if not expires_at_ts:
        # ŸÅÿßÿ™Ÿàÿ±ÿ© ŸÇÿØŸäŸÖÿ© ÿ®ÿØŸàŸÜ expires_at - ŸÜÿ≠ÿ≥ÿ® ŸÖŸÜ ŸàŸÇÿ™ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ° + ÿ≥ÿßÿπÿ©
        created_at = invoice_data.get('created_at')
        if created_at:
            # ÿ•ÿ∞ÿß ŸÉÿßŸÜ timestamp ŸÖŸÜ Firebase
            if hasattr(created_at, 'timestamp'):
                expires_at_ts = created_at.timestamp() + 3600
            elif isinstance(created_at, (int, float)):
                expires_at_ts = created_at + 3600
            else:
                expires_at_ts = time.time()  # ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä = ŸÖŸÜÿ™ŸáŸäÿ©
        else:
            expires_at_ts = time.time()  # ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä = ŸÖŸÜÿ™ŸáŸäÿ©
    
    remaining_seconds = int(expires_at_ts - time.time())
    if remaining_seconds < 0:
        remaining_seconds = 0
    
    return render_template_string('''
    <!DOCTYPE html>
    <html dir="rtl" lang="ar">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ŸÅÿßÿ™Ÿàÿ±ÿ© - {{ merchant_name }}</title>
        <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
        <style>
            * { box-sizing: border-box; margin: 0; padding: 0; }
            body { 
                font-family: 'Tajawal', sans-serif; 
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .invoice-card {
                background: rgba(255,255,255,0.1);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 30px;
                width: 100%;
                max-width: 400px;
                border: 1px solid rgba(255,255,255,0.2);
            }
            .header {
                text-align: center;
                margin-bottom: 25px;
            }
            .merchant-icon {
                width: 70px;
                height: 70px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 15px;
                font-size: 30px;
            }
            .merchant-name {
                color: #fff;
                font-size: 22px;
                font-weight: 700;
            }
            .invoice-id {
                color: #a29bfe;
                font-size: 12px;
                margin-top: 5px;
            }
            .amount-section {
                background: rgba(255,255,255,0.05);
                border-radius: 15px;
                padding: 20px;
                text-align: center;
                margin-bottom: 20px;
            }
            .timer-section {
                background: rgba(253,203,110,0.1);
                border: 1px solid rgba(253,203,110,0.3);
                border-radius: 12px;
                padding: 12px;
                text-align: center;
                margin-bottom: 20px;
            }
            .timer-label {
                color: #fdcb6e;
                font-size: 12px;
                margin-bottom: 5px;
            }
            .timer-value {
                color: #fdcb6e;
                font-size: 24px;
                font-weight: 700;
                font-family: monospace;
            }
            .timer-expired {
                color: #ff7675 !important;
            }
            .amount-label {
                color: #b2bec3;
                font-size: 14px;
                margin-bottom: 8px;
            }
            .amount-value {
                color: #00cec9;
                font-size: 36px;
                font-weight: 700;
            }
            .amount-currency {
                color: #81ecec;
                font-size: 18px;
                margin-right: 5px;
            }
            .form-group {
                margin-bottom: 20px;
            }
            .form-label {
                display: block;
                color: #dfe6e9;
                margin-bottom: 8px;
                font-size: 14px;
            }
            .form-input {
                width: 100%;
                padding: 15px;
                border: 2px solid rgba(255,255,255,0.1);
                border-radius: 12px;
                background: rgba(255,255,255,0.05);
                color: #fff;
                font-size: 18px;
                font-family: 'Tajawal', sans-serif;
                text-align: center;
                direction: ltr;
                transition: border-color 0.3s;
            }
            .form-input:focus {
                outline: none;
                border-color: #667eea;
            }
            .form-input::placeholder {
                color: #636e72;
            }
            .phone-wrapper {
                display: flex;
                gap: 10px;
                direction: ltr;
            }
            .country-select {
                width: 120px;
                padding: 15px 10px;
                border: 2px solid rgba(255,255,255,0.1);
                border-radius: 12px;
                background: rgba(255,255,255,0.05);
                color: #fff;
                font-size: 14px;
                font-family: 'Tajawal', sans-serif;
                cursor: pointer;
                transition: border-color 0.3s;
            }
            .country-select:focus {
                outline: none;
                border-color: #667eea;
            }
            .country-select option {
                background: #1a1a2e;
                color: #fff;
            }
            .phone-input-wrapper {
                flex: 1;
            }
            .phone-input-wrapper .form-input {
                width: 100%;
            }
            .pay-btn {
                width: 100%;
                padding: 16px;
                border: none;
                border-radius: 12px;
                background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
                color: #fff;
                font-size: 18px;
                font-weight: 700;
                font-family: 'Tajawal', sans-serif;
                cursor: pointer;
                transition: transform 0.2s, box-shadow 0.2s;
            }
            .pay-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 30px rgba(0,206,201,0.3);
            }
            .pay-btn:disabled {
                background: #636e72;
                cursor: not-allowed;
                transform: none;
            }
            .secure-note {
                text-align: center;
                color: #636e72;
                font-size: 12px;
                margin-top: 20px;
            }
            .secure-note span {
                color: #00b894;
            }
            .error-msg {
                color: #ff7675;
                font-size: 13px;
                margin-top: 8px;
                display: none;
            }
            .loading {
                display: none;
            }
            .loading.show {
                display: inline-block;
            }
        </style>
    </head>
    <body>
        <div class="invoice-card">
            <div class="header">
                <div class="merchant-icon">üè™</div>
                <div class="merchant-name">{{ merchant_name }}</div>
                <div class="invoice-id">ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©: {{ invoice_id }}</div>
            </div>
            
            <div class="amount-section">
                <div class="amount-label">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®</div>
                <div class="amount-value">
                    {{ amount }}
                    <span class="amount-currency">ÿ±ŸäÿßŸÑ</span>
                </div>
            </div>
            
            <div class="timer-section">
                <div class="timer-label">‚è∞ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ŸÑŸÑÿØŸÅÿπ</div>
                <div class="timer-value" id="countdown">00:00:00</div>
            </div>
            
            <form id="paymentForm" action="/invoice/{{ invoice_id }}/pay" method="POST">
                <div class="form-group">
                    <label class="form-label">üì± ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ</label>
                    <div class="phone-wrapper">
                        <select name="country_code" id="countrySelect" class="country-select">
                            <option value="966" data-length="9">üá∏üá¶ +966</option>
                            <option value="971" data-length="9">üá¶üá™ +971</option>
                            <option value="965" data-length="8">üá∞üáº +965</option>
                            <option value="973" data-length="8">üáßüá≠ +973</option>
                            <option value="974" data-length="8">üá∂üá¶ +974</option>
                            <option value="968" data-length="8">üá¥üá≤ +968</option>
                            <option value="962" data-length="9">üáØüá¥ +962</option>
                            <option value="20" data-length="10">üá™üá¨ +20</option>
                            <option value="212" data-length="9">üá≤üá¶ +212</option>
                            <option value="216" data-length="8">üáπüá≥ +216</option>
                            <option value="213" data-length="9">üá©üáø +213</option>
                            <option value="218" data-length="9">üá±üáæ +218</option>
                            <option value="249" data-length="9">üá∏üá© +249</option>
                            <option value="964" data-length="10">üáÆüá∂ +964</option>
                            <option value="963" data-length="9">üá∏üáæ +963</option>
                            <option value="961" data-length="8">üá±üáß +961</option>
                            <option value="970" data-length="9">üáµüá∏ +970</option>
                            <option value="967" data-length="9">üáæüá™ +967</option>
                            <option value="90" data-length="10">üáπüá∑ +90</option>
                            <option value="44" data-length="10">üá¨üáß +44</option>
                            <option value="1" data-length="10">üá∫üá∏ +1</option>
                            <option value="33" data-length="9">üá´üá∑ +33</option>
                            <option value="49" data-length="11">üá©üá™ +49</option>
                        </select>
                        <div class="phone-input-wrapper">
                            <input type="tel" name="phone" class="form-input" 
                                   placeholder="5xxxxxxxx" 
                                   maxlength="10"
                                   required
                                   id="phoneInput">
                        </div>
                    </div>
                    <input type="hidden" name="full_phone" id="fullPhone">
                    <div class="error-msg" id="phoneError">ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿ¨ŸàÿßŸÑ ÿµÿ≠Ÿäÿ≠</div>
                </div>
                
                <button type="submit" class="pay-btn" id="payBtn">
                    <span class="loading" id="loading">‚è≥ </span>
                    üí≥ ÿßÿØŸÅÿπ ÿßŸÑÿ¢ŸÜ
                </button>
            </form>
            
            <div class="secure-note">
                üîí <span>ÿØŸÅÿπ ÿ¢ŸÖŸÜ</span> ÿπÿ®ÿ± ÿ®Ÿàÿßÿ®ÿ© EdfaPay
            </div>
        </div>
        
        <script>
            const form = document.getElementById('paymentForm');
            const phoneInput = document.getElementById('phoneInput');
            const countrySelect = document.getElementById('countrySelect');
            const fullPhoneInput = document.getElementById('fullPhone');
            const phoneError = document.getElementById('phoneError');
            const payBtn = document.getElementById('payBtn');
            const loading = document.getElementById('loading');
            
            phoneInput.addEventListener('input', function() {
                phoneError.style.display = 'none';
                // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿµŸÅÿ± ŸÖŸÜ ÿßŸÑÿ®ÿØÿßŸäÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                if (this.value.startsWith('0')) {
                    this.value = this.value.substring(1);
                }
            });
            
            form.addEventListener('submit', function(e) {
                let phone = phoneInput.value.trim();
                const countryCode = countrySelect.value;
                
                // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿµŸÅÿ± ŸÖŸÜ ÿßŸÑÿ®ÿØÿßŸäÿ©
                if (phone.startsWith('0')) {
                    phone = phone.substring(1);
                }
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ±ŸÇŸÖ ÿ£ÿ±ŸÇÿßŸÖ ŸÅŸÇÿ∑
                if (!/^[0-9]+$/.test(phone)) {
                    e.preventDefault();
                    phoneError.textContent = 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ£ÿ±ŸÇÿßŸÖ ŸÅŸÇÿ∑';
                    phoneError.style.display = 'block';
                    return;
                }
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ∑ŸàŸÑ ÿßŸÑÿ±ŸÇŸÖ
                if (phone.length < 7 || phone.length > 11) {
                    e.preventDefault();
                    phoneError.textContent = 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿ¨ŸàÿßŸÑ ÿµÿ≠Ÿäÿ≠';
                    phoneError.style.display = 'block';
                    return;
                }
                
                // ÿØŸÖÿ¨ ÿ±ŸÖÿ≤ ÿßŸÑÿØŸàŸÑÿ© ŸÖÿπ ÿßŸÑÿ±ŸÇŸÖ
                fullPhoneInput.value = countryCode + phone;
                
                payBtn.disabled = true;
                loading.classList.add('show');
            });
            
            // ÿßŸÑÿπÿØÿßÿØ ÿßŸÑÿ™ŸÜÿßÿ≤ŸÑŸä
            let remainingSeconds = {{ remaining_seconds }};
            const countdownEl = document.getElementById('countdown');
            
            function updateCountdown() {
                if (remainingSeconds <= 0) {
                    countdownEl.textContent = 'ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©';
                    countdownEl.classList.add('timer-expired');
                    payBtn.disabled = true;
                    payBtn.textContent = '‚è∞ ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©';
                    return;
                }
                
                const hours = Math.floor(remainingSeconds / 3600);
                const minutes = Math.floor((remainingSeconds % 3600) / 60);
                const seconds = remainingSeconds % 60;
                
                countdownEl.textContent = 
                    String(hours).padStart(2, '0') + ':' +
                    String(minutes).padStart(2, '0') + ':' +
                    String(seconds).padStart(2, '0');
                
                // ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑŸàŸÜ ŸÑŸÑÿ£ÿ≠ŸÖÿ± ÿ•ÿ∞ÿß ÿ£ŸÇŸÑ ŸÖŸÜ 5 ÿØŸÇÿßÿ¶ŸÇ
                if (remainingSeconds < 300) {
                    countdownEl.classList.add('timer-expired');
                }
                
                remainingSeconds--;
            }
            
            updateCountdown();
            setInterval(updateCountdown, 1000);
        </script>
    </body>
    </html>
    ''', merchant_name=merchant_name, amount=amount, invoice_id=invoice_id, remaining_seconds=remaining_seconds)

@app.route('/invoice/<invoice_id>/pay', methods=['POST'])
def process_invoice_payment(invoice_id):
    """ŸÖÿπÿßŸÑÿ¨ÿ© ÿØŸÅÿπ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©"""
    
    # ÿ¨ŸÑÿ® ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ÿßŸÑŸÉÿßŸÖŸÑ (ŸÖÿπ ÿ±ŸÖÿ≤ ÿßŸÑÿØŸàŸÑÿ©)
    phone = request.form.get('full_phone', '').strip()
    # ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸàÿ¨ÿØÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑÿπÿßÿØŸä
    if not phone:
        phone = request.form.get('phone', '').strip()
    
    # ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
    invoice_data = merchant_invoices.get(invoice_id)
    
    if not invoice_data:
        try:
            doc = db.collection('merchant_invoices').document(invoice_id).get()
            if doc.exists:
                invoice_data = doc.to_dict()
        except:
            pass
    
    if not invoice_data:
        return redirect(f'/invoice/{invoice_id}')
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÜÿ™Ÿáÿßÿ° ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
    expires_at = invoice_data.get('expires_at', 0)
    if expires_at > 0 and time.time() > expires_at:
        return redirect(f'/invoice/{invoice_id}')
    
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÑŸÖ ÿ™ÿØŸÅÿπ
    if invoice_data.get('status') == 'completed':
        return redirect(f'/invoice/{invoice_id}')
    
    # ÿ•ŸÜÿ¥ÿßÿ° ÿ∑ŸÑÿ® ÿßŸÑÿØŸÅÿπ
    merchant_id = invoice_data.get('merchant_id')
    merchant_name = invoice_data.get('merchant_name')
    amount = invoice_data.get('amount')
    
    result = create_customer_invoice(merchant_id, merchant_name, amount, phone, invoice_id)
    
    if result['success']:
        # ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©
        try:
            merchant_invoices[invoice_id]['customer_phone'] = phone
            merchant_invoices[invoice_id]['order_id'] = result['order_id']
            
            db.collection('merchant_invoices').document(invoice_id).update({
                'customer_phone': phone,
                'order_id': result['order_id']
            })
        except:
            pass
        
        # ÿ•ÿπÿßÿØÿ© ÿ™Ÿàÿ¨ŸäŸá ŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿØŸÅÿπ
        return redirect(result['payment_url'])
    else:
        # ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿÆÿ∑ÿ£
        return render_template_string('''
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ÿÆÿ∑ÿ£</title>
            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
            <style>
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { 
                    font-family: 'Tajawal', sans-serif; 
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                }
                .container {
                    background: rgba(255,255,255,0.1);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    padding: 40px;
                    text-align: center;
                    max-width: 400px;
                    border: 1px solid rgba(255,255,255,0.2);
                }
                .icon { font-size: 80px; margin-bottom: 20px; }
                h1 { color: #ff7675; margin-bottom: 15px; font-size: 24px; }
                p { color: #dfe6e9; line-height: 1.6; margin-bottom: 20px; }
                .btn {
                    display: inline-block;
                    padding: 12px 30px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: #fff;
                    text-decoration: none;
                    border-radius: 10px;
                    font-weight: 600;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="icon">‚ö†Ô∏è</div>
                <h1>ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£</h1>
                <p>{{ error }}</p>
                <a href="/invoice/{{ invoice_id }}" class="btn">ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ</a>
            </div>
        </body>
        </html>
        ''', error=result.get('error', 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'), invoice_id=invoice_id)

@app.route('/payment/cancel')
def payment_cancel():
    """ÿµŸÅÿ≠ÿ© ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿØŸÅÿπ"""
    return render_template_string('''
    <!DOCTYPE html>
    <html dir="rtl" lang="ar">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿØŸÅÿπ</title>
        <style>
            * { box-sizing: border-box; margin: 0; padding: 0; }
            body { 
                font-family: 'Tajawal', sans-serif; 
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .container {
                background: rgba(255,255,255,0.1);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 40px;
                text-align: center;
                max-width: 400px;
                border: 1px solid rgba(255,255,255,0.2);
            }
            .icon { font-size: 80px; margin-bottom: 20px; }
            h1 { color: #ff7675; margin-bottom: 15px; font-size: 24px; }
            p { color: #dfe6e9; margin-bottom: 25px; line-height: 1.6; }
            .btn {
                display: inline-block;
                background: linear-gradient(135deg, #6c5ce7, #a29bfe);
                color: white;
                padding: 15px 40px;
                border-radius: 30px;
                text-decoration: none;
                font-weight: bold;
                transition: transform 0.3s;
            }
            .btn:hover { transform: scale(1.05); }
        </style>
        <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    </head>
    <body>
        <div class="container">
            <div class="icon">‚ùå</div>
            <h1>ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿØŸÅÿπ</h1>
            <p>ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿπŸÖŸÑŸäÿ© ÿßŸÑÿØŸÅÿπ.<br>ŸäŸÖŸÉŸÜŸÉ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.</p>
            <a href="https://t.me/{{ bot_username }}" class="btn">ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ®Ÿàÿ™</a>
        </div>
    </body>
    </html>
    ''', bot_username=BOT_USERNAME)

# ŸÑÿßÿ≥ÿ™ŸÇÿ®ÿßŸÑ ÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ (Webhook)
@app.route('/webhook', methods=['POST'])
def getMessage():
    try:
        json_string = request.get_data().decode('utf-8')
        print(f"üì© Webhook received: {json_string[:200]}...")
        print(f"ü§ñ BOT_ACTIVE: {BOT_ACTIVE}")
        
        update = telebot.types.Update.de_json(json_string)
        
        # ÿ∑ÿ®ÿßÿπÿ© ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´
        if update.message:
            print(f"üìù ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿµŸäÿ© ŸÖŸÜ: {update.message.from_user.id}")
            print(f"üìù ÿßŸÑŸÜÿµ: {update.message.text}")
        
        # ‚úÖ ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∂ÿ∫ÿ∑ÿßÿ™ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± (callback_query)
        if update.callback_query:
            print(f"üîò ÿ∂ÿ∫ÿ∑ ÿ≤ÿ± ŸÖŸÜ: {update.callback_query.from_user.id}")
            print(f"üîò ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: {update.callback_query.data}")
        
        if BOT_ACTIVE:
            print(f"üî¢ ŸÖÿπÿßŸÑÿ¨ÿßÿ™ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ: {len(bot.message_handlers)}")
            print(f"üî¢ ŸÖÿπÿßŸÑÿ¨ÿßÿ™ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±: {len(bot.callback_query_handlers)}")
            
            bot.threaded = False
            
            try:
                bot.process_new_updates([update])
                print("‚úÖ ÿ™ŸÖ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸÜÿ¨ÿßÿ≠")
            except Exception as proc_error:
                print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©: {proc_error}")
                import traceback
                traceback.print_exc()
        else:
            print("‚ö†Ô∏è ÿßŸÑÿ®Ÿàÿ™ ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑!")
    except Exception as e:
        print(f"‚ùå ÿÆÿ∑ÿ£ ŸÅŸä Webhook: {e}")
        import traceback
        traceback.print_exc()
    return "!", 200

@app.route("/set_webhook")
def set_webhook():
    webhook_url = SITE_URL + "/webhook"
    bot.remove_webhook()
    bot.set_webhook(url=webhook_url)
    return f"Webhook set to {webhook_url}", 200

# Health check endpoint for Render
@app.route('/health')
def health():
    return {'status': 'ok'}, 200

# ŸÖÿ≥ÿßÿ± ŸÑÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ Firebase (ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑)
@app.route('/migrate_to_firebase')
def migrate_to_firebase_route():
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸáŸà ÿßŸÑŸÖÿßŸÑŸÉ (ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© password parameter)
    password = request.args.get('password', '')
    admin_password = os.environ.get('ADMIN_PASS', 'admin123')
    
    if password != admin_password:
        return {'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠'}, 403
    
    # ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ±ŸÅÿπ
    success = migrate_data_to_firebase()
    
    if success:
        return {
            'status': 'success',
            'message': 'ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠ ÿ•ŸÑŸâ Firebase',
            'data': {
                'products': len(marketplace_items),
                'users': len(users_wallets),
                'orders': len(active_orders),
                'keys': len(charge_keys)
            }
        }, 200
    else:
        return {'status': 'error', 'message': 'ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™'}, 500

# ÿµŸÅÿ≠ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ (HTML ŸÖŸÜŸÅÿµŸÑ) - ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÖÿ§ŸÇÿ™
LOGIN_HTML = """
<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿØÿÆŸàŸÑ ÿßŸÑŸÖÿßŸÑŸÉ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }
        h1 { color: #667eea; margin-bottom: 10px; text-align: center; }
        .subtitle { color: #888; text-align: center; margin-bottom: 25px; font-size: 14px; }
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
        }
        input:focus { outline: none; border-color: #667eea; }
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
        }
        button:hover { transform: scale(1.05); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .error { color: #e74c3c; background: #ffe5e5; padding: 12px; border-radius: 8px; text-align: center; margin-top: 15px; font-size: 14px; }
        .success { color: #27ae60; background: #e5ffe5; padding: 12px; border-radius: 8px; text-align: center; margin-top: 15px; font-size: 14px; }
        .step { display: none; }
        .step.active { display: block; }
        .code-input {
            letter-spacing: 10px;
            font-size: 24px;
            font-weight: bold;
        }
        .timer { color: #e74c3c; font-weight: bold; text-align: center; margin: 10px 0; }
        .security-note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-top: 15px;
            text-align: center;
        }
        .back-btn {
            background: #95a5a6;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="login-box">
        <!-- ÿßŸÑÿÆÿ∑Ÿàÿ© 1: ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± -->
        <div id="step1" class="step active">
            <h1>üîê ÿØÿÆŸàŸÑ ÿßŸÑÿ¢ÿØŸÖŸÜ</h1>
            <p class="subtitle">ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ</p>
            <form id="passwordForm">
                <input type="password" id="password" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±" required autofocus>
                <button type="submit" id="sendCodeBtn">üì± ÿ•ÿ±ÿ≥ÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ</button>
            </form>
            <div id="error1" class="error" style="display:none;"></div>
            <div class="security-note">
                üõ°Ô∏è ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÉŸàÿØ ŸÖÿ§ŸÇÿ™ ŸÑŸÑÿ®Ÿàÿ™ ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸáŸàŸäÿ™ŸÉ
            </div>
        </div>
        
        <!-- ÿßŸÑÿÆÿ∑Ÿàÿ© 2: ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÉŸàÿØ -->
        <div id="step2" class="step">
            <h1>üì± ŸÉŸàÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ</h1>
            <p class="subtitle">ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÖÿ±ÿ≥ŸÑ ŸÑŸÉ ÿπŸÑŸâ ÿßŸÑÿ®Ÿàÿ™</p>
            <div class="timer">‚è∞ ÿµÿßŸÑÿ≠ ŸÑŸÖÿØÿ©: <span id="countdown">180</span> ÿ´ÿßŸÜŸäÿ©</div>
            <form id="codeForm">
                <input type="text" id="verifyCode" class="code-input" placeholder="000000" maxlength="6" required pattern="[0-9]{6}">
                <button type="submit" id="verifyBtn">‚úÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿØÿÆŸàŸÑ</button>
            </form>
            <button class="back-btn" onclick="goBack()">‚Ü©Ô∏è ÿ±ÿ¨Ÿàÿπ</button>
            <div id="error2" class="error" style="display:none;"></div>
            <div id="success2" class="success" style="display:none;"></div>
        </div>
    </div>
    
    <script>
        let countdownInterval;
        let secondsLeft = 180;
        
        // ÿßŸÑÿÆÿ∑Ÿàÿ© 1: ÿ•ÿ±ÿ≥ÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const btn = document.getElementById('sendCodeBtn');
            const errorDiv = document.getElementById('error1');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ...';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/send_code', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if(data.status === 'success') {
                    // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÑÿÆÿ∑Ÿàÿ© 2
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step2').classList.add('active');
                    startCountdown();
                } else {
                    errorDiv.textContent = data.message;
                    errorDiv.style.display = 'block';
                    btn.disabled = false;
                    btn.textContent = 'üì± ÿ•ÿ±ÿ≥ÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ';
                }
            } catch(error) {
                errorDiv.textContent = '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ';
                errorDiv.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'üì± ÿ•ÿ±ÿ≥ÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ';
            }
        });
        
        // ÿßŸÑÿÆÿ∑Ÿàÿ© 2: ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÉŸàÿØ
        document.getElementById('codeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const code = document.getElementById('verifyCode').value;
            const btn = document.getElementById('verifyBtn');
            const errorDiv = document.getElementById('error2');
            const successDiv = document.getElementById('success2');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ...';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/verify_code', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code: code })
                });
                
                const data = await response.json();
                
                if(data.status === 'success') {
                    successDiv.textContent = '‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ! ÿ¨ÿßÿ±Ÿä ÿßŸÑÿØÿÆŸàŸÑ...';
                    successDiv.style.display = 'block';
                    clearInterval(countdownInterval);
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1000);
                } else {
                    errorDiv.textContent = data.message;
                    errorDiv.style.display = 'block';
                    btn.disabled = false;
                    btn.textContent = '‚úÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿØÿÆŸàŸÑ';
                }
            } catch(error) {
                errorDiv.textContent = '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ';
                errorDiv.style.display = 'block';
                btn.disabled = false;
                btn.textContent = '‚úÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿØÿÆŸàŸÑ';
            }
        });
        
        // ÿßŸÑÿπÿØ ÿßŸÑÿ™ŸÜÿßÿ≤ŸÑŸä
        function startCountdown() {
            secondsLeft = 180;
            document.getElementById('countdown').textContent = secondsLeft;
            
            countdownInterval = setInterval(() => {
                secondsLeft--;
                document.getElementById('countdown').textContent = secondsLeft;
                
                if(secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('error2').textContent = '‚è∞ ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÉŸàÿØ! ÿ£ÿπÿØ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©';
                    document.getElementById('error2').style.display = 'block';
                    document.getElementById('verifyBtn').disabled = true;
                }
            }, 1000);
        }
        
        // ÿßŸÑÿ±ÿ¨Ÿàÿπ ŸÑŸÑÿÆÿ∑Ÿàÿ© 1
        function goBack() {
            clearInterval(countdownInterval);
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
            document.getElementById('password').value = '';
            document.getElementById('verifyCode').value = '';
            document.getElementById('error1').style.display = 'none';
            document.getElementById('error2').style.display = 'none';
            document.getElementById('sendCodeBtn').disabled = false;
            document.getElementById('sendCodeBtn').textContent = 'üì± ÿ•ÿ±ÿ≥ÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ';
        }
        
        // ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿ£ÿ±ŸÇÿßŸÖ ŸÅŸÇÿ∑ ŸÅŸä ÿ≠ŸÇŸÑ ÿßŸÑŸÉŸàÿØ
        document.getElementById('verifyCode').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    </script>
</body>
</html>
"""

# ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÑŸÑŸÖÿßŸÑŸÉ (ŸÖÿ≠ÿØÿ´ÿ© ÿ®ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÖÿ§ŸÇÿ™)
@app.route('/dashboard', methods=['GET'])
def dashboard():
    # ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ -> ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ© ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÉŸàÿØ
    if not session.get('is_admin'):
        return render_template_string(LOGIN_HTML)
    
    # ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ -> ÿπÿ±ÿ∂ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ

    # --- ÿ¨ŸÑÿ® ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≠ŸÇŸäŸÇŸäÿ© ŸÖŸÜ Firebase ---
    try:
        # ÿπÿØÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        users_ref = db.collection('users')
        total_users = len(list(users_ref.stream()))
        
        # ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ£ÿ±ÿµÿØÿ© (Ÿäÿ≠ÿ™ÿßÿ¨ ŸÑÿπŸÖŸÑ Loop)
        total_balance = 0
        users_list = []
        for user in users_ref.stream():
            user_data = user.to_dict()
            balance = user_data.get('balance', 0)
            total_balance += balance
            users_list.append({
                'id': user.id,
                'name': user_data.get('name', user_data.get('telegram_name', 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ')),
                'balance': balance,
                'username': user_data.get('username', '')
            })

        # ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
        products_ref = db.collection('products')
        all_products = list(products_ref.stream())
        total_products = len(all_products)
        
        # ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ®ÿßÿπ ŸàÿßŸÑŸÖÿ™ÿßÿ≠
        sold_products = 0
        available_products = 0
        for p in all_products:
            p_data = p.to_dict()
            if p_data.get('sold'):
                sold_products += 1
            else:
                available_products += 1
                
        # ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ (Orders)
        orders_ref = db.collection('orders')
        recent_orders_docs = orders_ref.order_by('created_at', direction=firestore.Query.DESCENDING).limit(20).stream()
        recent_orders = []
        total_revenue = 0
        for doc in recent_orders_docs:
            data = doc.to_dict()
            price = data.get('price', 0)
            total_revenue += price
            recent_orders.append({
                'id': doc.id[:8],
                'item_name': data.get('item_name', 'ŸÖŸÜÿ™ÿ¨'),
                'price': price,
                'buyer_name': data.get('buyer_name', 'ŸÖÿ¥ÿ™ÿ±Ÿä'),
                'buyer_id': data.get('buyer_id', ''),
                'created_at': data.get('created_at', '')
            })
        
        # ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™
        total_orders = len(list(orders_ref.stream()))

        # ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠
        keys_ref = db.collection('charge_keys')
        all_keys_docs = list(keys_ref.stream())
        charge_keys_display = []
        active_keys = 0
        used_keys = 0
        
        for k in all_keys_docs:
            data = k.to_dict()
            is_used = data.get('used', False)
            if is_used:
                used_keys += 1
            else:
                active_keys += 1
            charge_keys_display.append({
                'code': k.id,
                'amount': data.get('amount', 0),
                'used': is_used,
                'used_by': data.get('used_by', '')
            })
        
        # ===== ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± (ÿßŸÑÿ¨ÿØŸäÿØ) =====
        invoices_ref = db.collection('merchant_invoices')
        all_invoices = list(invoices_ref.order_by('created_at', direction=firestore.Query.DESCENDING).limit(50).stream())
        invoices_list = []
        total_invoice_revenue = 0
        pending_invoices = 0
        completed_invoices = 0
        
        for inv in all_invoices:
            inv_data = inv.to_dict()
            status = inv_data.get('status', 'pending')
            amount = inv_data.get('amount', 0)
            expires_at = inv_data.get('expires_at', 0)
            
            # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ© (ÿ£ŸÉÿ´ÿ± ŸÖŸÜ ÿ≥ÿßÿπÿ©)
            if status == 'pending' and expires_at > 0 and time.time() > expires_at:
                status = 'expired'  # ÿßÿπÿ™ÿ®ÿ±Ÿáÿß ŸÖÿ±ŸÅŸàÿ∂ÿ©
            
            if status == 'completed':
                completed_invoices += 1
                total_invoice_revenue += amount
            else:
                pending_invoices += 1
            
            invoices_list.append({
                'id': inv.id,
                'merchant_id': inv_data.get('merchant_id', ''),
                'merchant_name': inv_data.get('merchant_name', 'ÿ™ÿßÿ¨ÿ±'),
                'amount': amount,
                'customer_phone': inv_data.get('customer_phone', 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'),
                'status': status,
                'created_at': inv_data.get('created_at', '')
            })
        
        # ===== ÿßŸÑŸÖÿØŸÅŸàÿπÿßÿ™ (pending_payments) =====
        payments_ref = db.collection('pending_payments')
        all_payments = list(payments_ref.order_by('created_at', direction=firestore.Query.DESCENDING).limit(50).stream())
        payments_list = []
        
        for pay in all_payments:
            pay_data = pay.to_dict()
            payments_list.append({
                'order_id': pay.id,
                'user_id': pay_data.get('user_id', ''),
                'amount': pay_data.get('amount', 0),
                'status': pay_data.get('status', 'pending'),
                'is_invoice': pay_data.get('is_merchant_invoice', False),
                'invoice_id': pay_data.get('invoice_id', ''),
                'created_at': pay_data.get('created_at', '')
            })
        
        # ===== ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≥ŸÑÿ© =====
        active_carts = len(user_carts)
        cart_stats_ref = db.collection('cart_stats')
        cart_stats = list(cart_stats_ref.order_by('add_to_cart_count', direction=firestore.Query.DESCENDING).limit(10).stream())
        top_cart_products = []
        total_add_to_cart = 0
        total_cart_purchases = 0
        
        for stat in cart_stats:
            stat_data = stat.to_dict()
            add_count = stat_data.get('add_to_cart_count', 0)
            purchase_count = stat_data.get('purchase_count', 0)
            total_add_to_cart += add_count
            total_cart_purchases += purchase_count
            
            # ÿ¨ŸÑÿ® ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨
            try:
                prod_doc = db.collection('products').document(stat.id).get()
                prod_name = prod_doc.to_dict().get('item_name', 'ŸÖŸÜÿ™ÿ¨') if prod_doc.exists else 'ŸÖÿ≠ÿ∞ŸàŸÅ'
            except:
                prod_name = 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'
            
            top_cart_products.append({
                'product_id': stat.id,
                'name': prod_name,
                'add_count': add_count,
                'purchase_count': purchase_count
            })
        
        # ŸÖÿπÿØŸÑ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ°
        conversion_rate = (total_cart_purchases / total_add_to_cart * 100) if total_add_to_cart > 0 else 0

    except Exception as e:
        print(f"Error loading stats from Firebase: {e}")
        import traceback
        traceback.print_exc()
        # ŸÇŸäŸÖ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ÿπŸÜÿØ ÿßŸÑÿÆÿ∑ÿ£
        total_users = 0
        total_balance = 0
        total_products = 0
        available_products = 0
        sold_products = 0
        total_orders = 0
        total_revenue = 0
        recent_orders = []
        users_list = []
        active_keys = 0
        used_keys = 0
        charge_keys_display = []
        invoices_list = []
        payments_list = []
        total_invoice_revenue = 0
        pending_invoices = 0
        completed_invoices = 0
        active_carts = 0
        top_cart_products = []
        conversion_rate = 0
    
    return f"""
    <!DOCTYPE html>
    <html dir="rtl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ - ÿßŸÑŸÖÿßŸÑŸÉ</title>
        <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
        <style>
            * {{ margin: 0; padding: 0; box-sizing: border-box; }}
            body {{
                font-family: 'Tajawal', 'Segoe UI', sans-serif;
                background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
                min-height: 100vh;
                padding: 20px;
                color: #fff;
            }}
            .container {{
                max-width: 1600px;
                margin: 0 auto;
            }}
            .header {{
                background: rgba(255,255,255,0.1);
                backdrop-filter: blur(10px);
                padding: 20px 30px;
                border-radius: 15px;
                margin-bottom: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 15px;
                border: 1px solid rgba(255,255,255,0.1);
            }}
            .header h1 {{ color: #fff; font-size: 26px; }}
            .header-btns {{ display: flex; gap: 10px; flex-wrap: wrap; }}
            .btn {{
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
                font-family: inherit;
                text-decoration: none;
                display: inline-block;
                font-size: 14px;
            }}
            .btn-success {{ background: linear-gradient(135deg, #00b894, #55efc4); color: #000; }}
            .btn-danger {{ background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; }}
            .btn-primary {{ background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }}
            .btn-info {{ background: linear-gradient(135deg, #00cec9, #81ecec); color: #000; }}
            
            .stats-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 15px;
                margin-bottom: 25px;
            }}
            .stat-card {{
                background: rgba(255,255,255,0.1);
                backdrop-filter: blur(10px);
                padding: 20px;
                border-radius: 15px;
                text-align: center;
                border: 1px solid rgba(255,255,255,0.1);
                transition: transform 0.3s;
            }}
            .stat-card:hover {{ transform: translateY(-5px); }}
            .stat-card .icon {{ font-size: 36px; margin-bottom: 10px; }}
            .stat-card .value {{ font-size: 28px; font-weight: bold; color: #00cec9; }}
            .stat-card .label {{ color: #b2bec3; margin-top: 5px; font-size: 14px; }}
            .stat-card .label {{ color: #888; margin-top: 5px; }}
            .section {{
                background: rgba(255,255,255,0.1);
                backdrop-filter: blur(10px);
                padding: 25px;
                border-radius: 15px;
                margin-bottom: 20px;
                border: 1px solid rgba(255,255,255,0.1);
            }}
            .section h2 {{ 
                color: #fff; 
                margin-bottom: 20px; 
                border-bottom: 2px solid rgba(255,255,255,0.2); 
                padding-bottom: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }}
            .section h2 .count {{
                background: #667eea;
                padding: 5px 15px;
                border-radius: 20px;
                font-size: 14px;
            }}
            .tabs {{
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }}
            .tab {{
                padding: 10px 20px;
                background: rgba(255,255,255,0.1);
                border: none;
                border-radius: 8px;
                color: #fff;
                cursor: pointer;
                font-family: inherit;
                transition: all 0.3s;
            }}
            .tab:hover, .tab.active {{
                background: linear-gradient(135deg, #667eea, #764ba2);
            }}
            table {{
                width: 100%;
                border-collapse: collapse;
            }}
            th, td {{
                padding: 12px;
                text-align: right;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }}
            th {{
                background: rgba(102, 126, 234, 0.3);
                color: #fff;
                font-weight: bold;
            }}
            tr:hover {{ background: rgba(255,255,255,0.05); }}
            .badge {{
                display: inline-block;
                padding: 5px 12px;
                border-radius: 15px;
                font-size: 12px;
                font-weight: bold;
            }}
            .badge-success {{ background: #00b894; color: white; }}
            .badge-danger {{ background: #e74c3c; color: white; }}
            .badge-warning {{ background: #fdcb6e; color: #333; }}
            .badge-info {{ background: #74b9ff; color: white; }}
            .badge-pending {{ background: #f39c12; color: white; }}
            
            .search-box {{
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
            }}
            .search-box input {{
                flex: 1;
                padding: 12px 15px;
                border: 2px solid rgba(255,255,255,0.2);
                border-radius: 8px;
                background: rgba(255,255,255,0.1);
                color: #fff;
                font-family: inherit;
            }}
            .search-box input::placeholder {{ color: #888; }}
            .search-box input:focus {{ outline: none; border-color: #667eea; }}
            
            .bot-commands {{
                background: rgba(102, 126, 234, 0.2);
                border: 1px solid rgba(102, 126, 234, 0.3);
                border-radius: 12px;
                padding: 20px;
            }}
            .bot-commands h3 {{ color: #fff; margin-bottom: 15px; }}
            .command-item {{
                background: rgba(255,255,255,0.1);
                padding: 12px 15px;
                border-radius: 8px;
                margin-bottom: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-right: 4px solid #667eea;
            }}
            .command-item code {{
                background: rgba(102, 126, 234, 0.3);
                padding: 5px 10px;
                border-radius: 5px;
                font-family: monospace;
                color: #81ecec;
            }}
            .command-item span {{ color: #b2bec3; font-size: 14px; }}
            
            .hidden {{ display: none; }}
            
            @media (max-width: 768px) {{
                .stats-grid {{ grid-template-columns: repeat(2, 1fr); }}
                .stat-card .value {{ font-size: 22px; }}
                table {{ font-size: 13px; }}
                th, td {{ padding: 8px 5px; }}
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üéõÔ∏è ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ</h1>
                <div class="header-btns">
                    <a href="/admin/products" class="btn btn-success">üè™ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</a>
                    <a href="/admin/categories" class="btn btn-info">üè∑Ô∏è ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</a>
                    <button class="btn btn-primary" onclick="location.reload()">üîÑ ÿ™ÿ≠ÿØŸäÿ´</button>
                    <a href="/logout_admin" class="btn btn-danger">üö™ ÿÆÿ±Ÿàÿ¨</a>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">üë•</div>
                    <div class="value">{total_users}</div>
                    <div class="label">ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üì¶</div>
                    <div class="value">{available_products}</div>
                    <div class="label">ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üõí</div>
                    <div class="value">{active_carts}</div>
                    <div class="label">ÿ≥ŸÑÿßÿ™ ŸÜÿ¥ÿ∑ÿ©</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üìä</div>
                    <div class="value">{conversion_rate:.1f}%</div>
                    <div class="label">ŸÖÿπÿØŸÑ ÿßŸÑÿ•ÿ™ŸÖÿßŸÖ</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üßæ</div>
                    <div class="value">{completed_invoices}</div>
                    <div class="label">ŸÅŸàÿßÿ™Ÿäÿ± ŸÖŸÉÿ™ŸÖŸÑÿ©</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üí≥</div>
                    <div class="value">{total_invoice_revenue:.0f}</div>
                    <div class="label">ÿ•Ÿäÿ±ÿßÿØÿßÿ™ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üí∞</div>
                    <div class="value">{total_balance:.0f}</div>
                    <div class="label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ÿ±ÿµÿØÿ©</div>
                </div>
                <div class="stat-card">
                    <div class="icon">‚úÖ</div>
                    <div class="value">{sold_products}</div>
                    <div class="label">ŸÖÿ®ÿßÿπÿ©</div>
                </div>
            </div>
            
            <!-- ===== ŸÇÿ≥ŸÖ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ≥ŸÑÿ© ===== -->
            <div class="section">
                <h2>üõí ÿ£ŸÉÿ´ÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ© <span class="count">{len(top_cart_products)}</span></h2>
                <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
                            <th>ÿ•ÿ∂ÿßŸÅÿßÿ™ ŸÑŸÑÿ≥ŸÑÿ©</th>
                            <th>ŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™</th>
                            <th>ŸÖÿπÿØŸÑ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {''.join([f'''
                        <tr>
                            <td>{i+1}</td>
                            <td>{p['name']}</td>
                            <td><span style="color:#a29bfe">{p['add_count']}</span></td>
                            <td><span style="color:#00b894">{p['purchase_count']}</span></td>
                            <td><span style="color:#f1c40f">{(p['purchase_count']/p['add_count']*100 if p['add_count'] > 0 else 0):.1f}%</span></td>
                        </tr>
                        ''' for i, p in enumerate(top_cart_products)]) if top_cart_products else '<tr><td colspan="5" style="text-align:center;color:#888">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿπÿØ</td></tr>'}
                    </tbody>
                </table>
                </div>
            </div>
            
            <!-- ===== ŸÇÿ≥ŸÖ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ===== -->
            <div class="section">
                <h2>üßæ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± <span class="count">{len(invoices_list)}</span></h2>
                <div class="search-box">
                    <input type="text" id="invoiceSearch" placeholder="üîç ÿ®ÿ≠ÿ´ ÿ®ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ£Ÿà ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸäŸÑ..." onkeyup="searchTable('invoiceSearch', 'invoicesTable')">
                </div>
                <div style="overflow-x: auto;">
                <table id="invoicesTable">
                    <thead>
                        <tr>
                            <th>ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</th>
                            <th>ÿßŸÑÿ™ÿßÿ¨ÿ±</th>
                            <th>ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
                            <th>ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸäŸÑ</th>
                            <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                        </tr>
                    </thead>
                    <tbody>
                        {''.join([f"""
                        <tr>
                            <td><code>{inv['id']}</code></td>
                            <td>{inv['merchant_name']} <small style="color:#888">({inv['merchant_id']})</small></td>
                            <td style="color:#00cec9; font-weight:bold;">{inv['amount']} ÿ±ŸäÿßŸÑ</td>
                            <td dir="ltr">{inv['customer_phone']}</td>
                            <td><span class="badge {'badge-success' if inv['status'] == 'completed' else 'badge-danger' if inv['status'] in ['expired', 'failed', 'declined'] else 'badge-pending'}">{'ŸÖŸÉÿ™ŸÖŸÑ' if inv['status'] == 'completed' else 'ŸÖÿ±ŸÅŸàÿ∂ÿ©' if inv['status'] in ['expired', 'failed', 'declined'] else 'ŸÖÿπŸÑŸÇ'}</span></td>
                        </tr>
                        """ for inv in invoices_list]) if invoices_list else '<tr><td colspan="5" style="text-align:center; color:#888;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÅŸàÿßÿ™Ÿäÿ±</td></tr>'}
                    </tbody>
                </table>
                </div>
            </div>
            
            <!-- ===== ŸÇÿ≥ŸÖ ÿßŸÑŸÖÿØŸÅŸàÿπÿßÿ™ ===== -->
            <div class="section">
                <h2>üí≥ ÿßŸÑŸÖÿØŸÅŸàÿπÿßÿ™ <span class="count">{len(payments_list)}</span></h2>
                <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ®</th>
                            <th>ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                            <th>ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
                            <th>ÿßŸÑŸÜŸàÿπ</th>
                            <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                        </tr>
                    </thead>
                    <tbody>
                        {''.join([f"""
                        <tr>
                            <td><code>{pay['order_id'][:15]}...</code></td>
                            <td>{pay['user_id']}</td>
                            <td style="color:#00cec9; font-weight:bold;">{pay['amount']} ÿ±ŸäÿßŸÑ</td>
                            <td><span class="badge {'badge-info' if pay['is_invoice'] else 'badge-warning'}">{'ŸÅÿßÿ™Ÿàÿ±ÿ©' if pay['is_invoice'] else 'ÿ¥ÿ≠ŸÜ'}</span></td>
                            <td><span class="badge {'badge-success' if pay['status'] == 'completed' else 'badge-danger' if pay['status'] == 'failed' else 'badge-pending'}">{'ŸÖŸÉÿ™ŸÖŸÑ' if pay['status'] == 'completed' else 'ŸÅÿ¥ŸÑ' if pay['status'] == 'failed' else 'ŸÖÿπŸÑŸÇ'}</span></td>
                        </tr>
                        """ for pay in payments_list]) if payments_list else '<tr><td colspan="5" style="text-align:center; color:#888;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿØŸÅŸàÿπÿßÿ™</td></tr>'}
                    </tbody>
                </table>
                </div>
            </div>
            
            <!-- ===== ŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ===== -->
            <div class="section">
                <h2>üë• ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ <span class="count">{len(users_list)}</span></h2>
                <div class="search-box">
                    <input type="text" id="userSearch" placeholder="üîç ÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿ¢ŸäÿØŸä..." onkeyup="searchTable('userSearch', 'usersTable')">
                </div>
                <div style="overflow-x: auto;">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>ÿ¢ŸäÿØŸä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                            <th>ÿßŸÑÿßÿ≥ŸÖ</th>
                            <th>ÿßŸÑÿ±ÿµŸäÿØ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {''.join([f'''
                        <tr>
                            <td><code>{user['id']}</code></td>
                            <td>{user['name']}</td>
                            <td style="color:#00cec9; font-weight:bold;">{user['balance']:.2f} ÿ±ŸäÿßŸÑ</td>
                        </tr>
                        ''' for user in users_list]) if users_list else '<tr><td colspan="3" style="text-align:center; color:#888;">ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</td></tr>'}
                    </tbody>
                </table>
                </div>
            </div>
            
            <!-- ===== ÿ£ŸàÿßŸÖÿ± ÿßŸÑÿ®Ÿàÿ™ ===== -->
            <div class="section">
                <h2>ü§ñ ÿ£ŸàÿßŸÖÿ± ÿßŸÑÿ®Ÿàÿ™</h2>
                <div class="bot-commands">
                    <div class="command-item">
                        <code>/ŸÅÿßÿ™Ÿàÿ±ÿ©</code>
                        <span>ÿ•ŸÜÿ¥ÿßÿ° ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ¨ÿØŸäÿØÿ©</span>
                    </div>
                    <div class="command-item">
                        <code>/add ID AMOUNT</code>
                        <span>ÿ¥ÿ≠ŸÜ ÿ±ÿµŸäÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖ</span>
                    </div>
                    <div class="command-item">
                        <code>/ÿ™ŸàŸÑŸäÿØ 50 10</code>
                        <span>ÿ™ŸàŸÑŸäÿØ 10 ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿ®ŸÇŸäŸÖÿ© 50 ÿ±ŸäÿßŸÑ</span>
                    </div>
                    <div class="command-item">
                        <code>/ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠</code>
                        <span>ÿπÿ±ÿ∂ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠</span>
                    </div>
                    <div class="command-item">
                        <code>/add_product</code>
                        <span>ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ</span>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>ÔøΩ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ <span class="count">{len(charge_keys_display)}</span></h2>
                <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>ÿßŸÑŸÖŸÅÿ™ÿßÿ≠</th>
                            <th>ÿßŸÑŸÇŸäŸÖÿ©</th>
                            <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                            <th>ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®Ÿàÿßÿ≥ÿ∑ÿ©</th>
                        </tr>
                    </thead>
                    <tbody>
                        {''.join([f"""
                        <tr>
                            <td><code>{key['code']}</code></td>
                            <td style="color:#00cec9;">{key['amount']} ÿ±ŸäÿßŸÑ</td>
                            <td><span class="badge {'badge-success' if not key['used'] else 'badge-danger'}">{'ŸÜÿ¥ÿ∑' if not key['used'] else 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ'}</span></td>
                            <td>{key['used_by'] if key['used'] else '-'}</td>
                        </tr>
                        """ for key in charge_keys_display[:30]]) if charge_keys_display else '<tr><td colspan="4" style="text-align:center; color:#888;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÅÿßÿ™Ÿäÿ≠</td></tr>'}
                    </tbody>
                </table>
                </div>
            </div>
        </div>
        
        <script>
            // ÿØÿßŸÑÿ© ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ¨ÿØÿßŸàŸÑ
            function searchTable(inputId, tableId) {{
                const input = document.getElementById(inputId);
                const filter = input.value.toLowerCase();
                const table = document.getElementById(tableId);
                const rows = table.getElementsByTagName('tr');
                
                for (let i = 1; i < rows.length; i++) {{
                    const cells = rows[i].getElementsByTagName('td');
                    let found = false;
                    for (let j = 0; j < cells.length; j++) {{
                        if (cells[j].textContent.toLowerCase().includes(filter)) {{
                            found = true;
                            break;
                        }}
                    }}
                    rows[i].style.display = found ? '' : 'none';
                }}
            }}
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÉŸÑ 60 ÿ´ÿßŸÜŸäÿ©
            setTimeout(() => location.reload(), 60000);
        </script>
    </body>
    </html>
    """

# API ŸÑÿ¥ÿ≠ŸÜ ÿ±ÿµŸäÿØ ŸÖŸÜ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ (ŸÑŸÑÿ£ÿØŸÖŸÜ ŸÅŸÇÿ∑)
@app.route('/api/add_balance', methods=['POST'])
def api_add_balance():
    # ===== ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ£ÿØŸÖŸÜ =====
    if not session.get('is_admin'):
        return {'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠!'}
    
    data = request.json
    user_id = str(data.get('user_id'))
    amount = float(data.get('amount'))
    
    if not user_id or amount <= 0:
        return {'status': 'error', 'message': 'ÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©'}
    
    add_balance(user_id, amount)
    
    # ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    try:
        bot.send_message(int(user_id), f"üéâ ÿ™ŸÖ ÿ¥ÿ≠ŸÜ ÿ±ÿµŸäÿØŸÉ ÿ®ŸÖÿ®ŸÑÿ∫ {amount} ÿ±ŸäÿßŸÑ!")
    except:
        pass
    
    return {'status': 'success'}

# --- API ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ (ŸÖÿµÿ≠ÿ≠ ŸÑŸÑÿ≠ŸÅÿ∏ ŸÅŸä Firebase) ---
@app.route('/api/add_product', methods=['POST'])
def api_add_product():
    # ===== ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ£ÿØŸÖŸÜ =====
    if not session.get('is_admin'):
        return {'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠!'}
    
    try:
        data = request.json
        name = data.get('name')
        price = data.get('price')
        category = data.get('category')
        details = data.get('details', '')
        image = data.get('image', '')
        hidden_data = data.get('hidden_data')
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        if not name or not price or not hidden_data:
            return {'status': 'error', 'message': 'ÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÉÿßŸÖŸÑÿ©'}
        
        # ÿ•ŸÜÿ¥ÿßÿ° ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨
        new_id = str(uuid.uuid4())
        item = {
            'id': new_id,
            'item_name': name,
            'price': float(price),
            'seller_id': str(ADMIN_ID),
            'seller_name': 'ÿßŸÑŸÖÿßŸÑŸÉ',
            'hidden_data': hidden_data,
            'category': category,
            'details': details,
            'image_url': image,
            'sold': False,
            'created_at': firestore.SERVER_TIMESTAMP
        }
        
        # 1. ÿßŸÑÿ≠ŸÅÿ∏ ŸÅŸä Firebase (ÿßŸÑŸÖŸáŸÖ)
        db.collection('products').document(new_id).set(item)
        print(f"‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÜÿ™ÿ¨ {new_id} ŸÅŸä Firestore: {name}")
        
        # 2. ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ© (ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑÿ≥ÿ±Ÿäÿπ)
        marketplace_items.append(item)
        print(f"‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÑŸÑÿ∞ÿßŸÉÿ±ÿ©. ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™: {len(marketplace_items)}")
        
        # 3. ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿßŸÑŸÉ (ÿØÿßÿÆŸÑ try/except ŸÑÿ∂ŸÖÿßŸÜ ÿπÿØŸÖ ÿ™ŸàŸÇŸÅ ÿßŸÑÿπŸÖŸÑŸäÿ©)
        try:
            bot.send_message(
                ADMIN_ID,
                f"‚úÖ **ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ**\nüì¶ {name}\nüí∞ {price} ÿ±ŸäÿßŸÑ",
                parse_mode="Markdown"
            )
        except Exception as e:
            print(f"ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±: {e}")
            
        return {'status': 'success', 'message': 'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™'}

    except Exception as e:
        print(f"Error in add_product: {e}")
        return {'status': 'error', 'message': f'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±: {str(e)}'}

# --- API ŸÑÿ™ŸàŸÑŸäÿØ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠ (ŸÖÿµÿ≠ÿ≠ ŸÑŸÑÿ≠ŸÅÿ∏ ŸÅŸä Firebase) ---
@app.route('/api/generate_keys', methods=['POST'])
def api_generate_keys():
    # ===== ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ£ÿØŸÖŸÜ =====
    if not session.get('is_admin'):
        return {'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠!'}
    
    try:
        data = request.json
        amount = float(data.get('amount'))
        count = int(data.get('count', 1))
        
        if amount <= 0 or count <= 0 or count > 100:
            return {'status': 'error', 'message': 'ÿ£ÿ±ŸÇÿßŸÖ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©'}
        
        generated_keys = []
        batch = db.batch() # ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿØŸÅÿπÿßÿ™ ŸÑŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ≥ÿ±Ÿäÿπ
        
        for _ in range(count):
            # ÿ•ŸÜÿ¥ÿßÿ° ŸÉŸàÿØ ÿπÿ¥Ÿàÿßÿ¶Ÿä
            key_code = f"KEY-{random.randint(10000, 99999)}-{random.randint(1000, 9999)}"
            
            key_data = {
                'amount': amount,
                'used': False,
                'used_by': None,
                'created_at': firestore.SERVER_TIMESTAMP
            }
            
            # ÿ™ÿ¨ŸáŸäÿ≤ ÿßŸÑÿ≠ŸÅÿ∏ ŸÅŸä Firebase
            doc_ref = db.collection('charge_keys').document(key_code)
            batch.set(doc_ref, key_data)
            
            # ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
            charge_keys[key_code] = key_data
            generated_keys.append(key_code)
            
        # ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ≠ŸÅÿ∏ ŸÅŸä Firebase ÿØŸÅÿπÿ© Ÿàÿßÿ≠ÿØÿ©
        batch.commit()
        
        return {'status': 'success', 'keys': generated_keys}

    except Exception as e:
        print(f"Error generating keys: {e}")
        return {'status': 'error', 'message': f'ŸÅÿ¥ŸÑ ÿßŸÑÿ™ŸàŸÑŸäÿØ: {str(e)}'}

# ==================== ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÖÿ§ŸÇÿ™ ŸÑŸÑÿØÿÆŸàŸÑ ====================

# API ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ
@app.route('/api/admin/send_code', methods=['POST'])
@limiter.limit("3 per minute")  # üîí Rate Limiting: ŸÖŸÜÿπ ÿ™ÿÆŸÖŸäŸÜ ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ÿßŸÑÿ£ÿØŸÖŸÜ
def api_send_admin_code():
    global admin_login_codes, failed_login_attempts
    
    try:
        data = request.json
        password = data.get('password', '')
        client_ip = request.headers.get('X-Forwarded-For', request.remote_addr)
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿ∏ÿ± ÿ®ÿ≥ÿ®ÿ® ŸÖÿ≠ÿßŸàŸÑÿßÿ™ ŸÅÿßÿ¥ŸÑÿ©
        if client_ip in failed_login_attempts:
            attempt_data = failed_login_attempts[client_ip]
            if attempt_data.get('blocked_until', 0) > time.time():
                remaining = int(attempt_data['blocked_until'] - time.time())
                return jsonify({
                    'status': 'error',
                    'message': f'‚õî ÿ™ŸÖ ÿ≠ÿ∏ÿ±ŸÉ ŸÖÿ§ŸÇÿ™ÿßŸã. ÿ≠ÿßŸàŸÑ ÿ®ÿπÿØ {remaining} ÿ´ÿßŸÜŸäÿ©'
                })
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
        admin_password = os.environ.get('ADMIN_PASS', 'admin123')
        
        if password != admin_password:
            # ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑŸÅÿßÿ¥ŸÑÿ©
            if client_ip not in failed_login_attempts:
                failed_login_attempts[client_ip] = {'count': 0, 'blocked_until': 0}
            
            failed_login_attempts[client_ip]['count'] += 1
            attempts_left = 5 - failed_login_attempts[client_ip]['count']
            
            # ÿ≠ÿ∏ÿ± ÿ®ÿπÿØ 5 ŸÖÿ≠ÿßŸàŸÑÿßÿ™
            if failed_login_attempts[client_ip]['count'] >= 5:
                failed_login_attempts[client_ip]['blocked_until'] = time.time() + 900  # 15 ÿØŸÇŸäŸÇÿ©
                
                # ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÜÿ®ŸäŸá ÿ£ŸÖŸÜŸä ŸÑŸÑŸÖÿßŸÑŸÉ
                try:
                    alert_msg = f"""
‚ö†Ô∏è *ÿ™ŸÜÿ®ŸäŸá ÿ£ŸÖŸÜŸä!*

ŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿØÿÆŸàŸÑ ŸÅÿßÿ¥ŸÑÿ© ŸÖÿ™ÿπÿØÿØÿ© ŸÑŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ!

üåê *IP:* `{client_ip}`
‚è∞ *ÿßŸÑŸàŸÇÿ™:* {time.strftime('%Y-%m-%d %H:%M:%S')}
üîí *ÿßŸÑÿ≠ÿßŸÑÿ©:* ÿ™ŸÖ ÿßŸÑÿ≠ÿ∏ÿ± ŸÑŸÖÿØÿ© 15 ÿØŸÇŸäŸÇÿ©
                    """
                    if BOT_ACTIVE:
                        bot.send_message(ADMIN_ID, alert_msg, parse_mode='Markdown')
                except Exception as e:
                    print(f"Failed to send security alert: {e}")
                
                return jsonify({
                    'status': 'error',
                    'message': '‚õî ÿ™ŸÖ ÿ≠ÿ∏ÿ±ŸÉ ŸÑŸÖÿØÿ© 15 ÿØŸÇŸäŸÇÿ© ÿ®ÿ≥ÿ®ÿ® ŸÖÿ≠ÿßŸàŸÑÿßÿ™ ŸÅÿßÿ¥ŸÑÿ© ŸÖÿ™ŸÉÿ±ÿ±ÿ©'
                })
            
            return jsonify({
                'status': 'error',
                'message': f'‚ùå ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ÿÆÿßÿ∑ÿ¶ÿ©! ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©: {attempts_left}'
            })
        
        # ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿµÿ≠Ÿäÿ≠ÿ© - ÿ™ŸàŸÑŸäÿØ ŸÉŸàÿØ ÿπÿ¥Ÿàÿßÿ¶Ÿä
        code = str(random.randint(100000, 999999))
        
        # ÿ≠ŸÅÿ∏ ÿßŸÑŸÉŸàÿØ ŸÖÿπ ŸàŸÇÿ™ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° (3 ÿØŸÇÿßÿ¶ŸÇ)
        admin_login_codes = {
            'code': code,
            'created_at': time.time(),
            'expires_at': time.time() + 180,  # 3 ÿØŸÇÿßÿ¶ŸÇ
            'used': False,
            'ip': client_ip
        }
        
        # ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÉŸàÿØ ŸÑŸÑŸÖÿßŸÑŸÉ ÿπÿ®ÿ± ÿßŸÑÿ®Ÿàÿ™
        try:
            if BOT_ACTIVE:
                code_msg = f"""
üîê *ÿ∑ŸÑÿ® ÿØÿÆŸàŸÑ ŸÑŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ*

üìç *ÿßŸÑŸÉŸàÿØ:* `{code}`
‚è∞ *ÿµÿßŸÑÿ≠ ŸÑŸÖÿØÿ©:* 3 ÿØŸÇÿßÿ¶ŸÇ
üåê *IP:* `{client_ip}`
‚è±Ô∏è *ÿßŸÑŸàŸÇÿ™:* {time.strftime('%Y-%m-%d %H:%M:%S')}

‚ö†Ô∏è *ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ÿ£ŸÜÿ™ÿå ÿ™ÿ¨ÿßŸáŸÑ Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ!*
                """
                bot.send_message(ADMIN_ID, code_msg, parse_mode='Markdown')
                
                # ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÅÿßÿ¥ŸÑÿ© ÿπŸÜÿØ ÿßŸÑŸÜÿ¨ÿßÿ≠
                if client_ip in failed_login_attempts:
                    del failed_login_attempts[client_ip]
                
                return jsonify({'status': 'success', 'message': 'ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÉŸàÿØ'})
            else:
                return jsonify({
                    'status': 'error',
                    'message': '‚ùå ÿßŸÑÿ®Ÿàÿ™ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ! ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÉŸàÿØ'
                })
        except Exception as e:
            print(f"Error sending code: {e}")
            return jsonify({
                'status': 'error',
                'message': '‚ùå ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÉŸàÿØ ŸÑŸÑÿ®Ÿàÿ™'
            })
            
    except Exception as e:
        print(f"Error in send_code: {e}")
        return jsonify({'status': 'error', 'message': 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±'})

# API ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÉŸàÿØ
@app.route('/api/admin/verify_code', methods=['POST'])
def api_verify_admin_code():
    global admin_login_codes
    
    try:
        data = request.json
        code = data.get('code', '').strip()
        client_ip = request.headers.get('X-Forwarded-For', request.remote_addr)
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÉŸàÿØ ŸÜÿ¥ÿ∑
        if not admin_login_codes or not admin_login_codes.get('code'):
            return jsonify({
                'status': 'error',
                'message': '‚ùå ŸÑÿß ŸäŸàÿ¨ÿØ ŸÉŸàÿØ ŸÜÿ¥ÿ∑. ÿßÿ∑ŸÑÿ® ŸÉŸàÿØ ÿ¨ÿØŸäÿØ'
            })
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©
        if time.time() > admin_login_codes.get('expires_at', 0):
            admin_login_codes = {}  # ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÖŸÜÿ™ŸáŸä
            return jsonify({
                'status': 'error',
                'message': '‚è∞ ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÉŸàÿØ! ÿßÿ∑ŸÑÿ® ŸÉŸàÿØ ÿ¨ÿØŸäÿØ'
            })
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÉŸàÿØ ŸÖÿ≥ÿ®ŸÇÿßŸã
        if admin_login_codes.get('used'):
            return jsonify({
                'status': 'error',
                'message': '‚ùå ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ ŸÖÿ≥ÿ®ŸÇÿßŸã'
            })
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑŸÉŸàÿØ
        if code != admin_login_codes.get('code'):
            return jsonify({
                'status': 'error',
                'message': '‚ùå ŸÉŸàÿØ ÿÆÿßÿ∑ÿ¶!'
            })
        
        # ÿßŸÑŸÉŸàÿØ ÿµÿ≠Ÿäÿ≠ - ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
        admin_login_codes['used'] = True
        session['is_admin'] = True
        
        # ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠ ÿßŸÑÿØÿÆŸàŸÑ
        try:
            if BOT_ACTIVE:
                success_msg = f"""
‚úÖ *ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!*

üåê *IP:* `{client_ip}`
‚è∞ *ÿßŸÑŸàŸÇÿ™:* {time.strftime('%Y-%m-%d %H:%M:%S')}
                """
                bot.send_message(ADMIN_ID, success_msg, parse_mode='Markdown')
        except:
            pass
        
        # ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸàÿØ
        admin_login_codes = {}
        
        return jsonify({'status': 'success', 'message': 'ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ®ŸÜÿ¨ÿßÿ≠'})
        
    except Exception as e:
        print(f"Error in verify_code: {e}")
        return jsonify({'status': 'error', 'message': 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±'})

# ŸÖÿ≥ÿßÿ± ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨ ÿßŸÑÿ¢ÿØŸÖŸÜ
@app.route('/logout_admin')
def logout_admin():
    session.pop('is_admin', None)
    return redirect('/dashboard')

# ==================== ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÑŸÖÿßŸÑŸÉ ====================

ADMIN_PRODUCTS_HTML = """
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ - ÿßŸÑŸÖÿßŸÑŸÉ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --success: #00b894;
            --danger: #e74c3c;
            --warning: #fdcb6e;
            --bg: #1a1a2e;
            --card: #16213e;
            --text: #ffffff;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* ÿßŸÑŸáŸäÿØÿ± */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #a29bfe);
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, var(--success), #55efc4);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #ff7675);
            color: white;
        }
        .btn-secondary {
            background: #636e72;
            color: white;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        
        /* ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™ */
        .section-title {
            font-size: 18px;
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .product-card {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }
        .product-card:hover { transform: translateY(-5px); }
        .product-image {
            height: 120px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            position: relative;
        }
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .product-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--warning);
            color: #2d3436;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .product-info { padding: 15px; }
        .product-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .product-details {
            color: #888;
            font-size: 13px;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid #333;
        }
        .product-price {
            font-size: 20px;
            font-weight: bold;
            color: var(--success);
        }
        .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-size: 13px;
            transition: all 0.3s;
        }
        .delete-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }
        
        /* ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿπÿ© */
        .sold-card {
            opacity: 0.6;
            position: relative;
        }
        .sold-card::after {
            content: 'ŸÖÿ®ÿßÿπ ‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background: var(--danger);
            color: white;
            padding: 10px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 5px;
            z-index: 10;
        }
        
        /* ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ© */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--card);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            background: linear-gradient(135deg, var(--success), #55efc4);
            padding: 20px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }
        .modal-header h2 {
            font-size: 20px;
            margin: 0;
        }
        .modal-body { padding: 25px; }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #a29bfe;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #333;
            border-radius: 12px;
            background: var(--bg);
            color: var(--text);
            font-size: 15px;
            font-family: 'Tajawal', sans-serif;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .modal-footer {
            display: flex;
            gap: 10px;
            padding: 0 25px 25px;
        }
        .modal-footer .btn { flex: 1; justify-content: center; }
        
        /* ÿ≠ÿßŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ© */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #888;
        }
        .empty-state .icon { font-size: 60px; margin-bottom: 15px; }
        
        /* ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: var(--card);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
        }
        .stat-label {
            color: #888;
            font-size: 14px;
            margin-top: 5px;
        }
        
        /* ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        .spinner {
            border: 4px solid #333;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ŸÜÿ®ŸäŸá */
        .alert {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }
        .alert.show { display: block; animation: fadeIn 0.3s; }
        .alert-success { background: rgba(0, 184, 148, 0.2); border: 1px solid var(--success); color: var(--success); }
        .alert-error { background: rgba(231, 76, 60, 0.2); border: 1px solid var(--danger); color: var(--danger); }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ÿßŸÑŸáŸäÿØÿ± -->
        <div class="header">
            <h1>üè™ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</h1>
            <div class="header-actions">
                <a href="/admin/categories" class="btn btn-primary">üè∑Ô∏è ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</a>
                <button class="btn btn-success" onclick="openAddModal()">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨</button>
                <a href="/dashboard" class="btn btn-secondary">üîô ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ</a>
            </div>
        </div>
        
        <!-- ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ŸÜÿ®ŸäŸá -->
        <div id="alertSuccess" class="alert alert-success"></div>
        <div id="alertError" class="alert alert-error"></div>
        
        <!-- ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalProducts">0</div>
                <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="availableProducts">0</div>
                <div class="stat-label">ŸÖÿ™ÿßÿ≠ ŸÑŸÑÿ®Ÿäÿπ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="soldProducts">0</div>
                <div class="stat-label">ÿ™ŸÖ ÿ®ŸäÿπŸáÿß</div>
            </div>
        </div>
        
        <!-- ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© -->
        <h2 class="section-title">üì¶ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</h2>
        <div id="availableGrid" class="products-grid">
            <div class="loading">
                <div class="spinner"></div>
                <p>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>
            </div>
        </div>
        
        <!-- ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿπÿ© -->
        <h2 class="section-title">‚úÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿπÿ©</h2>
        <div id="soldGrid" class="products-grid">
            <div class="loading">
                <div class="spinner"></div>
                <p>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>
            </div>
        </div>
    </div>
    
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ</h2>
            </div>
            <div class="modal-body">
                <!-- ÿßÿÆÿ™Ÿäÿßÿ± ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿ£ŸàŸÑÿßŸã -->
                <div class="form-group">
                    <label>üì¶ ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ *</label>
                    <select id="productDeliveryType" required onchange="toggleDeliveryFields()">
                        <option value="">-- ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ --</option>
                        <option value="instant">‚ö° ÿ™ÿ≥ŸÑŸäŸÖ ŸÅŸàÿ±Ÿä (ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™)</option>
                        <option value="manual">üë®‚Äçüíº ÿ™ÿ≥ŸÑŸäŸÖ ŸäÿØŸàŸä (ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä ŸäŸÉÿ™ÿ® ÿ∑ŸÑÿ®Ÿá)</option>
                    </select>
                </div>
                
                <!-- ÿ≠ŸÇŸàŸÑ ŸÖÿ¥ÿ™ÿ±ŸÉÿ© -->
                <div id="commonFields" style="display: none;">
                    <div class="form-group">
                        <label>üì¶ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ *</label>
                        <input type="text" id="productName" placeholder="ŸÖÿ´ÿßŸÑ: ŸÜÿ™ŸÅŸÑŸÉÿ≥ ÿ¥Ÿáÿ± ŸÉÿßŸÖŸÑ" required>
                    </div>
                    <div class="form-group">
                        <label>üí∞ ÿßŸÑÿ≥ÿπÿ± (ÿ±ŸäÿßŸÑ) *</label>
                        <input type="number" id="productPrice" placeholder="25" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>üè∑Ô∏è ÿßŸÑŸÅÿ¶ÿ© *</label>
                        <select id="productCategory" required>
                            <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÅÿ¶ÿ© --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìù ŸàÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
                        <textarea id="productDetails" placeholder="ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ± ŸÑŸÑŸÖŸÜÿ™ÿ¨..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>üñºÔ∏è ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
                        <input type="url" id="productImage" placeholder="https://example.com/image.jpg">
                    </div>
                </div>
                
                <!-- ÿ≠ŸÇŸàŸÑ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸÅŸàÿ±Ÿä ŸÅŸÇÿ∑ -->
                <div id="instantFields" style="display: none;">
                    <div class="form-group" style="background: rgba(46, 204, 113, 0.1); padding: 15px; border-radius: 10px; border: 1px solid rgba(46, 204, 113, 0.3);">
                        <label>üîê ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿ© (ÿ•ŸäŸÖŸäŸÑ/ÿ®ÿßÿ≥Ÿàÿ±ÿØ) *</label>
                        <textarea id="productHiddenData" placeholder="email@example.com&#10;password123" style="min-height: 80px;"></textarea>
                        <small style="color: #888;">‚ö° Ÿáÿ∞Ÿá ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≥ÿ™Ÿèÿ±ÿ≥ŸÑ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÑŸÑŸÖÿ¥ÿ™ÿ±Ÿä ŸÅŸàÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°</small>
                    </div>
                </div>
                
                <!-- ÿ≠ŸÇŸàŸÑ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸäÿØŸàŸä ŸÅŸÇÿ∑ -->
                <div id="manualFields" style="display: none;">
                    <div class="form-group" style="background: rgba(241, 196, 15, 0.1); padding: 15px; border-radius: 10px; border: 1px solid rgba(241, 196, 15, 0.3);">
                        <label>üìù ŸÖÿßÿ∞ÿß ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÖŸÜ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿü *</label>
                        <textarea id="productBuyerInstructions" placeholder="ŸÖÿ´ÿßŸÑ: ÿ¢ŸäÿØŸä ÿßŸÑŸÑÿπÿ®ÿ©ÿå ÿßÿ≥ŸÖ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿå ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©..." style="min-height: 80px;"></textarea>
                        <small style="color: #888;">üë®‚Äçüíº ÿ≥Ÿäÿ∏Ÿáÿ± Ÿáÿ∞ÿß ŸÑŸÑŸÖÿ¥ÿ™ÿ±Ÿä Ÿàÿ≥ŸäŸèÿ∑ŸÑÿ® ŸÖŸÜŸá ŸÉÿ™ÿßÿ®ÿ© Ÿáÿ∞Ÿá ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button class="btn btn-success" onclick="submitProduct()">‚úÖ ŸÜÿ¥ÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨</button>
            </div>
        </div>
    </div>
    
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                <h2>üóëÔ∏è ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ</h2>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div style="font-size: 50px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                <p style="font-size: 16px; margin-bottom: 10px;">ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ÿü</p>
                <p id="deleteProductName" style="color: var(--danger); font-weight: bold;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button class="btn btn-danger" onclick="confirmDelete()">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>
            </div>
        </div>
    </div>
    
    <script>
        const ADMIN_ID = {{ admin_id }};
        let productToDelete = null;
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸàÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿµŸÅÿ≠ÿ©
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadCategoriesForSelect();
        });
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸÑŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ©
        async function loadCategoriesForSelect() {
            try {
                const response = await fetch('/api/admin/get_categories');
                const data = await response.json();
                
                if(data.status === 'success') {
                    const select = document.getElementById('productCategory');
                    select.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÅÿ¶ÿ© --</option>';
                    data.categories.forEach(cat => {
                        select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                    });
                }
            } catch(error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ:', error);
            }
        }
        
        async function loadProducts() {
            try {
                const response = await fetch('/api/admin/get_products');
                const data = await response.json();
                
                if(data.status === 'success') {
                    renderProducts(data.available, data.sold);
                    updateStats(data.available.length, data.sold.length);
                } else {
                    showAlert('error', 'ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™');
                }
            } catch(error) {
                showAlert('error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±');
            }
        }
        
        function renderProducts(available, sold) {
            const availableGrid = document.getElementById('availableGrid');
            const soldGrid = document.getElementById('soldGrid');
            
            // ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©
            if(available.length === 0) {
                availableGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="icon">üì¶</div>
                        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ÿ≠ÿßŸÑŸäÿßŸã</p>
                    </div>
                `;
            } else {
                availableGrid.innerHTML = available.map(product => `
                    <div class="product-card">
                        <div class="product-image">
                            ${product.image_url ? `<img src="${product.image_url}" alt="${product.item_name}">` : 'üéÅ'}
                            ${product.category ? `<span class="product-badge">${product.category}</span>` : ''}
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.item_name}</div>
                            <div class="product-details">${product.details || 'ÿ®ÿØŸàŸÜ ÿ™ŸÅÿßÿµŸäŸÑ'}</div>
                            <div class="product-footer">
                                <span class="product-price">${product.price} ÿ±ŸäÿßŸÑ</span>
                                <button class="delete-btn" onclick="openDeleteModal('${product.id}', '${product.item_name.replace(/'/g, "\\'")}')">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿπÿ©
            if(sold.length === 0) {
                soldGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="icon">üõí</div>
                        <p>ŸÑŸÖ Ÿäÿ™ŸÖ ÿ®Ÿäÿπ ÿ£Ÿä ŸÖŸÜÿ™ÿ¨ ÿ®ÿπÿØ</p>
                    </div>
                `;
            } else {
                soldGrid.innerHTML = sold.map(product => `
                    <div class="product-card sold-card">
                        <div class="product-image">
                            ${product.image_url ? `<img src="${product.image_url}" alt="${product.item_name}" style="filter: grayscale(50%);">` : 'üéÅ'}
                            ${product.category ? `<span class="product-badge" style="background: #e74c3c; color: white;">${product.category}</span>` : ''}
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.item_name}</div>
                            <div class="product-details">
                                ${product.buyer_name ? `üéâ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä: ${product.buyer_name}` : ''}
                            </div>
                            <div class="product-footer">
                                <span class="product-price" style="text-decoration: line-through; color: #888;">${product.price} ÿ±ŸäÿßŸÑ</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function updateStats(available, sold) {
            document.getElementById('totalProducts').textContent = available + sold;
            document.getElementById('availableProducts').textContent = available;
            document.getElementById('soldProducts').textContent = sold;
        }
        
        // ÿØÿßŸÑÿ© ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ≠ŸÇŸàŸÑ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
        function toggleDeliveryFields() {
            const deliveryType = document.getElementById('productDeliveryType').value;
            const commonFields = document.getElementById('commonFields');
            const instantFields = document.getElementById('instantFields');
            const manualFields = document.getElementById('manualFields');
            
            if(deliveryType === '') {
                commonFields.style.display = 'none';
                instantFields.style.display = 'none';
                manualFields.style.display = 'none';
            } else if(deliveryType === 'instant') {
                commonFields.style.display = 'block';
                instantFields.style.display = 'block';
                manualFields.style.display = 'none';
            } else if(deliveryType === 'manual') {
                commonFields.style.display = 'block';
                instantFields.style.display = 'none';
                manualFields.style.display = 'block';
            }
        }
        
        // ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨
        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
        }
        
        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            // ŸÖÿ≥ÿ≠ ÿßŸÑÿ≠ŸÇŸàŸÑ
            document.getElementById('productDeliveryType').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productDetails').value = '';
            document.getElementById('productHiddenData').value = '';
            document.getElementById('productBuyerInstructions').value = '';
            document.getElementById('productImage').value = '';
            // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ
            document.getElementById('commonFields').style.display = 'none';
            document.getElementById('instantFields').style.display = 'none';
            document.getElementById('manualFields').style.display = 'none';
        }
        
        async function submitProduct() {
            const deliveryType = document.getElementById('productDeliveryType').value;
            const name = document.getElementById('productName').value.trim();
            const price = document.getElementById('productPrice').value;
            const category = document.getElementById('productCategory').value;
            const details = document.getElementById('productDetails').value.trim();
            const image = document.getElementById('productImage').value.trim();
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿ£ŸàŸÑÿßŸã
            if(!deliveryType) {
                showAlert('error', 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ');
                return;
            }
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ¥ÿ™ÿ±ŸÉÿ©
            if(!name || !price || !category) {
                showAlert('error', 'ÿßŸÑÿ±ÿ¨ÿßÿ° ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© (ÿßŸÑÿßÿ≥ŸÖÿå ÿßŸÑÿ≥ÿπÿ±ÿå ÿßŸÑŸÅÿ¶ÿ©)');
                return;
            }
            
            let hiddenData = '';
            let buyerInstructions = '';
            
            if(deliveryType === 'instant') {
                hiddenData = document.getElementById('productHiddenData').value.trim();
                if(!hiddenData) {
                    showAlert('error', 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿ© ŸÑŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸÅŸàÿ±Ÿä');
                    return;
                }
            } else if(deliveryType === 'manual') {
                buyerInstructions = document.getElementById('productBuyerInstructions').value.trim();
                if(!buyerInstructions) {
                    showAlert('error', 'ÿßŸÑÿ±ÿ¨ÿßÿ° ŸÉÿ™ÿßÿ®ÿ© ŸÖÿß ÿ™ÿ≠ÿ™ÿßÿ¨Ÿá ŸÖŸÜ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä');
                    return;
                }
            }
            
            try {
                const response = await fetch('/api/admin/add_product_new', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        price: parseFloat(price),
                        category: category,
                        details: details,
                        hidden_data: hiddenData,
                        buyer_instructions: buyerInstructions,
                        image: image,
                        delivery_type: deliveryType
                    })
                });
                
                const data = await response.json();
                
                if(data.status === 'success') {
                    showAlert('success', '‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠!');
                    closeAddModal();
                    loadProducts(); // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                } else {
                    showAlert('error', data.message || 'ŸÅÿ¥ŸÑ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨');
                }
            } catch(error) {
                showAlert('error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±');
            }
        }
        
        // ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ≠ÿ∞ŸÅ
        function openDeleteModal(productId, productName) {
            productToDelete = productId;
            document.getElementById('deleteProductName').textContent = productName;
            document.getElementById('deleteModal').classList.add('active');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            productToDelete = null;
        }
        
        async function confirmDelete() {
            if(!productToDelete) return;
            
            try {
                const response = await fetch('/api/admin/delete_product', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ product_id: productToDelete })
                });
                
                const data = await response.json();
                
                if(data.status === 'success') {
                    showAlert('success', '‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠!');
                    closeDeleteModal();
                    loadProducts(); // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
                } else {
                    showAlert('error', data.message || 'ŸÅÿ¥ŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨');
                }
            } catch(error) {
                showAlert('error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±');
            }
        }
        
        // ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ŸÜÿ®ŸäŸá
        function showAlert(type, message) {
            const alertEl = document.getElementById(type === 'success' ? 'alertSuccess' : 'alertError');
            alertEl.textContent = message;
            alertEl.classList.add('show');
            
            setTimeout(() => {
                alertEl.classList.remove('show');
            }, 4000);
        }
        
        // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿ®ÿßŸÑÿ∂ÿ∫ÿ∑ ÿÆÿßÿ±ÿ¨Ÿáÿß
        window.onclick = function(event) {
            if(event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>
"""

# ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ (ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑)
ADMIN_CATEGORIES_HTML = """
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∑Ô∏è ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #667eea;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --dark: #1a1a2e;
            --darker: #16213e;
            --card: #0f3460;
            --text: #ffffff;
            --text-secondary: #a0a0a0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, var(--dark), var(--darker));
            min-height: 100vh;
            color: var(--text);
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #764ba2);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #2ecc71);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: white;
        }
        
        .btn-secondary {
            background: #444;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .category-card {
            background: var(--card);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: all 0.3s;
        }
        
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .category-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .category-image {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            object-fit: cover;
            background: rgba(255,255,255,0.1);
        }
        
        .category-info {
            flex: 1;
        }
        
        .category-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .category-count {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .category-order {
            background: var(--primary);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .category-actions {
            display: flex;
            gap: 10px;
        }
        
        .category-actions .btn {
            flex: 1;
            justify-content: center;
            padding: 10px;
            font-size: 13px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--card);
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), #764ba2);
            border-radius: 20px 20px 0 0;
        }
        
        .modal-header h2 {
            font-size: 20px;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .image-preview {
            margin-top: 10px;
            text-align: center;
        }
        
        .image-preview img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 10px;
            border: 2px solid var(--primary);
        }
        
        .modal-footer {
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: var(--card);
            border-radius: 15px;
        }
        
        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        /* Alert */
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 2000;
            transition: transform 0.3s;
        }
        
        .alert.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .alert.success {
            background: var(--success);
            color: white;
        }
        
        .alert.error {
            background: var(--danger);
            color: white;
        }
        
        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .back-link:hover {
            color: white;
        }
        
        .settings-card {
            background: var(--card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .settings-card h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .columns-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .column-btn {
            padding: 12px 24px;
            border: 2px solid var(--primary);
            background: transparent;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .column-btn:hover {
            background: rgba(102, 126, 234, 0.2);
        }
        
        .column-btn.active {
            background: var(--primary);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <a href="/admin/products" class="back-link">‚Üí ÿßŸÑÿπŸàÿØÿ© ŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</a>
                <h1>üè∑Ô∏è ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</h1>
            </div>
            <button class="btn btn-success" onclick="openAddModal()">
                ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ
            </button>
        </div>
        
        <!-- ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿ±ÿ∂ -->
        <div class="settings-card">
            <h3>‚öôÔ∏è ÿ™ÿ±ÿ™Ÿäÿ® ÿπÿ±ÿ∂ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸÅŸä ÿßŸÑŸÖŸàŸÇÿπ</h3>
            <div class="columns-selector">
                <button class="column-btn" data-cols="2" onclick="setColumns(2)">
                    2√ó2 (ÿπŸÖŸàÿØŸäŸÜ)
                </button>
                <button class="column-btn" data-cols="3" onclick="setColumns(3)">
                    3√ó3 (ÿ´ŸÑÿßÿ´ÿ© ÿ£ÿπŸÖÿØÿ©)
                </button>
                <button class="column-btn" data-cols="4" onclick="setColumns(4)">
                    4√ó4 (ÿ£ÿ±ÿ®ÿπÿ© ÿ£ÿπŸÖÿØÿ©)
                </button>
            </div>
        </div>
        
        <div id="categoriesGrid" class="categories-grid">
            <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸáŸÜÿß -->
        </div>
    </div>
    
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ŸÇÿ≥ŸÖ -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ</h2>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editCategoryId">
                <div class="form-group">
                    <label>üè∑Ô∏è ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ *</label>
                    <input type="text" id="categoryName" placeholder="ŸÖÿ´ÿßŸÑ: ŸÜÿ™ŸÅŸÑŸÉÿ≥">
                </div>
                <div class="form-group">
                    <label>üñºÔ∏è ÿ±ÿßÿ®ÿ∑ ÿµŸàÿ±ÿ© ÿßŸÑŸÇÿ≥ŸÖ</label>
                    <input type="url" id="categoryImage" placeholder="https://example.com/image.png" oninput="previewImage()">
                    <div class="image-preview" id="imagePreview"></div>
                </div>
                <div class="form-group">
                    <label>üì¶ ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä *</label>
                    <select id="categoryDeliveryType">
                        <option value="instant">‚ö° ÿ™ÿ≥ŸÑŸäŸÖ ŸÅŸàÿ±Ÿä</option>
                        <option value="manual">üë®‚Äçüíº ÿ™ÿ≥ŸÑŸäŸÖ ŸäÿØŸàŸä</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button class="btn btn-success" onclick="saveCategory()">üíæ ÿ≠ŸÅÿ∏</button>
            </div>
        </div>
    </div>
    
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--danger), #c0392b);">
                <h2>üóëÔ∏è ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ</h2>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div style="font-size: 50px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                <p style="margin-bottom: 10px;">ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖÿü</p>
                <p id="deleteCategoryName" style="color: var(--danger); font-weight: bold;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button class="btn btn-danger" onclick="confirmDelete()">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>
            </div>
        </div>
    </div>
    
    <div id="alertBox" class="alert"></div>
    
    <script>
        let categoryToDelete = null;
        let isEditMode = false;
        let currentColumns = 3;
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸàÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿµŸÅÿ≠ÿ©
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadDisplaySettings();
        });
        
        async function loadDisplaySettings() {
            try {
                const response = await fetch('/api/admin/get_display_settings');
                const data = await response.json();
                if(data.status === 'success') {
                    currentColumns = data.categories_columns || 3;
                    updateColumnsUI();
                }
            } catch(error) {
                console.log('ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©');
            }
        }
        
        function updateColumnsUI() {
            document.querySelectorAll('.column-btn').forEach(btn => {
                btn.classList.remove('active');
                if(parseInt(btn.dataset.cols) === currentColumns) {
                    btn.classList.add('active');
                }
            });
        }
        
        async function setColumns(cols) {
            try {
                const response = await fetch('/api/admin/set_display_settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ categories_columns: cols })
                });
                const data = await response.json();
                if(data.status === 'success') {
                    currentColumns = cols;
                    updateColumnsUI();
                    showAlert('success', '‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØ!');
                } else {
                    showAlert('error', data.message || 'ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏');
                }
            } catch(error) {
                showAlert('error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ');
            }
        }
        
        async function loadCategories() {
            try {
                const response = await fetch('/api/admin/get_categories');
                const data = await response.json();
                
                if(data.status === 'success') {
                    renderCategories(data.categories);
                } else {
                    showAlert('error', 'ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ');
                }
            } catch(error) {
                showAlert('error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±');
            }
        }
        
        function renderCategories(categories) {
            const grid = document.getElementById('categoriesGrid');
            
            if(categories.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="icon">üìÇ</div>
                        <h3>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÇÿ≥ÿßŸÖ</h3>
                        <p>ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± "ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ" ŸÑŸÑÿ®ÿØÿ°</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = categories.map(cat => `
                <div class="category-card" data-id="${cat.id}">
                    <div class="category-header">
                        <img src="${cat.image_url || 'https://via.placeholder.com/60?text=' + encodeURIComponent(cat.name)}" 
                             class="category-image" 
                             onerror="this.src='https://via.placeholder.com/60?text=üìÅ'">
                        <div class="category-info">
                            <div class="category-name">${cat.name}</div>
                            <div class="category-count">üì¶ ${cat.product_count || 0} ŸÖŸÜÿ™ÿ¨</div>
                            <div class="category-delivery" style="font-size: 12px; margin-top: 3px;">
                                ${cat.delivery_type === 'manual' ? 'üë®‚Äçüíº ŸäÿØŸàŸä' : '‚ö° ŸÅŸàÿ±Ÿä'}
                            </div>
                        </div>
                        <div class="category-order">${cat.order || '?'}</div>
                    </div>
                    <div class="category-actions">
                        <button class="btn btn-primary" onclick="openEditModal('${cat.id}', '${cat.name}', '${cat.image_url || ''}', '${cat.delivery_type || 'instant'}')">
                            ‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ
                        </button>
                        <button class="btn btn-danger" onclick="openDeleteModal('${cat.id}', '${cat.name}', ${cat.product_count || 0})">
                            üóëÔ∏è ÿ≠ÿ∞ŸÅ
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function openAddModal() {
            isEditMode = false;
            document.getElementById('modalTitle').textContent = '‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ';
            document.getElementById('editCategoryId').value = '';
            document.getElementById('categoryName').value = '';
            document.getElementById('categoryImage').value = '';
            document.getElementById('categoryDeliveryType').value = 'instant';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('categoryModal').classList.add('active');
        }
        
        function openEditModal(id, name, imageUrl, deliveryType) {
            isEditMode = true;
            document.getElementById('modalTitle').textContent = '‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÇÿ≥ŸÖ';
            document.getElementById('editCategoryId').value = id;
            document.getElementById('categoryName').value = name;
            document.getElementById('categoryImage').value = imageUrl;
            document.getElementById('categoryDeliveryType').value = deliveryType || 'instant';
            previewImage();
            document.getElementById('categoryModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('categoryModal').classList.remove('active');
        }
        
        function previewImage() {
            const url = document.getElementById('categoryImage').value;
            const preview = document.getElementById('imagePreview');
            if(url) {
                preview.innerHTML = `<img src="${url}" onerror="this.src='https://via.placeholder.com/100?text=‚ùå'">`;
            } else {
                preview.innerHTML = '';
            }
        }
        
        async function saveCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const imageUrl = document.getElementById('categoryImage').value.trim();
            const deliveryType = document.getElementById('categoryDeliveryType').value;
            const editId = document.getElementById('editCategoryId').value;
            
            if(!name) {
                showAlert('error', 'ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ ŸÖÿ∑ŸÑŸàÿ®');
                return;
            }
            
            try {
                let endpoint = isEditMode ? '/api/admin/update_category' : '/api/admin/add_category';
                let body = isEditMode 
                    ? { id: editId, name: name, image_url: imageUrl, delivery_type: deliveryType }
                    : { name: name, image_url: imageUrl, delivery_type: deliveryType };
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                if(data.status === 'success') {
                    showAlert('success', isEditMode ? '‚úÖ ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÇÿ≥ŸÖ!' : '‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÇÿ≥ŸÖ!');
                    closeModal();
                    loadCategories();
                } else {
                    showAlert('error', data.message || 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£');
                }
            } catch(error) {
                showAlert('error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ');
            }
        }
        
        function openDeleteModal(id, name, productCount) {
            if(productCount > 0) {
                showAlert('error', `ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÇÿ≥ŸÖ - ŸäŸàÿ¨ÿØ ${productCount} ŸÖŸÜÿ™ÿ¨ ŸÅŸäŸá`);
                return;
            }
            categoryToDelete = id;
            document.getElementById('deleteCategoryName').textContent = name;
            document.getElementById('deleteModal').classList.add('active');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            categoryToDelete = null;
        }
        
        async function confirmDelete() {
            if(!categoryToDelete) return;
            
            try {
                const response = await fetch('/api/admin/delete_category', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: categoryToDelete })
                });
                
                const data = await response.json();
                
                if(data.status === 'success') {
                    showAlert('success', '‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÇÿ≥ŸÖ!');
                    closeDeleteModal();
                    loadCategories();
                } else {
                    showAlert('error', data.message || 'ŸÅÿ¥ŸÑ ÿßŸÑÿ≠ÿ∞ŸÅ');
                }
            } catch(error) {
                showAlert('error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ');
            }
        }
        
        function showAlert(type, message) {
            const alertEl = document.getElementById('alertBox');
            alertEl.textContent = message;
            alertEl.className = 'alert ' + type + ' show';
            setTimeout(() => alertEl.classList.remove('show'), 4000);
        }
        
        // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿ®ÿßŸÑÿ∂ÿ∫ÿ∑ ÿÆÿßÿ±ÿ¨Ÿáÿß
        window.onclick = function(event) {
            if(event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>
"""

# ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ (ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑)
@app.route('/admin/products')
def admin_products():
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÉŸÖÿßŸÑŸÉ
    if not session.get('is_admin'):
        return redirect('/dashboard')
    
    return render_template_string(ADMIN_PRODUCTS_HTML, admin_id=ADMIN_ID)

# ÿµŸÅÿ≠ÿ© ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ (ŸÑŸÑŸÖÿßŸÑŸÉ ŸÅŸÇÿ∑)
@app.route('/admin/categories')
def admin_categories():
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÉŸÖÿßŸÑŸÉ
    if not session.get('is_admin'):
        return redirect('/dashboard')
    
    return render_template_string(ADMIN_CATEGORIES_HTML)

# API ŸÑÿ¨ŸÑÿ® ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ (ŸÑŸÑŸÖÿßŸÑŸÉ)
@app.route('/api/admin/get_products')
def api_get_products():
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©
    if not session.get('is_admin'):
        return jsonify({'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠'})
    
    try:
        available = []
        sold = []
        
        if db:
            # ÿ¨ŸÑÿ® ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖŸÜ Firebase
            products_ref = db.collection('products')
            
            # ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©
            available_query = query_where(products_ref, 'sold', '==', False)
            for doc in available_query.stream():
                data = doc.to_dict()
                data['id'] = doc.id
                available.append(data)
            
            # ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿπÿ©
            sold_query = query_where(products_ref, 'sold', '==', True)
            for doc in sold_query.stream():
                data = doc.to_dict()
                data['id'] = doc.id
                sold.append(data)
        else:
            # ŸÖŸÜ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
            for item in marketplace_items:
                if item.get('sold'):
                    sold.append(item)
                else:
                    available.append(item)
        
        return jsonify({
            'status': 'success',
            'available': available,
            'sold': sold
        })
        
    except Exception as e:
        logger.error(f"Error getting products: {e}")
        return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇÿßŸã'})

# API ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ (ŸÑŸÑŸÖÿßŸÑŸÉ)
@app.route('/api/admin/add_product_new', methods=['POST'])
def api_add_product_new():
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©
    if not session.get('is_admin'):
        return jsonify({'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠'})
    
    try:
        data = request.json
        name = data.get('name', '').strip()
        price = float(data.get('price', 0))
        category = data.get('category', '').strip()
        details = data.get('details', '').strip()
        hidden_data = data.get('hidden_data', '').strip()
        buyer_instructions = data.get('buyer_instructions', '').strip()
        image = data.get('image', '').strip()
        delivery_type = data.get('delivery_type', 'instant').strip()
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
        if delivery_type not in ['instant', 'manual']:
            delivery_type = 'instant'
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
        if not name or price <= 0 or not category:
            return jsonify({'status': 'error', 'message': 'ÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿßŸÇÿµÿ© (ÿßŸÑÿßÿ≥ŸÖÿå ÿßŸÑÿ≥ÿπÿ±ÿå ÿßŸÑŸÅÿ¶ÿ©)'})
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ
        if delivery_type == 'instant' and not hidden_data:
            return jsonify({'status': 'error', 'message': 'ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿ© ŸÖÿ∑ŸÑŸàÿ®ÿ© ŸÑŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸÅŸàÿ±Ÿä'})
        
        if delivery_type == 'manual' and not buyer_instructions:
            return jsonify({'status': 'error', 'message': 'Ÿäÿ¨ÿ® ÿ™ÿ≠ÿØŸäÿØ ŸÖÿß ÿ™ÿ≠ÿ™ÿßÿ¨Ÿá ŸÖŸÜ ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä'})
        
        # ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸÜÿ™ÿ¨
        product_id = str(uuid.uuid4())
        product_data = {
            'id': product_id,
            'item_name': name,
            'price': price,
            'category': category,
            'details': details,
            'hidden_data': hidden_data,
            'buyer_instructions': buyer_instructions,
            'image_url': image,
            'seller_id': ADMIN_ID,
            'seller_name': 'ÿßŸÑŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ±ÿ≥ŸÖŸä',
            'delivery_type': delivery_type,
            'sold': False,
            'created_at': time.time()
        }
        
        # ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
        if db:
            db.collection('products').document(product_id).set(product_data)
            print(f"‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÅŸä Firebase: {name} (ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ: {delivery_type})")
        
        # ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ∞ÿßŸÉÿ±ÿ©
        marketplace_items.append(product_data)
        
        return jsonify({'status': 'success', 'product_id': product_id})
        
    except Exception as e:
        logger.error(f"Error adding product: {e}")
        return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇÿßŸã'})

# API ŸÑÿ≠ÿ∞ŸÅ ŸÖŸÜÿ™ÿ¨ (ŸÑŸÑŸÖÿßŸÑŸÉ)
@app.route('/api/admin/delete_product', methods=['POST'])
def api_delete_product():
    # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©
    if not session.get('is_admin'):
        return jsonify({'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠'})
    
    try:
        data = request.json
        product_id = data.get('product_id')
        
        if not product_id:
            return jsonify({'status': 'error', 'message': 'ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÖÿ∑ŸÑŸàÿ®'})
        
        # ÿ≠ÿ∞ŸÅ ŸÖŸÜ Firebase
        if db:
            db.collection('products').document(product_id).delete()
            print(f"‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÖŸÜ Firebase: {product_id}")
        
        # ÿ≠ÿ∞ŸÅ ŸÖŸÜ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
        global marketplace_items
        marketplace_items = [item for item in marketplace_items if item.get('id') != product_id]
        
        return jsonify({'status': 'success'})
        
    except Exception as e:
        logger.error(f"Error deleting product: {e}")
        return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇÿßŸã'})

# ============ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ============

# API ŸÑÿ¨ŸÑÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
@app.route('/api/admin/get_categories', methods=['GET'])
def api_get_categories():
    """ÿ¨ŸÑÿ® ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ"""
    # ‚úÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ£ÿØŸÖŸÜ
    if not session.get('is_admin'):
        return jsonify({'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠'})
    
    try:
        # ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÉŸÑ ŸÇÿ≥ŸÖ
        category_counts = {}
        for item in marketplace_items:
            cat = item.get('category', '')
            if cat:
                category_counts[cat] = category_counts.get(cat, 0) + 1
        
        # ÿ•ÿ∂ÿßŸÅÿ© ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÉŸÑ ŸÇÿ≥ŸÖ
        result = []
        for cat in categories_list:
            cat_data = cat.copy()
            cat_data['product_count'] = category_counts.get(cat['name'], 0)
            result.append(cat_data)
        
        return jsonify({'status': 'success', 'categories': result})
    except Exception as e:
        logger.error(f"Error getting categories: {e}")
        return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇÿßŸã'})

# API ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ
@app.route('/api/admin/add_category', methods=['POST'])
def api_add_category():
    """ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ"""
    if not session.get('is_admin'):
        return jsonify({'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠'})
    
    try:
        data = request.json
        name = data.get('name', '').strip()
        image_url = data.get('image_url', '').strip()
        delivery_type = data.get('delivery_type', 'instant').strip()
        
        if delivery_type not in ['instant', 'manual']:
            delivery_type = 'instant'
        
        if not name:
            return jsonify({'status': 'error', 'message': 'ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ ŸÖÿ∑ŸÑŸàÿ®'})
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿßÿ≥ŸÖ
        for cat in categories_list:
            if cat['name'] == name:
                return jsonify({'status': 'error', 'message': 'Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ ŸÖŸàÿ¨ŸàÿØ ŸÖÿ≥ÿ®ŸÇÿßŸã'})
        
        # ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ¨ÿØŸäÿØ
        import uuid
        cat_id = str(uuid.uuid4())[:8]
        new_order = len(categories_list) + 1
        
        new_category = {
            'id': cat_id,
            'name': name,
            'image_url': image_url or 'https://via.placeholder.com/100?text=' + name,
            'order': new_order,
            'delivery_type': delivery_type,
            'created_at': time.time()
        }
        
        # ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
        if db:
            db.collection('categories').document(cat_id).set(new_category)
            print(f"‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÇÿ≥ŸÖ ŸÅŸä Firebase: {name} ({delivery_type})")
        
        # ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ∞ÿßŸÉÿ±ÿ©
        categories_list.append(new_category)
        
        return jsonify({'status': 'success', 'category': new_category})
        
    except Exception as e:
        logger.error(f"Error adding category: {e}")
        return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇÿßŸã'})

# API ŸÑÿ™ÿπÿØŸäŸÑ ŸÇÿ≥ŸÖ
@app.route('/api/admin/update_category', methods=['POST'])
def api_update_category():
    """ÿ™ÿπÿØŸäŸÑ ŸÇÿ≥ŸÖ ŸÖŸàÿ¨ŸàÿØ"""
    if not session.get('is_admin'):
        return jsonify({'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠'})
    
    try:
        data = request.json
        cat_id = data.get('id')
        new_name = data.get('name', '').strip()
        new_image = data.get('image_url', '').strip()
        new_delivery_type = data.get('delivery_type', '').strip()
        
        if not cat_id:
            return jsonify({'status': 'error', 'message': 'ŸÖÿπÿ±ŸÅ ÿßŸÑŸÇÿ≥ŸÖ ŸÖÿ∑ŸÑŸàÿ®'})
        
        # ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÇÿ≥ŸÖ
        cat_found = None
        old_name = None
        for cat in categories_list:
            if cat['id'] == cat_id:
                cat_found = cat
                old_name = cat['name']
                break
        
        if not cat_found:
            return jsonify({'status': 'error', 'message': 'ÿßŸÑŸÇÿ≥ŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ'})
        
        # ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿ≥ŸÖ
        if new_name:
            cat_found['name'] = new_name
        if new_image:
            cat_found['image_url'] = new_image
        if new_delivery_type in ['instant', 'manual']:
            cat_found['delivery_type'] = new_delivery_type
        
        # ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase
        if db:
            db.collection('categories').document(cat_id).update({
                'name': cat_found['name'],
                'image_url': cat_found['image_url'],
                'delivery_type': cat_found.get('delivery_type', 'instant')
            })
        
        # ÿ™ÿ≠ÿØŸäÿ´ ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ•ÿ∞ÿß ÿ™ÿ∫Ÿäÿ±
        if old_name and new_name and old_name != new_name:
            for item in marketplace_items:
                if item.get('category') == old_name:
                    item['category'] = new_name
                    # ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase ÿ£Ÿäÿ∂ÿßŸã
                    if db and item.get('id'):
                        try:
                            db.collection('products').document(item['id']).update({'category': new_name})
                        except:
                            pass
        
        return jsonify({'status': 'success', 'category': cat_found})
        
    except Exception as e:
        logger.error(f"Error updating category: {e}")
        return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇÿßŸã'})

# API ŸÑÿ≠ÿ∞ŸÅ ŸÇÿ≥ŸÖ
@app.route('/api/admin/delete_category', methods=['POST'])
def api_delete_category():
    """ÿ≠ÿ∞ŸÅ ŸÇÿ≥ŸÖ"""
    if not session.get('is_admin'):
        return jsonify({'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠'})
    
    try:
        global categories_list
        data = request.json
        cat_id = data.get('id')
        
        if not cat_id:
            return jsonify({'status': 'error', 'message': 'ŸÖÿπÿ±ŸÅ ÿßŸÑŸÇÿ≥ŸÖ ŸÖÿ∑ŸÑŸàÿ®'})
        
        # ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÇÿ≥ŸÖ
        cat_found = None
        for cat in categories_list:
            if cat['id'] == cat_id:
                cat_found = cat
                break
        
        if not cat_found:
            return jsonify({'status': 'error', 'message': 'ÿßŸÑŸÇÿ≥ŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ'})
        
        # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ Ÿàÿ¨ŸàÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑŸÇÿ≥ŸÖ
        product_count = 0
        for item in marketplace_items:
            if item.get('category') == cat_found['name']:
                product_count += 1
        
        if product_count > 0:
            return jsonify({
                'status': 'error', 
                'message': f'ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÇÿ≥ŸÖ - ŸäŸàÿ¨ÿØ {product_count} ŸÖŸÜÿ™ÿ¨ ŸÅŸäŸá'
            })
        
        # ÿ≠ÿ∞ŸÅ ŸÖŸÜ Firebase
        if db:
            db.collection('categories').document(cat_id).delete()
            print(f"‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÇÿ≥ŸÖ ŸÖŸÜ Firebase: {cat_found['name']}")
        
        # ÿ≠ÿ∞ŸÅ ŸÖŸÜ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
        categories_list = [c for c in categories_list if c['id'] != cat_id]
        
        return jsonify({'status': 'success'})
        
    except Exception as e:
        logger.error(f"Error deleting category: {e}")
        return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇÿßŸã'})

# API ŸÑÿ•ÿπÿßÿØÿ© ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
@app.route('/api/admin/reorder_categories', methods=['POST'])
def api_reorder_categories():
    """ÿ•ÿπÿßÿØÿ© ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ"""
    if not session.get('is_admin'):
        return jsonify({'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠'})
    
    try:
        data = request.json
        new_order = data.get('order', [])  # ŸÇÿßÿ¶ŸÖÿ© ÿ®ŸÖÿπÿ±ŸÅÿßÿ™ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿ®ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ¨ÿØŸäÿØ
        
        if not new_order:
            return jsonify({'status': 'error', 'message': 'ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ŸÖÿ∑ŸÑŸàÿ®'})
        
        # ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®
        for idx, cat_id in enumerate(new_order):
            for cat in categories_list:
                if cat['id'] == cat_id:
                    cat['order'] = idx + 1
                    # ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase
                    if db:
                        try:
                            db.collection('categories').document(cat_id).update({'order': idx + 1})
                        except:
                            pass
                    break
        
        # ÿ•ÿπÿßÿØÿ© ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
        categories_list.sort(key=lambda x: x.get('order', 999))
        
        return jsonify({'status': 'success'})
        
    except Exception as e:
        logger.error(f"Error reordering categories: {e}")
        return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇÿßŸã'})

# API ŸÑÿ¨ŸÑÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑÿπÿßŸÖ (ÿ®ÿØŸàŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ)
@app.route('/api/categories', methods=['GET'])
def api_public_categories():
    """ÿ¨ŸÑÿ® ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸÑŸÑÿπÿ±ÿ∂ ŸÅŸä ÿßŸÑŸÖŸàŸÇÿπ"""
    try:
        result = []
        for cat in categories_list:
            result.append({
                'name': cat['name'],
                'image_url': cat.get('image_url', ''),
                'delivery_type': cat.get('delivery_type', 'instant')
            })
        return jsonify({
            'status': 'success', 
            'categories': result,
            'columns': display_settings.get('categories_columns', 3)
        })
    except Exception as e:
        logger.error(f"Error in public categories: {e}")
        return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇÿßŸã'})

# API ŸÑÿ¨ŸÑÿ® ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿ±ÿ∂
@app.route('/api/admin/get_display_settings', methods=['GET'])
def api_get_display_settings():
    """ÿ¨ŸÑÿ® ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿ±ÿ∂"""
    # ‚úÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ£ÿØŸÖŸÜ
    if not session.get('is_admin'):
        return jsonify({'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠'})
    
    return jsonify({
        'status': 'success',
        'categories_columns': display_settings.get('categories_columns', 3)
    })

# API ŸÑÿ™ÿπÿØŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿ±ÿ∂
@app.route('/api/admin/set_display_settings', methods=['POST'])
def api_set_display_settings():
    """ÿ™ÿπÿØŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπÿ±ÿ∂"""
    if not session.get('is_admin'):
        return jsonify({'status': 'error', 'message': 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠'})
    
    try:
        data = request.json
        cols = data.get('categories_columns')
        
        if cols and cols in [2, 3, 4]:
            display_settings['categories_columns'] = cols
            
            # ÿ≠ŸÅÿ∏ ŸÅŸä Firebase
            if db:
                db.collection('settings').document('display').set({
                    'categories_columns': cols
                }, merge=True)
            
            return jsonify({'status': 'success'})
        else:
            return jsonify({'status': 'error', 'message': 'ŸÇŸäŸÖÿ© ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©'})
            
    except Exception as e:
        logger.error(f"Error setting display settings: {e}")
        return jsonify({'status': 'error', 'message': 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇÿßŸã'})

# ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase ÿπŸÜÿØ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ (ŸäÿπŸÖŸÑ ŸÖÿπ Gunicorn Ÿàlocal)
print("üöÄ ÿ®ÿØÿ° ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ...")
load_all_data_from_firebase()

# ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑÿØŸäŸáÿß UUID
ensure_product_ids()

if __name__ == "__main__":
    # Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ± Ÿäÿ¨ÿπŸÑ ÿßŸÑÿ®Ÿàÿ™ ŸäÿπŸÖŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸÜŸÅÿ∞ ÿßŸÑÿµÿ≠Ÿäÿ≠ ŸÅŸä ÿ±ŸäŸÜÿØÿ± ÿ£Ÿà 10000 ŸÅŸä ÿ¨Ÿáÿßÿ≤ŸÉ
    port = int(os.environ.get("PORT", 10000))
    print(f"‚úÖ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸäÿπŸÖŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸÜŸÅÿ∞ {port}")
    app.run(host="0.0.0.0", port=port)
