{% extends "admin_base.html" %}
{% block title %}Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endblock %}
{% block content %}
<div class="top-bar">
    <h1>ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h1>
    <div class="top-bar-actions">
        <button class="btn btn-secondary" onclick="loadWithdrawals()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    </div>
</div>

<!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
<div class="stats-grid">
    <div class="stat-card" style="border-color: var(--warning);">
        <div class="icon">â³</div>
        <div class="value" id="pendingCount" style="color: var(--warning);">-</div>
        <div class="label">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
    </div>
    <div class="stat-card" style="border-color: var(--success);">
        <div class="icon">âœ…</div>
        <div class="value" id="approvedCount" style="color: var(--success);">-</div>
        <div class="label">ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</div>
    </div>
    <div class="stat-card" style="border-color: var(--danger);">
        <div class="icon">âŒ</div>
        <div class="value" id="rejectedCount" style="color: var(--danger);">-</div>
        <div class="label">Ù…Ø±ÙÙˆØ¶</div>
    </div>
    <div class="stat-card" style="border-color: var(--primary);">
        <div class="icon">ğŸ’°</div>
        <div class="value" id="totalAmount" style="color: var(--primary);">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</div>
    </div>
</div>

<!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
<div class="card">
    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <select id="statusFilter" style="padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: white;">
            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="pending" selected>â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
            <option value="approved">âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</option>
            <option value="rejected">âŒ Ù…Ø±ÙÙˆØ¶</option>
        </select>
        <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†..." 
               style="flex: 1; min-width: 200px; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: white;">
    </div>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
<div class="card">
    <div class="card-header">
        <span class="card-title">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
        <span id="requestsCountLabel" style="color: var(--muted); font-size: 13px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„Ø±Ø³ÙˆÙ…</th>
                    <th>Ø§Ù„ØµØ§ÙÙŠ</th>
                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                    <th>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="withdrawalsTable">
                <tr>
                    <td colspan="10" style="text-align: center; padding: 40px;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ -->
<div id="detailsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--card-bg); border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
            <button onclick="closeModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">Ã—</button>
        </div>
        <div id="modalContent"></div>
    </div>
</div>

<style>
    .action-btn {
        padding: 6px 12px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 12px;
        margin: 2px;
        transition: all 0.2s;
    }
    .action-btn:hover {
        transform: scale(1.05);
    }
    .action-btn.approve {
        background: rgba(0, 184, 148, 0.2);
        color: var(--success);
    }
    .action-btn.reject {
        background: rgba(231, 76, 60, 0.2);
        color: var(--danger);
    }
    .action-btn.resend {
        background: rgba(108, 92, 231, 0.2);
        color: var(--primary);
    }
    .action-btn.details {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }
    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .bank-info {
        font-size: 11px;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let allWithdrawals = [];
    
    async function loadWithdrawals() {
        const tbody = document.getElementById('withdrawalsTable');
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></td></tr>';
        
        try {
            const res = await fetch('/api/admin/get_withdrawals');
            const data = await res.json();
            
            if (data.status === 'success') {
                allWithdrawals = data.withdrawals || [];
                updateStats();
                renderWithdrawals();
            } else {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #e74c3c;">âŒ ' + (data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£') + '</td></tr>';
            }
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #e74c3c;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</td></tr>';
        }
    }
    
    function updateStats() {
        let pending = 0, approved = 0, rejected = 0, total = 0;
        
        allWithdrawals.forEach(w => {
            const amount = parseFloat(w.amount) || 0;
            total += amount;
            
            if (w.status === 'pending') pending++;
            else if (w.status === 'approved') approved++;
            else if (w.status === 'rejected') rejected++;
        });
        
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('approvedCount').textContent = approved;
        document.getElementById('rejectedCount').textContent = rejected;
        document.getElementById('totalAmount').textContent = total.toFixed(2) + ' Ø±.Ø³';
    }
    
    function renderWithdrawals() {
        const tbody = document.getElementById('withdrawalsTable');
        const statusFilter = document.getElementById('statusFilter').value;
        const search = document.getElementById('searchInput').value.toLowerCase();
        
        let filtered = allWithdrawals.filter(w => {
            if (statusFilter !== 'all' && w.status !== statusFilter) return false;
            if (search) {
                const searchFields = [
                    w.user_id || '',
                    w.full_name || '',
                    w.iban || '',
                    w.wallet_number || ''
                ].join(' ').toLowerCase();
                if (!searchFields.includes(search)) return false;
            }
            return true;
        });
        
        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
        filtered.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
        
        document.getElementById('requestsCountLabel').textContent = `${filtered.length} Ø·Ù„Ø¨`;
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: var(--muted);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>';
            return;
        }
        
        tbody.innerHTML = filtered.map(w => {
            const statusBadge = getStatusBadge(w.status);
            const date = w.created_at ? new Date(w.created_at).toLocaleString('ar-SA') : '-';
            const amount = parseFloat(w.amount) || 0;
            const fee = parseFloat(w.fee) || 0;
            const netAmount = parseFloat(w.net_amount) || 0;
            
            const typeIcon = w.withdrawal_type === 'bank' ? 'ğŸ¦' : 'ğŸ’³';
            const typeName = w.withdrawal_type === 'bank' ? 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ' : 'Ù…Ø­ÙØ¸Ø©';
            
            let bankInfo = '';
            if (w.withdrawal_type === 'bank') {
                bankInfo = `${w.bank_name || '-'}<br>IBAN: ${w.iban || '-'}`;
            } else {
                bankInfo = `${w.wallet_type || '-'}<br>${w.wallet_number || '-'}`;
            }
            
            const isPending = w.status === 'pending';
            
            return `
                <tr>
                    <td>${statusBadge}</td>
                    <td style="font-family: monospace;">#${w.user_id || '-'}</td>
                    <td>${w.full_name || '-'}</td>
                    <td style="font-weight: 600;">${amount.toFixed(2)} Ø±.Ø³</td>
                    <td style="color: var(--danger); font-size: 12px;">${fee.toFixed(2)} Ø±.Ø³</td>
                    <td style="color: var(--success); font-weight: 600;">${netAmount.toFixed(2)} Ø±.Ø³</td>
                    <td>${typeIcon} ${typeName}</td>
                    <td class="bank-info">${bankInfo}</td>
                    <td style="font-size: 12px; color: var(--muted);">${date}</td>
                    <td>
                        <button class="action-btn details" onclick="showDetails('${w.id}')">ğŸ“‹</button>
                        <button class="action-btn resend" onclick="resendNotification('${w.id}')" title="Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±">ğŸ“¤</button>
                        ${isPending ? `
                            <button class="action-btn approve" onclick="approveWithdrawal('${w.id}')">âœ…</button>
                            <button class="action-btn reject" onclick="rejectWithdrawal('${w.id}')">âŒ</button>
                        ` : ''}
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function getStatusBadge(status) {
        switch(status) {
            case 'pending':
                return '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(243,156,18,0.2); color: var(--warning);">â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>';
            case 'approved':
                return '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(0,184,148,0.2); color: var(--success);">âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</span>';
            case 'rejected':
                return '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(231,76,60,0.2); color: var(--danger);">âŒ Ù…Ø±ÙÙˆØ¶</span>';
            default:
                return '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(255,255,255,0.1); color: var(--muted);">ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>';
        }
    }
    
    function showDetails(id) {
        const w = allWithdrawals.find(x => x.id === id);
        if (!w) return;
        
        const modal = document.getElementById('detailsModal');
        const content = document.getElementById('modalContent');
        
        const date = w.created_at ? new Date(w.created_at).toLocaleString('ar-SA') : '-';
        const amount = parseFloat(w.amount) || 0;
        const fee = parseFloat(w.fee) || 0;
        const netAmount = parseFloat(w.net_amount) || 0;
        
        content.innerHTML = `
            <div style="display: grid; gap: 15px;">
                <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                    <span style="color: var(--muted);">Ø§Ù„Ø­Ø§Ù„Ø©</span>
                    <span>${getStatusBadge(w.status)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                    <span style="color: var(--muted);">Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
                    <span style="font-family: monospace;">#${w.user_id || '-'}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                    <span style="color: var(--muted);">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</span>
                    <span>${w.full_name || '-'}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                    <span style="color: var(--muted);">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</span>
                    <span style="font-weight: 600;">${amount.toFixed(2)} Ø±.Ø³</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                    <span style="color: var(--muted);">Ø§Ù„Ø±Ø³ÙˆÙ… (${w.fee_percentage || 0}%)</span>
                    <span style="color: var(--danger);">${fee.toFixed(2)} Ø±.Ø³</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(0,184,148,0.1); border-radius: 10px; border: 1px solid rgba(0,184,148,0.3);">
                    <span style="color: var(--success);">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ØµØ§ÙÙŠ Ù„Ù„ØªØ­ÙˆÙŠÙ„</span>
                    <span style="color: var(--success); font-weight: 700; font-size: 18px;">${netAmount.toFixed(2)} Ø±.Ø³</span>
                </div>
                
                <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 10px 0;"></div>
                
                <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                    <div style="color: var(--muted); margin-bottom: 8px;">Ù†ÙˆØ¹ Ø§Ù„Ø³Ø­Ø¨</div>
                    <div>${w.withdrawal_type === 'bank' ? 'ğŸ¦ ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ' : 'ğŸ’³ Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©'}</div>
                </div>
                
                ${w.withdrawal_type === 'bank' ? `
                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                        <div style="color: var(--muted); margin-bottom: 8px;">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ</div>
                        <div>${w.bank_name || '-'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                        <div style="color: var(--muted); margin-bottom: 8px;">Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†</div>
                        <div style="font-family: monospace; word-break: break-all;">${w.iban || '-'}</div>
                    </div>
                ` : `
                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                        <div style="color: var(--muted); margin-bottom: 8px;">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
                        <div>${w.wallet_type || '-'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                        <div style="color: var(--muted); margin-bottom: 8px;">Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
                        <div style="font-family: monospace;">${w.wallet_number || '-'}</div>
                    </div>
                `}
                
                <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                    <div style="color: var(--muted); margin-bottom: 8px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</div>
                    <div>${date}</div>
                </div>
                
                ${w.status === 'pending' ? `
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="action-btn approve" style="flex: 1; padding: 12px;" onclick="approveWithdrawal('${w.id}'); closeModal();">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
                        <button class="action-btn reject" style="flex: 1; padding: 12px;" onclick="rejectWithdrawal('${w.id}'); closeModal();">âŒ Ø±ÙØ¶</button>
                    </div>
                ` : ''}
                
                <button class="action-btn resend" style="width: 100%; padding: 12px;" onclick="resendNotification('${w.id}');">ğŸ“¤ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</button>
            </div>
        `;
        
        modal.style.display = 'flex';
    }
    
    function closeModal() {
        document.getElementById('detailsModal').style.display = 'none';
    }
    
    async function approveWithdrawal(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;
        
        try {
            const res = await fetch(`/api/admin/withdrawal/${id}/approve`, { method: 'POST' });
            const data = await res.json();
            
            if (data.status === 'success') {
                alert('âœ… ØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨');
                loadWithdrawals();
            } else {
                alert('âŒ ' + (data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£'));
            }
        } catch (e) {
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
        }
    }
    
    async function rejectWithdrawal(id) {
        const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):');
        if (reason === null) return; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¶ØºØ· Cancel
        
        try {
            const res = await fetch(`/api/admin/withdrawal/${id}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason: reason })
            });
            const data = await res.json();
            
            if (data.status === 'success') {
                alert('âœ… ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨');
                loadWithdrawals();
            } else {
                alert('âŒ ' + (data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£'));
            }
        } catch (e) {
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
        }
    }
    
    async function resendNotification(id) {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ø¯Ù…Ù†ØŸ')) return;
        
        try {
            const res = await fetch(`/api/admin/withdrawal/${id}/resend`, { method: 'POST' });
            const data = await res.json();
            
            if (data.status === 'success') {
                alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±');
            } else {
                alert('âŒ ' + (data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£'));
            }
        } catch (e) {
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
        }
    }
    
    // Ø¥ØºÙ„Ø§Ù‚ Modal Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.getElementById('detailsModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
    
    // Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    document.getElementById('statusFilter').addEventListener('change', renderWithdrawals);
    document.getElementById('searchInput').addEventListener('input', renderWithdrawals);
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    loadWithdrawals();
</script>
{% endblock %}
