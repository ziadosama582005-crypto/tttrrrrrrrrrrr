{% extends "admin_base.html" %}

{% block title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª{% endblock %}

{% block extra_css %}
<style>
    /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
    .stats-grid-mini {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
    }
    .stat-mini {
        background: var(--card);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        border: 1px solid rgba(108, 92, 231, 0.2);
    }
    .stat-mini .icon { font-size: 24px; margin-bottom: 8px; }
    .stat-mini .value { font-size: 22px; font-weight: bold; color: var(--primary-light); }
    .stat-mini .label { font-size: 12px; color: var(--muted); margin-top: 5px; }
    .stat-mini.success .value { color: var(--success); }
    .stat-mini.warning .value { color: var(--warning); }
    .stat-mini.danger .value { color: var(--danger); }
    
    /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .tab-btn {
        padding: 10px 18px;
        background: var(--card);
        border: 1px solid rgba(108, 92, 231, 0.2);
        border-radius: 10px;
        color: var(--text);
        cursor: pointer;
        font-family: 'Tajawal', sans-serif;
        font-size: 13px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .tab-btn.active {
        background: var(--primary);
        border-color: var(--primary);
    }
    .tab-btn:hover {
        background: rgba(108, 92, 231, 0.3);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .table-wrapper {
        background: var(--card);
        border-radius: 14px;
        overflow: hidden;
        border: 1px solid rgba(108, 92, 231, 0.2);
        margin-bottom: 20px;
    }
    .table-header {
        padding: 15px 20px;
        background: rgba(0,0,0,0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    .table-title {
        font-size: 15px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .search-box {
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.2);
        background: rgba(255,255,255,0.1);
        color: var(--text);
        font-family: 'Tajawal', sans-serif;
        width: 220px;
    }
    .search-box:focus {
        outline: none;
        border-color: var(--primary);
    }
    
    .status {
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: bold;
    }
    .status.completed, .status.success { background: rgba(0, 184, 148, 0.2); color: var(--success); }
    .status.pending { background: rgba(241, 196, 15, 0.2); color: var(--warning); }
    .status.failed, .status.cancelled { background: rgba(231, 76, 60, 0.2); color: var(--danger); }
    
    .type-badge {
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: bold;
    }
    .type-badge.charge { background: rgba(9, 132, 227, 0.2); color: #74b9ff; }
    .type-badge.invoice { background: rgba(108, 92, 231, 0.2); color: var(--primary-light); }
    
    .amount { color: var(--success); font-weight: bold; }
    
    .details-btn {
        background: var(--primary);
        border: none;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
    }
    .details-btn:hover { opacity: 0.8; }
    
    /* Modal */
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    .modal.active { display: flex; }
    .modal-content {
        background: var(--card);
        border-radius: 14px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        border: 1px solid rgba(108, 92, 231, 0.3);
    }
    .modal-header {
        padding: 18px;
        background: linear-gradient(135deg, var(--primary), #a29bfe);
        border-radius: 14px 14px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .modal-header h3 { margin: 0; font-size: 16px; }
    .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
    }
    .modal-body { padding: 20px; }
    
    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { color: var(--muted); font-size: 13px; }
    .detail-value { font-weight: 500; font-size: 14px; }
    
    .empty-msg {
        text-align: center;
        padding: 40px;
        color: var(--muted);
    }
</style>
{% endblock %}

{% block content %}
<div class="top-bar">
    <h1>ğŸ“Š Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h1>
    <div class="top-bar-actions">
        <button class="btn btn-secondary btn-sm" onclick="loadData()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    </div>
</div>

<!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
<div class="stats-grid-mini">
    <div class="stat-mini success">
        <div class="icon">ğŸ’°</div>
        <div class="value" id="totalRevenue">0</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
    </div>
    <div class="stat-mini">
        <div class="icon">âœ…</div>
        <div class="value" id="completedPayments">0</div>
        <div class="label">Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</div>
    </div>
    <div class="stat-mini warning">
        <div class="icon">â³</div>
        <div class="value" id="pendingPayments">0</div>
        <div class="label">Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</div>
    </div>
    <div class="stat-mini">
        <div class="icon">ğŸ›’</div>
        <div class="value" id="totalOrders">0</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
    </div>
    <div class="stat-mini">
        <div class="icon">ğŸ“¦</div>
        <div class="value" id="soldProducts">0</div>
        <div class="label">Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨Ø§Ø¹Ø©</div>
    </div>
    <div class="stat-mini success">
        <div class="icon">ğŸ·ï¸</div>
        <div class="value" id="availableProducts">0</div>
        <div class="label">Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¨ÙŠØ¹</div>
    </div>
</div>

<!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('payments')">ğŸ’³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹</button>
    <button class="tab-btn" onclick="switchTab('invoices')">ğŸ§¾ ÙÙˆØ§ØªÙŠØ± Ø§Ù„ØªØ¬Ø§Ø±</button>
    <button class="tab-btn" onclick="switchTab('charges')">ğŸ”‹ Ø³Ø¬Ù„ Ø§Ù„Ø´Ø­Ù†</button>
    <button class="tab-btn" onclick="switchTab('orders')">ğŸ›’ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
    <button class="tab-btn" onclick="switchTab('sold')">ğŸ“¦ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</button>
    <button class="tab-btn" onclick="switchTab('available')">ğŸ·ï¸ Ø§Ù„Ù…ØªØ§Ø­Ø©</button>
</div>

<!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ -->
<div class="tab-content active" id="payments-tab">
    <div class="table-wrapper">
        <div class="table-header">
            <div class="table-title">ğŸ’³ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹</div>
            <input type="text" class="search-box" placeholder="Ø¨Ø­Ø«..." onkeyup="filterTable('paymentsTable', this.value)">
        </div>
        <div class="table-container">
            <table id="paymentsTable">
                <thead>
                    <tr>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>ØªÙØ§ØµÙŠÙ„</th>
                    </tr>
                </thead>
                <tbody id="paymentsBody">
                    <tr><td colspan="7" class="loading"><div class="spinner"></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ÙÙˆØ§ØªÙŠØ± Ø§Ù„ØªØ¬Ø§Ø± -->
<div class="tab-content" id="invoices-tab">
    <div class="table-wrapper">
        <div class="table-header">
            <div class="table-title">ğŸ§¾ ÙÙˆØ§ØªÙŠØ± Ø§Ù„ØªØ¬Ø§Ø±</div>
            <input type="text" class="search-box" placeholder="Ø¨Ø­Ø«..." onkeyup="filterTable('invoicesTable', this.value)">
        </div>
        <div class="table-container">
            <table id="invoicesTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø¬Ø±</th>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>ØªÙØ§ØµÙŠÙ„</th>
                    </tr>
                </thead>
                <tbody id="invoicesBody">
                    <tr><td colspan="6" class="empty-msg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Ø³Ø¬Ù„ Ø§Ù„Ø´Ø­Ù† -->
<div class="tab-content" id="charges-tab">
    <div class="table-wrapper">
        <div class="table-header">
            <div class="table-title">ğŸ”‹ Ø³Ø¬Ù„ Ø§Ù„Ø´Ø­Ù†</div>
            <input type="text" class="search-box" placeholder="Ø¨Ø­Ø«..." onkeyup="filterTable('chargesTable', this.value)">
        </div>
        <div class="table-container">
            <table id="chargesTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>ÙƒÙˆØ¯ Ø§Ù„Ø´Ø­Ù†</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    </tr>
                </thead>
                <tbody id="chargesBody">
                    <tr><td colspan="5" class="empty-msg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
<div class="tab-content" id="orders-tab">
    <div class="table-wrapper">
        <div class="table-header">
            <div class="table-title">ğŸ›’ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
            <input type="text" class="search-box" placeholder="Ø¨Ø­Ø«..." onkeyup="filterTable('ordersTable', this.value)">
        </div>
        <div class="table-container">
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>Ø±Ù‚Ù…</th>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø§Ù„Ø³Ø¹Ø±</th>
                        <th>Ø§Ù„Ù…Ø´ØªØ±ÙŠ</th>
                        <th>Ø§Ù„Ø¨Ø§Ø¦Ø¹</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>ØªÙØ§ØµÙŠÙ„</th>
                    </tr>
                </thead>
                <tbody id="ordersBody">
                    <tr><td colspan="7" class="empty-msg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© -->
<div class="tab-content" id="sold-tab">
    <div class="table-wrapper">
        <div class="table-header">
            <div class="table-title">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</div>
            <input type="text" class="search-box" placeholder="Ø¨Ø­Ø«..." onkeyup="filterTable('soldTable', this.value)">
        </div>
        <div class="table-container">
            <table id="soldTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø§Ù„Ø³Ø¹Ø±</th>
                        <th>Ø§Ù„Ù‚Ø³Ù…</th>
                        <th>Ø§Ù„Ù…Ø´ØªØ±ÙŠ</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹</th>
                    </tr>
                </thead>
                <tbody id="soldBody">
                    <tr><td colspan="5" class="empty-msg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© -->
<div class="tab-content" id="available-tab">
    <div class="table-wrapper">
        <div class="table-header">
            <div class="table-title">ğŸ·ï¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¨ÙŠØ¹</div>
            <input type="text" class="search-box" placeholder="Ø¨Ø­Ø«..." onkeyup="filterTable('availableTable', this.value)">
        </div>
        <div class="table-container">
            <table id="availableTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø§Ù„Ø³Ø¹Ø±</th>
                        <th>Ø§Ù„Ù‚Ø³Ù…</th>
                        <th>Ø§Ù„Ø¨Ø§Ø¦Ø¹</th>
                        <th>Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
                    </tr>
                </thead>
                <tbody id="availableBody">
                    <tr><td colspan="5" class="empty-msg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
<div class="modal" id="detailsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">ØªÙØ§ØµÙŠÙ„</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allData = {};
    
    async function loadData() {
        try {
            const response = await fetch('/api/admin/get_invoices');
            const result = await response.json();
            
            if (result.status === 'success') {
                allData = result;
                updateStats(result.stats);
                renderPayments(result.pending_payments);
                renderInvoices(result.merchant_invoices);
                renderCharges(result.charge_history);
                renderOrders(result.orders);
                renderSoldProducts(result.sold_products);
                renderAvailableProducts(result.available_products);
            } else {
                showToast('Ø®Ø·Ø£: ' + result.message, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        }
    }
    
    function updateStats(stats) {
        document.getElementById('totalRevenue').textContent = (stats.total_revenue || 0).toLocaleString() + ' Ø±.Ø³';
        document.getElementById('completedPayments').textContent = stats.completed_payments || 0;
        document.getElementById('pendingPayments').textContent = stats.pending_payments || 0;
        document.getElementById('totalOrders').textContent = stats.total_orders || 0;
        document.getElementById('soldProducts').textContent = stats.sold_products || 0;
        document.getElementById('availableProducts').textContent = stats.available_products || 0;
    }
    
    function renderPayments(payments) {
        const tbody = document.getElementById('paymentsBody');
        if (!payments || payments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¯ÙØ¹</td></tr>';
            return;
        }
        tbody.innerHTML = payments.map(p => `
            <tr>
                <td>${(p.order_id || '').substring(0, 8)}...</td>
                <td>${p.user_name || ''}<br><small style="color:var(--muted)">${p.user_id || ''}</small></td>
                <td class="amount">${(p.amount || 0).toLocaleString()} Ø±.Ø³</td>
                <td><span class="type-badge ${p.is_merchant_invoice ? 'invoice' : 'charge'}">${p.type || ''}</span></td>
                <td><span class="status ${p.status || ''}">${getStatusText(p.status)}</span></td>
                <td style="font-size:12px;">${formatDate(p.created_at)}</td>
                <td><button class="details-btn" onclick='showPaymentDetails(${JSON.stringify(p)})'>ğŸ‘ï¸</button></td>
            </tr>
        `).join('');
    }
    
    function renderInvoices(invoices) {
        const tbody = document.getElementById('invoicesBody');
        if (!invoices || invoices.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ØªØ¬Ø§Ø±</td></tr>';
            return;
        }
        tbody.innerHTML = invoices.map(inv => `
            <tr>
                <td>${inv.merchant_name || ''}<br><small style="color:var(--muted)">${inv.merchant_id || ''}</small></td>
                <td>${inv.customer_phone || '-'}</td>
                <td class="amount">${(inv.amount || 0).toLocaleString()} Ø±.Ø³</td>
                <td><span class="status ${inv.status || ''}">${getStatusText(inv.status)}</span></td>
                <td style="font-size:12px;">${formatDate(inv.created_at)}</td>
                <td><button class="details-btn" onclick='showInvoiceDetails(${JSON.stringify(inv)})'>ğŸ‘ï¸</button></td>
            </tr>
        `).join('');
    }
    
    function renderCharges(charges) {
        const tbody = document.getElementById('chargesBody');
        if (!charges || charges.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø´Ø­Ù†</td></tr>';
            return;
        }
        tbody.innerHTML = charges.map(c => `
            <tr>
                <td>${c.user_name || ''}<br><small style="color:var(--muted)">${c.user_id || ''}</small></td>
                <td class="amount">${(c.amount || 0).toLocaleString()} Ø±.Ø³</td>
                <td><span class="type-badge charge">${c.type || ''}</span></td>
                <td>${c.key_code || '-'}</td>
                <td style="font-size:12px;">${formatDate(c.created_at)}</td>
            </tr>
        `).join('');
    }
    
    function renderOrders(orders) {
        const tbody = document.getElementById('ordersBody');
        if (!orders || orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª</td></tr>';
            return;
        }
        tbody.innerHTML = orders.map(o => `
            <tr>
                <td>#${o.order_id || ''}</td>
                <td>${o.item_name || ''}</td>
                <td class="amount">${(o.price || 0).toLocaleString()} Ø±.Ø³</td>
                <td>${o.buyer_name || ''}<br><small style="color:var(--muted)">${o.buyer_id || ''}</small></td>
                <td>${o.seller_name || ''}</td>
                <td style="font-size:12px;">${formatDate(o.created_at)}</td>
                <td><button class="details-btn" onclick='showOrderDetails(${JSON.stringify(o)})'>ğŸ‘ï¸</button></td>
            </tr>
        `).join('');
    }
    
    function renderSoldProducts(products) {
        const tbody = document.getElementById('soldBody');
        if (!products || products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨Ø§Ø¹Ø©</td></tr>';
            return;
        }
        tbody.innerHTML = products.map(p => `
            <tr>
                <td>${p.item_name || ''}</td>
                <td class="amount">${(p.price || 0).toLocaleString()} Ø±.Ø³</td>
                <td>${p.category || '-'}</td>
                <td>${p.buyer_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}<br><small style="color:var(--muted)">ID: ${p.buyer_id || '-'}</small></td>
                <td style="font-size:12px;">${formatDate(p.sold_at)}</td>
            </tr>
        `).join('');
    }
    
    function renderAvailableProducts(products) {
        const tbody = document.getElementById('availableBody');
        if (!products || products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø©</td></tr>';
            return;
        }
        tbody.innerHTML = products.map(p => `
            <tr>
                <td>${p.item_name || ''}</td>
                <td class="amount">${(p.price || 0).toLocaleString()} Ø±.Ø³</td>
                <td>${p.category || '-'}</td>
                <td>${p.seller_name || 'Ø§Ù„Ù…ØªØ¬Ø±'}</td>
                <td>${p.delivery_type === 'instant' ? 'âš¡ ÙÙˆØ±ÙŠ' : 'ğŸ“¦ ÙŠØ¯ÙˆÙŠ'}</td>
            </tr>
        `).join('');
    }
    
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabName + '-tab').classList.add('active');
        event.target.classList.add('active');
    }
    
    function showPaymentDetails(payment) {
        document.getElementById('modalTitle').textContent = 'ğŸ’³ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø¯ÙØ¹';
        document.getElementById('modalBody').innerHTML = `
            <div class="detail-row"><span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</span><span class="detail-value">${payment.order_id || ''}</span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span><span class="detail-value">${payment.user_name || ''} (${payment.user_id || ''})</span></div>
            <div class="detail-row"><span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</span><span class="detail-value">${payment.user_phone || '-'}</span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„Ù…Ø¨Ù„Øº:</span><span class="detail-value amount">${(payment.amount || 0).toLocaleString()} Ø±.Ø³</span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„Ù†ÙˆØ¹:</span><span class="detail-value">${payment.type || ''}</span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span><span class="detail-value"><span class="status ${payment.status || ''}">${getStatusText(payment.status)}</span></span></div>
            <div class="detail-row"><span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</span><span class="detail-value">${payment.trans_id || '-'}</span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span><span class="detail-value">${formatDate(payment.created_at)}</span></div>
        `;
        document.getElementById('detailsModal').classList.add('active');
    }
    
    function showInvoiceDetails(invoice) {
        document.getElementById('modalTitle').textContent = 'ğŸ§¾ ØªÙØ§ØµÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„ØªØ§Ø¬Ø±';
        document.getElementById('modalBody').innerHTML = `
            <div class="detail-row"><span class="detail-label">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</span><span class="detail-value">${invoice.id || ''}</span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„ØªØ§Ø¬Ø±:</span><span class="detail-value">${invoice.merchant_name || ''} (${invoice.merchant_id || ''})</span></div>
            <div class="detail-row"><span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</span><span class="detail-value">${invoice.customer_phone || '-'}</span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„Ù…Ø¨Ù„Øº:</span><span class="detail-value amount">${(invoice.amount || 0).toLocaleString()} Ø±.Ø³</span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span><span class="detail-value"><span class="status ${invoice.status || ''}">${getStatusText(invoice.status)}</span></span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span><span class="detail-value">${formatDate(invoice.created_at)}</span></div>
        `;
        document.getElementById('detailsModal').classList.add('active');
    }
    
    function showOrderDetails(order) {
        document.getElementById('modalTitle').textContent = 'ğŸ›’ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨';
        document.getElementById('modalBody').innerHTML = `
            <div class="detail-row"><span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</span><span class="detail-value">#${order.order_id || ''}</span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„Ù…Ù†ØªØ¬:</span><span class="detail-value">${order.item_name || ''}</span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„Ø³Ø¹Ø±:</span><span class="detail-value amount">${(order.price || 0).toLocaleString()} Ø±.Ø³</span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„Ù…Ø´ØªØ±ÙŠ:</span><span class="detail-value">${order.buyer_name || ''} (${order.buyer_id || ''})</span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„Ø¨Ø§Ø¦Ø¹:</span><span class="detail-value">${order.seller_name || ''}</span></div>
            <div class="detail-row"><span class="detail-label">Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ù„ÙŠÙ…:</span><span class="detail-value">${order.delivery_type === 'instant' ? 'âš¡ ÙÙˆØ±ÙŠ' : 'ğŸ“¦ ÙŠØ¯ÙˆÙŠ'}</span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span><span class="detail-value">${formatDate(order.created_at)}</span></div>
        `;
        document.getElementById('detailsModal').classList.add('active');
    }
    
    function closeModal() {
        document.getElementById('detailsModal').classList.remove('active');
    }
    
    function getStatusText(status) {
        const statuses = {
            'pending': 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹',
            'completed': 'Ù…ÙƒØªÙ…Ù„',
            'success': 'Ù†Ø§Ø¬Ø­',
            'failed': 'ÙØ´Ù„',
            'cancelled': 'Ù…Ù„ØºÙŠ'
        };
        return statuses[status] || status || '-';
    }
    
    function formatDate(dateStr) {
        if (!dateStr || dateStr === 'None' || dateStr === '') return '-';
        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            return date.toLocaleDateString('ar-SA') + ' ' + date.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});
        } catch {
            return dateStr;
        }
    }
    
    function filterTable(tableId, searchText) {
        const table = document.getElementById(tableId);
        const rows = table.querySelectorAll('tbody tr');
        const search = searchText.toLowerCase();
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    }
    
    document.getElementById('detailsModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
    
    document.addEventListener('DOMContentLoaded', loadData);
</script>
{% endblock %}
