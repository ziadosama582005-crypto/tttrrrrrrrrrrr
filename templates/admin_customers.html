{% extends "admin_base.html" %}
{% block title %}Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endblock %}
{% block content %}
<div class="top-bar">
    <h1> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h1>
    <div class="top-bar-actions">
        <button class="btn btn-secondary" onclick="loadCustomers()"> ØªØ­Ø¯ÙŠØ«</button>
    </div>
</div>
<div class="stats-grid">
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="totalCustomers">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
    </div>
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="totalBalance">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©</div>
    </div>
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="totalOrders">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
    </div>
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="totalSpent">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
    </div>
</div>
<div class="card">
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <input type="text" id="searchInput" placeholder=" Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ID..." 
               style="flex: 1; min-width: 200px; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: white;">
        <select id="sortBy" style="padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: white;">
            <option value="balance_desc">Ø§Ù„Ø±ØµÙŠØ¯ (Ø§Ù„Ø£Ø¹Ù„Ù‰)</option>
            <option value="balance_asc">Ø§Ù„Ø±ØµÙŠØ¯ (Ø§Ù„Ø£Ù‚Ù„)</option>
            <option value="orders_desc">Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø§Ù„Ø£ÙƒØ«Ø±)</option>
            <option value="name_asc">Ø§Ù„Ø§Ø³Ù… (Ø£-ÙŠ)</option>
        </select>
        <button class="btn btn-primary" onclick="loadCustomers()">Ø¨Ø­Ø«</button>
    </div>
</div>
<div class="card">
    <div class="card-header">
        <span class="card-title"> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
        <span id="customersCountLabel" style="color: var(--muted); font-size: 13px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                    <th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</th>
                    <th>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="customersTable">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
<div id="customerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; overflow-y: auto;">
    <div style="max-width: 800px; margin: 40px auto; padding: 20px;">
        <div class="card" style="position: relative;">
            <button onclick="closeModal()" style="position: absolute; left: 15px; top: 15px; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">âœ•</button>
            <div id="customerDetails">
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    let allCustomers = [];
    async function loadCustomers() {
        const tbody = document.getElementById('customersTable');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></td></tr>';
        try {
            const res = await fetch('/api/admin/get_customers');
            const data = await res.json();
            if (data.status === 'success') {
                allCustomers = data.customers;
                updateStats(data.stats);
                renderCustomers();
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #e74c3c;"> ' + (data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£') + '</td></tr>';
            }
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #e74c3c;"> Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</td></tr>';
        }
    }
    function updateStats(stats) {
        document.getElementById('totalCustomers').textContent = stats.total_customers || 0;
        document.getElementById('totalBalance').textContent = (stats.total_balance || 0).toFixed(2) + ' Ø±.Ø³';
        document.getElementById('totalOrders').textContent = stats.total_orders || 0;
        document.getElementById('totalSpent').textContent = (stats.total_spent || 0).toFixed(2) + ' Ø±.Ø³';
    }
    function renderCustomers() {
        const tbody = document.getElementById('customersTable');
        const search = document.getElementById('searchInput').value.toLowerCase();
        const sortBy = document.getElementById('sortBy').value;
        let filtered = allCustomers.filter(c => {
            const name = (c.name || c.username || c.first_name || '').toLowerCase();
            const id = (c.user_id || c.id || '').toString();
            return name.includes(search) || id.includes(search);
        });
        filtered.sort((a, b) => {
            switch (sortBy) {
                case 'balance_desc': return (b.balance || 0) - (a.balance || 0);
                case 'balance_asc': return (a.balance || 0) - (b.balance || 0);
                case 'orders_desc': return (b.orders_count || 0) - (a.orders_count || 0);
                case 'name_asc': return (a.name || '').localeCompare(b.name || '');
                default: return 0;
            }
        });
        document.getElementById('customersCountLabel').textContent = `${filtered.length} Ø¹Ù…ÙŠÙ„`;
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--muted);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</td></tr>';
            return;
        }
        tbody.innerHTML = filtered.map(c => {
            const name = c.name || c.username || c.first_name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
            const userId = c.user_id || c.id || '-';
            const balance = (c.balance || 0).toFixed(2);
            const orders = c.orders_count || 0;
            const spent = (c.total_spent || 0).toFixed(2);
            const lastActivity = c.last_activity ? new Date(c.last_activity).toLocaleDateString('ar-SA') : '-';
            return `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #8b7cf7); display: flex; align-items: center; justify-content: center; font-size: 18px;">
                                ${name.charAt(0)}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${name}</div>
                                <div style="font-size: 12px; color: var(--muted);">#${userId}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span style="color: ${parseFloat(balance) > 0 ? 'var(--success)' : 'var(--muted)'}; font-weight: 600;">
                            ${balance} Ø±.Ø³
                        </span>
                    </td>
                    <td>${orders}</td>
                    <td>${spent} Ø±.Ø³</td>
                    <td style="font-size: 12px; color: var(--muted);">${lastActivity}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewCustomer('${userId}')">
                             Ø¹Ø±Ø¶
                        </button>
                        <button class="btn btn-success btn-sm" onclick="addBalance('${userId}', '${name}')">
                             Ø´Ø­Ù†
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    async function viewCustomer(userId) {
        const modal = document.getElementById('customerModal');
        const details = document.getElementById('customerDetails');
        modal.style.display = 'block';
        details.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></div>';
        try {
            const res = await fetch(`/api/admin/get_customer_details?user_id=${userId}`);
            const data = await res.json();
            const historyRes = await fetch(`/api/admin/get_user_history?user_id=${userId}`);
            const historyData = await historyRes.json();
            if (data.status === 'success') {
                const c = data.customer;
                const name = c.name || c.username || c.first_name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
                let chargesHtml = '<p style="color: var(--muted);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø­Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>';
                if (historyData.status === 'success' && historyData.data.charges && historyData.data.charges.length > 0) {
                    chargesHtml = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                        <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${historyData.data.charges.map(ch => {
                                        const now = Date.now() / 1000;
                                        const waitMinutes = 5;
                                        const passed = (now - ch.timestamp) / 60;
                                        const isAvailable = passed >= waitMinutes;
                                        const minutesLeft = Math.ceil(waitMinutes - passed);
                                        const methodName = {
                                            'edfapay': ' Ø¨Ø·Ø§Ù‚Ø©',
                                            'key': ' ÙƒÙˆØ¯',
                                            'admin': 'ğŸ‘¨â€ğŸ’¼ Ø£Ø¯Ù…Ù†',
                                            'charge': ' ÙƒÙˆØ¯'
                                        }[ch.method] || ch.method;
                                        return `
                                            <tr>
                                                <td style="font-weight: 600; color: var(--success);">+${ch.amount} Ø±.Ø³</td>
                                                <td>${methodName}</td>
                                                <td style="font-size: 12px;">${ch.date || '-'}</td>
                                                <td>
                                                    ${isAvailable 
                                                        ? '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(0,184,148,0.2); color: var(--success);"> Ù…ØªØ§Ø­ Ù„Ù„Ø³Ø­Ø¨</span>'
                                                        : `<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(243,156,18,0.2); color: var(--warning);">â³ ${minutesLeft} Ø¯Ù‚ÙŠÙ‚Ø©</span>`
                                                    }
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                let withdrawalsHtml = '<p style="color: var(--muted);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨</p>';
                if (historyData.status === 'success' && historyData.data.withdrawals && historyData.data.withdrawals.length > 0) {
                    withdrawalsHtml = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                        <th>Ø§Ù„ØµØ§ÙÙŠ</th>
                                        <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${historyData.data.withdrawals.map(w => {
                                        const statusColor = w.status === 'completed' ? 'var(--success)' : w.status === 'rejected' ? 'var(--danger)' : 'var(--warning)';
                                        const statusText = w.status === 'completed' ? ' Ù…ÙƒØªÙ…Ù„' : w.status === 'rejected' ? ' Ù…Ø±ÙÙˆØ¶' : 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
                                        return `
                                            <tr>
                                                <td>${w.amount} Ø±.Ø³</td>
                                                <td style="color: var(--success);">${w.net_amount} Ø±.Ø³</td>
                                                <td>${w.method === 'wallet' ? ' Ù…Ø­ÙØ¸Ø©' : 'ğŸ¦ Ø¨Ù†Ùƒ'}</td>
                                                <td><span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: ${statusColor}22; color: ${statusColor};">${statusText}</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                details.innerHTML = `
                    <h2 style="margin-bottom: 20px;"> ${name}</h2>
                    <p style="color: var(--muted); margin-bottom: 20px;">ID: ${userId}</p>
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="icon"></div>
                            <div class="value">${(c.balance || 0).toFixed(2)}</div>
                            <div class="label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon"></div>
                            <div class="value">${historyData.stats?.total_charged?.toFixed(2) || 0}</div>
                            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon"></div>
                            <div class="value">${c.orders_count || 0}</div>
                            <div class="label">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                        </div>
                        <div class="stat-card">
                            <div class="icon"></div>
                            <div class="value">${historyData.stats?.total_withdrawals || 0}</div>
                            <div class="label">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;"> Ø³Ø¬Ù„ Ø§Ù„Ø´Ø­Ù†Ø§Øª (${historyData.data?.charges?.length || 0})</h3>
                        ${chargesHtml}
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;"> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ (${historyData.data?.withdrawals?.length || 0})</h3>
                        ${withdrawalsHtml}
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;"> Ø§Ù„Ø·Ù„Ø¨Ø§Øª (${(c.orders || []).length})</h3>
                        ${c.orders && c.orders.length > 0 ? `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                                            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                            <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${c.orders.map(o => `
                                            <tr>
                                                <td style="font-family: monospace;">${o.id || '-'}</td>
                                                <td>${o.item_name || '-'}</td>
                                                <td>${o.price || 0} Ø±.Ø³</td>
                                                <td>
                                                    <span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: ${o.status === 'completed' ? 'rgba(0,184,148,0.2)' : 'rgba(243,156,18,0.2)'}; color: ${o.status === 'completed' ? 'var(--success)' : 'var(--warning)'};">
                                                        ${o.status === 'completed' ? ' Ù…ÙƒØªÙ…Ù„' : 'â³ Ù…Ø¹Ù„Ù‚'}
                                                    </span>
                                                </td>
                                                <td style="font-size: 12px;">${o.created_at ? new Date(o.created_at).toLocaleDateString('ar-SA') : '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p style="color: var(--muted);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>'}
                    </div>
                `;
            } else {
                details.innerHTML = '<p style="color: var(--danger); text-align: center;"> Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>';
            }
        } catch (e) {
            console.error(e);
            details.innerHTML = '<p style="color: var(--danger); text-align: center;"> Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</p>';
        }
    }
    function closeModal() {
        document.getElementById('customerModal').style.display = 'none';
    }
    async function addBalance(userId, name) {
        const amount = prompt(` ÙƒÙ… ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ù„Ø±ØµÙŠØ¯ ${name}ØŸ`);
        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) return;
        try {
            const res = await fetch('/api/add_balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    user_id: userId, 
                    amount: parseFloat(amount) 
                })
            });
            const data = await res.json();
            if (data.success) {
                showToast(` ØªÙ… Ø¥Ø¶Ø§ÙØ© ${amount} Ø±.Ø³ Ù„Ù€ ${name}`);
                loadCustomers();
            } else {
                showToast(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            }
        } catch (e) {
            showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
        }
    }
    document.getElementById('searchInput').addEventListener('input', renderCustomers);
    document.getElementById('sortBy').addEventListener('change', renderCustomers);
    loadCustomers();
</script>
{% endblock %}
