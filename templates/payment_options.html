<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¯ÙØ¹ - Ù…ØªØ¬Ø± ØªÙŠ Ø¢Ø±</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body style="background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 100%); color: white; font-family: 'Tajawal', sans-serif; margin: 0; padding: 20px;">
    <div style="max-width: 500px; margin: 0 auto; background: #16213e; border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="font-size: 28px; margin-bottom: 8px; color: #6c5ce7;">ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h1>
            <p style="color: #888; font-size: 14px;">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ù†Ø³Ø¨ Ù„Ùƒ</p>
        </div>

<!-- 1ï¸âƒ£ Ù‚Ø³Ù… Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¯ÙØ¹ -->
<div class="payment-section">
    <h3>ğŸ’³ Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</h3>
    
    <div class="payment-methods">
        <!-- Ø®ÙŠØ§Ø± 1: Ø§Ù„Ù…Ø­ÙØ¸Ø© -->
        <label class="payment-option">
            <input type="radio" name="payment_method" value="wallet" checked>
            <div class="payment-card">
                <div class="payment-icon">ğŸ’°</div>
                <div class="payment-info">
                    <div class="payment-name">Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
                    <div class="payment-desc">Ø§Ø³ØªØ®Ø¯Ù… Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                    <div class="payment-balance" id="walletBalance">Ø§Ù„Ø±ØµÙŠØ¯: 150 Ø±ÙŠØ§Ù„</div>
                </div>
                <div class="payment-check">âœ“</div>
            </div>
        </label>

        <!-- Ø®ÙŠØ§Ø± 2: Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù† -->
        <label class="payment-option">
            <input type="radio" name="payment_method" value="card">
            <div class="payment-card">
                <div class="payment-icon">ğŸ¦</div>
                <div class="payment-info">
                    <div class="payment-name">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</div>
                    <div class="payment-desc">ÙÙŠØ²Ø§ Ø£Ùˆ Ù…Ø§Ø³ØªØ±ÙƒØ§Ø±Ø¯</div>
                    <div class="payment-fee">Ø¨Ø¯ÙˆÙ† Ø±Ø³ÙˆÙ… Ø¥Ø¶Ø§ÙÙŠØ©</div>
                </div>
                <div class="payment-check">âœ“</div>
            </div>
        </label>

        <!-- Ø®ÙŠØ§Ø± 3: Ø§Ù„ØªÙ‚Ø³ÙŠØ· -->
        <label class="payment-option">
            <input type="radio" name="payment_method" value="installments">
            <div class="payment-card">
                <div class="payment-icon">ğŸ“…</div>
                <div class="payment-info">
                    <div class="payment-name">ØªÙ‚Ø³ÙŠØ· 3 Ø£Ø´Ù‡Ø±</div>
                    <div class="payment-desc">Ø§Ø¯ÙØ¹ Ø¨Ø¯ÙˆÙ† ÙÙˆØ§Ø¦Ø¯</div>
                    <div class="payment-fee" id="monthlyPayment">Ø§Ù„Ø¯ÙØ¹Ø©: 21.99 Ø±ÙŠØ§Ù„/Ø´Ù‡Ø±</div>
                </div>
                <div class="payment-check">âœ“</div>
            </div>
        </label>
    </div>
</div>

<!-- 2ï¸âƒ£ ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø¯Ù… ÙƒÙØ§ÙŠØ© Ø§Ù„Ø±ØµÙŠØ¯ -->
<div id="balanceWarning" class="balance-warning" style="display: none;">
    <div class="warning-icon">âš ï¸</div>
    <div class="warning-content">
        <div class="warning-title">Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ</div>
        <div class="warning-message" id="warningMessage">
            ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ <span id="shortageAmount">15.00</span> Ø±ÙŠØ§Ù„ Ø¥Ø¶Ø§ÙÙŠ
        </div>
    </div>
</div>

<!-- 3ï¸âƒ£ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯ -->
<div id="chargeSuggestions" class="charge-suggestions" style="display: none;">
    <h3>ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ùƒ:</h3>
    
    <!-- Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¶Ø¨Ø· -->
    <div class="suggestion-card recommended">
        <div class="suggestion-icon">âœ¨</div>
        <div class="suggestion-info">
            <div class="suggestion-title">Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£Ù…Ø«Ù„</div>
            <div class="suggestion-desc" id="exactAmountDesc">Ø§Ø´Ø­Ù† 15.00 Ø±ÙŠØ§Ù„ ÙÙ‚Ø·</div>
        </div>
        <button class="charge-btn" onclick="quickCharge(15.00, 'exact')">Ø§Ø´Ø­Ù† Ø§Ù„Ø¢Ù†</button>
    </div>

    <!-- Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù…Ø¹ Ù‡Ø¯ÙŠØ© -->
    <div class="suggestion-card offer">
        <div class="suggestion-icon">ğŸ</div>
        <div class="suggestion-info">
            <div class="suggestion-title">Ø¹Ø±Ø¶ Ø®Ø§Øµ</div>
            <div class="suggestion-desc" id="bonusDesc">Ø§Ø´Ø­Ù† 65.00 Ø±ÙŠØ§Ù„ + 50 Ø±ÙŠØ§Ù„ Ù‡Ø¯ÙŠØ©</div>
            <div class="suggestion-badge">ğŸ‰ Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù‡Ø¯ÙŠØ©</div>
        </div>
        <button class="charge-btn offer-btn" onclick="quickCharge(65.00, 'bonus')">Ø§Ø´Ø­Ù† Ø§Ù„Ø¢Ù†</button>
    </div>

    <!-- Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§ -->
    <h4 style="margin-top: 20px;">Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§:</h4>
    <div class="quick-amounts" id="quickAmounts">
        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ù€ JavaScript -->
    </div>
</div>

<!-- 4ï¸âƒ£ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ù„Ø®Øµ ÙˆØ§Ù„Ø¯ÙØ¹ -->
<div class="payment-summary">
    <div class="summary-row">
        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
        <span id="totalAmount">65.97 Ø±ÙŠØ§Ù„</span>
    </div>
    <div class="summary-row" id="balanceRow">
        <span>Ø±ØµÙŠØ¯Ùƒ:</span>
        <span id="currentBalance">150.00 Ø±ÙŠØ§Ù„</span>
    </div>
    <div class="summary-row balance-after" id="balanceAfterRow" style="display: none;">
        <span>Ø±ØµÙŠØ¯Ùƒ Ø¨Ø¹Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡:</span>
        <span id="balanceAfter" style="color: #00b894;">84.03 Ø±ÙŠØ§Ù„</span>
    </div>

    <button class="checkout-btn" id="checkoutBtn" onclick="processPayment()">
        âœ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡
    </button>
</div>

<style>
    /* Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¯ÙØ¹ */
    .payment-section {
        margin: 20px 0;
    }
    
    .payment-section h3 {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #ffffff;
    }
    
    .payment-methods {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .payment-option {
        cursor: pointer;
    }
    
    .payment-option input {
        display: none;
    }
    
    .payment-card {
        background: #1a1a2e;
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 16px;
        display: flex;
        gap: 15px;
        align-items: center;
        transition: all 0.3s;
        position: relative;
    }
    
    .payment-option input:checked + .payment-card {
        border-color: #6c5ce7;
        background: rgba(108, 92, 231, 0.1);
        box-shadow: 0 0 20px rgba(108, 92, 231, 0.3);
    }
    
    .payment-icon {
        font-size: 32px;
        min-width: 50px;
    }
    
    .payment-info {
        flex: 1;
    }
    
    .payment-name {
        font-weight: bold;
        font-size: 15px;
        margin-bottom: 4px;
    }
    
    .payment-desc, .payment-fee, .payment-balance {
        font-size: 13px;
        color: #888;
    }
    
    .payment-check {
        width: 24px;
        height: 24px;
        border: 2px solid #ddd;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: transparent;
        transition: all 0.3s;
    }
    
    .payment-option input:checked + .payment-card .payment-check {
        background: #6c5ce7;
        border-color: #6c5ce7;
        color: white;
    }
    
    /* ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø±ØµÙŠØ¯ */
    .balance-warning {
        background: rgba(231, 76, 60, 0.1);
        border: 2px solid rgba(231, 76, 60, 0.3);
        border-radius: 14px;
        padding: 16px;
        margin: 15px 0;
        display: flex;
        gap: 12px;
    }
    
    .warning-icon {
        font-size: 24px;
    }
    
    .warning-content {
        flex: 1;
    }
    
    .warning-title {
        font-weight: bold;
        color: #e74c3c;
        margin-bottom: 4px;
    }
    
    .warning-message {
        color: #888;
        font-size: 14px;
    }
    
    /* Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª */
    .charge-suggestions {
        background: rgba(108, 92, 231, 0.05);
        border: 2px solid rgba(108, 92, 231, 0.2);
        border-radius: 14px;
        padding: 15px;
        margin: 15px 0;
    }
    
    .charge-suggestions h3 {
        margin-bottom: 12px;
    }
    
    .suggestion-card {
        background: #1a1a2e;
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 12px;
        display: flex;
        gap: 12px;
        align-items: center;
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.3s;
    }
    
    .suggestion-card.recommended {
        border: 2px solid #6c5ce7;
        background: rgba(108, 92, 231, 0.1);
    }
    
    .suggestion-card.offer {
        border: 2px solid #f1c40f;
        background: rgba(241, 196, 15, 0.05);
    }
    
    .suggestion-icon {
        font-size: 24px;
        min-width: 40px;
    }
    
    .suggestion-info {
        flex: 1;
    }
    
    .suggestion-title {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 4px;
    }
    
    .suggestion-desc {
        font-size: 13px;
        color: #888;
    }
    
    .suggestion-badge {
        font-size: 11px;
        color: #f1c40f;
        margin-top: 4px;
        font-weight: bold;
    }
    
    .charge-btn {
        background: #6c5ce7;
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        transition: all 0.3s;
    }
    
    .charge-btn:hover {
        background: #5d4db5;
        transform: scale(1.05);
    }
    
    .charge-btn.offer-btn {
        background: linear-gradient(135deg, #f1c40f, #f39c12);
        color: black;
    }
    
    /* Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ø³Ø±ÙŠØ¹Ø© */
    .quick-amounts {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    
    .quick-amount-btn {
        background: #1a1a2e;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        padding: 12px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        text-align: center;
    }
    
    .quick-amount-btn:hover {
        background: #6c5ce7;
        border-color: #6c5ce7;
    }
    
    .quick-amount-btn.recommended {
        background: #6c5ce7;
        border-color: #6c5ce7;
    }
    
    .quick-amount-badge {
        display: block;
        font-size: 10px;
        color: #f1c40f;
        margin-top: 4px;
    }
</style>

<script>
    // ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ
    function updatePaymentSummary() {
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
        const cartTotal = parseFloat(document.getElementById('totalAmount').innerText);
        const currentBalance = parseFloat(document.getElementById('currentBalance').innerText);
        
        if (paymentMethod === 'wallet') {
            const balanceAfter = currentBalance - cartTotal;
            
            if (balanceAfter < 0) {
                // âŒ Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ
                showBalanceWarning(cartTotal, currentBalance);
                loadChargeSuggestions(Math.abs(balanceAfter), currentBalance);
                document.getElementById('checkoutBtn').disabled = true;
            } else {
                // âœ… Ø±ØµÙŠØ¯ ÙƒØ§ÙÙŠ
                document.getElementById('balanceWarning').style.display = 'none';
                document.getElementById('chargeSuggestions').style.display = 'none';
                document.getElementById('balanceAfterRow').style.display = 'flex';
                document.getElementById('balanceAfter').innerText = balanceAfter.toFixed(2) + ' Ø±ÙŠØ§Ù„';
                document.getElementById('checkoutBtn').disabled = false;
            }
        } else {
            // Ø®ÙŠØ§Ø±Ø§Øª Ø¯ÙØ¹ Ø£Ø®Ø±Ù‰ (Ø¨Ø·Ø§Ù‚Ø©ØŒ ØªÙ‚Ø³ÙŠØ·)
            document.getElementById('balanceWarning').style.display = 'none';
            document.getElementById('chargeSuggestions').style.display = 'none';
            document.getElementById('balanceAfterRow').style.display = 'none';
            document.getElementById('checkoutBtn').disabled = false;
        }
    }

    // âš ï¸ Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø¯Ù… ÙƒÙØ§ÙŠØ© Ø§Ù„Ø±ØµÙŠØ¯
    function showBalanceWarning(total, balance) {
        const shortage = total - balance;
        document.getElementById('balanceWarning').style.display = 'flex';
        document.getElementById('shortageAmount').innerText = shortage.toFixed(2);
        document.getElementById('warningMessage').innerHTML = 
            `ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ <span style="color: #e74c3c; font-weight: bold;">${shortage.toFixed(2)} Ø±ÙŠØ§Ù„</span> Ø¥Ø¶Ø§ÙÙŠ`;
    }

    // ğŸ’¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø´Ø­Ù†
    async function loadChargeSuggestions(shortage, balance) {
        document.getElementById('chargeSuggestions').style.display = 'block';
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø£ÙˆÙ„
        document.getElementById('exactAmountDesc').innerText = 
            `Ø§Ø´Ø­Ù† ${shortage.toFixed(2)} Ø±ÙŠØ§Ù„ ÙÙ‚Ø·`;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø«Ø§Ù†ÙŠ (Ù…Ø¹ Ù‡Ø¯ÙŠØ©)
        const bonusAmount = shortage + 50;
        document.getElementById('bonusDesc').innerText = 
            `Ø§Ø´Ø­Ù† ${bonusAmount.toFixed(2)} Ø±ÙŠØ§Ù„ + 50 Ø±ÙŠØ§Ù„ Ù‡Ø¯ÙŠØ©`;
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§
        const response = await fetch('/api/charge/recommended-amounts');
        const data = await response.json();
        
        const quickAmounts = document.getElementById('quickAmounts');
        quickAmounts.innerHTML = '';
        
        data.recommended_amounts.forEach(item => {
            const btn = document.createElement('button');
            btn.className = 'quick-amount-btn';
            btn.onclick = () => quickCharge(item.amount, 'recommended');
            btn.innerHTML = `
                ${item.amount} Ø±ÙŠØ§Ù„
                ${item.badge ? `<span class="quick-amount-badge">${item.badge}</span>` : ''}
            `;
            quickAmounts.appendChild(btn);
        });
    }

    // ğŸ’³ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹
    async function processPayment() {
        const method = document.querySelector('input[name="payment_method"]:checked').value;
        const total = parseFloat(document.getElementById('totalAmount').innerText);
        
        const response = await fetch('/api/payment/process', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: '{{ user_id }}',
                payment_method: method,
                total_amount: total
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert(result.message);
            window.location.href = '/';
        } else {
            alert('âŒ ' + result.message);
        }
    }

    // âš¡ Ø´Ø­Ù† Ø³Ø±ÙŠØ¹
    async function quickCharge(amount, type) {
        const response = await fetch('/api/charge/quick-charge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: '{{ user_id }}',
                amount: amount
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert(`âœ… ØªÙ… ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø´Ø­Ù†\nØ§Ù„Ù…Ø¨Ù„Øº: ${amount} Ø±ÙŠØ§Ù„`);
            window.location.href = result.redirect_url;
        }
    }

    // ğŸ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø± Ø§Ù„Ø¯ÙØ¹
    document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
        radio.addEventListener('change', updatePaymentSummary);
    });

    // ğŸš€ ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.addEventListener('load', updatePaymentSummary);
</script>
