{% extends "admin_base.html" %}

{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©{% endblock %}

{% block content %}
<div class="top-bar">
    <h1> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h1>
    <div class="top-bar-actions">
        <button class="btn btn-secondary btn-sm" onclick="loadAllStats()"> ØªØ­Ø¯ÙŠØ«</button>
    </div>
</div>

<!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="totalUsers">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
    </div>
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="totalBalance">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©</div>
    </div>
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="totalProducts">-</div>
        <div class="label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
    </div>
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="availableProducts">-</div>
        <div class="label">Ù…ØªØ§Ø­ Ù„Ù„Ø¨ÙŠØ¹</div>
    </div>
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="totalOrders">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
    </div>
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="totalRevenue">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
    </div>
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="activeKeys">-</div>
        <div class="label">Ù…ÙØ§ØªÙŠØ­ Ù†Ø´Ø·Ø©</div>
    </div>
    <div class="stat-card">
        <div class="icon">ğŸ“„</div>
        <div class="value" id="pendingInvoices">-</div>
        <div class="label">ÙÙˆØ§ØªÙŠØ± Ù…Ø¹Ù„Ù‚Ø©</div>
    </div>
</div>

<!-- ØµÙ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
    <!-- Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <div class="card">
        <div class="card-header">
            <span class="card-title"> Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
            <a href="/admin/orders" class="btn btn-secondary btn-sm">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø§Ù„Ù…Ø´ØªØ±ÙŠ</th>
                        <th>Ø§Ù„Ø³Ø¹Ø±</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    </tr>
                </thead>
                <tbody id="recentOrders">
                    <tr><td colspan="4" class="loading"><div class="spinner"></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø³Ù„Ø© -->
    <div class="card">
        <div class="card-header">
            <span class="card-title"> Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</span>
            <a href="/admin/carts" class="btn btn-secondary btn-sm">Ø§Ù„Ø³Ù„Ø§Øª</a>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø¥Ø¶Ø§ÙØ§Øª</th>
                        <th>Ù…Ø´ØªØ±ÙŠØ§Øª</th>
                        <th>Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</th>
                    </tr>
                </thead>
                <tbody id="topCartProducts">
                    <tr><td colspan="4" class="loading"><div class="spinner"></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ØµÙ Ø«Ø§Ù†ÙŠ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">
    <!-- Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø±ØµÙŠØ¯ -->
    <div class="card">
        <div class="card-header">
            <span class="card-title"> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø±ØµÙŠØ¯Ø§Ù‹</span>
            <a href="/admin/customers" class="btn btn-secondary btn-sm">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                    </tr>
                </thead>
                <tbody id="topCustomers">
                    <tr><td colspan="3" class="loading"><div class="spinner"></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ÙƒØ±ÙˆØª Ø§Ù„Ø´Ø­Ù† -->
    <div class="card">
        <div class="card-header">
            <span class="card-title"> ÙƒØ±ÙˆØª Ø§Ù„Ø´Ø­Ù†</span>
            <a href="/admin/charge-keys" class="btn btn-secondary btn-sm">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ±ÙˆØª</a>
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 15px;">
            <div style="text-align: center;">
                <div style="font-size: 28px; font-weight: bold; color: var(--success);" id="activeKeysCard">-</div>
                <div style="font-size: 12px; color: var(--muted);">Ù†Ø´Ø·Ø©</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 28px; font-weight: bold; color: var(--muted);" id="usedKeysCard">-</div>
                <div style="font-size: 12px; color: var(--muted);">Ù…Ø³ØªØ®Ø¯Ù…Ø©</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 28px; font-weight: bold; color: var(--primary-light);" id="totalKeysCard">-</div>
                <div style="font-size: 12px; color: var(--muted);">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
            </div>
        </div>
        <div style="padding: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
            <button class="btn btn-primary btn-sm" onclick="openGenerateModal()" style="width: 100%;">
                â• ØªÙˆÙ„ÙŠØ¯ ÙƒØ±ÙˆØª Ø¬Ø¯ÙŠØ¯Ø©
            </button>
        </div>
    </div>
</div>

<!-- Modal ØªÙˆÙ„ÙŠØ¯ ÙƒØ±ÙˆØª -->
<div id="generateModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 400px; margin: 0;">
        <div class="card-header">
            <span class="card-title"> ØªÙˆÙ„ÙŠØ¯ ÙƒØ±ÙˆØª Ø´Ø­Ù†</span>
            <button onclick="closeGenerateModal()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">âœ•</button>
        </div>
        <div style="padding: 20px;">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px;">Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒØ§Ø±Øª (Ø±.Ø³)</label>
                <input type="number" id="keyAmount" placeholder="10" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-size: 14px;">Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ±ÙˆØª</label>
                <input type="number" id="keyCount" placeholder="5" min="1" max="100" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
            </div>
            <button class="btn btn-primary" onclick="generateKeys()" style="width: 100%;"> ØªÙˆÙ„ÙŠØ¯</button>
            <div id="generatedKeys" style="margin-top: 15px; display: none; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; max-height: 200px; overflow-y: auto;">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    async function loadAllStats() {
        try {
            const res = await fetch('/api/admin/dashboard_stats');
            const data = await res.json();
            
            if (data.status === 'success') {
                const s = data.stats;
                
                // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                document.getElementById('totalUsers').textContent = s.total_users || 0;
                document.getElementById('totalBalance').textContent = (s.total_balance || 0).toFixed(2) + ' Ø±.Ø³';
                document.getElementById('totalProducts').textContent = s.total_products || 0;
                document.getElementById('availableProducts').textContent = s.available_products || 0;
                document.getElementById('totalOrders').textContent = s.total_orders || 0;
                document.getElementById('totalRevenue').textContent = (s.total_revenue || 0).toFixed(2) + ' Ø±.Ø³';
                document.getElementById('activeKeys').textContent = s.active_keys || 0;
                document.getElementById('pendingInvoices').textContent = s.pending_invoices || 0;
                
                // ÙƒØ±ÙˆØª Ø§Ù„Ø´Ø­Ù†
                document.getElementById('activeKeysCard').textContent = s.active_keys || 0;
                document.getElementById('usedKeysCard').textContent = s.used_keys || 0;
                document.getElementById('totalKeysCard').textContent = (s.active_keys || 0) + (s.used_keys || 0);
                
                // Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                loadRecentOrders(s.recent_orders || []);
                
                // Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                loadTopCartProducts(s.top_cart_products || []);
                
                // Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
                loadTopCustomers(s.users_list || []);
            }
        } catch (e) {
            console.error('Error loading stats:', e);
            showToast('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', 'error');
        }
    }
    
    function loadRecentOrders(orders) {
        const tbody = document.getElementById('recentOrders');
        if (!orders.length) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>';
            return;
        }
        
        tbody.innerHTML = orders.slice(0, 8).map(o => `
            <tr>
                <td>${o.item_name || 'Ù…Ù†ØªØ¬'}</td>
                <td>${o.buyer_name || 'Ù…Ø´ØªØ±ÙŠ'}</td>
                <td>${o.price || 0} Ø±.Ø³</td>
                <td style="font-size: 12px; color: var(--muted);">${formatDate(o.created_at)}</td>
            </tr>
        `).join('');
    }
    
    function loadTopCartProducts(products) {
        const tbody = document.getElementById('topCartProducts');
        if (!products.length) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
            return;
        }
        
        tbody.innerHTML = products.slice(0, 6).map(p => {
            const rate = p.add_count > 0 ? ((p.purchase_count / p.add_count) * 100).toFixed(1) : 0;
            return `
                <tr>
                    <td>${p.name || 'Ù…Ù†ØªØ¬'}</td>
                    <td>${p.add_count || 0}</td>
                    <td>${p.purchase_count || 0}</td>
                    <td><span style="color: ${rate > 50 ? 'var(--success)' : 'var(--warning)'}">${rate}%</span></td>
                </tr>
            `;
        }).join('');
    }
    
    function loadTopCustomers(users) {
        const tbody = document.getElementById('topCustomers');
        
        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø±ØµÙŠØ¯
        const sorted = users.sort((a, b) => (b.balance || 0) - (a.balance || 0)).slice(0, 6);
        
        if (!sorted.length) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--muted);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</td></tr>';
            return;
        }
        
        tbody.innerHTML = sorted.map(u => `
            <tr style="cursor: pointer;" onclick="window.location.href='/admin/customers?search=${u.id}'">
                <td>${u.name || 'Ù…Ø³ØªØ®Ø¯Ù…'}</td>
                <td style="color: var(--success);">${(u.balance || 0).toFixed(2)} Ø±.Ø³</td>
                <td style="font-size: 12px; color: var(--muted);">@${u.username || '-'}</td>
            </tr>
        `).join('');
    }
    
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        try {
            const d = new Date(dateStr);
            return d.toLocaleDateString('ar-SA') + ' ' + d.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'});
        } catch {
            return dateStr;
        }
    }
    
    // Modal ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒØ±ÙˆØª
    function openGenerateModal() {
        document.getElementById('generateModal').style.display = 'flex';
    }
    
    function closeGenerateModal() {
        document.getElementById('generateModal').style.display = 'none';
        document.getElementById('generatedKeys').style.display = 'none';
    }
    
    async function generateKeys() {
        const amount = parseFloat(document.getElementById('keyAmount').value);
        const count = parseInt(document.getElementById('keyCount').value);
        
        if (!amount || amount <= 0) {
            showToast('Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø©', 'error');
            return;
        }
        if (!count || count <= 0 || count > 100) {
            showToast('Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ (1-100)', 'error');
            return;
        }
        
        try {
            const res = await fetch('/api/generate_keys', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({amount, count})
            });
            
            const data = await res.json();
            
            if (data.status === 'success') {
                showToast(`ØªÙ… ØªÙˆÙ„ÙŠØ¯ ${data.keys.length} ÙƒØ±Øª Ø¨Ù†Ø¬Ø§Ø­`, 'success');
                
                // Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ±ÙˆØª
                const keysDiv = document.getElementById('generatedKeys');
                keysDiv.innerHTML = data.keys.map(k => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px; margin-bottom: 5px;">
                        <code style="font-size: 13px;">${k}</code>
                        <button onclick="copyKey('${k}')" style="background: var(--primary); border: none; padding: 4px 8px; border-radius: 4px; color: white; cursor: pointer; font-size: 12px;">Ù†Ø³Ø®</button>
                    </div>
                `).join('');
                keysDiv.style.display = 'block';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                loadAllStats();
            } else {
                showToast(data.message || 'ÙØ´Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯', 'error');
            }
        } catch (e) {
            showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
        }
    }
    
    function copyKey(key) {
        navigator.clipboard.writeText(key);
        showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø®!', 'success');
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', loadAllStats);
</script>
{% endblock %}
