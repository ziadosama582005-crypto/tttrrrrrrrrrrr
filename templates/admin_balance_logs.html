{% extends "admin_base.html" %}

{% block title %}Ø³Ø¬Ù„ Ø§Ù„Ø±ØµÙŠØ¯ - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endblock %}

{% block content %}
<div class="top-bar">
    <h1>ğŸ’³ Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø±ØµÙŠØ¯</h1>
    <div class="top-bar-actions">
        <button class="btn btn-secondary" onclick="loadLogs()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    </div>
</div>

<!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
<div class="stats-grid">
    <div class="stat-card" style="border-color: var(--success);">
        <div class="icon">â•</div>
        <div class="value" id="totalDeposits" style="color: var(--success);">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª</div>
    </div>
    <div class="stat-card" style="border-color: var(--danger);">
        <div class="icon">â–</div>
        <div class="value" id="totalDeductions" style="color: var(--danger);">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</div>
    </div>
    <div class="stat-card">
        <div class="icon">ğŸ“Š</div>
        <div class="value" id="totalTransactions">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
    </div>
</div>

<!-- Ø§Ù„ÙÙ„ØªØ±Ø© -->
<div class="card">
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <select id="typeFilter" style="padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: white;">
            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
            <option value="add">â• Ø¥ÙŠØ¯Ø§Ø¹</option>
            <option value="deduct">â– Ø®ØµÙ…</option>
        </select>
        <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..." 
               style="flex: 1; min-width: 150px; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: white;">
    </div>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª -->
<div class="card">
    <div class="card-header">
        <span class="card-title">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
        <span id="logsCountLabel" style="color: var(--muted); font-size: 13px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„ÙˆØµÙ</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                </tr>
            </thead>
            <tbody id="logsTable">
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allLogs = [];

    async function loadLogs() {
        const tbody = document.getElementById('logsTable');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></td></tr>';
        
        try {
            const res = await fetch('/api/admin/get_balance_logs');
            const data = await res.json();
            
            if (data.status === 'success') {
                allLogs = data.logs || [];
                updateStats();
                renderLogs();
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #e74c3c;">âŒ ' + (data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£') + '</td></tr>';
            }
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #e74c3c;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</td></tr>';
        }
    }

    function updateStats() {
        let deposits = 0, deductions = 0;
        allLogs.forEach(l => {
            const amount = parseFloat(l.amount) || 0;
            if (l.type === 'add') deposits += amount;
            else deductions += amount;
        });
        
        document.getElementById('totalDeposits').textContent = deposits.toFixed(2) + ' Ø±.Ø³';
        document.getElementById('totalDeductions').textContent = deductions.toFixed(2) + ' Ø±.Ø³';
        document.getElementById('totalTransactions').textContent = allLogs.length;
    }

    function renderLogs() {
        const tbody = document.getElementById('logsTable');
        const typeFilter = document.getElementById('typeFilter').value;
        const search = document.getElementById('searchInput').value.toLowerCase();
        
        let filtered = allLogs.filter(l => {
            if (typeFilter !== 'all' && l.type !== typeFilter) return false;
            if (search && !(l.user_id || '').toLowerCase().includes(search)) return false;
            return true;
        });
        
        document.getElementById('logsCountLabel').textContent = `${filtered.length} Ø¹Ù…Ù„ÙŠØ©`;
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--muted);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>';
            return;
        }
        
        tbody.innerHTML = filtered.map(l => {
            const typeBadge = l.type === 'add'
                ? '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(0,184,148,0.2); color: var(--success);">â• Ø¥ÙŠØ¯Ø§Ø¹</span>'
                : '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(231,76,60,0.2); color: var(--danger);">â– Ø®ØµÙ…</span>';
            
            const date = l.created_at ? new Date(l.created_at).toLocaleString('ar-SA') : '-';
            const amount = parseFloat(l.amount) || 0;
            
            return `
                <tr>
                    <td>${typeBadge}</td>
                    <td style="font-family: monospace;">#${l.user_id || '-'}</td>
                    <td style="color: ${l.type === 'add' ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">
                        ${l.type === 'add' ? '+' : '-'}${amount.toFixed(2)} Ø±.Ø³
                    </td>
                    <td style="font-size: 12px; color: var(--muted);">${l.description || '-'}</td>
                    <td style="font-size: 12px; color: var(--muted);">${date}</td>
                </tr>
            `;
        }).join('');
    }

    // Filters
    document.getElementById('typeFilter').addEventListener('change', renderLogs);
    document.getElementById('searchInput').addEventListener('input', renderLogs);

    loadLogs();
</script>
{% endblock %}
