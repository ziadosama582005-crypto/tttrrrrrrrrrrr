{% extends "admin_base.html" %}
{% block title %}كروت الشحن - لوحة التحكم{% endblock %}
{% block content %}
<div class="top-bar">
    <h1> إدارة كروت الشحن</h1>
    <div class="top-bar-actions">
        <button class="btn btn-primary" onclick="showGenerateModal()">➕ إنشاء كروت</button>
        <button class="btn btn-secondary" onclick="loadKeys()"> تحديث</button>
    </div>
</div>
<div class="stats-grid">
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="totalKeys">-</div>
        <div class="label">إجمالي الكروت</div>
    </div>
    <div class="stat-card" style="border-color: var(--success);">
        <div class="icon"></div>
        <div class="value" id="activeKeys" style="color: var(--success);">-</div>
        <div class="label">نشطة</div>
    </div>
    <div class="stat-card" style="border-color: var(--muted);">
        <div class="icon"></div>
        <div class="value" id="usedKeys" style="color: var(--muted);">-</div>
        <div class="label">مستخدمة</div>
    </div>
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="totalValue">-</div>
        <div class="label">القيمة الإجمالية</div>
    </div>
</div>
<div class="card">
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <select id="statusFilter" style="padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: white;">
            <option value="all">جميع الحالات</option>
            <option value="active"> نشطة</option>
            <option value="used"> مستخدمة</option>
        </select>
        <select id="amountFilter" style="padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: white;">
            <option value="all">جميع القيم</option>
        </select>
        <input type="text" id="searchInput" placeholder=" بحث بالكود..." 
               style="flex: 1; min-width: 150px; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: white;">
    </div>
</div>
<div class="card">
    <div class="card-header">
        <span class="card-title"> قائمة الكروت</span>
        <span id="keysCountLabel" style="color: var(--muted); font-size: 13px;">جاري التحميل...</span>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>الكود</th>
                    <th>القيمة</th>
                    <th>الحالة</th>
                    <th>تاريخ الإنشاء</th>
                    <th>المستخدم</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody id="keysTable">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
<div id="generateModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; overflow-y: auto;">
    <div style="max-width: 400px; margin: 80px auto; padding: 20px;">
        <div class="card">
            <h2 style="margin-bottom: 20px;">➕ إنشاء كروت شحن</h2>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: var(--muted);">القيمة (ر.س)</label>
                <input type="number" id="keyAmount" value="10" min="1" step="0.5"
                       style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: white;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: var(--muted);">عدد الكروت</label>
                <input type="number" id="keyCount" value="5" min="1" max="100"
                       style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: white;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="generateKeys()"> إنشاء</button>
                <button class="btn btn-secondary" onclick="closeModal()"> إلغاء</button>
            </div>
            <div id="generatedResult" style="display: none; margin-top: 20px; padding: 15px; background: rgba(0,184,148,0.1); border-radius: 10px; border: 1px solid rgba(0,184,148,0.3);">
                <h4 style="color: var(--success); margin-bottom: 10px;"> تم إنشاء الكروت!</h4>
                <div id="generatedKeys" style="font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
                <button class="btn btn-secondary btn-sm" style="margin-top: 10px;" onclick="copyKeys()"> نسخ الكل</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    let allKeys = [];
    let generatedKeysText = '';
    async function loadKeys() {
        const tbody = document.getElementById('keysTable');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></td></tr>';
        try {
            const res = await fetch('/api/admin/get_charge_keys');
            const data = await res.json();
            if (data.status === 'success') {
                allKeys = data.keys || [];
                updateStats();
                updateAmountFilter();
                renderKeys();
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #e74c3c;"> ' + (data.message || 'حدث خطأ') + '</td></tr>';
            }
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #e74c3c;"> خطأ في الاتصال</td></tr>';
        }
    }
    function updateStats() {
        const active = allKeys.filter(k => !k.used).length;
        const used = allKeys.filter(k => k.used).length;
        const totalValue = allKeys.filter(k => !k.used).reduce((sum, k) => sum + (k.amount || 0), 0);
        document.getElementById('totalKeys').textContent = allKeys.length;
        document.getElementById('activeKeys').textContent = active;
        document.getElementById('usedKeys').textContent = used;
        document.getElementById('totalValue').textContent = totalValue.toFixed(2) + ' ر.س';
    }
    function updateAmountFilter() {
        const amounts = [...new Set(allKeys.map(k => k.amount))].sort((a, b) => a - b);
        const filter = document.getElementById('amountFilter');
        filter.innerHTML = '<option value="all">جميع القيم</option>';
        amounts.forEach(a => {
            filter.innerHTML += `<option value="${a}">${a} ر.س</option>`;
        });
    }
    function renderKeys() {
        const tbody = document.getElementById('keysTable');
        const statusFilter = document.getElementById('statusFilter').value;
        const amountFilter = document.getElementById('amountFilter').value;
        const search = document.getElementById('searchInput').value.toLowerCase();
        let filtered = allKeys.filter(k => {
            if (statusFilter === 'active' && k.used) return false;
            if (statusFilter === 'used' && !k.used) return false;
            if (amountFilter !== 'all' && k.amount != amountFilter) return false;
            if (search && !(k.key || '').toLowerCase().includes(search)) return false;
            return true;
        });
        document.getElementById('keysCountLabel').textContent = `${filtered.length} كرت`;
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--muted);">لا يوجد كروت</td></tr>';
            return;
        }
        tbody.innerHTML = filtered.map(k => {
            const statusBadge = k.used
                ? '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(100,100,100,0.3); color: var(--muted);"> مستخدم</span>'
                : '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(0,184,148,0.2); color: var(--success);"> نشط</span>';
            const date = k.created_at ? new Date(k.created_at).toLocaleDateString('ar-SA') : '-';
            return `
                <tr style="${k.used ? 'opacity: 0.6;' : ''}">
                    <td>
                        <code style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 6px; font-size: 12px;">${k.key || '-'}</code>
                        ${!k.used ? `<button onclick="copyKey('${k.key}')" style="background: none; border: none; cursor: pointer; margin-right: 5px;"></button>` : ''}
                    </td>
                    <td style="color: var(--success); font-weight: 600;">${k.amount || 0} ر.س</td>
                    <td>${statusBadge}</td>
                    <td style="font-size: 12px; color: var(--muted);">${date}</td>
                    <td style="font-size: 12px; color: var(--muted);">${k.used_by || '-'}</td>
                    <td>
                        ${!k.used ? `<button class="btn btn-danger btn-sm" onclick="deleteKey('${k.id}')"></button>` : ''}
                    </td>
                </tr>
            `;
        }).join('');
    }
    function showGenerateModal() {
        document.getElementById('generateModal').style.display = 'block';
        document.getElementById('generatedResult').style.display = 'none';
    }
    function closeModal() {
        document.getElementById('generateModal').style.display = 'none';
    }
    async function generateKeys() {
        const amount = parseFloat(document.getElementById('keyAmount').value);
        const count = parseInt(document.getElementById('keyCount').value);
        if (!amount || amount <= 0 || !count || count <= 0 || count > 100) {
            showToast('قيم غير صالحة', 'error');
            return;
        }
        try {
            const res = await fetch('/api/generate_keys', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount, count })
            });
            const data = await res.json();
            if (data.success || data.status === 'success') {
                const keys = data.keys || [];
                generatedKeysText = keys.join('\n');
                document.getElementById('generatedKeys').innerHTML = keys.map(k => 
                    `<div style="padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.1);">${k}</div>`
                ).join('');
                document.getElementById('generatedResult').style.display = 'block';
                showToast(` تم إنشاء ${keys.length} كرت`);
                loadKeys();
            } else {
                showToast(data.message || 'حدث خطأ', 'error');
            }
        } catch (e) {
            showToast('خطأ في الاتصال', 'error');
        }
    }
    function copyKeys() {
        navigator.clipboard.writeText(generatedKeysText).then(() => {
            showToast(' تم نسخ الكروت');
        });
    }
    function copyKey(key) {
        navigator.clipboard.writeText(key).then(() => {
            showToast(' تم نسخ الكود');
        });
    }
    async function deleteKey(keyId) {
        if (!confirm('هل تريد حذف هذا الكرت؟')) return;
        try {
            const res = await fetch('/api/admin/delete_charge_key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key_id: keyId })
            });
            const data = await res.json();
            if (data.status === 'success') {
                showToast(' تم الحذف');
                loadKeys();
            } else {
                showToast(data.message || 'حدث خطأ', 'error');
            }
        } catch (e) {
            showToast('خطأ في الاتصال', 'error');
        }
    }
    document.getElementById('statusFilter').addEventListener('change', renderKeys);
    document.getElementById('amountFilter').addEventListener('change', renderKeys);
    document.getElementById('searchInput').addEventListener('input', renderKeys);
    loadKeys();
</script>
{% endblock %}
