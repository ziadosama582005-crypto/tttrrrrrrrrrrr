{% extends "base.html" %}
{% block title %}Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚{% endblock %}
{% block extra_css %}
<style>
:root {
    --accent: #00ff88;
    --accent-dim: rgba(0,255,136,0.12);
    --bg-card: rgba(17,17,30,0.85);
    --bg-card2: rgba(24,24,42,0.9);
    --border: rgba(255,255,255,0.06);
    --text1: #f0f0f5;
    --text2: #8b8ba3;
    --text3: #5a5a72;
    --danger: #ef4444;
    --warning: #f59e0b;
    --radius: 16px;
    --radius-sm: 10px;
}

body { padding-bottom: 100px; }

/* ===== Ø§Ù„ØµÙØ­Ø© ===== */
.cart-page {
    min-height: 100vh;
    padding: 16px;
}

.cart-container {
    max-width: 600px;
    margin: 0 auto;
}

/* ===== Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¤Ù‚Øª ===== */
.timer-strip {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 10px 16px;
    background: linear-gradient(135deg, rgba(245,158,11,0.12), rgba(239,68,68,0.08));
    border: 1px solid rgba(245,158,11,0.2);
    border-radius: var(--radius-sm);
    margin-bottom: 14px;
}

.timer-strip.show { display: flex; }

.timer-strip i {
    color: var(--warning);
    font-size: 15px;
    animation: pulse-icon 1.5s ease infinite;
}

@keyframes pulse-icon {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

.timer-label {
    color: var(--text2);
    font-size: 13px;
}

.timer-digits {
    font-size: 18px;
    font-weight: 800;
    color: var(--danger);
    font-variant-numeric: tabular-nums;
    min-width: 50px;
    text-align: center;
    letter-spacing: 1px;
}

.timer-strip.urgent {
    border-color: rgba(239,68,68,0.3);
    background: linear-gradient(135deg, rgba(239,68,68,0.12), rgba(239,68,68,0.06));
}

.timer-strip.urgent .timer-digits {
    animation: pulse-icon 0.5s ease infinite;
}

/* ===== Ø§Ù„ØªØ­Ù…ÙŠÙ„ ===== */
.cart-loading {
    text-align: center;
    padding: 60px 20px;
    color: var(--text3);
}

.cart-loading .spinner {
    width: 36px; height: 36px;
    border: 3px solid rgba(0,255,136,0.15);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
}

@keyframes spin { to { transform: rotate(360deg); } }

.cart-loading p {
    font-size: 14px;
    color: var(--text3);
}

/* ===== Ø§Ù„Ø³Ù„Ø© Ø§Ù„ÙØ§Ø±ØºØ© ===== */
.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-icon {
    font-size: 56px;
    margin-bottom: 16px;
    opacity: 0.6;
}

.empty-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text1);
    margin-bottom: 6px;
}

.empty-desc {
    font-size: 13px;
    color: var(--text3);
    margin-bottom: 24px;
}

.shop-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 28px;
    background: var(--accent);
    color: #000;
    text-decoration: none;
    border-radius: 10px;
    font-weight: 700;
    font-size: 14px;
    transition: all 0.2s;
}

.shop-link:hover {
    filter: brightness(1.1);
    transform: translateY(-2px);
}

/* ===== Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… ===== */
.cart-section-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
}

.cart-section-head h2 {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
    font-weight: 700;
    color: var(--text1);
    margin: 0;
}

.cart-section-head h2 i {
    color: var(--accent);
    font-size: 14px;
}

.items-count {
    font-size: 12px;
    color: var(--text3);
    background: rgba(255,255,255,0.04);
    padding: 3px 10px;
    border-radius: 12px;
}

/* ===== Ø¹Ù†ØµØ± Ø§Ù„Ø³Ù„Ø© ===== */
.cart-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-bottom: 8px;
    position: relative;
    transition: all 0.2s;
}

.cart-item:hover {
    border-color: rgba(255,255,255,0.1);
}

.cart-item.sold-item {
    opacity: 0.45;
    border-color: rgba(239,68,68,0.2);
}

.cart-item.price-changed-item {
    border-color: rgba(245,158,11,0.25);
}

.item-thumb {
    width: 52px; height: 52px;
    border-radius: 10px;
    background: rgba(99,102,241,0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    flex-shrink: 0;
    overflow: hidden;
}

.item-thumb img {
    width: 100%; height: 100%;
    object-fit: cover;
    border-radius: 10px;
}

.item-body {
    flex: 1;
    min-width: 0;
}

.item-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text1);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 3px;
}

.item-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.item-cat {
    font-size: 11px;
    color: var(--text3);
}

.item-badge {
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 4px;
    font-weight: 600;
}

.badge-ok {
    background: var(--accent-dim);
    color: var(--accent);
}

.badge-sold {
    background: rgba(239,68,68,0.12);
    color: var(--danger);
}

.badge-price {
    background: rgba(245,158,11,0.12);
    color: var(--warning);
}

.badge-manual {
    background: rgba(245,158,11,0.1);
    color: var(--warning);
}

.item-price-col {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 6px;
    flex-shrink: 0;
}

.item-price {
    font-size: 15px;
    font-weight: 800;
    color: var(--accent);
}

.item-del {
    width: 30px; height: 30px;
    border-radius: 8px;
    border: none;
    background: rgba(239,68,68,0.08);
    color: var(--danger);
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.item-del:hover {
    background: var(--danger);
    color: #fff;
}

/* ===== Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨ ===== */
.order-summary {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-top: 16px;
}

.summary-head {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
}

.summary-head i {
    color: var(--accent);
    font-size: 14px;
}

.summary-head h3 {
    font-size: 15px;
    font-weight: 700;
    color: var(--text1);
    margin: 0;
}

.summary-rows {
    display: flex;
    flex-direction: column;
    gap: 0;
}

.s-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
}

.s-row:last-child { border-bottom: none; }

.s-label { color: var(--text2); }

.s-value {
    font-weight: 600;
    color: var(--text1);
}

.s-row.total-row {
    padding-top: 14px;
    margin-top: 4px;
    border-top: 2px solid rgba(0,255,136,0.15);
    border-bottom: none;
}

.s-row.total-row .s-label {
    font-size: 14px;
    font-weight: 700;
    color: var(--text1);
}

.s-row.total-row .s-value {
    font-size: 20px;
    font-weight: 800;
    color: var(--accent);
}

/* ===== Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯ ===== */
.balance-strip {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    background: rgba(0,255,136,0.04);
    border: 1px solid rgba(0,255,136,0.1);
    border-radius: var(--radius-sm);
    margin-top: 14px;
}

.bal-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.bal-label {
    font-size: 11px;
    color: var(--text3);
}

.bal-amount {
    font-size: 20px;
    font-weight: 800;
    color: var(--accent);
}

.bal-after {
    font-size: 11px;
    color: var(--text3);
}

.bal-after span {
    color: var(--text2);
    font-weight: 600;
}

/* ===== Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ===== */
.alert-box {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-weight: 500;
    margin-top: 12px;
}

.alert-danger {
    background: rgba(239,68,68,0.08);
    border: 1px solid rgba(239,68,68,0.15);
    color: var(--danger);
}

.alert-warning {
    background: rgba(245,158,11,0.08);
    border: 1px solid rgba(245,158,11,0.15);
    color: var(--warning);
}

.charge-link {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    background: rgba(99,102,241,0.1);
    border: 1px solid rgba(99,102,241,0.2);
    border-radius: var(--radius-sm);
    color: #818cf8;
    text-decoration: none;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
}

.charge-link:hover {
    background: rgba(99,102,241,0.18);
}

/* ===== Ø²Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ===== */
.checkout-btn {
    width: 100%;
    padding: 16px;
    margin-top: 16px;
    background: var(--accent);
    border: none;
    border-radius: var(--radius-sm);
    color: #000;
    font-family: inherit;
    font-size: 16px;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.checkout-btn:hover:not(:disabled) {
    filter: brightness(1.1);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,255,136,0.2);
}

.checkout-btn:disabled {
    background: rgba(255,255,255,0.06);
    color: var(--text3);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* ===== Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª ===== */
.c-modal {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(4px);
    z-index: 1100;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.c-modal.show { display: flex; }

.c-modal-box {
    background: #13132a;
    border: 1px solid var(--border);
    border-radius: 20px;
    width: 100%; max-width: 400px;
    padding: 28px 24px 24px;
    text-align: center;
    animation: modal-in 0.25s ease;
}

@keyframes modal-in {
    from { opacity: 0; transform: scale(0.95) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

.c-modal-icon {
    font-size: 48px;
    margin-bottom: 12px;
}

.c-modal-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text1);
    margin-bottom: 6px;
}

.c-modal-desc {
    font-size: 13px;
    color: var(--text3);
    margin-bottom: 18px;
}

.c-modal-items {
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    padding: 12px 14px;
    margin-bottom: 14px;
    text-align: right;
    max-height: 180px;
    overflow-y: auto;
}

.c-modal-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    color: var(--text2);
}

.c-modal-row:last-child { border-bottom: none; }

.c-modal-total {
    font-size: 17px;
    font-weight: 800;
    color: var(--accent);
    padding-top: 10px;
    margin-top: 6px;
    border-top: 1px solid rgba(0,255,136,0.15);
}

.c-modal-btns {
    display: flex;
    gap: 10px;
    margin-top: 16px;
}

.c-btn {
    flex: 1;
    padding: 13px;
    border-radius: var(--radius-sm);
    border: none;
    font-family: inherit;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
}

.c-btn-confirm {
    background: var(--accent);
    color: #000;
}

.c-btn-confirm:hover {
    filter: brightness(1.1);
}

.c-btn-cancel {
    background: rgba(255,255,255,0.06);
    color: var(--text2);
}

.c-btn-cancel:hover {
    background: rgba(255,255,255,0.1);
}

/* ===== Toast ===== */
.cart-toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    padding: 10px 24px;
    border-radius: 24px;
    font-size: 13px;
    font-weight: 600;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s;
    z-index: 2000;
    color: #000;
    background: var(--accent);
}

.cart-toast.error {
    background: var(--danger);
    color: #fff;
}

.cart-toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

/* ===== Responsive ===== */
@media (max-width: 500px) {
    .cart-page { padding: 12px; }
    .item-thumb { width: 44px; height: 44px; font-size: 18px; }
    .item-name { font-size: 13px; }
    .item-price { font-size: 14px; }
    .order-summary { padding: 16px; }
    .bal-amount { font-size: 18px; }
}
</style>
{% endblock %}

{% block content %}
<div class="cart-page">
    <div class="cart-container">

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¤Ù‚Øª -->
        <div class="timer-strip" id="timerStrip">
            <i class="fas fa-clock"></i>
            <span class="timer-label">ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø­Ø¬Ø² Ø®Ù„Ø§Ù„</span>
            <span class="timer-digits" id="timerDigits">--:--</span>
        </div>

        <!-- Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <div class="cart-loading" id="loadingDiv">
            <div class="spinner"></div>
            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù„Ø©...</p>
        </div>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
        <div id="cartContent" style="display:none;"></div>

    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡ -->
<div class="c-modal" id="confirmModal">
    <div class="c-modal-box">
        <div class="c-modal-icon">ğŸ›ï¸</div>
        <div class="c-modal-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡</div>
        <div class="c-modal-desc">Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø±ØµÙŠØ¯Ùƒ</div>
        <div class="c-modal-items" id="modalItems"></div>
        <div class="c-modal-total" id="modalTotal"></div>
        <div class="c-modal-btns">
            <button class="c-btn c-btn-confirm" onclick="processCheckout()"><i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯</button>
            <button class="c-btn c-btn-cancel" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­ -->
<div class="c-modal" id="successModal">
    <div class="c-modal-box">
        <div class="c-modal-icon">ğŸ‰</div>
        <div class="c-modal-title">ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!</div>
        <div class="c-modal-desc" id="successText"></div>
        <button class="c-btn c-btn-confirm" onclick="window.location.href='/my_purchases'" style="width:100%;margin-top:12px;">
            <i class="fas fa-box"></i> Ø¹Ø±Ø¶ Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ
        </button>
    </div>
</div>

<!-- Toast -->
<div class="cart-toast" id="cartToast"></div>

{% endblock %}

{% block extra_js %}
<script>
const userId = '{{ user_id }}';
const userBalance = parseFloat('{{ balance }}') || 0;
let cartData = null;
let countdownInterval = null;
let isLoadingCart = false;

function showToast(msg, type) {
    const t = document.getElementById('cartToast');
    t.textContent = msg;
    t.className = 'cart-toast ' + (type || '');
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2200);
}

async function loadCart() {
    if (isLoadingCart) return;
    isLoadingCart = true;

    if (!userId || userId === '' || userId === 'None') {
        document.getElementById('loadingDiv').style.display = 'none';
        document.getElementById('cartContent').innerHTML = renderAuthRequired();
        document.getElementById('cartContent').style.display = 'block';
        isLoadingCart = false;
        return;
    }

    try {
        const res = await fetch('/api/cart/get');
        const data = await res.json();
        document.getElementById('loadingDiv').style.display = 'none';
        document.getElementById('cartContent').style.display = 'block';

        if (data.status === 'success') {
            cartData = data.cart;
            renderCart();
            startCountdown(data.cart.expires_at);
        } else {
            if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
            renderEmpty();
        }
    } catch (e) {
        document.getElementById('loadingDiv').style.display = 'none';
        document.getElementById('cartContent').innerHTML = renderError();
        document.getElementById('cartContent').style.display = 'block';
    } finally {
        isLoadingCart = false;
    }
}

function renderAuthRequired() {
    return '<div class="empty-state">' +
        '<div class="empty-icon">ğŸ”’</div>' +
        '<div class="empty-title">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>' +
        '<div class="empty-desc">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø¹Ø±Ø¶ Ø³Ù„ØªÙƒ</div>' +
        '<a href="/login" class="shop-link"><i class="fas fa-right-to-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></div>';
}

function renderError() {
    return '<div class="empty-state">' +
        '<div class="empty-icon">âš ï¸</div>' +
        '<div class="empty-title">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>' +
        '<div class="empty-desc">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ù„Ø©</div>' +
        '<a href="/cart" class="shop-link"><i class="fas fa-rotate-right"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</a></div>';
}

function renderCart() {
    const el = document.getElementById('cartContent');
    if (!cartData || !cartData.items || !cartData.items.length) { renderEmpty(); return; }

    let total = 0, available = 0, hasSold = false;
    let itemsHtml = '';

    cartData.items.forEach(function(item) {
        const sold = item.sold;
        const priceChanged = item.price_changed;
        const price = item.current_price || item.price;
        const isManual = item.delivery_type === 'manual';
        let cls = sold ? 'sold-item' : (priceChanged ? 'price-changed-item' : '');

        if (!sold) { total += price; available++; } else { hasSold = true; }

        let badge = sold
            ? '<span class="item-badge badge-sold">Ù†ÙØ¯</span>'
            : (priceChanged
                ? '<span class="item-badge badge-price">ØªØºÙŠÙ‘Ø± Ø§Ù„Ø³Ø¹Ø±</span>'
                : '<span class="item-badge badge-ok">Ù…ØªØ§Ø­</span>');

        if (isManual && !sold) badge += ' <span class="item-badge badge-manual">ÙŠØ¯ÙˆÙŠ</span>';

        itemsHtml += '<div class="cart-item ' + cls + '">' +
            '<div class="item-thumb">' +
                (item.image_url ? '<img src="' + item.image_url + '" onerror="this.parentElement.innerHTML=\'ğŸ›’\'">' : 'ğŸ›’') +
            '</div>' +
            '<div class="item-body">' +
                '<div class="item-name">' + item.name + '</div>' +
                '<div class="item-meta">' +
                    '<span class="item-cat">' + (item.category || 'Ø¹Ø§Ù…') + '</span>' +
                    badge +
                '</div>' +
            '</div>' +
            '<div class="item-price-col">' +
                '<span class="item-price">' + price.toFixed(2) + ' Ø±.Ø³</span>' +
                '<button class="item-del" onclick="removeItem(\'' + item.product_id + '\')" title="Ø­Ø°Ù">' +
                    '<i class="fas fa-trash-can"></i>' +
                '</button>' +
            '</div>' +
        '</div>';
    });

    const after = userBalance - total;
    const canBuy = after >= 0 && available > 0;

    let alertsHtml = '';
    if (after < 0) {
        alertsHtml += '<div class="alert-box alert-danger">' +
            '<i class="fas fa-circle-exclamation"></i>' +
            'Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ â€” ØªØ­ØªØ§Ø¬ ' + Math.abs(after).toFixed(2) + ' Ø±.Ø³ Ø¥Ø¶Ø§ÙÙŠØ©</div>' +
            '<a href="/wallet" class="charge-link"><i class="fas fa-wallet"></i> Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</a>';
    }
    if (hasSold) {
        alertsHtml += '<div class="alert-box alert-warning">' +
            '<i class="fas fa-triangle-exclamation"></i>' +
            'Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù†ÙØ¯Øª ÙˆØ³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡Ø§</div>';
    }

    let btnText = canBuy
        ? '<i class="fas fa-lock"></i> Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡'
        : (after < 0 ? '<i class="fas fa-wallet"></i> Ø§Ø´Ø­Ù† Ø±ØµÙŠØ¯Ùƒ Ø£ÙˆÙ„Ø§Ù‹' : '<i class="fas fa-ban"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø©');

    let html = '<div class="cart-section-head">' +
        '<h2><i class="fas fa-bag-shopping"></i> Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h2>' +
        '<span class="items-count">' + available + ' Ù…Ù†ØªØ¬</span></div>' +
        itemsHtml +
        '<div class="order-summary">' +
            '<div class="summary-head"><i class="fas fa-receipt"></i><h3>Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h3></div>' +
            '<div class="summary-rows">' +
                '<div class="s-row"><span class="s-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span><span class="s-value">' + available + '</span></div>' +
                '<div class="s-row total-row"><span class="s-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span class="s-value">' + total.toFixed(2) + ' Ø±.Ø³</span></div>' +
            '</div>' +
            '<div class="balance-strip">' +
                '<div class="bal-info"><span class="bal-label">Ø±ØµÙŠØ¯Ùƒ</span>' +
                '<span class="bal-amount">' + userBalance.toFixed(2) + ' <small style="font-size:12px;font-weight:500;">Ø±.Ø³</small></span></div>' +
                '<div class="bal-after">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span>' + after.toFixed(2) + ' Ø±.Ø³</span></div>' +
            '</div>' +
            alertsHtml +
            '<button class="checkout-btn" onclick="showConfirmModal()" ' + (!canBuy ? 'disabled' : '') + '>' + btnText + '</button>' +
        '</div>';

    el.innerHTML = html;
}

function renderEmpty() {
    document.getElementById('timerStrip').classList.remove('show');
    document.getElementById('cartContent').innerHTML =
        '<div class="empty-state">' +
        '<div class="empty-icon">ğŸ›’</div>' +
        '<div class="empty-title">Ø³Ù„ØªÙƒ ÙØ§Ø±ØºØ©</div>' +
        '<div class="empty-desc">Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ¹Ø¯ Ù„Ø§Ø­Ù‚Ø§Ù‹</div>' +
        '<a href="/" class="shop-link"><i class="fas fa-store"></i> ØªØµÙØ­ Ø§Ù„Ù…ØªØ¬Ø±</a></div>';
}

async function removeItem(productId) {
    try {
        const res = await fetch('/api/cart/remove', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ product_id: productId })
        });
        const data = await res.json();
        if (data.status === 'success') {
            showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', 'success');
            loadCart();
        } else {
            showToast(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
        }
    } catch (e) {
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
    }
}

function showConfirmModal() {
    if (!cartData || !cartData.items) return;
    const items = cartData.items.filter(function(i) { return !i.sold; });
    let total = 0, html = '';

    items.forEach(function(item) {
        const p = item.current_price || item.price;
        total += p;
        html += '<div class="c-modal-row"><span>' + item.name + '</span><span>' + p.toFixed(2) + ' Ø±.Ø³</span></div>';
    });

    document.getElementById('modalItems').innerHTML = html;
    document.getElementById('modalTotal').innerHTML = 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + total.toFixed(2) + ' Ø±.Ø³';
    document.getElementById('confirmModal').classList.add('show');
}

function closeModal() {
    document.getElementById('confirmModal').classList.remove('show');
}

async function processCheckout() {
    closeModal();
    const btn = document.querySelector('.checkout-btn');
    if (btn) { btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡...'; btn.disabled = true; }

    try {
        const res = await fetch('/api/cart/checkout', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        const data = await res.json();
        if (data.status === 'success') {
            document.getElementById('successText').innerHTML =
                'ØªÙ… Ø´Ø±Ø§Ø¡ <b>' + data.purchased_count + '</b> Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­<br>' +
                '<small style="color:var(--text3);">Ø³ØªØ¬Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ ÙˆØ±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨ÙˆØª</small>';
            document.getElementById('successModal').classList.add('show');
        } else {
            showToast(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            if (btn) { btn.innerHTML = '<i class="fas fa-lock"></i> Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡'; btn.disabled = false; }
        }
    } catch (e) {
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
        if (btn) { btn.innerHTML = '<i class="fas fa-lock"></i> Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡'; btn.disabled = false; }
    }
}

function startCountdown(expiresAt) {
    if (!expiresAt) return;
    if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }

    const strip = document.getElementById('timerStrip');
    const digits = document.getElementById('timerDigits');
    strip.classList.add('show');

    let utc = expiresAt;
    if (!expiresAt.endsWith('Z') && !expiresAt.includes('+')) utc = expiresAt + 'Z';

    function tick() {
        const diff = new Date(utc).getTime() - Date.now();
        if (diff <= 0) {
            digits.textContent = '00:00';
            strip.classList.add('urgent');
            if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
            setTimeout(function() {
                showToast('Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø­Ø¬Ø²!', 'error');
                setTimeout(function() { location.reload(); }, 1500);
            }, 500);
            return;
        }

        const m = Math.floor(diff / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        digits.textContent = String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');

        if (diff < 60000) {
            strip.classList.add('urgent');
        } else {
            strip.classList.remove('urgent');
        }
    }

    tick();
    countdownInterval = setInterval(tick, 1000);
}

window.addEventListener('DOMContentLoaded', loadCart);
window.categoriesData = [];
</script>
{% endblock %}
