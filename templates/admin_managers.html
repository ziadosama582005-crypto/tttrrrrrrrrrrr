{% extends 'admin_base.html' %}
{% block title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endblock %}
{% block content %}
<div class="top-bar">
    <h1> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</h1>
    <div class="top-bar-actions">
        <button class="btn btn-primary" onclick="openAddModal()">
            â• Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù
        </button>
    </div>
</div>
<div class="stats-grid">
    <div class="stat-card">
        <div class="icon">ğŸ‘‘</div>
        <div class="value">1</div>
        <div class="label">Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø£Ù†Øª)</div>
    </div>
    <div class="stat-card">
        <div class="icon">ğŸ‘¨â€ğŸ’¼</div>
        <div class="value" id="adminsCount">0</div>
        <div class="label">Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</div>
    </div>
</div>
<div class="card">
    <div class="card-header">
        <span class="card-title">ğŸ‘‘ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</span>
    </div>
    <div class="owner-info">
        <div class="owner-badge">
            <span class="crown">ğŸ‘‘</span>
            <div class="owner-details">
                <strong>Ø£Ù†Øª Ø§Ù„Ù…Ø§Ù„Ùƒ</strong>
                <small>ID: {{ owner_id }}</small>
            </div>
        </div>
        <div class="owner-note">
             Ø§Ù„Ù…Ø§Ù„Ùƒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°ÙÙ‡ ÙˆÙŠÙ…Ù„Ùƒ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        </div>
    </div>
</div>
<div class="card">
    <div class="card-header">
        <span class="card-title">ğŸ‘¨â€ğŸ’¼ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</span>
        <button class="btn btn-sm btn-secondary" onclick="loadAdmins()"> ØªØ­Ø¯ÙŠØ«</button>
    </div>
    <div id="adminsList">
        <div class="loading">
            <div class="spinner"></div>
        </div>
    </div>
</div>
<div class="modal-overlay" id="addModal" onclick="closeAddModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù Ø¬Ø¯ÙŠØ¯</h3>
            <button class="close-btn" onclick="closeAddModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ğŸ†” Telegram ID</label>
                <input type="text" id="newAdminId" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…" class="form-control">
                <small class="hint">ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù€ ID Ù…Ù† Ø®Ù„Ø§Ù„ @userinfobot</small>
            </div>
            <div class="form-group">
                <label> Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="text" id="newAdminName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯" class="form-control">
            </div>
            <div class="form-group">
                <label> Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <textarea id="newAdminNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±Ù..." class="form-control"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn btn-primary" onclick="addAdmin()">â• Ø¥Ø¶Ø§ÙØ©</button>
        </div>
    </div>
</div>
<style>
    .owner-info {
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.1));
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 12px;
        padding: 20px;
    }
    .owner-badge {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
    }
    .owner-badge .crown {
        font-size: 40px;
    }
    .owner-details strong {
        display: block;
        font-size: 16px;
        color: #ffd700;
    }
    .owner-details small {
        color: rgba(255, 255, 255, 0.6);
    }
    .owner-note {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.7);
        padding: 10px;
        background: rgba(0,0,0,0.2);
        border-radius: 8px;
    }
    .admin-card {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(108, 92, 231, 0.2);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
    }
    .admin-card:hover {
        border-color: var(--primary);
        background: rgba(108, 92, 231, 0.1);
    }
    .admin-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .admin-avatar {
        width: 50px;
        height: 50px;
        background: var(--primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    .admin-details h4 {
        margin: 0 0 5px;
        font-size: 15px;
    }
    .admin-details small {
        color: var(--muted);
        font-size: 12px;
    }
    .admin-meta {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    .admin-meta .date {
        font-size: 12px;
        color: var(--muted);
    }
    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--muted);
    }
    .empty-state .icon {
        font-size: 50px;
        margin-bottom: 15px;
    }
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }
    .modal-overlay.show {
        display: flex;
    }
    .modal-content {
        background: var(--card);
        border-radius: 16px;
        width: 90%;
        max-width: 450px;
        border: 1px solid rgba(108, 92, 231, 0.3);
        animation: modalIn 0.3s ease;
    }
    @keyframes modalIn {
        from {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .modal-header h3 {
        margin: 0;
        font-size: 18px;
    }
    .close-btn {
        background: none;
        border: none;
        color: var(--muted);
        font-size: 28px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }
    .modal-body {
        padding: 20px;
    }
    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid rgba(255,255,255,0.1);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 14px;
    }
    .form-control {
        width: 100%;
        padding: 12px 15px;
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 10px;
        color: white;
        font-family: 'Tajawal', sans-serif;
        font-size: 14px;
    }
    .form-control:focus {
        outline: none;
        border-color: var(--primary);
    }
    .form-control::placeholder {
        color: rgba(255,255,255,0.4);
    }
    textarea.form-control {
        min-height: 80px;
        resize: vertical;
    }
    .hint {
        display: block;
        margin-top: 5px;
        color: var(--muted);
        font-size: 11px;
    }
</style>
{% endblock %}
{% block extra_js %}
<script>
    let admins = [];
    async function loadAdmins() {
        const container = document.getElementById('adminsList');
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        try {
            const res = await fetch('/api/admin/managers/list');
            const data = await res.json();
            if (data.status === 'success') {
                admins = data.admins || [];
                document.getElementById('adminsCount').textContent = admins.length;
                renderAdmins();
            } else {
                container.innerHTML = '<div class="empty-state"><div class="icon"></div><p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p></div>';
            }
        } catch (e) {
            container.innerHTML = '<div class="empty-state"><div class="icon"></div><p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</p></div>';
        }
    }
    function renderAdmins() {
        const container = document.getElementById('adminsList');
        if (admins.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="icon"></div>
                    <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø±ÙÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    <small>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù" Ù„Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…Ø´Ø±Ù</small>
                </div>
            `;
            return;
        }
        let html = '';
        admins.forEach(admin => {
            const date = admin.added_at ? new Date(admin.added_at).toLocaleDateString('ar-SA') : '-';
            html += `
                <div class="admin-card">
                    <div class="admin-info">
                        <div class="admin-avatar">ğŸ‘¨â€ğŸ’¼</div>
                        <div class="admin-details">
                            <h4>${admin.name || 'Ù…Ø´Ø±Ù'}</h4>
                            <small>ğŸ†” ${admin.telegram_id}</small>
                            ${admin.note ? `<br><small> ${admin.note}</small>` : ''}
                        </div>
                    </div>
                    <div class="admin-meta">
                        <span class="date"> ${date}</span>
                        <button class="btn btn-sm btn-danger" onclick="deleteAdmin('${admin.id}', '${admin.name || admin.telegram_id}')">
                             Ø­Ø°Ù
                        </button>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }
    function openAddModal() {
        document.getElementById('addModal').classList.add('show');
        document.getElementById('newAdminId').focus();
    }
    function closeAddModal(e) {
        if (e && e.target !== e.currentTarget) return;
        document.getElementById('addModal').classList.remove('show');
        document.getElementById('newAdminId').value = '';
        document.getElementById('newAdminName').value = '';
        document.getElementById('newAdminNote').value = '';
    }
    async function addAdmin() {
        const telegramId = document.getElementById('newAdminId').value.trim();
        const name = document.getElementById('newAdminName').value.trim();
        const note = document.getElementById('newAdminNote').value.trim();
        if (!telegramId) {
            showToast('Ø£Ø¯Ø®Ù„ Telegram ID', 'error');
            return;
        }
        if (!/^\d+$/.test(telegramId)) {
            showToast('ID ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·', 'error');
            return;
        }
        try {
            const res = await fetch('/api/admin/managers/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: telegramId, name, note })
            });
            const data = await res.json();
            if (data.status === 'success') {
                showToast(' ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
                closeAddModal();
                loadAdmins();
            } else {
                showToast(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            }
        } catch (e) {
            showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
        }
    }
    async function deleteAdmin(id, name) {
        if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±Ù "${name}"ØŸ`)) return;
        try {
            const res = await fetch('/api/admin/managers/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_id: id })
            });
            const data = await res.json();
            if (data.status === 'success') {
                showToast(' ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±Ù', 'success');
                loadAdmins();
            } else {
                showToast(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            }
        } catch (e) {
            showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
        }
    }
    document.addEventListener('DOMContentLoaded', loadAdmins);
</script>
{% endblock %}
