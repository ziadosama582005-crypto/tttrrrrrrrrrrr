{% extends "admin/base.html" %}

{% block title %}Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©{% endblock %}
{% block page_title %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endblock %}

{% block content %}
<!-- Stats Cards Row 1 -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-box"></i>
        </div>
        <div class="stat-info">
            <h3 id="totalProducts">--</h3>
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
            <h3 id="availableProducts">--</h3>
            <p>Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø©</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon warning">
            <i class="fas fa-shopping-cart"></i>
        </div>
        <div class="stat-info">
            <h3 id="soldProducts">--</h3>
            <p>Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨Ø§Ø¹Ø©</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon secondary">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-info">
            <h3 id="totalUsers">--</h3>
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon danger">
            <i class="fas fa-coins"></i>
        </div>
        <div class="stat-info">
            <h3 id="totalRevenue">--</h3>
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-wallet"></i>
        </div>
        <div class="stat-info">
            <h3 id="totalBalance">--</h3>
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø©</p>
        </div>
    </div>
</div>

<!-- Stats Cards Row 2 -->
<div class="stats-grid" style="margin-top: 15px;">
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-folder"></i>
        </div>
        <div class="stat-info">
            <h3 id="totalCategories">--</h3>
            <p>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon warning">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-info">
            <h3 id="pendingOrders">--</h3>
            <p>Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fas fa-receipt"></i>
        </div>
        <div class="stat-info">
            <h3 id="completedOrders">--</h3>
            <p>Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fas fa-key"></i>
        </div>
        <div class="stat-info">
            <h3 id="activeKeys">--</h3>
            <p>Ù…ÙØ§ØªÙŠØ­ Ù†Ø´Ø·Ø©</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon secondary">
            <i class="fas fa-key"></i>
        </div>
        <div class="stat-info">
            <h3 id="usedKeys">--</h3>
            <p>Ù…ÙØ§ØªÙŠØ­ Ù…Ø³ØªØ®Ø¯Ù…Ø©</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-file-invoice-dollar"></i>
        </div>
        <div class="stat-info">
            <h3 id="totalInvoices">--</h3>
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</p>
        </div>
    </div>
</div>

<!-- Main Grid -->
<div class="grid-2">
    <!-- Recent Orders -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-clock"></i> Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
            <a href="/admin/orders" class="btn btn-sm btn-secondary">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="recentOrders">
                        <tr>
                            <td colspan="4" class="text-muted" style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Recent Users -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-user-plus"></i> Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
            <a href="/admin/users" class="btn btn-sm btn-secondary">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                        </tr>
                    </thead>
                    <tbody id="recentUsers">
                        <tr>
                            <td colspan="3" class="text-muted" style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card" style="margin-top: 20px;">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-bolt"></i> Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
    </div>
    <div class="card-body">
        <div class="d-flex gap-3" style="flex-wrap: wrap;">
            <a href="/admin/products" class="btn btn-primary">
                <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
            </a>
            <a href="/admin/categories" class="btn btn-secondary">
                <i class="fas fa-folder-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…
            </a>
            <a href="/admin/keys" class="btn btn-success">
                <i class="fas fa-key"></i> ØªÙˆÙ„ÙŠØ¯ Ù…ÙØ§ØªÙŠØ­
            </a>
            <a href="/admin/users" class="btn btn-secondary">
                <i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯
            </a>
        </div>
    </div>
</div>

<!-- Categories Overview -->
<div class="card" style="margin-top: 20px;">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-chart-bar"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…</h3>
    </div>
    <div class="card-body">
        <div id="categoriesChart" class="d-flex gap-3" style="flex-wrap: wrap;">
            <div class="loading"><div class="spinner"></div></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Format currency with Riyal
    function formatMoney(amount) {
        return parseFloat(amount || 0).toFixed(2) + ' Ø±ÙŠØ§Ù„';
    }
    
    // Load dashboard data
    async function loadDashboardData() {
        try {
            const response = await fetch('/api/admin/dashboard_stats');
            const data = await response.json();
            
            if (data.success) {
                const stats = data.stats;
                
                // Update stats - Row 1
                document.getElementById('totalProducts').textContent = formatNumber(stats.total_products || 0);
                document.getElementById('availableProducts').textContent = formatNumber(stats.available_products || 0);
                document.getElementById('soldProducts').textContent = formatNumber(stats.sold_products || 0);
                document.getElementById('totalUsers').textContent = formatNumber(stats.total_users || 0);
                document.getElementById('totalRevenue').textContent = formatMoney(stats.total_revenue || 0);
                document.getElementById('totalBalance').textContent = formatMoney(stats.total_balance || 0);
                
                // Update stats - Row 2
                document.getElementById('totalCategories').textContent = formatNumber(stats.total_categories || 0);
                document.getElementById('pendingOrders').textContent = formatNumber(stats.pending_orders || 0);
                document.getElementById('completedOrders').textContent = formatNumber(stats.completed_orders || 0);
                document.getElementById('activeKeys').textContent = formatNumber(stats.active_keys || 0);
                document.getElementById('usedKeys').textContent = formatNumber(stats.used_keys || 0);
                document.getElementById('totalInvoices').textContent = formatNumber(stats.total_invoices || 0);
                
                // Recent orders
                const ordersHtml = stats.recent_orders && stats.recent_orders.length > 0
                    ? stats.recent_orders.map(order => `
                        <tr>
                            <td><code>#${order.id.slice(0, 8)}...</code></td>
                            <td>${order.user_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                            <td>${formatMoney(order.total)}</td>
                            <td><span class="badge badge-${order.status === 'completed' ? 'success' : order.status === 'cancelled' ? 'danger' : 'warning'}">${order.status === 'completed' ? 'Ù…ÙƒØªÙ…Ù„' : order.status === 'cancelled' ? 'Ù…Ù„ØºÙŠ' : 'Ù…Ø¹Ù„Ù‚'}</span></td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="4" class="text-muted" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>';
                document.getElementById('recentOrders').innerHTML = ordersHtml;
                
                // Recent users
                const usersHtml = stats.recent_users && stats.recent_users.length > 0
                    ? stats.recent_users.map(user => `
                        <tr>
                            <td>${user.name || user.username || 'Ù…Ø³ØªØ®Ø¯Ù… ' + user.id}</td>
                            <td><strong class="text-primary">${formatMoney(user.balance || 0)}</strong></td>
                            <td>${user.created_at ? new Date(user.created_at * 1000).toLocaleDateString('ar') : '-'}</td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="3" class="text-muted" style="text-align: center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</td></tr>';
                document.getElementById('recentUsers').innerHTML = usersHtml;
                
                // Categories chart
                const categoriesHtml = stats.categories_with_count && stats.categories_with_count.length > 0
                    ? stats.categories_with_count.map(cat => `
                        <div class="stat-card" style="min-width: 150px; cursor: pointer;" onclick="window.location='/admin/categories'">
                            <div class="stat-icon primary">
                                <span style="font-size: 24px;">${cat.icon || 'ğŸ“¦'}</span>
                            </div>
                            <div class="stat-info">
                                <h3>${cat.count}</h3>
                                <p>${cat.name}</p>
                            </div>
                        </div>
                    `).join('')
                    : '<div class="empty-state"><i class="fas fa-folder-open"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù…</p></div>';
                document.getElementById('categoriesChart').innerHTML = categoriesHtml;
                
                // Top products
                if (stats.top_products && stats.top_products.length > 0) {
                    let topProductsHtml = '<div class="card" style="margin-top: 20px;"><div class="card-header"><h3 class="card-title"><i class="fas fa-trophy"></i> Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹</h3></div><div class="card-body"><div class="table-container"><table><thead><tr><th>#</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th></tr></thead><tbody>';
                    stats.top_products.forEach((p, i) => {
                        topProductsHtml += `<tr><td>${i + 1}</td><td>${p.name}</td><td><span class="badge badge-success">${p.sold}</span></td><td><strong class="text-primary">${formatMoney(p.revenue)}</strong></td></tr>`;
                    });
                    topProductsHtml += '</tbody></table></div></div></div>';
                    
                    // Add after categories
                    const categoriesCard = document.getElementById('categoriesChart').closest('.card');
                    if (categoriesCard && !document.getElementById('topProductsCard')) {
                        categoriesCard.insertAdjacentHTML('afterend', topProductsHtml);
                        const newCard = categoriesCard.nextElementSibling;
                        if (newCard) newCard.id = 'topProductsCard';
                    }
                }
            } else {
                console.error('API returned error:', data.message);
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }
    
    // Load on page load
    loadDashboardData();
    
    // Auto refresh every 30 seconds
    setInterval(loadDashboardData, 30000);
</script>
{% endblock %}
