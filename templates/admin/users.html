{% extends "admin/base.html" %}

{% block title %}العملاء{% endblock %}
{% block page_title %}إدارة العملاء{% endblock %}

{% block content %}
<!-- Filters -->
<div class="card">
    <div class="card-body">
        <div class="d-flex gap-3" style="flex-wrap: wrap; align-items: center;">
            <div class="form-group" style="margin: 0; flex: 1; min-width: 200px;">
                <input type="text" id="searchInput" class="form-control" placeholder="بحث بالاسم أو ID...">
            </div>
            <div class="form-group" style="margin: 0; min-width: 150px;">
                <select id="statusFilter" class="form-control">
                    <option value="">كل العملاء</option>
                    <option value="verified">موثق</option>
                    <option value="unverified">غير موثق</option>
                </select>
            </div>
            <div class="form-group" style="margin: 0; min-width: 150px;">
                <select id="balanceFilter" class="form-control">
                    <option value="">كل الأرصدة</option>
                    <option value="has_balance">لديه رصيد</option>
                    <option value="zero_balance">رصيد صفر</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Stats -->
<div class="stats-grid" style="margin-top: 20px;">
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-info">
            <h3 id="totalUsers">--</h3>
            <p>إجمالي العملاء</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fas fa-user-check"></i>
        </div>
        <div class="stat-info">
            <h3 id="verifiedUsers">--</h3>
            <p>موثقين</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon warning">
            <i class="fas fa-wallet"></i>
        </div>
        <div class="stat-info">
            <h3 id="totalBalance">--</h3>
            <p>إجمالي الأرصدة</p>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="card" style="margin-top: 20px;">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-users"></i> قائمة العملاء</h3>
        <span class="badge badge-primary" id="usersCount">0</span>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>العميل</th>
                        <th>Telegram ID</th>
                        <th>الرصيد</th>
                        <th>الطلبات</th>
                        <th>الحالة</th>
                        <th>تاريخ التسجيل</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="usersTable">
                    <tr>
                        <td colspan="7">
                            <div class="loading"><div class="spinner"></div></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Balance Modal -->
<div class="modal" id="balanceModal">
    <div class="modal-dialog" style="max-width: 450px;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إدارة الرصيد</h3>
                <button class="modal-close" onclick="closeBalanceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="userBalanceInfo" style="text-align: center; margin-bottom: 20px; padding: 15px; background: var(--dark); border-radius: 10px;">
                    <h4 id="balanceUserName">--</h4>
                    <p class="text-muted">الرصيد الحالي: <span id="currentBalance" class="text-primary">--</span></p>
                </div>
                
                <input type="hidden" id="balanceUserId">
                
                <div class="form-group">
                    <label>نوع العملية</label>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success flex-1 balance-type-btn active" data-type="add">
                            <i class="fas fa-plus"></i> إضافة
                        </button>
                        <button type="button" class="btn btn-danger flex-1 balance-type-btn" data-type="subtract">
                            <i class="fas fa-minus"></i> خصم
                        </button>
                    </div>
                    <input type="hidden" id="balanceType" value="add">
                </div>
                
                <div class="form-group">
                    <label>المبلغ</label>
                    <input type="number" id="balanceAmount" class="form-control" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label>السبب (اختياري)</label>
                    <input type="text" id="balanceReason" class="form-control" placeholder="سبب التعديل...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBalanceModal()">إلغاء</button>
                <button class="btn btn-primary" onclick="updateBalance()">
                    <i class="fas fa-save"></i> تأكيد
                </button>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal" id="userModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تفاصيل العميل</h3>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-body" id="userDetails">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUserModal()">إغلاق</button>
            </div>
        </div>
    </div>
</div>

<style>
    .balance-type-btn {
        opacity: 0.6;
    }
    .balance-type-btn.active {
        opacity: 1;
    }
    .flex-1 {
        flex: 1;
    }
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    let users = [];
    
    // Load users
    async function loadUsers() {
        try {
            const response = await fetch('/api/admin/users');
            const data = await response.json();
            
            if (data.success) {
                users = data.users || [];
                updateStats();
                renderUsers();
            }
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }
    
    // Update stats
    function updateStats() {
        const total = users.length;
        const verified = users.filter(u => u.verified || u.email_verified).length;
        const totalBalance = users.reduce((sum, u) => sum + (parseFloat(u.balance) || 0), 0);
        
        document.getElementById('totalUsers').textContent = formatNumber(total);
        document.getElementById('verifiedUsers').textContent = formatNumber(verified);
        document.getElementById('totalBalance').textContent = formatCurrency(totalBalance);
    }
    
    // Render users
    function renderUsers() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const balance = document.getElementById('balanceFilter').value;
        
        let filtered = users.filter(u => {
            const matchSearch = !search || 
                (u.name && u.name.toLowerCase().includes(search)) ||
                (u.username && u.username.toLowerCase().includes(search)) ||
                (u.telegram_id && u.telegram_id.toString().includes(search));
            
            const matchStatus = !status ||
                (status === 'verified' && (u.verified || u.email_verified)) ||
                (status === 'unverified' && !u.verified && !u.email_verified);
            
            const matchBalance = !balance ||
                (balance === 'has_balance' && u.balance > 0) ||
                (balance === 'zero_balance' && (!u.balance || u.balance === 0));
            
            return matchSearch && matchStatus && matchBalance;
        });
        
        document.getElementById('usersCount').textContent = filtered.length;
        
        if (filtered.length === 0) {
            document.getElementById('usersTable').innerHTML = `
                <tr><td colspan="7" class="text-muted" style="text-align: center;">لا يوجد عملاء</td></tr>
            `;
            return;
        }
        
        const html = filtered.map(u => {
            const name = u.name || u.username || u.first_name || 'مستخدم';
            const initial = name.charAt(0).toUpperCase();
            const isVerified = u.verified || u.email_verified;
            
            return `
                <tr>
                    <td>
                        <div class="d-flex gap-2" style="align-items: center;">
                            <div class="user-avatar">${initial}</div>
                            <div>
                                <strong>${name}</strong>
                                ${u.username ? `<br><small class="text-muted">@${u.username}</small>` : ''}
                            </div>
                        </div>
                    </td>
                    <td><code>${u.telegram_id || u.id}</code></td>
                    <td><strong class="text-primary">${formatCurrency(u.balance || 0)}</strong></td>
                    <td><span class="badge badge-secondary">${u.orders_count || 0}</span></td>
                    <td>
                        ${isVerified 
                            ? '<span class="badge badge-success"><i class="fas fa-check"></i> موثق</span>' 
                            : '<span class="badge badge-warning">غير موثق</span>'}
                        ${u.totp_enabled ? '<span class="badge badge-primary"><i class="fas fa-shield-alt"></i></span>' : ''}
                    </td>
                    <td>${u.created_at ? new Date(u.created_at * 1000).toLocaleDateString('ar') : '-'}</td>
                    <td>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-success" onclick="openBalanceModal('${u.id}')">
                                <i class="fas fa-wallet"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="viewUser('${u.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('usersTable').innerHTML = html;
    }
    
    // Open balance modal
    function openBalanceModal(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        const name = user.name || user.username || user.first_name || 'مستخدم';
        document.getElementById('balanceUserName').textContent = name;
        document.getElementById('currentBalance').textContent = formatCurrency(user.balance || 0);
        document.getElementById('balanceUserId').value = userId;
        document.getElementById('balanceAmount').value = '';
        document.getElementById('balanceReason').value = '';
        
        // Reset type buttons
        document.querySelectorAll('.balance-type-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.type === 'add');
        });
        document.getElementById('balanceType').value = 'add';
        
        document.getElementById('balanceModal').classList.add('active');
    }
    
    function closeBalanceModal() {
        document.getElementById('balanceModal').classList.remove('active');
    }
    
    // Balance type toggle
    document.querySelectorAll('.balance-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.balance-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('balanceType').value = btn.dataset.type;
        });
    });
    
    // Update balance
    async function updateBalance() {
        const userId = document.getElementById('balanceUserId').value;
        const type = document.getElementById('balanceType').value;
        const amount = parseFloat(document.getElementById('balanceAmount').value);
        const reason = document.getElementById('balanceReason').value;
        
        if (!amount || amount <= 0) {
            showAlert('danger', 'يرجى إدخال مبلغ صحيح');
            return;
        }
        
        try {
            const response = await fetch('/api/admin/users/balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    type: type,
                    amount: amount,
                    reason: reason
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('success', type === 'add' ? 'تم إضافة الرصيد بنجاح' : 'تم خصم الرصيد بنجاح');
                closeBalanceModal();
                loadUsers();
            } else {
                showAlert('danger', result.message || 'حدث خطأ');
            }
        } catch (error) {
            showAlert('danger', 'حدث خطأ في الاتصال');
        }
    }
    
    // View user
    function viewUser(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        const name = user.name || user.username || user.first_name || 'مستخدم';
        const isVerified = user.verified || user.email_verified;
        
        document.getElementById('userDetails').innerHTML = `
            <div style="text-align: center; margin-bottom: 20px;">
                <div class="user-avatar" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto 10px;">${name.charAt(0).toUpperCase()}</div>
                <h3>${name}</h3>
                ${user.username ? `<p class="text-muted">@${user.username}</p>` : ''}
            </div>
            
            <div class="d-flex gap-3 mb-3" style="justify-content: center;">
                ${isVerified ? '<span class="badge badge-success"><i class="fas fa-check"></i> موثق</span>' : '<span class="badge badge-warning">غير موثق</span>'}
                ${user.totp_enabled ? '<span class="badge badge-primary"><i class="fas fa-shield-alt"></i> 2FA</span>' : ''}
            </div>
            
            <div class="form-group">
                <label>Telegram ID</label>
                <p><code>${user.telegram_id || user.id}</code></p>
            </div>
            
            <div class="d-flex gap-3">
                <div class="form-group" style="flex: 1;">
                    <label>الرصيد</label>
                    <p class="text-primary" style="font-size: 24px; font-weight: bold;">${formatCurrency(user.balance || 0)}</p>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>الطلبات</label>
                    <p style="font-size: 24px; font-weight: bold;">${user.orders_count || 0}</p>
                </div>
            </div>
            
            ${user.email ? `
                <div class="form-group">
                    <label>البريد الإلكتروني</label>
                    <p>${user.email} ${user.email_verified ? '<span class="badge badge-success">موثق</span>' : ''}</p>
                </div>
            ` : ''}
            
            <div class="form-group">
                <label>تاريخ التسجيل</label>
                <p>${user.created_at ? new Date(user.created_at * 1000).toLocaleString('ar') : '-'}</p>
            </div>
        `;
        
        document.getElementById('userModal').classList.add('active');
    }
    
    function closeUserModal() {
        document.getElementById('userModal').classList.remove('active');
    }
    
    // Event listeners
    document.getElementById('searchInput').addEventListener('input', renderUsers);
    document.getElementById('statusFilter').addEventListener('change', renderUsers);
    document.getElementById('balanceFilter').addEventListener('change', renderUsers);
    
    // Load on page load
    loadUsers();
</script>
{% endblock %}
