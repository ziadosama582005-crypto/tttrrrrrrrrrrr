{% extends "admin/base.html" %}

{% block title %}المنتجات{% endblock %}
{% block page_title %}إدارة المنتجات{% endblock %}

{% block content %}
<!-- Filters -->
<div class="card">
    <div class="card-body">
        <div class="d-flex gap-3" style="flex-wrap: wrap; align-items: center;">
            <div class="form-group" style="margin: 0; flex: 1; min-width: 200px;">
                <input type="text" id="searchInput" class="form-control" placeholder="بحث عن منتج...">
            </div>
            <div class="form-group" style="margin: 0; min-width: 150px;">
                <select id="categoryFilter" class="form-control">
                    <option value="">كل الأقسام</option>
                </select>
            </div>
            <div class="form-group" style="margin: 0; min-width: 150px;">
                <select id="statusFilter" class="form-control">
                    <option value="">كل الحالات</option>
                    <option value="available">متاح</option>
                    <option value="sold">مباع</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="openAddModal()">
                <i class="fas fa-plus"></i> إضافة منتج
            </button>
        </div>
    </div>
</div>

<!-- Products Table -->
<div class="card" style="margin-top: 20px;">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-box"></i> قائمة المنتجات</h3>
        <span class="badge badge-primary" id="productsCount">0</span>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>المنتج</th>
                        <th>القسم</th>
                        <th>السعر</th>
                        <th>الكمية</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="productsTable">
                    <tr>
                        <td colspan="6">
                            <div class="loading"><div class="spinner"></div></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal" id="productModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">إضافة منتج جديد</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    
                    <div class="form-group">
                        <label>اسم المنتج</label>
                        <input type="text" id="productName" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label>الوصف</label>
                        <textarea id="productDesc" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>القسم</label>
                        <select id="productCategory" class="form-control" required>
                            <option value="">اختر القسم</option>
                        </select>
                    </div>
                    
                    <div class="d-flex gap-3">
                        <div class="form-group" style="flex: 1;">
                            <label>السعر</label>
                            <input type="number" id="productPrice" class="form-control" step="0.01" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>الكمية</label>
                            <input type="number" id="productQty" class="form-control" value="1" min="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>رابط الصورة (اختياري)</label>
                        <input type="url" id="productImage" class="form-control" placeholder="https://...">
                    </div>
                    
                    <div class="form-group">
                        <label>البيانات (كل سطر = وحدة)</label>
                        <textarea id="productData" class="form-control" rows="5" placeholder="account1:password1&#10;account2:password2"></textarea>
                        <small class="text-muted">أدخل البيانات، كل سطر يمثل وحدة واحدة من المنتج</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">إلغاء</button>
                <button class="btn btn-primary" onclick="saveProduct()">
                    <i class="fas fa-save"></i> حفظ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Product Modal -->
<div class="modal" id="viewModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تفاصيل المنتج</h3>
                <button class="modal-close" onclick="closeViewModal()">&times;</button>
            </div>
            <div class="modal-body" id="viewContent">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeViewModal()">إغلاق</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-dialog" style="max-width: 400px;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تأكيد الحذف</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--danger); margin-bottom: 15px;"></i>
                <p>هل أنت متأكد من حذف هذا المنتج؟</p>
                <p class="text-muted">لا يمكن التراجع عن هذا الإجراء</p>
                <input type="hidden" id="deleteProductId">
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">إلغاء</button>
                <button class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> حذف
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let products = [];
    let categories = [];
    
    // Load categories for filter
    async function loadCategories() {
        try {
            const response = await fetch('/api/categories');
            const data = await response.json();
            if (data.categories) {
                categories = data.categories;
                const filterSelect = document.getElementById('categoryFilter');
                const formSelect = document.getElementById('productCategory');
                
                categories.forEach(cat => {
                    filterSelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                    formSelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                });
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }
    
    // Load products
    async function loadProducts() {
        try {
            const response = await fetch('/api/admin/products');
            const data = await response.json();
            
            if (data.success) {
                products = data.products || [];
                renderProducts();
            }
        } catch (error) {
            console.error('Error loading products:', error);
            document.getElementById('productsTable').innerHTML = `
                <tr><td colspan="6" class="text-danger" style="text-align: center;">خطأ في تحميل المنتجات</td></tr>
            `;
        }
    }
    
    // Render products table
    function renderProducts() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const categoryId = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        let filtered = products.filter(p => {
            const matchSearch = !search || p.name.toLowerCase().includes(search);
            const matchCategory = !categoryId || p.category_id === categoryId;
            const matchStatus = !status || 
                (status === 'available' && p.available_count > 0) ||
                (status === 'sold' && p.available_count === 0);
            return matchSearch && matchCategory && matchStatus;
        });
        
        document.getElementById('productsCount').textContent = filtered.length;
        
        if (filtered.length === 0) {
            document.getElementById('productsTable').innerHTML = `
                <tr><td colspan="6" class="text-muted" style="text-align: center;">لا توجد منتجات</td></tr>
            `;
            return;
        }
        
        const html = filtered.map(p => {
            const category = categories.find(c => c.id === p.category_id);
            const statusClass = p.available_count > 0 ? 'success' : 'danger';
            const statusText = p.available_count > 0 ? 'متاح' : 'نفذ';
            
            return `
                <tr>
                    <td>
                        <div class="d-flex gap-2" style="align-items: center;">
                            ${p.image ? `<img src="${p.image}" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;">` : ''}
                            <div>
                                <strong>${p.name}</strong>
                                ${p.description ? `<br><small class="text-muted">${p.description.substring(0, 50)}...</small>` : ''}
                            </div>
                        </div>
                    </td>
                    <td>${category ? category.name : '-'}</td>
                    <td>${formatCurrency(p.price)}</td>
                    <td>
                        <span class="badge badge-${p.available_count > 0 ? 'primary' : 'danger'}">
                            ${p.available_count} / ${p.total_count || p.available_count}
                        </span>
                    </td>
                    <td><span class="badge badge-${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-secondary" onclick="viewProduct('${p.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="editProduct('${p.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('productsTable').innerHTML = html;
    }
    
    // Open add modal
    function openAddModal() {
        document.getElementById('modalTitle').textContent = 'إضافة منتج جديد';
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('productModal').classList.add('active');
    }
    
    // Close modal
    function closeModal() {
        document.getElementById('productModal').classList.remove('active');
    }
    
    // Edit product
    function editProduct(id) {
        const product = products.find(p => p.id === id);
        if (!product) return;
        
        document.getElementById('modalTitle').textContent = 'تعديل المنتج';
        document.getElementById('productId').value = id;
        document.getElementById('productName').value = product.name || '';
        document.getElementById('productDesc').value = product.description || '';
        document.getElementById('productCategory').value = product.category_id || '';
        document.getElementById('productPrice').value = product.price || '';
        document.getElementById('productQty').value = product.available_count || 1;
        document.getElementById('productImage').value = product.image || '';
        document.getElementById('productData').value = product.data ? product.data.join('\n') : '';
        
        document.getElementById('productModal').classList.add('active');
    }
    
    // View product
    function viewProduct(id) {
        const product = products.find(p => p.id === id);
        if (!product) return;
        
        const category = categories.find(c => c.id === product.category_id);
        
        document.getElementById('viewContent').innerHTML = `
            <div style="text-align: center; margin-bottom: 20px;">
                ${product.image ? `<img src="${product.image}" style="max-width: 200px; border-radius: 10px;">` : ''}
            </div>
            <div class="form-group">
                <label>اسم المنتج</label>
                <p>${product.name}</p>
            </div>
            <div class="form-group">
                <label>الوصف</label>
                <p>${product.description || '-'}</p>
            </div>
            <div class="d-flex gap-3">
                <div class="form-group" style="flex: 1;">
                    <label>القسم</label>
                    <p>${category ? category.name : '-'}</p>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>السعر</label>
                    <p>${formatCurrency(product.price)}</p>
                </div>
            </div>
            <div class="d-flex gap-3">
                <div class="form-group" style="flex: 1;">
                    <label>المتاح</label>
                    <p><span class="badge badge-primary">${product.available_count}</span></p>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>المباع</label>
                    <p><span class="badge badge-success">${(product.total_count || 0) - (product.available_count || 0)}</span></p>
                </div>
            </div>
        `;
        
        document.getElementById('viewModal').classList.add('active');
    }
    
    function closeViewModal() {
        document.getElementById('viewModal').classList.remove('active');
    }
    
    // Save product
    async function saveProduct() {
        const id = document.getElementById('productId').value;
        const data = {
            name: document.getElementById('productName').value,
            description: document.getElementById('productDesc').value,
            category_id: document.getElementById('productCategory').value,
            price: parseFloat(document.getElementById('productPrice').value),
            image: document.getElementById('productImage').value,
            data: document.getElementById('productData').value.split('\n').filter(d => d.trim())
        };
        
        try {
            const url = id ? `/api/admin/products/${id}` : '/api/admin/products';
            const method = id ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('success', id ? 'تم تحديث المنتج بنجاح' : 'تم إضافة المنتج بنجاح');
                closeModal();
                loadProducts();
            } else {
                showAlert('danger', result.message || 'حدث خطأ');
            }
        } catch (error) {
            showAlert('danger', 'حدث خطأ في الاتصال');
        }
    }
    
    // Delete product
    function deleteProduct(id) {
        document.getElementById('deleteProductId').value = id;
        document.getElementById('deleteModal').classList.add('active');
    }
    
    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('active');
    }
    
    async function confirmDelete() {
        const id = document.getElementById('deleteProductId').value;
        
        try {
            const response = await fetch(`/api/admin/products/${id}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('success', 'تم حذف المنتج بنجاح');
                closeDeleteModal();
                loadProducts();
            } else {
                showAlert('danger', result.message || 'حدث خطأ');
            }
        } catch (error) {
            showAlert('danger', 'حدث خطأ في الاتصال');
        }
    }
    
    // Event listeners
    document.getElementById('searchInput').addEventListener('input', renderProducts);
    document.getElementById('categoryFilter').addEventListener('change', renderProducts);
    document.getElementById('statusFilter').addEventListener('change', renderProducts);
    
    // Load on page load
    loadCategories().then(loadProducts);
</script>
{% endblock %}
