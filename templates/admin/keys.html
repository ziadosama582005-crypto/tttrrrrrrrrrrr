{% extends "admin/base.html" %}

{% block title %}مفاتيح الشحن{% endblock %}
{% block page_title %}إدارة مفاتيح الشحن{% endblock %}

{% block content %}
<!-- Actions -->
<div class="card">
    <div class="card-body">
        <div class="d-flex gap-3" style="flex-wrap: wrap; align-items: center; justify-content: space-between;">
            <div class="d-flex gap-3" style="flex-wrap: wrap; flex: 1;">
                <div class="form-group" style="margin: 0; min-width: 200px;">
                    <input type="text" id="searchInput" class="form-control" placeholder="بحث بالمفتاح...">
                </div>
                <div class="form-group" style="margin: 0; min-width: 150px;">
                    <select id="statusFilter" class="form-control">
                        <option value="">كل الحالات</option>
                        <option value="active">نشط</option>
                        <option value="used">مستخدم</option>
                    </select>
                </div>
                <div class="form-group" style="margin: 0; min-width: 150px;">
                    <select id="amountFilter" class="form-control">
                        <option value="">كل المبالغ</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary" onclick="openGenerateModal()">
                <i class="fas fa-plus"></i> توليد مفاتيح
            </button>
        </div>
    </div>
</div>

<!-- Stats -->
<div class="stats-grid" style="margin-top: 20px;">
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-key"></i>
        </div>
        <div class="stat-info">
            <h3 id="totalKeys">--</h3>
            <p>إجمالي المفاتيح</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
            <h3 id="activeKeys">--</h3>
            <p>نشطة</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon warning">
            <i class="fas fa-history"></i>
        </div>
        <div class="stat-info">
            <h3 id="usedKeys">--</h3>
            <p>مستخدمة</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon secondary">
            <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-info">
            <h3 id="totalValue">--</h3>
            <p>قيمة المفاتيح النشطة</p>
        </div>
    </div>
</div>

<!-- Keys Table -->
<div class="card" style="margin-top: 20px;">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-key"></i> قائمة المفاتيح</h3>
        <div class="d-flex gap-2">
            <span class="badge badge-primary" id="keysCount">0</span>
            <button class="btn btn-sm btn-secondary" onclick="exportKeys()">
                <i class="fas fa-download"></i> تصدير
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>المفتاح</th>
                        <th>المبلغ</th>
                        <th>الحالة</th>
                        <th>تاريخ الإنشاء</th>
                        <th>مستخدم بواسطة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="keysTable">
                    <tr>
                        <td colspan="6">
                            <div class="loading"><div class="spinner"></div></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Generate Keys Modal -->
<div class="modal" id="generateModal">
    <div class="modal-dialog" style="max-width: 450px;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">توليد مفاتيح جديدة</h3>
                <button class="modal-close" onclick="closeGenerateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="generateForm">
                    <div class="form-group">
                        <label>عدد المفاتيح</label>
                        <input type="number" id="keysCount" class="form-control" value="10" min="1" max="100" required>
                    </div>
                    
                    <div class="form-group">
                        <label>قيمة كل مفتاح</label>
                        <div class="d-flex gap-2" style="flex-wrap: wrap;">
                            <button type="button" class="btn btn-secondary amount-btn" data-amount="5">$5</button>
                            <button type="button" class="btn btn-secondary amount-btn" data-amount="10">$10</button>
                            <button type="button" class="btn btn-secondary amount-btn active" data-amount="25">$25</button>
                            <button type="button" class="btn btn-secondary amount-btn" data-amount="50">$50</button>
                            <button type="button" class="btn btn-secondary amount-btn" data-amount="100">$100</button>
                        </div>
                        <input type="number" id="keyAmount" class="form-control" value="25" min="1" style="margin-top: 10px;">
                    </div>
                    
                    <div class="form-group">
                        <label>بادئة المفتاح (اختياري)</label>
                        <input type="text" id="keyPrefix" class="form-control" placeholder="STORE-" maxlength="10">
                        <small class="text-muted">سيتم إضافتها في بداية كل مفتاح</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGenerateModal()">إلغاء</button>
                <button class="btn btn-primary" onclick="generateKeys()">
                    <i class="fas fa-magic"></i> توليد
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Generated Keys Modal -->
<div class="modal" id="generatedModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">المفاتيح المولدة</h3>
                <button class="modal-close" onclick="closeGeneratedModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success mb-3">
                    <i class="fas fa-check-circle"></i>
                    تم توليد <span id="generatedCount">0</span> مفتاح بنجاح
                </div>
                <div class="form-group">
                    <label>المفاتيح</label>
                    <textarea id="generatedKeys" class="form-control" rows="10" readonly style="font-family: monospace;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGeneratedModal()">إغلاق</button>
                <button class="btn btn-primary" onclick="copyGeneratedKeys()">
                    <i class="fas fa-copy"></i> نسخ الكل
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-dialog" style="max-width: 400px;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تأكيد الحذف</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--danger); margin-bottom: 15px;"></i>
                <p>هل أنت متأكد من حذف هذا المفتاح؟</p>
                <input type="hidden" id="deleteKeyId">
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">إلغاء</button>
                <button class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> حذف
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .amount-btn {
        opacity: 0.7;
    }
    .amount-btn.active {
        opacity: 1;
        background: var(--primary);
        border-color: var(--primary);
    }
    
    .key-code {
        font-family: monospace;
        background: var(--dark);
        padding: 5px 10px;
        border-radius: 5px;
        letter-spacing: 1px;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    let keys = [];
    let uniqueAmounts = [];
    
    // Load keys
    async function loadKeys() {
        try {
            const response = await fetch('/api/admin/keys');
            const data = await response.json();
            
            if (data.success) {
                keys = data.keys || [];
                
                // Get unique amounts for filter
                uniqueAmounts = [...new Set(keys.map(k => k.amount))].sort((a, b) => a - b);
                const amountFilter = document.getElementById('amountFilter');
                amountFilter.innerHTML = '<option value="">كل المبالغ</option>';
                uniqueAmounts.forEach(amt => {
                    amountFilter.innerHTML += `<option value="${amt}">${formatCurrency(amt)}</option>`;
                });
                
                updateStats();
                renderKeys();
            }
        } catch (error) {
            console.error('Error loading keys:', error);
        }
    }
    
    // Update stats
    function updateStats() {
        const total = keys.length;
        const active = keys.filter(k => k.status === 'active' || !k.used).length;
        const used = keys.filter(k => k.status === 'used' || k.used).length;
        const value = keys
            .filter(k => k.status === 'active' || !k.used)
            .reduce((sum, k) => sum + (parseFloat(k.amount) || 0), 0);
        
        document.getElementById('totalKeys').textContent = formatNumber(total);
        document.getElementById('activeKeys').textContent = formatNumber(active);
        document.getElementById('usedKeys').textContent = formatNumber(used);
        document.getElementById('totalValue').textContent = formatCurrency(value);
    }
    
    // Render keys
    function renderKeys() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const amount = document.getElementById('amountFilter').value;
        
        let filtered = keys.filter(k => {
            const matchSearch = !search || (k.key && k.key.toLowerCase().includes(search));
            
            let matchStatus = !status;
            if (status === 'active') {
                matchStatus = k.status === 'active' || !k.used;
            } else if (status === 'used') {
                matchStatus = k.status === 'used' || k.used;
            }
            
            const matchAmount = !amount || k.amount == amount;
            
            return matchSearch && matchStatus && matchAmount;
        });
        
        // Sort by date desc
        filtered.sort((a, b) => (b.created_at || 0) - (a.created_at || 0));
        
        document.getElementById('keysCount').textContent = filtered.length;
        
        if (filtered.length === 0) {
            document.getElementById('keysTable').innerHTML = `
                <tr><td colspan="6" class="text-muted" style="text-align: center;">لا توجد مفاتيح</td></tr>
            `;
            return;
        }
        
        const html = filtered.map(k => {
            const isUsed = k.status === 'used' || k.used;
            
            return `
                <tr>
                    <td>
                        <span class="key-code">${k.key}</span>
                        <button class="btn btn-sm" style="padding: 2px 8px; margin-right: 5px;" onclick="copyKey('${k.key}')" title="نسخ">
                            <i class="fas fa-copy"></i>
                        </button>
                    </td>
                    <td><strong class="text-primary">${formatCurrency(k.amount)}</strong></td>
                    <td>
                        <span class="badge badge-${isUsed ? 'warning' : 'success'}">
                            ${isUsed ? 'مستخدم' : 'نشط'}
                        </span>
                    </td>
                    <td>${k.created_at ? new Date(k.created_at * 1000).toLocaleString('ar') : '-'}</td>
                    <td>
                        ${k.used_by ? `
                            <span class="text-muted">${k.used_by_name || k.used_by}</span>
                            <br>
                            <small>${k.used_at ? new Date(k.used_at * 1000).toLocaleString('ar') : ''}</small>
                        ` : '-'}
                    </td>
                    <td>
                        ${!isUsed ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteKey('${k.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('keysTable').innerHTML = html;
    }
    
    // Copy key
    function copyKey(key) {
        navigator.clipboard.writeText(key).then(() => {
            showAlert('success', 'تم نسخ المفتاح');
        });
    }
    
    // Open generate modal
    function openGenerateModal() {
        document.getElementById('generateForm').reset();
        document.getElementById('keyAmount').value = 25;
        document.querySelectorAll('.amount-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.amount === '25');
        });
        document.getElementById('generateModal').classList.add('active');
    }
    
    function closeGenerateModal() {
        document.getElementById('generateModal').classList.remove('active');
    }
    
    // Amount buttons
    document.querySelectorAll('.amount-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('keyAmount').value = btn.dataset.amount;
        });
    });
    
    // Generate keys
    async function generateKeys() {
        const count = parseInt(document.getElementById('keysCount').value);
        const amount = parseFloat(document.getElementById('keyAmount').value);
        const prefix = document.getElementById('keyPrefix').value;
        
        if (!count || count < 1 || count > 100) {
            showAlert('danger', 'يرجى إدخال عدد صحيح (1-100)');
            return;
        }
        
        if (!amount || amount < 1) {
            showAlert('danger', 'يرجى إدخال قيمة صحيحة');
            return;
        }
        
        try {
            const response = await fetch('/api/admin/keys/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    count: count,
                    amount: amount,
                    prefix: prefix
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                closeGenerateModal();
                
                // Show generated keys
                document.getElementById('generatedCount').textContent = result.keys.length;
                document.getElementById('generatedKeys').value = result.keys.join('\n');
                document.getElementById('generatedModal').classList.add('active');
                
                loadKeys();
            } else {
                showAlert('danger', result.message || 'حدث خطأ');
            }
        } catch (error) {
            showAlert('danger', 'حدث خطأ في الاتصال');
        }
    }
    
    function closeGeneratedModal() {
        document.getElementById('generatedModal').classList.remove('active');
    }
    
    function copyGeneratedKeys() {
        const keys = document.getElementById('generatedKeys').value;
        navigator.clipboard.writeText(keys).then(() => {
            showAlert('success', 'تم نسخ المفاتيح');
        });
    }
    
    // Delete key
    function deleteKey(id) {
        document.getElementById('deleteKeyId').value = id;
        document.getElementById('deleteModal').classList.add('active');
    }
    
    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('active');
    }
    
    async function confirmDelete() {
        const id = document.getElementById('deleteKeyId').value;
        
        try {
            const response = await fetch(`/api/admin/keys/${id}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('success', 'تم حذف المفتاح بنجاح');
                closeDeleteModal();
                loadKeys();
            } else {
                showAlert('danger', result.message || 'حدث خطأ');
            }
        } catch (error) {
            showAlert('danger', 'حدث خطأ في الاتصال');
        }
    }
    
    // Export keys
    function exportKeys() {
        const activeKeys = keys.filter(k => k.status === 'active' || !k.used);
        if (activeKeys.length === 0) {
            showAlert('warning', 'لا توجد مفاتيح نشطة للتصدير');
            return;
        }
        
        const content = activeKeys.map(k => `${k.key} - ${formatCurrency(k.amount)}`).join('\n');
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `keys_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    }
    
    // Event listeners
    document.getElementById('searchInput').addEventListener('input', renderKeys);
    document.getElementById('statusFilter').addEventListener('change', renderKeys);
    document.getElementById('amountFilter').addEventListener('change', renderKeys);
    
    // Load on page load
    loadKeys();
</script>
{% endblock %}
