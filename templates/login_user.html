<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ¬Ø±</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background: #0a0a0f;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        /* Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 255, 136, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 255, 136, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(200, 255, 0, 0.02) 0%, transparent 40%);
            animation: bgMove 20s ease-in-out infinite;
            z-index: -1;
        }
        
        @keyframes bgMove {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(5deg); }
            66% { transform: translate(-20px, 20px) rotate(-5deg); }
        }
        
        /* Ø¬Ø²ÙŠØ¦Ø§Øª Ù…ØªØ·Ø§ÙŠØ±Ø© */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #00ff88;
            border-radius: 50%;
            opacity: 0.3;
            animation: float 15s infinite;
        }
        
        .particle:nth-child(1) { left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 20%; animation-delay: 2s; }
        .particle:nth-child(3) { left: 30%; animation-delay: 4s; }
        .particle:nth-child(4) { left: 40%; animation-delay: 6s; }
        .particle:nth-child(5) { left: 50%; animation-delay: 8s; }
        .particle:nth-child(6) { left: 60%; animation-delay: 10s; }
        .particle:nth-child(7) { left: 70%; animation-delay: 12s; }
        .particle:nth-child(8) { left: 80%; animation-delay: 14s; }
        .particle:nth-child(9) { left: 90%; animation-delay: 1s; }
        .particle:nth-child(10) { left: 95%; animation-delay: 3s; }
        
        @keyframes float {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            10% { opacity: 0.5; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-100vh) scale(1); opacity: 0; }
        }
        
        .login-container {
            background: linear-gradient(145deg, #12121a 0%, #0d0d12 100%);
            border-radius: 24px;
            max-width: 420px;
            width: 100%;
            padding: 40px 35px;
            color: #fff;
            position: relative;
            border: 1px solid rgba(0, 255, 136, 0.15);
            box-shadow: 
                0 0 60px rgba(0, 255, 136, 0.08),
                0 25px 50px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        
        /* Ø­Ø¯ÙˆØ¯ Ù…ØªØ­Ø±ÙƒØ© */
        .login-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, 
                #00ff88 0%, 
                transparent 40%, 
                transparent 60%, 
                #c8ff00 100%);
            border-radius: 26px;
            z-index: -1;
            opacity: 0.5;
            animation: borderGlow 3s ease-in-out infinite;
        }
        
        @keyframes borderGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
        
        .logo-area {
            text-align: center;
            margin-bottom: 35px;
        }
        
        .logo-icon {
            width: 70px;
            height: 70px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 
                0 10px 30px rgba(0, 255, 136, 0.3),
                0 0 20px rgba(0, 255, 136, 0.2);
            animation: logoFloat 3s ease-in-out infinite;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        h1 {
            color: #fff;
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .subtitle {
            color: #6b7280;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #9ca3af;
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .input-wrapper::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            padding: 2px;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.3), rgba(0, 255, 136, 0.1));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .input-wrapper:focus-within::before {
            opacity: 1;
        }
        
        input {
            width: 100%;
            padding: 16px 18px;
            border: 1px solid #2a2a35;
            border-radius: 12px;
            background: #15151d;
            color: #fff;
            font-size: 16px;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s ease;
            text-align: right;
        }
        
        input:focus {
            outline: none;
            border-color: #00ff88;
            background: #1a1a24;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.1);
        }
        
        input::placeholder {
            color: #4b5563;
        }
        
        .code-input {
            letter-spacing: 12px;
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            color: #00ff88;
            background: #0d0d12;
            padding: 20px;
        }
        
        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #c8ff00 0%, #9acd32 100%);
            color: #0a0a0f;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }
        
        button:hover:not(:disabled)::before {
            left: 100%;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 
                0 15px 35px rgba(200, 255, 0, 0.3),
                0 0 20px rgba(200, 255, 0, 0.2);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .back-btn {
            background: transparent;
            border: 1px solid #2a2a35;
            color: #9ca3af;
            margin-top: 10px;
        }
        
        .back-btn:hover:not(:disabled) {
            border-color: #00ff88;
            color: #00ff88;
            background: rgba(0, 255, 136, 0.05);
            box-shadow: none;
        }
        
        .message {
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 14px;
            margin-top: 15px;
            text-align: center;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .error {
            background: rgba(255, 71, 87, 0.1);
            color: #ff4757;
            border: 1px solid rgba(255, 71, 87, 0.3);
            display: block;
        }
        
        .success {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
            border: 1px solid rgba(0, 255, 136, 0.3);
            display: block;
        }
        
        .info {
            background: rgba(0, 136, 255, 0.1);
            color: #0088ff;
            border: 1px solid rgba(0, 136, 255, 0.3);
            display: block;
        }
        
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .timer {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 255, 136, 0.05) 100%);
            border: 1px solid rgba(0, 255, 136, 0.2);
            color: #00ff88;
            font-weight: 700;
            text-align: center;
            margin: 25px 0;
            font-size: 32px;
            padding: 20px;
            border-radius: 16px;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }
        
        .security-note {
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.1);
            color: #6b7280;
            padding: 16px;
            border-radius: 12px;
            font-size: 12px;
            margin-top: 25px;
            text-align: center;
            line-height: 1.7;
        }
        
        .security-note span {
            color: #00ff88;
        }
        
        .help-text {
            color: #4b5563;
            font-size: 12px;
            margin-top: 15px;
            text-align: center;
        }
        
        .switch-method {
            text-align: center;
            margin: 20px 0;
        }
        
        .switch-method a {
            color: #00ff88;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 16px;
            border-radius: 8px;
        }
        
        .switch-method a:hover {
            background: rgba(0, 255, 136, 0.1);
        }
        
        .login-input-section {
            display: none;
        }
        
        .login-input-section.active {
            display: block;
        }
        
        /* Ø±ÙŠØ³Ø¨ÙˆÙ†Ø³ÙŠÙ */
        @media (max-width: 480px) {
            .login-container {
                padding: 30px 25px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .code-input {
                letter-spacing: 8px;
                font-size: 24px;
            }
            
            .timer {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <!-- Ø¬Ø²ÙŠØ¦Ø§Øª Ù…ØªØ·Ø§ÙŠØ±Ø© -->
    <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="login-container">
        <!-- Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±Ù -->
        <div id="step1" class="step active">
            <div class="logo-area">
                <div class="logo-icon">ğŸ”</div>
                <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
                <p class="subtitle" id="loginSubtitle">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Telegram ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</p>
            </div>
            
            <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙ„ØºØ±Ø§Ù… -->
            <div id="telegramSection" class="login-input-section active">
                <form id="userIdForm">
                    <div class="form-group">
                        <label>ğŸ†” Ø±Ù‚Ù… Telegram ID</label>
                        <div class="input-wrapper">
                            <input type="text" id="userId" placeholder="Ù…Ø«Ø§Ù„: 123456789" inputmode="numeric" autocomplete="off">
                        </div>
                    </div>
                    <div class="switch-method">
                        <a onclick="switchToPhone()">ğŸ“± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</a>
                    </div>
                    <button type="submit" id="sendCodeBtn">Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</button>
                </form>
                <div class="help-text">
                    ğŸ’¡ Ù„Ø§ ØªØ¹Ø±Ù Ø±Ù‚Ù…ÙƒØŸ Ø£Ø±Ø³Ù„ /id Ù„Ù„Ø¨ÙˆØª
                </div>
            </div>
            
            <!-- Ù‚Ø³Ù… Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ -->
            <div id="phoneSection" class="login-input-section">
                <form id="phoneForm">
                    <div class="form-group">
                        <label>ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                        <div class="input-wrapper">
                            <input type="tel" id="loginPhone" placeholder="05xxxxxxxx" dir="ltr" maxlength="10" autocomplete="off">
                        </div>
                    </div>
                    <div class="switch-method">
                        <a onclick="switchToTelegram()">ğŸ†” Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù€ Telegram ID</a>
                    </div>
                    <button type="submit" id="sendCodePhoneBtn">Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</button>
                </form>
                <div class="help-text">
                    âš ï¸ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ«Ù‚ ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø³Ø¨Ù‚Ø§Ù‹
                </div>
            </div>
            
            <div id="error1" class="message error"></div>
            
            <div class="security-note">
                ğŸ”’ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ <span>ÙƒÙˆØ¯ Ù…Ø¤Ù‚Øª</span> Ø¹Ø¨Ø± Ø§Ù„Ø¨ÙˆØª Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØªÙƒ
            </div>
        </div>
        
        <!-- Ø§Ù„Ø®Ø·ÙˆØ© 2: ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ -->
        <div id="step2" class="step">
            <div class="logo-area">
                <div class="logo-icon">âœ‰ï¸</div>
                <h1>ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</h1>
                <p class="subtitle">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±Ø³Ù„ Ù„Ùƒ ÙÙŠ Telegram</p>
            </div>
            
            <div class="timer">â±ï¸ <span id="countdown">2:00</span></div>
            
            <form id="codeForm">
                <div class="form-group">
                    <label>ğŸ”¢ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ (6 Ø£Ø±Ù‚Ø§Ù…)</label>
                    <div class="input-wrapper">
                        <input type="text" id="verifyCode" class="code-input" placeholder="â— â— â— â— â— â—" maxlength="6" required inputmode="numeric" autocomplete="off">
                    </div>
                </div>
                <button type="submit" id="verifyBtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button type="button" class="back-btn" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
            </form>
            
            <div id="error2" class="message error"></div>
            <div id="success2" class="message success"></div>
            
            <div class="security-note">
                ğŸ” Ù„Ø§ ØªØ´Ø§Ø±Ùƒ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ <span>Ø£ÙŠ Ø´Ø®Øµ</span> - Ø³Ø±ÙŠ ØªÙ…Ø§Ù…Ø§Ù‹
            </div>
        </div>
        
        <!-- Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ© -->
        <div id="step3" class="step">
            <div class="logo-area">
                <div class="logo-icon">ğŸ›¡ï¸</div>
                <h1>Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ©</h1>
                <p class="subtitle">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Google Authenticator</p>
            </div>
            
            <form id="twoFAForm">
                <div class="form-group">
                    <label>ğŸ” ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (6 Ø£Ø±Ù‚Ø§Ù…)</label>
                    <div class="input-wrapper">
                        <input type="text" id="twoFACode" class="code-input" placeholder="â— â— â— â— â— â—" maxlength="6" required inputmode="numeric" autocomplete="off">
                    </div>
                </div>
                <button type="submit" id="verify2FABtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button type="button" class="back-btn" onclick="goBackToStep1()">â† Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©</button>
            </form>
            
            <div id="error3" class="message error"></div>
            <div id="success3" class="message success"></div>
            
            <div class="security-note">
                âš¡ Ø§Ù„ÙƒÙˆØ¯ ÙŠØªØºÙŠØ± ÙƒÙ„ <span>30 Ø«Ø§Ù†ÙŠØ©</span> - Ø£Ø¯Ø®Ù„Ù‡ Ø¨Ø³Ø±Ø¹Ø©!
            </div>
        </div>
    </div>

    <script>
        let countdownInterval;
        let secondsLeft = 120;
        let currentUserId = '';
        let loginMethod = 'telegram';
        
        function switchToPhone() {
            loginMethod = 'phone';
            document.getElementById('telegramSection').classList.remove('active');
            document.getElementById('phoneSection').classList.add('active');
            document.getElementById('loginSubtitle').textContent = 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ«Ù‚';
            document.getElementById('error1').style.display = 'none';
            document.getElementById('loginPhone').focus();
        }
        
        function switchToTelegram() {
            loginMethod = 'telegram';
            document.getElementById('phoneSection').classList.remove('active');
            document.getElementById('telegramSection').classList.add('active');
            document.getElementById('loginSubtitle').textContent = 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Telegram ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ';
            document.getElementById('error1').style.display = 'none';
            document.getElementById('userId').focus();
        }
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ØªÙ„ØºØ±Ø§Ù…
        document.getElementById('userIdForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const userId = document.getElementById('userId').value.trim();
            const btn = document.getElementById('sendCodeBtn');
            const errorDiv = document.getElementById('error1');
            
            if (!userId || !userId.match(/^\d+$/)) {
                errorDiv.textContent = 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ ÙÙ‚Ø·';
                errorDiv.style.display = 'block';
                return;
            }
            
            currentUserId = userId;
            btn.disabled = true;
            btn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/send_code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step2').classList.add('active');
                    startCountdown();
                    document.getElementById('verifyCode').focus();
                } else {
                    errorDiv.textContent = 'âŒ ' + data.message;
                    errorDiv.style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚';
                }
            } catch (error) {
                errorDiv.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±';
                errorDiv.style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚';
            }
        });
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
        document.getElementById('phoneForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const phone = document.getElementById('loginPhone').value.trim();
            const btn = document.getElementById('sendCodePhoneBtn');
            const errorDiv = document.getElementById('error1');
            
            const cleanPhone = phone.replace(/[\s\-\+]/g, '');
            if (!cleanPhone.match(/^(05\d{8}|5\d{8}|9665\d{8})$/)) {
                errorDiv.textContent = 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ ØµØ­ÙŠØ­ (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05)';
                errorDiv.style.display = 'block';
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/send_code_by_phone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: phone })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUserId = data.user_id;
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step2').classList.add('active');
                    startCountdown();
                    document.getElementById('verifyCode').focus();
                } else {
                    errorDiv.textContent = 'âŒ ' + data.message;
                    errorDiv.style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚';
                }
            } catch (error) {
                errorDiv.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±';
                errorDiv.style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚';
            }
        });
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
        document.getElementById('codeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const code = document.getElementById('verifyCode').value.trim();
            const btn = document.getElementById('verifyBtn');
            const errorDiv = document.getElementById('error2');
            const successDiv = document.getElementById('success2');
            
            if (!code || code.length !== 6 || !code.match(/^\d{6}$/)) {
                errorDiv.textContent = 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ 6 Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø©';
                errorDiv.style.display = 'block';
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            try {
                const response = await fetch('/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: currentUserId,
                        code: code 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.requires_2fa) {
                        successDiv.textContent = 'ğŸ” Ù…Ø·Ù„ÙˆØ¨ ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ©';
                        successDiv.style.display = 'block';
                        clearInterval(countdownInterval);
                        setTimeout(() => {
                            document.getElementById('step2').classList.remove('active');
                            document.getElementById('step3').classList.add('active');
                            document.getElementById('twoFACode').focus();
                        }, 1000);
                    } else {
                        successDiv.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚! Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„Ùƒ...';
                        successDiv.style.display = 'block';
                        clearInterval(countdownInterval);
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1500);
                    }
                } else {
                    errorDiv.textContent = 'âŒ ' + data.message;
                    errorDiv.style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                }
            } catch (error) {
                errorDiv.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±';
                errorDiv.style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            }
        });
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† 2FA
        document.getElementById('twoFAForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const totpCode = document.getElementById('twoFACode').value.trim();
            const btn = document.getElementById('verify2FABtn');
            const errorDiv = document.getElementById('error3');
            const successDiv = document.getElementById('success3');
            
            if (!totpCode || totpCode.length !== 6 || !totpCode.match(/^\d{6}$/)) {
                errorDiv.textContent = 'âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ 6 Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø©';
                errorDiv.style.display = 'block';
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            try {
                const response = await fetch('/verify_2fa_login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ totp_code: totpCode })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successDiv.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚! Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„Ùƒ...';
                    successDiv.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                } else {
                    errorDiv.textContent = data.message || 'âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­';
                    errorDiv.style.display = 'block';
                    btn.disabled = false;
                    btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                }
            } catch (error) {
                errorDiv.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±';
                errorDiv.style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            }
        });
        
        function startCountdown() {
            secondsLeft = 120;
            updateCountdown();
            countdownInterval = setInterval(() => {
                secondsLeft--;
                updateCountdown();
                if (secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('error2').textContent = 'â° Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒÙˆØ¯! Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹';
                    document.getElementById('error2').style.display = 'block';
                    document.getElementById('verifyBtn').disabled = true;
                }
            }, 1000);
        }
        
        function updateCountdown() {
            const minutes = Math.floor(secondsLeft / 60);
            const seconds = secondsLeft % 60;
            document.getElementById('countdown').textContent = minutes + ':' + seconds.toString().padStart(2, '0');
        }
        
        function goBack() {
            clearInterval(countdownInterval);
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
            document.getElementById('userId').value = '';
            document.getElementById('loginPhone').value = '';
            document.getElementById('verifyCode').value = '';
            document.getElementById('error1').style.display = 'none';
            document.getElementById('error2').style.display = 'none';
            document.getElementById('success2').style.display = 'none';
            document.getElementById('sendCodeBtn').disabled = false;
            document.getElementById('sendCodeBtn').innerHTML = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚';
            document.getElementById('sendCodePhoneBtn').disabled = false;
            document.getElementById('sendCodePhoneBtn').innerHTML = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚';
            document.getElementById('verifyBtn').disabled = false;
            document.getElementById('verifyBtn').innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        }
        
        function goBackToStep1() {
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step1').classList.add('active');
            document.getElementById('userId').value = '';
            document.getElementById('loginPhone').value = '';
            document.getElementById('verifyCode').value = '';
            document.getElementById('twoFACode').value = '';
            document.getElementById('error1').style.display = 'none';
            document.getElementById('error3').style.display = 'none';
            document.getElementById('success3').style.display = 'none';
            document.getElementById('sendCodeBtn').disabled = false;
            document.getElementById('sendCodeBtn').innerHTML = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚';
            document.getElementById('userId').focus();
        }
        
        // Ù…Ù†Ø¹ Ø¥Ø¯Ø®Ø§Ù„ ØºÙŠØ± Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        document.getElementById('userId').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
        
        document.getElementById('verifyCode').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
        
        document.getElementById('twoFACode').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
        
        // Focus Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        window.addEventListener('load', () => {
            document.getElementById('userId').focus();
        });
    </script>
</body>
</html>
