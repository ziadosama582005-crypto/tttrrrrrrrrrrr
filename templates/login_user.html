<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - GamersTR</title>
    {% include 'partials/pwa_head.html' %}
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Tajawal', sans-serif;
            background: #0a0a0f;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #fff;
        }

        .back-link {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #888;
            text-decoration: none;
            font-size: 14px;
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
            z-index: 10;
        }
        .back-link:active, .back-link:hover {
            color: #00ff88;
            border-color: rgba(0,255,136,0.3);
        }

        .login-box {
            width: 100%;
            max-width: 460px;
            background: #13131d;
            border-radius: 24px;
            padding: 40px 30px;
            border: 1.5px solid #1e1e2e;
            position: relative;
        }

        /* Ø­Ø¯ Ø³ÙÙ„ÙŠ Ø£Ø®Ø¶Ø± Ù…ØªÙˆÙ‡Ø¬ */
        .login-box::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 20%;
            right: 20%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #00ff88, #c8ff00, transparent);
            border-radius: 0 0 24px 24px;
            filter: blur(1px);
        }

        .logo-section {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
        .logo-section h1 {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        .logo-section p {
            color: #666;
            font-size: 14px;
        }

        .form-field {
            margin-bottom: 20px;
        }
        .form-field label {
            display: block;
            color: #999;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .form-field input {
            width: 100%;
            padding: 15px 16px;
            border: 1.5px solid #2a2a3a;
            border-radius: 14px;
            background: #0e0e16;
            color: #fff;
            font-size: 16px;
            font-family: 'Tajawal', sans-serif;
            text-align: right;
            outline: none;
            transition: border-color 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }
        .form-field input:focus {
            border-color: #00ff88;
        }
        .form-field input::placeholder {
            color: #444;
        }
        .form-field input[dir="ltr"] {
            text-align: left;
        }

        .code-field input {
            letter-spacing: 10px;
            font-size: 26px;
            font-weight: 700;
            text-align: center;
            color: #00ff88;
            padding: 18px 16px;
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #c8ff00, #9acd32);
            color: #0a0a0f;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
            margin-top: 5px;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-primary:active:not(:disabled) {
            transform: scale(0.98);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            width: 100%;
            padding: 14px;
            background: transparent;
            color: #888;
            border: 1.5px solid #2a2a3a;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
            margin-top: 10px;
            transition: border-color 0.2s, color 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-secondary:active {
            border-color: #00ff88;
            color: #00ff88;
        }

        .switch-link {
            text-align: center;
            margin: 18px 0;
        }
        .switch-link a {
            color: #00ff88;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
            -webkit-tap-highlight-color: transparent;
        }
        .switch-link a:active {
            background: rgba(0,255,136,0.1);
        }

        .help-note {
            color: #555;
            font-size: 12px;
            margin-top: 14px;
            text-align: center;
        }

        .timer-box {
            background: rgba(0,255,136,0.08);
            border: 1px solid rgba(0,255,136,0.15);
            color: #00ff88;
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
            font-size: 28px;
            padding: 16px;
            border-radius: 14px;
        }

        .msg {
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            margin-top: 14px;
            text-align: center;
            display: none;
        }
        .msg.err {
            background: rgba(255,71,87,0.1);
            color: #ff4757;
            border: 1px solid rgba(255,71,87,0.2);
            display: block;
        }
        .msg.ok {
            background: rgba(0,255,136,0.1);
            color: #00ff88;
            border: 1px solid rgba(0,255,136,0.2);
            display: block;
        }

        .step { display: none; }
        .step.active { display: block; }
        .section { display: none; }
        .section.active { display: block; }

        .security-hint {
            color: #555;
            font-size: 12px;
            margin-top: 20px;
            text-align: center;
            line-height: 1.7;
        }
        .security-hint b { color: #00ff88; }

        @media (max-width: 480px) {
            body { padding: 15px; }
            .login-box { padding: 30px 22px; }
            .logo-section h1 { font-size: 20px; }
            .code-field input { letter-spacing: 8px; font-size: 22px; }
        }
    </style>
</head>
<body>

    <a href="/" class="back-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© â†’</a>

    <div class="login-box">

        <!-- ===== Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±Ù ===== -->
        <div id="step1" class="step active">
            <div class="logo-section">
                <div class="logo-icon">ğŸ”</div>
                <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
                <p id="loginSubtitle">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            </div>

            <!-- Ø¬ÙˆØ§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ -->
            <div id="phoneSection" class="section active">
                <form id="phoneForm">
                    <div class="form-field">
                        <label>ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                        <input type="tel" id="loginPhone" placeholder="05xxxxxxxx" dir="ltr" inputmode="tel" autocomplete="tel">
                    </div>
                    <div class="switch-link">
                        <a onclick="switchToEmail()">ğŸ“§ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</a> Â· <a onclick="switchToTelegram()">ğŸ†” Telegram</a>
                    </div>
                    <button type="submit" id="sendCodePhoneBtn" class="btn-primary">ğŸ“² Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ ÙˆØ§ØªØ³Ø§Ø¨</button>
                </form>
                <div class="switch-link" style="margin-top:14px">
                    <a onclick="goToRegister()">ğŸ†• Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¢Ù†</a>
                </div>
                <div class="help-note">ğŸ’¬ Ø³ÙŠØµÙ„Ùƒ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨</div>
            </div>

            <!-- ØªÙ„ØºØ±Ø§Ù… -->
            <div id="telegramSection" class="section">
                <form id="userIdForm">
                    <div class="form-field">
                        <label>ğŸ†” Ø±Ù‚Ù… Telegram ID</label>
                        <input type="text" id="userId" placeholder="Ù…Ø«Ø§Ù„: 123456789" inputmode="numeric" autocomplete="off">
                    </div>
                    <div class="switch-link">
                        <a onclick="switchToPhone()">ğŸ“± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¬ÙˆØ§Ù„</a> Â· <a onclick="switchToEmail()">ğŸ“§ Ø¥ÙŠÙ…ÙŠÙ„</a>
                    </div>
                    <button type="submit" id="sendCodeBtn" class="btn-primary">Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</button>
                </form>
                <div class="switch-link" style="margin-top:14px">
                    <a onclick="goToRegister()">ğŸ†• Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¢Ù†</a>
                </div>
                <div class="help-note">ğŸ’¡ Ù„Ø§ ØªØ¹Ø±Ù Ø±Ù‚Ù…ÙƒØŸ Ø£Ø±Ø³Ù„ /id Ù„Ù„Ø¨ÙˆØª</div>
            </div>

            <!-- Ø¥ÙŠÙ…ÙŠÙ„ -->
            <div id="emailSection" class="section">
                <form id="emailForm">
                    <div class="form-field">
                        <label>ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" id="loginEmail" placeholder="example@gmail.com" dir="ltr" autocomplete="email">
                    </div>
                    <div class="switch-link">
                        <a onclick="switchToPhone()">ğŸ“± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¬ÙˆØ§Ù„</a> Â· <a onclick="switchToTelegram()">ğŸ†” Telegram</a>
                    </div>
                    <button type="submit" id="sendCodeEmailBtn" class="btn-primary">Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</button>
                </form>
                <div class="switch-link" style="margin-top:14px">
                    <a onclick="goToRegister()">ğŸ†• Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¢Ù†</a>
                </div>
                <div class="help-note">ğŸ“© Ø³ÙŠØµÙ„Ùƒ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù„Ù‰ Ø¥ÙŠÙ…ÙŠÙ„Ùƒ</div>
            </div>

            <div id="error1" class="msg"></div>
            <div class="security-hint">ğŸ”’ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ <b>ÙƒÙˆØ¯ Ù…Ø¤Ù‚Øª</b> Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØªÙƒ</div>
        </div>

        <!-- ===== Ø§Ù„Ø®Ø·ÙˆØ© 2: ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ ===== -->
        <div id="step2" class="step">
            <div class="logo-section">
                <div class="logo-icon">âœ‰ï¸</div>
                <h1>ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</h1>
                <p>Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±Ø³Ù„ Ù„Ùƒ</p>
            </div>

            <div class="timer-box">â±ï¸ <span id="countdown">2:00</span></div>

            <form id="codeForm">
                <div class="form-field code-field">
                    <label>ğŸ”¢ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ (6 Ø£Ø±Ù‚Ø§Ù…)</label>
                    <input type="text" id="verifyCode" placeholder="------" maxlength="6" inputmode="numeric" autocomplete="one-time-code">
                </div>
                <button type="submit" id="verifyBtn" class="btn-primary">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button type="button" class="btn-secondary" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
            </form>

            <div id="error2" class="msg"></div>
            <div id="success2" class="msg"></div>
            <div class="security-hint">ğŸ” Ù„Ø§ ØªØ´Ø§Ø±Ùƒ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ <b>Ø£ÙŠ Ø´Ø®Øµ</b></div>
        </div>

        <!-- ===== Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ© ===== -->
        <div id="step3" class="step">
            <div class="logo-section">
                <div class="logo-icon">ğŸ›¡ï¸</div>
                <h1>Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ©</h1>
                <p>Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Google Authenticator</p>
            </div>

            <form id="twoFAForm">
                <div class="form-field code-field">
                    <label>ğŸ” ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (6 Ø£Ø±Ù‚Ø§Ù…)</label>
                    <input type="text" id="twoFACode" placeholder="------" maxlength="6" inputmode="numeric" autocomplete="one-time-code">
                </div>
                <button type="submit" id="verify2FABtn" class="btn-primary">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button type="button" class="btn-secondary" onclick="goBackToStep1()">â† Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©</button>
            </form>

            <div id="error3" class="msg"></div>
            <div id="success3" class="msg"></div>
            <div class="security-hint">âš¡ Ø§Ù„ÙƒÙˆØ¯ ÙŠØªØºÙŠØ± ÙƒÙ„ <b>30 Ø«Ø§Ù†ÙŠØ©</b></div>
        </div>

        <!-- ===== Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ===== -->
        <div id="step4" class="step">
            <div class="logo-section">
                <div class="logo-icon">ğŸ†•</div>
                <h1>Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h1>
                <p>Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ</p>
            </div>

            <form id="registerForm">
                <div class="form-field">
                    <label>ï¿½ Ø§Ù„Ø§Ø³Ù…</label>
                    <input type="text" id="regName" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„" autocomplete="name">
                </div>
                <div class="form-field">
                    <label>ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                    <input type="tel" id="regPhone" placeholder="05xxxxxxxx" dir="ltr" inputmode="tel" autocomplete="tel">
                </div>
                <button type="submit" id="regSendCodeBtn" class="btn-primary">ğŸ“² Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ ÙˆØ§ØªØ³Ø§Ø¨</button>
                <button type="button" class="btn-secondary" onclick="goBackToStep1()">â† Ø±Ø¬ÙˆØ¹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </form>

            <div id="error4" class="msg"></div>
            <div class="security-hint">ğŸ’¬ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† <b>Ø±Ù‚Ù…Ùƒ</b></div>
        </div>

        <!-- ===== Ø§Ù„Ø®Ø·ÙˆØ© 5: ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„ØªØ³Ø¬ÙŠÙ„ ===== -->
        <div id="step5" class="step">
            <div class="logo-section">
                <div class="logo-icon">ï¿½</div>
                <h1>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨</h1>
                <p>Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±Ø³Ù„ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨</p>
            </div>

            <div class="timer-box">â±ï¸ <span id="regCountdown">2:00</span></div>

            <form id="regCodeForm">
                <div class="form-field code-field">
                    <label>ğŸ”¢ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ (6 Ø£Ø±Ù‚Ø§Ù…)</label>
                    <input type="text" id="regVerifyCode" placeholder="------" maxlength="6" inputmode="numeric" autocomplete="one-time-code">
                </div>
                <button type="submit" id="regVerifyBtn" class="btn-primary">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ğŸ‰</button>
                <button type="button" class="btn-secondary" onclick="goBackToStep4()">â† Ø±Ø¬ÙˆØ¹</button>
            </form>

            <div id="error5" class="msg"></div>
            <div id="success5" class="msg"></div>
            <div class="security-hint">ğŸ” Ù„Ø§ ØªØ´Ø§Ø±Ùƒ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ <b>Ø£ÙŠ Ø´Ø®Øµ</b></div>
        </div>

    </div>

<script>
    var countdownInterval;
    var regCountdownInterval;
    var secondsLeft = 120;
    var regSecondsLeft = 120;
    var currentUserId = '';
    var currentEmail = null;
    var currentPhone = null;
    var isRegistering = false;

    function switchToPhone() {
        document.querySelectorAll('#step1 .section').forEach(function(s) { s.classList.remove('active'); });
        document.getElementById('phoneSection').classList.add('active');
        document.getElementById('loginSubtitle').textContent = 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ';
        hideMsg('error1');
    }

    function switchToEmail() {
        document.querySelectorAll('#step1 .section').forEach(function(s) { s.classList.remove('active'); });
        document.getElementById('emailSection').classList.add('active');
        document.getElementById('loginSubtitle').textContent = 'Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';
        hideMsg('error1');
    }

    function switchToTelegram() {
        document.querySelectorAll('#step1 .section').forEach(function(s) { s.classList.remove('active'); });
        document.getElementById('telegramSection').classList.add('active');
        document.getElementById('loginSubtitle').textContent = 'Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©';
        hideMsg('error1');
    }

    function showErr(id, text) {
        var el = document.getElementById(id);
        el.textContent = 'âŒ ' + text;
        el.className = 'msg err';
    }
    function showOk(id, text) {
        var el = document.getElementById(id);
        el.textContent = text;
        el.className = 'msg ok';
    }
    function hideMsg(id) {
        document.getElementById(id).className = 'msg';
    }

    // Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ ØªÙ„ØºØ±Ø§Ù…
    document.getElementById('userIdForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var userId = document.getElementById('userId').value.trim();
        var btn = document.getElementById('sendCodeBtn');
        if (!userId || !/^\d+$/.test(userId)) { showErr('error1', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­'); return; }
        currentUserId = userId;
        currentEmail = null;
        currentPhone = null;
        btn.disabled = true; btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
        hideMsg('error1');
        try {
            var res = await fetch('/api/send_code', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({user_id: userId}) });
            var data = await res.json();
            if (data.success) { goToStep2(); }
            else { showErr('error1', data.message); btn.disabled = false; btn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚'; }
        } catch(err) { showErr('error1', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); btn.disabled = false; btn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚'; }
    });

    // Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø¬ÙˆØ§Ù„ ÙˆØ§ØªØ³Ø§Ø¨
    document.getElementById('phoneForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var phone = document.getElementById('loginPhone').value.trim();
        var btn = document.getElementById('sendCodePhoneBtn');
        if (!phone || phone.length < 10) { showErr('error1', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ ØµØ­ÙŠØ­'); return; }
        currentPhone = phone;
        currentEmail = null;
        currentUserId = null;
        btn.disabled = true; btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
        hideMsg('error1');
        try {
            var res = await fetch('/api/auth/send-code-phone', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({phone: phone}) });
            var data = await res.json();
            if (data.success) {
                if (data.user_id) currentUserId = data.user_id;
                isRegistering = false;
                goToStep2();
            } else { showErr('error1', data.message); }
            btn.disabled = false; btn.textContent = 'ğŸ“² Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ ÙˆØ§ØªØ³Ø§Ø¨';
        } catch(err) { showErr('error1', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); btn.disabled = false; btn.textContent = 'ğŸ“² Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ ÙˆØ§ØªØ³Ø§Ø¨'; }
    });

    // Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø¥ÙŠÙ…ÙŠÙ„
    document.getElementById('emailForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var email = document.getElementById('loginEmail').value.trim().toLowerCase();
        var btn = document.getElementById('sendCodeEmailBtn');
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showErr('error1', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ ØµØ­ÙŠØ­'); return; }
        currentEmail = email;
        currentUserId = null;
        btn.disabled = true; btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
        hideMsg('error1');
        try {
            var res = await fetch('/api/auth/send-code', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({email: email}) });
            var data = await res.json();
            if (data.success) { isRegistering = false; goToStep2(); }
            else if (data.not_registered) {
                // Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…Ø³Ø¬Ù„ - Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                document.getElementById('regEmail').value = email;
                showStep('step4');
            }
            else { showErr('error1', data.message); }
            btn.disabled = false; btn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚';
        } catch(err) { showErr('error1', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); btn.disabled = false; btn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚'; }
    });

    function goToStep2() {
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step2').classList.add('active');
        startCountdown();
    }

    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯
    document.getElementById('codeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var code = document.getElementById('verifyCode').value.trim();
        var btn = document.getElementById('verifyBtn');
        if (!code || code.length !== 6 || !/^\d{6}$/.test(code)) { showErr('error2', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ 6 Ø£Ø±Ù‚Ø§Ù…'); return; }
        btn.disabled = true; btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
        hideMsg('error2'); hideMsg('success2');
        try {
            var url, body;
            if (currentEmail) { url = '/api/auth/login'; body = {email: currentEmail, code: code}; }
            else if (currentPhone) { url = '/api/auth/login-phone'; body = {phone: currentPhone, code: code, user_id: currentUserId || ''}; }
            else { url = '/verify'; body = {user_id: currentUserId, code: code}; }
            var res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
            var data = await res.json();
            if (data.success) {
                if (data.requires_2fa) {
                    showOk('success2', 'ğŸ” Ù…Ø·Ù„ÙˆØ¨ ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ©');
                    clearInterval(countdownInterval);
                    setTimeout(function() {
                        document.getElementById('step2').classList.remove('active');
                        document.getElementById('step3').classList.add('active');
                    }, 800);
                } else {
                    showOk('success2', 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚! Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„Ùƒ...');
                    clearInterval(countdownInterval);
                    setTimeout(function() { window.location.href = '/'; }, 1200);
                }
            } else { showErr('error2', data.message); btn.disabled = false; btn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„'; }
        } catch(err) { showErr('error2', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); btn.disabled = false; btn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„'; }
    });

    // 2FA
    document.getElementById('twoFAForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var code = document.getElementById('twoFACode').value.trim();
        var btn = document.getElementById('verify2FABtn');
        if (!code || code.length !== 6 || !/^\d{6}$/.test(code)) { showErr('error3', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ 6 Ø£Ø±Ù‚Ø§Ù…'); return; }
        btn.disabled = true; btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
        hideMsg('error3'); hideMsg('success3');
        try {
            var res = await fetch('/verify_2fa_login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({totp_code: code}) });
            var data = await res.json();
            if (data.success) {
                showOk('success3', 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚! Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„Ùƒ...');
                setTimeout(function() { window.location.href = '/'; }, 1200);
            } else { showErr('error3', data.message || 'Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­'); btn.disabled = false; btn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„'; }
        } catch(err) { showErr('error3', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„'); btn.disabled = false; btn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„'; }
    });

    function startCountdown() {
        secondsLeft = 120;
        updateCountdown();
        countdownInterval = setInterval(function() {
            secondsLeft--;
            updateCountdown();
            if (secondsLeft <= 0) {
                clearInterval(countdownInterval);
                showErr('error2', 'â° Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒÙˆØ¯');
                document.getElementById('verifyBtn').disabled = true;
            }
        }, 1000);
    }
    function updateCountdown() {
        var m = Math.floor(secondsLeft / 60);
        var s = secondsLeft % 60;
        document.getElementById('countdown').textContent = m + ':' + (s < 10 ? '0' : '') + s;
    }

    function goBack() {
        clearInterval(countdownInterval);
        document.getElementById('verifyCode').value = '';
        hideMsg('error1'); hideMsg('error2'); hideMsg('success2');
        document.getElementById('sendCodeBtn').disabled = false;
        document.getElementById('sendCodeBtn').textContent = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚';
        document.getElementById('sendCodeEmailBtn').disabled = false;
        document.getElementById('sendCodeEmailBtn').textContent = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚';
        document.getElementById('sendCodePhoneBtn').disabled = false;
        document.getElementById('sendCodePhoneBtn').textContent = 'ğŸ“² Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ ÙˆØ§ØªØ³Ø§Ø¨';
        document.getElementById('verifyBtn').disabled = false;
        document.getElementById('verifyBtn').textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        showStep('step1');
    }

    function goBackToStep1() {
        document.getElementById('twoFACode').value = '';
        document.getElementById('verifyCode').value = '';
        hideMsg('error1'); hideMsg('error3'); hideMsg('success3'); hideMsg('error4');
        document.getElementById('sendCodeBtn').disabled = false;
        document.getElementById('sendCodeBtn').textContent = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚';
        document.getElementById('sendCodeEmailBtn').disabled = false;
        document.getElementById('sendCodeEmailBtn').textContent = 'Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚';
        document.getElementById('sendCodePhoneBtn').disabled = false;
        document.getElementById('sendCodePhoneBtn').textContent = 'ğŸ“² Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ ÙˆØ§ØªØ³Ø§Ø¨';
        showStep('step1');
    }

    // Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
    ['userId','verifyCode','twoFACode','regVerifyCode'].forEach(function(id) {
        document.getElementById(id).addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    });

    // Ø¹Ø±Ø¶ Ø®Ø·ÙˆØ© Ù…Ø¹ÙŠÙ†Ø©
    function showStep(stepId) {
        document.querySelectorAll('.step').forEach(function(s) { s.classList.remove('active'); });
        document.getElementById(stepId).classList.add('active');
    }

    // ===== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ =====
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var name = document.getElementById('regName').value.trim();
        var phone = document.getElementById('regPhone').value.trim();
        var btn = document.getElementById('regSendCodeBtn');

        if (!name) { showErr('error4', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…'); return; }
        if (!phone) { showErr('error4', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„'); return; }

        btn.disabled = true; btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
        hideMsg('error4');
        try {
            var res = await fetch('/api/auth/register-send-code', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({name: name, phone: phone})
            });
            var data = await res.json();
            if (data.success) {
                isRegistering = true;
                currentPhone = phone;
                showStep('step5');
                startRegCountdown();
            } else {
                showErr('error4', data.message);
            }
            btn.disabled = false; btn.textContent = 'ğŸ“² Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ ÙˆØ§ØªØ³Ø§Ø¨';
        } catch(err) {
            showErr('error4', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            btn.disabled = false; btn.textContent = 'ğŸ“² Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ ÙˆØ§ØªØ³Ø§Ø¨';
        }
    });

    // ØªØ£ÙƒÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    document.getElementById('regCodeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var code = document.getElementById('regVerifyCode').value.trim();
        var btn = document.getElementById('regVerifyBtn');
        if (!code || code.length !== 6 || !/^\d{6}$/.test(code)) { showErr('error5', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ 6 Ø£Ø±Ù‚Ø§Ù…'); return; }

        btn.disabled = true; btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
        hideMsg('error5'); hideMsg('success5');
        try {
            var res = await fetch('/api/auth/register-verify', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({phone: currentPhone, code: code})
            });
            var data = await res.json();
            if (data.success) {
                clearInterval(regCountdownInterval);
                showOk('success5', 'ğŸ‰ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„Ùƒ...');
                setTimeout(function() { window.location.href = '/'; }, 1500);
            } else {
                showErr('error5', data.message);
                btn.disabled = false; btn.textContent = 'ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ğŸ‰';
            }
        } catch(err) {
            showErr('error5', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            btn.disabled = false; btn.textContent = 'ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ğŸ‰';
        }
    });

    // Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    function startRegCountdown() {
        regSecondsLeft = 120;
        updateRegCountdown();
        regCountdownInterval = setInterval(function() {
            regSecondsLeft--;
            updateRegCountdown();
            if (regSecondsLeft <= 0) {
                clearInterval(regCountdownInterval);
                showErr('error5', 'â° Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒÙˆØ¯');
                document.getElementById('regVerifyBtn').disabled = true;
            }
        }, 1000);
    }
    function updateRegCountdown() {
        var m = Math.floor(regSecondsLeft / 60);
        var s = regSecondsLeft % 60;
        document.getElementById('regCountdown').textContent = m + ':' + (s < 10 ? '0' : '') + s;
    }

    function goBackToStep4() {
        clearInterval(regCountdownInterval);
        document.getElementById('regVerifyCode').value = '';
        hideMsg('error5'); hideMsg('success5');
        document.getElementById('regVerifyBtn').disabled = false;
        document.getElementById('regVerifyBtn').textContent = 'ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ğŸ‰';
        showStep('step4');
    }

    function goToRegister() {
        hideMsg('error1');
        showStep('step4');
    }
</script>
    {% include 'partials/pwa_install.html' %}
</body>
</html>
