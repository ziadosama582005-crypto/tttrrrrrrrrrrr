{% extends "base.html" %}
{% block title %}Ø­Ø³Ø§Ø¨ÙŠ{% endblock %}

{% block content %}
<div class="profile-page">
    <div class="profile-container">

        <!-- ===== Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ===== -->
        <div class="user-hero">
            <div class="user-avatar">
                {% if profile_photo %}
                    <img src="{{ profile_photo }}" alt="ØµÙˆØ±Ø©">
                {% else %}
                    <div class="avatar-placeholder">{{ (user_name or 'Ù…')[0] }}</div>
                {% endif %}
            </div>
            <div class="user-details">
                <h1 class="user-display-name">{{ user_name or 'Ù…Ø³ØªØ®Ø¯Ù…' }}</h1>
                <div class="user-meta">
                    <span class="meta-chip" onclick="copyToClipboard('{{ user_id }}')">
                        <i class="fas fa-fingerprint"></i> {{ user_id }}
                        <i class="fas fa-copy copy-icon"></i>
                    </span>
                    {% if phone and phone_verified %}
                        <span class="meta-chip verified-chip">
                            <i class="fas fa-phone-alt"></i> {{ phone }}
                            <i class="fas fa-circle-check"></i>
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ===== Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯ ===== -->
        <div class="balance-card">
            <div class="balance-top">
                <div class="balance-label">
                    <i class="fas fa-wallet"></i>
                    <span>Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
                </div>
                <a href="/wallet" class="balance-link">Ø´Ø­Ù† <i class="fas fa-plus-circle"></i></a>
            </div>
            <div class="balance-amount">{{ "%.2f"|format(balance|float) }} <small>Ø±.Ø³</small></div>
            <div class="balance-footer">
                {% if frozen_balance > 0 %}
                    <div class="balance-detail frozen">
                        <i class="fas fa-snowflake"></i>
                        <span>Ù…Ø¬Ù…Ù‘Ø¯: {{ "%.2f"|format(frozen_balance|float) }} Ø±.Ø³</span>
                    </div>
                {% endif %}
                <div class="balance-detail available">
                    <i class="fas fa-check-circle"></i>
                    <span>Ù…ØªØ§Ø­ Ù„Ù„Ø³Ø­Ø¨: {{ "%.2f"|format(normal_withdraw_amount|float) }} Ø±.Ø³</span>
                </div>
            </div>
        </div>

        <!-- ===== Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© ===== -->
        <div class="actions-grid">
            <a href="/wallet" class="action-card">
                <div class="action-icon" style="background: rgba(0,255,136,0.12); color: #00ff88;">
                    <i class="fas fa-wallet"></i>
                </div>
                <span>Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
            </a>
            <a href="/my_purchases" class="action-card">
                <div class="action-icon" style="background: rgba(99,102,241,0.12); color: #6366f1;">
                    <i class="fas fa-bag-shopping"></i>
                </div>
                <span>Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ</span>
            </a>
            <a href="/withdraw" class="action-card">
                <div class="action-icon" style="background: rgba(245,158,11,0.12); color: #f59e0b;">
                    <i class="fas fa-money-bill-transfer"></i>
                </div>
                <span>Ø³Ø­Ø¨</span>
            </a>
            <a href="/contact-us" class="action-card">
                <div class="action-icon" style="background: rgba(236,72,153,0.12); color: #ec4899;">
                    <i class="fas fa-headset"></i>
                </div>
                <span>Ø§Ù„Ø¯Ø¹Ù…</span>
            </a>
        </div>

        <!-- ===== Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚ ===== -->
        <div class="section-block">
            <div class="section-header">
                <div class="section-title-group">
                    <i class="fas fa-shield-halved"></i>
                    <h2>Ø§Ù„Ø£Ù…Ø§Ù†</h2>
                </div>
                <div class="security-score">
                    {% set score = 0 %}
                    {% if phone_verified %}{% set score = score + 50 %}{% endif %}
                    {% if totp_enabled %}{% set score = score + 50 %}{% endif %}
                    <div class="score-bar">
                        <div class="score-fill {% if score >= 100 %}full{% elif score >= 50 %}half{% else %}low{% endif %}" style="width: {{ score }}%"></div>
                    </div>
                    <span class="score-label">{{ score }}%</span>
                </div>
            </div>

            <!-- ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¬ÙˆØ§Ù„ -->
            <div class="security-item">
                <div class="security-left">
                    <div class="sec-icon {% if phone_verified %}done{% endif %}">
                        <i class="fas fa-mobile-screen-button"></i>
                    </div>
                    <div class="sec-text">
                        <h3>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</h3>
                        <p>{% if phone_verified %}{{ phone }} â€” Ù…ÙˆØ«Ù‘Ù‚{% elif phone %}{{ phone }} â€” Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙˆØ«ÙŠÙ‚{% else %}Ù„Ù… ÙŠÙØ¶Ù Ø¨Ø¹Ø¯{% endif %}</p>
                    </div>
                </div>
                <div class="security-right">
                    {% if phone_verified %}
                        <span class="badge-ok"><i class="fas fa-circle-check"></i></span>
                    {% else %}
                        <button class="sec-btn" onclick="openPhoneModal()">
                            {% if phone %}ØªÙˆØ«ÙŠÙ‚{% else %}Ø¥Ø¶Ø§ÙØ©{% endif %}
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ© -->
            <div class="security-item">
                <div class="security-left">
                    <div class="sec-icon {% if totp_enabled %}done{% endif %}">
                        <i class="fas fa-lock"></i>
                    </div>
                    <div class="sec-text">
                        <h3>Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ© (2FA)</h3>
                        <p>{% if totp_enabled %}Ù…ÙØ¹Ù‘Ù„Ø© â€” Google Authenticator{% else %}Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ø¨Ø± ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©{% endif %}</p>
                    </div>
                </div>
                <div class="security-right">
                    {% if totp_enabled %}
                        <span class="badge-ok"><i class="fas fa-circle-check"></i></span>
                        <button class="sec-btn danger-ghost" onclick="openDisable2FAModal()">ØªØ¹Ø·ÙŠÙ„</button>
                    {% else %}
                        <button class="sec-btn" onclick="openSetup2FAModal()">ØªÙØ¹ÙŠÙ„</button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ===== Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ ===== -->
        <div class="section-block">
            <div class="section-header">
                <div class="section-title-group">
                    <i class="fas fa-circle-info"></i>
                    <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h2>
                </div>
            </div>

            <div class="info-rows">
                <div class="info-row">
                    <span class="info-key"><i class="fas fa-user"></i> Ø§Ù„Ø§Ø³Ù…</span>
                    <span class="info-val">{{ user_name or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-key"><i class="fas fa-fingerprint"></i> Ø§Ù„Ù…Ø¹Ø±Ù</span>
                    <span class="info-val copyable-row" onclick="copyToClipboard('{{ user_id }}')">
                        <code>{{ user_id }}</code>
                        <i class="fas fa-copy"></i>
                    </span>
                </div>
                {% if phone %}
                <div class="info-row">
                    <span class="info-key"><i class="fas fa-phone"></i> Ø§Ù„Ø¬ÙˆØ§Ù„</span>
                    <span class="info-val">{{ phone }}
                        {% if phone_verified %}<i class="fas fa-circle-check" style="color:#00ff88; font-size:12px; margin-right:4px;"></i>{% endif %}
                    </span>
                </div>
                {% endif %}
                {% if email %}
                <div class="info-row">
                    <span class="info-key"><i class="fas fa-envelope"></i> Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</span>
                    <span class="info-val">{{ email }}</span>
                </div>
                {% endif %}
                <div class="info-row">
                    <span class="info-key"><i class="fas fa-calendar-days"></i> Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</span>
                    <span class="info-val">{{ join_date or 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-key"><i class="fas fa-right-to-bracket"></i> Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</span>
                    <span class="info-val">
                        {% if registered_via == 'whatsapp' %}ğŸ“² ÙˆØ§ØªØ³Ø§Ø¨
                        {% elif registered_via == 'email' %}ğŸ“§ Ø¥ÙŠÙ…ÙŠÙ„
                        {% else %}ğŸ¤– ØªÙ„ØºØ±Ø§Ù…{% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- ===== Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª ===== -->
        {% if orders %}
        <div class="section-block">
            <div class="section-header">
                <div class="section-title-group">
                    <i class="fas fa-clock-rotate-left"></i>
                    <h2>Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
                </div>
                <a href="/my_purchases" class="see-all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ <i class="fas fa-arrow-left"></i></a>
            </div>
            <div class="orders-list">
                {% for order in orders %}
                <div class="order-row">
                    <div class="order-info">
                        <span class="order-product">{{ order.product_name or 'Ù…Ù†ØªØ¬' }}</span>
                        <span class="order-date">{{ order.date }}</span>
                    </div>
                    <span class="order-price">{{ order.total_price }} Ø±.Ø³</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ===== -->
        <button class="logout-btn" onclick="if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) window.location.href='/logout'">
            <i class="fas fa-right-from-bracket"></i>
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        </button>

    </div>
</div>

<!-- ===== Ù…ÙˆØ¯Ø§Ù„ ØªÙˆØ«ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ===== -->
<div class="modal-overlay" id="phoneModal">
    <div class="modal-box">
        <button class="modal-x" onclick="closePhoneModal()"><i class="fas fa-xmark"></i></button>
        <div class="modal-top">
            <div class="modal-emoji">ğŸ“±</div>
            <h2>ØªÙˆØ«ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</h2>
            <p>Ø£Ø¶Ù Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ Ù„ØªØ£Ù…ÙŠÙ† Ø­Ø³Ø§Ø¨Ùƒ</p>
        </div>
        <div class="modal-warn">
            <i class="fas fa-triangle-exclamation"></i>
            Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆØ«ÙŠÙ‚
        </div>
        <div id="phoneError" class="modal-alert error"></div>
        <div id="phoneSuccess" class="modal-alert success"></div>
        <div id="phoneStep1" class="modal-form">
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
            <input type="tel" id="phoneInput" placeholder="05xxxxxxxx" dir="ltr" maxlength="10" inputmode="tel">
            <small>ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù…</small>
        </div>
        <div id="phoneStep2" class="modal-form" style="display:none;">
            <label>ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ (6 Ø£Ø±Ù‚Ø§Ù…)</label>
            <input type="text" id="phoneCodeInput" class="otp-input" placeholder="------" maxlength="6" inputmode="numeric">
            <small>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¹Ø¨Ø± Telegram</small>
        </div>
        <div class="modal-btns">
            <button class="m-btn ghost" onclick="closePhoneModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="m-btn primary" id="phoneStep1Btn" onclick="sendPhoneCode()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯</button>
            <button class="m-btn primary" id="phoneStep2Btn" onclick="verifyPhoneCode()" style="display:none;">ØªØ£ÙƒÙŠØ¯</button>
        </div>
    </div>
</div>

<!-- ===== Ù…ÙˆØ¯Ø§Ù„ ØªÙØ¹ÙŠÙ„ 2FA ===== -->
<div class="modal-overlay" id="setup2FAModal">
    <div class="modal-box">
        <button class="modal-x" onclick="closeSetup2FAModal()"><i class="fas fa-xmark"></i></button>
        <div class="modal-top">
            <div class="modal-emoji">ğŸ”</div>
            <h2>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ©</h2>
            <p>Ø§Ø³ØªØ®Ø¯Ù… Google Authenticator</p>
        </div>
        <div id="2faLoading" class="modal-loading">
            <i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
        </div>
        <div id="2faContent" style="display:none;">
            <div class="steps-info">
                <div class="step-item"><span>1</span> Ø­Ù…Ù‘Ù„ Google Authenticator</div>
                <div class="step-item"><span>2</span> Ø§Ù…Ø³Ø­ Ø±Ù…Ø² QR Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙØªØ§Ø­</div>
                <div class="step-item"><span>3</span> Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>
            </div>
            <div class="qr-box">
                <img id="qrCodeImg" src="" alt="QR">
            </div>
            <div class="secret-box" onclick="copySecret()">
                <code id="secretKey"></code>
                <small><i class="fas fa-copy"></i> Ø§Ù†Ù‚Ø± Ù„Ù„Ù†Ø³Ø®</small>
            </div>
            <div id="2faError" class="modal-alert error"></div>
            <div class="modal-form">
                <label>ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</label>
                <input type="text" id="totpCode" class="otp-input" placeholder="------" maxlength="6" inputmode="numeric">
            </div>
        </div>
        <div class="modal-btns">
            <button class="m-btn ghost" onclick="closeSetup2FAModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="m-btn primary" onclick="verify2FASetup()">ØªÙØ¹ÙŠÙ„</button>
        </div>
    </div>
</div>

<!-- ===== Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø·ÙŠÙ„ 2FA ===== -->
<div class="modal-overlay" id="disable2FAModal">
    <div class="modal-box">
        <button class="modal-x" onclick="closeDisable2FAModal()"><i class="fas fa-xmark"></i></button>
        <div class="modal-top">
            <div class="modal-emoji">âš ï¸</div>
            <h2>ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ©</h2>
            <p>Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„ØªØ£ÙƒÙŠØ¯</p>
        </div>
        <div id="disable2faError" class="modal-alert error"></div>
        <div class="modal-form">
            <label>ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</label>
            <input type="text" id="disableCode" class="otp-input" placeholder="------" maxlength="6" inputmode="numeric">
        </div>
        <div class="modal-btns">
            <button class="m-btn ghost" onclick="closeDisable2FAModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="m-btn danger" onclick="disable2FA()">ØªØ¹Ø·ÙŠÙ„</button>
        </div>
    </div>
</div>

<!-- ===== Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø³Ø® ===== -->
<div id="copyToast" class="copy-toast">ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…</div>

<style>
/* ===== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ===== */
:root {
    --accent: #00ff88;
    --accent-dim: rgba(0,255,136,0.12);
    --bg-card: rgba(17,17,30,0.85);
    --bg-card2: rgba(24,24,42,0.9);
    --border: rgba(255,255,255,0.06);
    --text1: #f0f0f5;
    --text2: #8b8ba3;
    --text3: #5a5a72;
    --danger: #ef4444;
    --radius: 16px;
    --radius-sm: 10px;
}

/* ===== ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ===== */
.profile-page {
    min-height: 100vh;
    padding: 16px;
    padding-bottom: 100px;
}

.profile-container {
    max-width: 600px;
    margin: 0 auto;
}

/* ===== Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ===== */
.user-hero {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 24px 20px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
}

.user-hero::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), #6366f1, var(--accent));
    background-size: 200% 100%;
    animation: shimmer 3s linear infinite;
}

@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.user-avatar { position: relative; flex-shrink: 0; }

.user-avatar img {
    width: 64px; height: 64px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--accent);
}

.avatar-placeholder {
    width: 64px; height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6366f1, var(--accent));
    display: flex; align-items: center; justify-content: center;
    font-size: 28px; font-weight: 700; color: #fff;
}

.user-details { min-width: 0; }

.user-display-name {
    font-size: 22px; font-weight: 700;
    color: var(--text1); margin: 0 0 8px;
}

.user-meta { display: flex; flex-wrap: wrap; gap: 8px; }

.meta-chip {
    display: inline-flex; align-items: center; gap: 5px;
    font-size: 11px; color: var(--text2);
    background: rgba(255,255,255,0.05);
    padding: 4px 10px; border-radius: 20px;
    cursor: pointer; transition: all 0.2s;
}

.meta-chip:hover { background: rgba(255,255,255,0.1); }
.meta-chip .copy-icon { font-size: 9px; opacity: 0.4; }
.meta-chip.verified-chip { color: var(--accent); background: var(--accent-dim); }
.meta-chip.verified-chip .fa-circle-check { font-size: 10px; }

/* ===== Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯ ===== */
.balance-card {
    background: linear-gradient(135deg, #0f1628 0%, #131b30 50%, #0d1420 100%);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 22px 20px;
    margin-bottom: 16px;
    position: relative; overflow: hidden;
}

.balance-card::after {
    content: '';
    position: absolute; top: -40px; left: -40px;
    width: 120px; height: 120px;
    background: radial-gradient(circle, rgba(0,255,136,0.08), transparent 70%);
    pointer-events: none;
}

.balance-top {
    display: flex; justify-content: space-between;
    align-items: center; margin-bottom: 10px;
}

.balance-label {
    display: flex; align-items: center; gap: 8px;
    color: var(--text2); font-size: 13px;
}

.balance-label i { color: var(--accent); }

.balance-link {
    font-size: 12px; color: var(--accent);
    text-decoration: none;
    display: flex; align-items: center; gap: 5px;
    padding: 5px 12px; border-radius: 20px;
    background: var(--accent-dim); transition: all 0.2s;
}

.balance-link:hover { background: rgba(0,255,136,0.2); }

.balance-amount {
    font-size: 36px; font-weight: 800;
    color: var(--text1); letter-spacing: -1px;
    position: relative; z-index: 1;
}

.balance-amount small {
    font-size: 16px; font-weight: 500;
    color: var(--text2); margin-right: 4px;
}

.balance-footer {
    display: flex; flex-wrap: wrap; gap: 12px;
    margin-top: 14px; padding-top: 14px;
    border-top: 1px solid var(--border);
}

.balance-detail {
    display: flex; align-items: center;
    gap: 6px; font-size: 12px;
}

.balance-detail.frozen { color: #f59e0b; }
.balance-detail.available { color: var(--accent); }

/* ===== Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© ===== */
.actions-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px; margin-bottom: 16px;
}

.action-card {
    display: flex; flex-direction: column;
    align-items: center; gap: 8px;
    padding: 16px 8px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    text-decoration: none;
    color: var(--text2); transition: all 0.2s;
}

.action-card:hover {
    border-color: rgba(255,255,255,0.12);
    transform: translateY(-2px);
    color: var(--text1);
}

.action-icon {
    width: 42px; height: 42px;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
}

.action-card span { font-size: 11px; font-weight: 500; }

/* ===== Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ===== */
.section-block {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px; margin-bottom: 16px;
}

.section-header {
    display: flex; justify-content: space-between;
    align-items: center; margin-bottom: 18px;
}

.section-title-group {
    display: flex; align-items: center; gap: 10px;
}

.section-title-group i { color: var(--accent); font-size: 16px; }

.section-title-group h2 {
    color: var(--text1); font-size: 16px;
    font-weight: 700; margin: 0;
}

.see-all {
    font-size: 12px; color: var(--accent);
    text-decoration: none;
    display: flex; align-items: center; gap: 4px;
}

/* ===== Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ù…Ø§Ù† ===== */
.security-score {
    display: flex; align-items: center; gap: 8px;
}

.score-bar {
    width: 60px; height: 6px;
    background: rgba(255,255,255,0.06);
    border-radius: 3px; overflow: hidden;
}

.score-fill {
    height: 100%; border-radius: 3px;
    transition: width 0.5s;
}

.score-fill.full { background: var(--accent); }
.score-fill.half { background: #f59e0b; }
.score-fill.low { background: var(--danger); }

.score-label { font-size: 12px; font-weight: 700; color: var(--text2); }

/* ===== Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ù…Ø§Ù† ===== */
.security-item {
    display: flex; justify-content: space-between;
    align-items: center; padding: 14px;
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-bottom: 10px;
}

.security-item:last-child { margin-bottom: 0; }

.security-left {
    display: flex; align-items: center;
    gap: 12px; min-width: 0;
}

.sec-icon {
    width: 40px; height: 40px;
    border-radius: 10px;
    background: rgba(99,102,241,0.12);
    color: #6366f1;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0;
}

.sec-icon.done { background: var(--accent-dim); color: var(--accent); }

.sec-text h3 {
    color: var(--text1); font-size: 14px;
    font-weight: 600; margin: 0 0 2px;
}

.sec-text p { color: var(--text3); font-size: 12px; margin: 0; }

.security-right {
    display: flex; align-items: center;
    gap: 8px; flex-shrink: 0;
}

.badge-ok { color: var(--accent); font-size: 20px; }

.sec-btn {
    padding: 7px 16px; border-radius: 8px;
    border: 1px solid var(--accent);
    background: transparent; color: var(--accent);
    font-family: inherit; font-size: 12px;
    font-weight: 600; cursor: pointer; transition: all 0.2s;
}

.sec-btn:hover { background: var(--accent); color: #000; }

.sec-btn.danger-ghost {
    border-color: rgba(239,68,68,0.4); color: var(--danger);
}

.sec-btn.danger-ghost:hover {
    background: var(--danger); color: #fff;
    border-color: var(--danger);
}

/* ===== Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ ===== */
.info-rows { display: flex; flex-direction: column; }

.info-row {
    display: flex; justify-content: space-between;
    align-items: center; padding: 13px 0;
    border-bottom: 1px solid var(--border);
}

.info-row:last-child { border-bottom: none; }

.info-key {
    font-size: 13px; color: var(--text2);
    display: flex; align-items: center; gap: 8px;
}

.info-key i {
    width: 16px; text-align: center;
    color: var(--text3); font-size: 13px;
}

.info-val { font-size: 13px; color: var(--text1); font-weight: 500; }

.copyable-row {
    cursor: pointer;
    display: flex; align-items: center; gap: 6px;
    transition: color 0.2s;
}

.copyable-row:hover { color: var(--accent); }

.copyable-row code {
    background: rgba(255,255,255,0.05);
    padding: 2px 8px; border-radius: 4px; font-size: 12px;
}

.copyable-row .fa-copy { font-size: 11px; opacity: 0.4; }

/* ===== Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª ===== */
.order-row {
    display: flex; justify-content: space-between;
    align-items: center; padding: 12px 0;
    border-bottom: 1px solid var(--border);
}

.order-row:last-child { border-bottom: none; }

.order-info { display: flex; flex-direction: column; gap: 2px; }
.order-product { font-size: 13px; color: var(--text1); font-weight: 500; }
.order-date { font-size: 11px; color: var(--text3); }
.order-price { font-size: 13px; color: var(--accent); font-weight: 700; }

/* ===== Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ===== */
.logout-btn {
    width: 100%; padding: 14px;
    background: rgba(239,68,68,0.08);
    border: 1px solid rgba(239,68,68,0.2);
    border-radius: var(--radius-sm);
    color: var(--danger); font-family: inherit;
    font-size: 14px; font-weight: 600;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    gap: 8px; transition: all 0.2s;
    margin-bottom: 20px;
}

.logout-btn:hover {
    background: rgba(239,68,68,0.15);
    border-color: rgba(239,68,68,0.4);
}

/* ===== Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª ===== */
.modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center; justify-content: center;
    padding: 20px;
}

.modal-overlay.show { display: flex; }

.modal-box {
    background: #13132a;
    border: 1px solid var(--border);
    border-radius: 20px;
    width: 100%; max-width: 400px;
    max-height: 90vh; overflow-y: auto;
    position: relative; padding: 28px 24px 24px;
}

.modal-x {
    position: absolute; top: 14px; left: 14px;
    background: rgba(255,255,255,0.06);
    border: none; color: var(--text3);
    width: 32px; height: 32px; border-radius: 50%;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; transition: all 0.2s;
}

.modal-x:hover { background: rgba(239,68,68,0.15); color: var(--danger); }

.modal-top { text-align: center; margin-bottom: 20px; }
.modal-emoji { font-size: 40px; margin-bottom: 10px; }

.modal-top h2 { color: var(--text1); font-size: 18px; margin: 0 0 6px; }
.modal-top p { color: var(--text3); font-size: 13px; margin: 0; }

.modal-warn {
    background: rgba(245,158,11,0.1);
    border: 1px solid rgba(245,158,11,0.2);
    border-radius: 10px; padding: 10px 14px;
    text-align: center; color: #f59e0b;
    font-size: 12px; margin-bottom: 18px;
    display: flex; align-items: center; justify-content: center; gap: 8px;
}

.modal-alert {
    padding: 10px 14px; border-radius: 8px;
    font-size: 13px; margin-bottom: 14px; display: none;
}

.modal-alert.error {
    background: rgba(239,68,68,0.1); color: var(--danger);
    border: 1px solid rgba(239,68,68,0.2);
}

.modal-alert.success {
    background: var(--accent-dim); color: var(--accent);
    border: 1px solid rgba(0,255,136,0.2);
}

.modal-form { margin-bottom: 16px; }

.modal-form label {
    display: block; color: var(--text2);
    font-size: 13px; margin-bottom: 8px; font-weight: 500;
}

.modal-form input {
    width: 100%; padding: 13px 14px;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text1); font-size: 15px;
    font-family: inherit; transition: border-color 0.2s;
    box-sizing: border-box;
}

.modal-form input:focus { outline: none; border-color: var(--accent); }

.modal-form small {
    display: block; margin-top: 6px;
    color: var(--text3); font-size: 11px;
}

.otp-input {
    text-align: center !important;
    letter-spacing: 10px;
    font-size: 24px !important; font-weight: 700;
}

.modal-btns { display: flex; gap: 10px; margin-top: 4px; }

.m-btn {
    flex: 1; padding: 13px;
    border-radius: var(--radius-sm);
    border: none; font-family: inherit;
    font-size: 14px; font-weight: 600;
    cursor: pointer; transition: all 0.2s;
}

.m-btn.ghost { background: rgba(255,255,255,0.06); color: var(--text2); }
.m-btn.ghost:hover { background: rgba(255,255,255,0.1); }

.m-btn.primary { background: var(--accent); color: #000; }
.m-btn.primary:hover { filter: brightness(1.1); transform: translateY(-1px); }

.m-btn.danger { background: var(--danger); color: #fff; }
.m-btn.danger:hover { filter: brightness(1.1); }

.modal-loading {
    text-align: center; padding: 30px;
    color: var(--text3); font-size: 14px;
}

.modal-loading i {
    font-size: 24px; color: var(--accent);
    display: block; margin-bottom: 10px;
}

/* ===== 2FA ===== */
.steps-info {
    display: flex; flex-direction: column; gap: 8px;
    margin-bottom: 18px; padding: 14px;
    background: rgba(99,102,241,0.08);
    border-radius: var(--radius-sm);
}

.step-item {
    display: flex; align-items: center; gap: 10px;
    font-size: 13px; color: var(--text2);
}

.step-item span {
    width: 22px; height: 22px; border-radius: 50%;
    background: rgba(99,102,241,0.2); color: #818cf8;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; flex-shrink: 0;
}

.qr-box { text-align: center; margin: 16px 0; }

.qr-box img {
    background: #fff; padding: 12px;
    border-radius: 12px; max-width: 160px;
}

.secret-box {
    text-align: center; padding: 12px;
    background: rgba(0,0,0,0.3);
    border-radius: 8px; cursor: pointer;
    transition: all 0.2s; margin-bottom: 16px;
}

.secret-box:hover { background: rgba(99,102,241,0.15); }

.secret-box code {
    font-size: 13px; color: var(--text1); letter-spacing: 2px;
}

.secret-box small {
    display: block; margin-top: 4px;
    color: #818cf8; font-size: 11px;
}

/* ===== Toast ===== */
.copy-toast {
    position: fixed; bottom: 80px; left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--accent); color: #000;
    padding: 10px 24px; border-radius: 24px;
    font-size: 13px; font-weight: 600;
    opacity: 0; pointer-events: none;
    transition: all 0.3s; z-index: 2000;
}

.copy-toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

/* ===== Responsive ===== */
@media (max-width: 500px) {
    .user-hero { flex-direction: column; text-align: center; padding: 20px 16px; }
    .user-meta { justify-content: center; }
    .balance-amount { font-size: 30px; }
    .actions-grid { grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .action-icon { width: 36px; height: 36px; font-size: 15px; }
    .action-card { padding: 12px 6px; }
    .action-card span { font-size: 10px; }
    .security-item { flex-direction: column; gap: 12px; text-align: center; }
    .security-left { flex-direction: column; align-items: center; }
    .section-block { padding: 16px; }
    .modal-box { padding: 22px 18px 20px; }
}
</style>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        var toast = document.getElementById('copyToast');
        toast.classList.add('show');
        setTimeout(function() { toast.classList.remove('show'); }, 1800);
    });
}

// ===== Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬ÙˆØ§Ù„ =====
function openPhoneModal() {
    document.getElementById('phoneModal').classList.add('show');
}

function closePhoneModal() {
    document.getElementById('phoneModal').classList.remove('show');
    document.getElementById('phoneError').style.display = 'none';
    document.getElementById('phoneSuccess').style.display = 'none';
    document.getElementById('phoneStep1').style.display = 'block';
    document.getElementById('phoneStep2').style.display = 'none';
    document.getElementById('phoneStep1Btn').style.display = 'block';
    document.getElementById('phoneStep2Btn').style.display = 'none';
    document.getElementById('phoneInput').value = '';
    document.getElementById('phoneCodeInput').value = '';
}

async function sendPhoneCode() {
    var phone = document.getElementById('phoneInput').value.trim();
    var btn = document.getElementById('phoneStep1Btn');
    var errorDiv = document.getElementById('phoneError');
    var successDiv = document.getElementById('phoneSuccess');

    var clean = phone.replace(/[\s\-\+]/g, '');
    if (!clean.match(/^(05\d{8}|5\d{8}|9665\d{8})$/)) {
        errorDiv.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ ØµØ­ÙŠØ­ (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05)';
        errorDiv.style.display = 'block';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
    errorDiv.style.display = 'none';

    try {
        var res = await fetch('/api/send_phone_code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phone })
        });
        var data = await res.json();

        if (data.success) {
            successDiv.textContent = 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚';
            successDiv.style.display = 'block';
            document.getElementById('phoneStep1').style.display = 'none';
            document.getElementById('phoneStep2').style.display = 'block';
            document.getElementById('phoneStep1Btn').style.display = 'none';
            document.getElementById('phoneStep2Btn').style.display = 'block';
        } else {
            errorDiv.textContent = data.message;
            errorDiv.style.display = 'block';
        }
    } catch (e) {
        errorDiv.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
        errorDiv.style.display = 'block';
    }

    btn.disabled = false;
    btn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯';
}

async function verifyPhoneCode() {
    var code = document.getElementById('phoneCodeInput').value.trim();
    var btn = document.getElementById('phoneStep2Btn');
    var errorDiv = document.getElementById('phoneError');
    var successDiv = document.getElementById('phoneSuccess');

    if (!code || code.length !== 6) {
        errorDiv.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ 6 Ø£Ø±Ù‚Ø§Ù…';
        errorDiv.style.display = 'block';
        successDiv.style.display = 'none';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
    errorDiv.style.display = 'none';

    try {
        var res = await fetch('/api/verify_phone_code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
        });
        var data = await res.json();

        if (data.success) {
            successDiv.textContent = 'âœ… ØªÙ… ØªÙˆØ«ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!';
            successDiv.style.display = 'block';
            setTimeout(function() { location.reload(); }, 1200);
        } else {
            errorDiv.textContent = data.message;
            errorDiv.style.display = 'block';
        }
    } catch (e) {
        errorDiv.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
        errorDiv.style.display = 'block';
    }

    btn.disabled = false;
    btn.textContent = 'ØªØ£ÙƒÙŠØ¯';
}

// ===== Ù…ÙˆØ¯Ø§Ù„ 2FA =====
function openSetup2FAModal() {
    var modal = document.getElementById('setup2FAModal');
    modal.classList.add('show');
    document.getElementById('2faLoading').style.display = 'block';
    document.getElementById('2faContent').style.display = 'none';

    fetch('/api/setup_2fa', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                document.getElementById('qrCodeImg').src = data.qr_code;
                document.getElementById('secretKey').textContent = data.secret;
                document.getElementById('2faLoading').style.display = 'none';
                document.getElementById('2faContent').style.display = 'block';
            }
        })
        .catch(function() {
            alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            closeSetup2FAModal();
        });
}

function closeSetup2FAModal() {
    document.getElementById('setup2FAModal').classList.remove('show');
    document.getElementById('totpCode').value = '';
    document.getElementById('2faError').style.display = 'none';
}

function copySecret() {
    var secret = document.getElementById('secretKey').textContent;
    copyToClipboard(secret);
}

async function verify2FASetup() {
    var code = document.getElementById('totpCode').value.trim();
    var errorDiv = document.getElementById('2faError');

    if (!code || code.length !== 6) {
        errorDiv.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ 6 Ø£Ø±Ù‚Ø§Ù…';
        errorDiv.style.display = 'block';
        return;
    }

    try {
        var res = await fetch('/api/verify_2fa_setup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
        });
        var data = await res.json();

        if (data.success) {
            var toast = document.getElementById('copyToast');
            toast.textContent = 'âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ 2FA Ø¨Ù†Ø¬Ø§Ø­!';
            toast.classList.add('show');
            setTimeout(function() { location.reload(); }, 1200);
        } else {
            errorDiv.textContent = data.message;
            errorDiv.style.display = 'block';
        }
    } catch (e) {
        errorDiv.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
        errorDiv.style.display = 'block';
    }
}

function openDisable2FAModal() {
    document.getElementById('disable2FAModal').classList.add('show');
}

function closeDisable2FAModal() {
    document.getElementById('disable2FAModal').classList.remove('show');
    document.getElementById('disableCode').value = '';
    document.getElementById('disable2faError').style.display = 'none';
}

async function disable2FA() {
    var code = document.getElementById('disableCode').value.trim();
    var errorDiv = document.getElementById('disable2faError');

    if (!code || code.length !== 6) {
        errorDiv.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ 6 Ø£Ø±Ù‚Ø§Ù…';
        errorDiv.style.display = 'block';
        return;
    }

    try {
        var res = await fetch('/api/disable_2fa', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
        });
        var data = await res.json();

        if (data.success) {
            var toast = document.getElementById('copyToast');
            toast.textContent = 'âœ… ØªÙ… ØªØ¹Ø·ÙŠÙ„ 2FA';
            toast.classList.add('show');
            setTimeout(function() { location.reload(); }, 1200);
        } else {
            errorDiv.textContent = data.message;
            errorDiv.style.display = 'block';
        }
    } catch (e) {
        errorDiv.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
        errorDiv.style.display = 'block';
    }
}
</script>
{% endblock %}
