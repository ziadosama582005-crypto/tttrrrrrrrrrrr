{% extends "admin_base.html" %}

{% block title %}Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endblock %}

{% block content %}
<div class="top-bar">
    <h1>ğŸ›’ Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h1>
    <div class="top-bar-actions">
        <button class="btn btn-secondary" onclick="loadCarts()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    </div>
</div>

<!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="icon">ğŸ›’</div>
        <div class="value" id="totalCarts">-</div>
        <div class="label">Ø³Ù„Ø§Øª Ù†Ø´Ø·Ø©</div>
    </div>
    <div class="stat-card">
        <div class="icon">ğŸ“¦</div>
        <div class="value" id="totalItems">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
    </div>
    <div class="stat-card">
        <div class="icon">ğŸ’°</div>
        <div class="value" id="totalValue">-</div>
        <div class="label">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div>
    </div>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Øª -->
<div class="card">
    <div class="card-header">
        <span class="card-title">ğŸ“‹ Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</span>
        <span id="cartsCountLabel" style="color: var(--muted); font-size: 13px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
                    <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                    <th>ØªÙ†ØªÙ‡ÙŠ ÙÙŠ</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
            </thead>
            <tbody id="cartsTable">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadCarts() {
        const tbody = document.getElementById('cartsTable');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></td></tr>';
        
        try {
            const res = await fetch('/api/admin/get_carts');
            const data = await res.json();
            
            if (data.status === 'success') {
                const carts = data.carts || [];
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                let totalItems = 0, totalValue = 0;
                carts.forEach(c => {
                    totalItems += c.items_count || 0;
                    totalValue += c.total_value || 0;
                });
                
                document.getElementById('totalCarts').textContent = carts.length;
                document.getElementById('totalItems').textContent = totalItems;
                document.getElementById('totalValue').textContent = totalValue.toFixed(2) + ' Ø±.Ø³';
                document.getElementById('cartsCountLabel').textContent = `${carts.length} Ø³Ù„Ø©`;
                
                if (carts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--muted);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ù„Ø§Øª Ù†Ø´Ø·Ø©</td></tr>';
                    return;
                }
                
                tbody.innerHTML = carts.map(c => {
                    const createdAt = c.created_at ? new Date(c.created_at).toLocaleString('ar-SA') : '-';
                    const expiresAt = c.expires_at ? new Date(c.expires_at) : null;
                    const now = new Date();
                    const isExpired = expiresAt && expiresAt < now;
                    
                    let expiresText = '-';
                    if (expiresAt) {
                        const diff = expiresAt - now;
                        if (diff > 0) {
                            const hours = Math.floor(diff / (1000 * 60 * 60));
                            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                            expiresText = `${hours}Ø³ ${mins}Ø¯`;
                        } else {
                            expiresText = 'Ù…Ù†ØªÙ‡ÙŠØ©';
                        }
                    }
                    
                    const statusBadge = isExpired
                        ? '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(231,76,60,0.2); color: var(--danger);">âŒ Ù…Ù†ØªÙ‡ÙŠØ©</span>'
                        : '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(0,184,148,0.2); color: var(--success);">âœ… Ù†Ø´Ø·Ø©</span>';
                    
                    return `
                        <tr>
                            <td style="font-family: monospace;">#${c.user_id || '-'}</td>
                            <td>${c.items_count || 0}</td>
                            <td style="color: var(--success); font-weight: 600;">${(c.total_value || 0).toFixed(2)} Ø±.Ø³</td>
                            <td style="font-size: 12px; color: var(--muted);">${createdAt}</td>
                            <td style="font-size: 12px; color: ${isExpired ? 'var(--danger)' : 'var(--warning)'};">${expiresText}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #e74c3c;">âŒ ' + (data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£') + '</td></tr>';
            }
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #e74c3c;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</td></tr>';
        }
    }

    loadCarts();
    // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
    setInterval(loadCarts, 30000);
</script>
{% endblock %}
