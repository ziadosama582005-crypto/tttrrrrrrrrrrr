{% extends "admin_base.html" %}

{% block title %}Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endblock %}

{% block content %}
<div class="top-bar">
    <h1> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
    <div class="top-bar-actions">
        <button class="btn btn-secondary" onclick="loadOrders()"> ØªØ­Ø¯ÙŠØ«</button>
    </div>
</div>

<!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="totalOrders">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
    </div>
    <div class="stat-card" style="border-color: var(--success);">
        <div class="icon"></div>
        <div class="value" id="completedOrders" style="color: var(--success);">-</div>
        <div class="label">Ù…ÙƒØªÙ…Ù„Ø©</div>
    </div>
    <div class="stat-card" style="border-color: var(--warning);">
        <div class="icon">â³</div>
        <div class="value" id="pendingOrders" style="color: var(--warning);">-</div>
        <div class="label">Ù…Ø¹Ù„Ù‚Ø©</div>
    </div>
    <div class="stat-card">
        <div class="icon"></div>
        <div class="value" id="totalRevenue">-</div>
        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
    </div>
</div>

<!-- Ø§Ù„ÙÙ„ØªØ±Ø© -->
<div class="card">
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <select id="statusFilter" style="padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: white;">
            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="pending">â³ Ù…Ø¹Ù„Ù‚Ø©</option>
            <option value="completed"> Ù…ÙƒØªÙ…Ù„Ø©</option>
        </select>
        <select id="deliveryFilter" style="padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: white;">
            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
            <option value="instant"> ÙÙˆØ±ÙŠ</option>
            <option value="manual">ğŸ‘¨â€ğŸ’¼ ÙŠØ¯ÙˆÙŠ</option>
        </select>
        <input type="text" id="searchInput" placeholder=" Ø¨Ø­Ø«..." 
               style="flex: 1; min-width: 150px; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: white;">
    </div>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
<div class="card">
    <div class="card-header">
        <span class="card-title"> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
        <span id="ordersCountLabel" style="color: var(--muted); font-size: 13px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                    <th>Ø§Ù„Ù…Ø´ØªØ±ÙŠ</th>
                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="ordersTable">
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ -->
<div id="orderModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; overflow-y: auto;">
    <div style="max-width: 600px; margin: 40px auto; padding: 20px;">
        <div class="card" style="position: relative;">
            <button onclick="closeModal()" style="position: absolute; left: 15px; top: 15px; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">âœ•</button>
            <div id="orderDetails">
                <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allOrders = [];

    async function loadOrders() {
        const tbody = document.getElementById('ordersTable');
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></td></tr>';
        
        try {
            const res = await fetch('/api/admin/get_orders');
            const data = await res.json();
            
            if (data.status === 'success') {
                allOrders = data.orders;
                updateStats(data.stats);
                renderOrders();
            } else {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #e74c3c;"> ' + (data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£') + '</td></tr>';
            }
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #e74c3c;"> Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</td></tr>';
        }
    }

    function updateStats(stats) {
        document.getElementById('totalOrders').textContent = stats.total || 0;
        document.getElementById('completedOrders').textContent = stats.completed || 0;
        document.getElementById('pendingOrders').textContent = stats.pending || 0;
        document.getElementById('totalRevenue').textContent = (stats.revenue || 0).toFixed(2) + ' Ø±.Ø³';
    }

    function renderOrders() {
        const tbody = document.getElementById('ordersTable');
        const statusFilter = document.getElementById('statusFilter').value;
        const deliveryFilter = document.getElementById('deliveryFilter').value;
        const search = document.getElementById('searchInput').value.toLowerCase();
        
        let filtered = allOrders.filter(o => {
            if (statusFilter !== 'all' && o.status !== statusFilter) return false;
            if (deliveryFilter !== 'all' && o.delivery_type !== deliveryFilter) return false;
            
            const searchStr = `${o.id} ${o.buyer_name} ${o.item_name}`.toLowerCase();
            if (search && !searchStr.includes(search)) return false;
            
            return true;
        });
        
        document.getElementById('ordersCountLabel').textContent = `${filtered.length} Ø·Ù„Ø¨`;
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--muted);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>';
            return;
        }
        
        tbody.innerHTML = filtered.map(o => {
            const statusBadge = o.status === 'completed' 
                ? '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(0,184,148,0.2); color: var(--success);"> Ù…ÙƒØªÙ…Ù„</span>'
                : '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(243,156,18,0.2); color: var(--warning);">â³ Ù…Ø¹Ù„Ù‚</span>';
            
            const typeBadge = o.delivery_type === 'instant'
                ? '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(52,152,219,0.2); color: var(--info);"> ÙÙˆØ±ÙŠ</span>'
                : '<span style="padding: 3px 8px; border-radius: 6px; font-size: 11px; background: rgba(155,89,182,0.2); color: #9b59b6;">ğŸ‘¨â€ğŸ’¼ ÙŠØ¯ÙˆÙŠ</span>';
            
            const date = o.created_at ? new Date(o.created_at).toLocaleDateString('ar-SA') : '-';
            
            return `
                <tr>
                    <td style="font-family: monospace; font-size: 12px;">${o.id || '-'}</td>
                    <td>
                        <div style="font-weight: 600;">${o.buyer_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</div>
                        <div style="font-size: 11px; color: var(--muted);">#${o.buyer_id || '-'}</div>
                    </td>
                    <td>${o.item_name || '-'}</td>
                    <td style="font-weight: 600; color: var(--success);">${o.price || 0} Ø±.Ø³</td>
                    <td>${typeBadge}</td>
                    <td>${statusBadge}</td>
                    <td style="font-size: 12px; color: var(--muted);">${date}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewOrder('${o.id}')"></button>
                        ${o.status === 'pending' ? `<button class="btn btn-success btn-sm" onclick="completeOrder('${o.id}')"></button>` : ''}
                    </td>
                </tr>
            `;
        }).join('');
    }

    function viewOrder(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) return;
        
        const modal = document.getElementById('orderModal');
        const details = document.getElementById('orderDetails');
        
        details.innerHTML = `
            <h2 style="margin-bottom: 20px;"> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
            
            <div style="display: grid; gap: 15px;">
                <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                    <div style="color: var(--muted); font-size: 12px;">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</div>
                    <div style="font-family: monospace;">${order.id}</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                        <div style="color: var(--muted); font-size: 12px;">Ø§Ù„Ù…Ø´ØªØ±ÙŠ</div>
                        <div>${order.buyer_name || '-'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                        <div style="color: var(--muted); font-size: 12px;">ID Ø§Ù„Ù…Ø´ØªØ±ÙŠ</div>
                        <div>${order.buyer_id || '-'}</div>
                    </div>
                </div>
                
                <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                    <div style="color: var(--muted); font-size: 12px;">Ø§Ù„Ù…Ù†ØªØ¬</div>
                    <div>${order.item_name || '-'}</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                        <div style="color: var(--muted); font-size: 12px;">Ø§Ù„Ø³Ø¹Ø±</div>
                        <div style="color: var(--success); font-weight: bold;">${order.price || 0} Ø±.Ø³</div>
                    </div>
                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                        <div style="color: var(--muted); font-size: 12px;">Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
                        <div>${order.delivery_type === 'instant' ? ' ÙÙˆØ±ÙŠ' : 'ğŸ‘¨â€ğŸ’¼ ÙŠØ¯ÙˆÙŠ'}</div>
                    </div>
                </div>
                
                ${order.hidden_data ? `
                    <div style="padding: 12px; background: rgba(108,92,231,0.15); border-radius: 10px; border: 1px solid rgba(108,92,231,0.3);">
                        <div style="color: var(--primary-light); font-size: 12px;"> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ©</div>
                        <div style="font-family: monospace; white-space: pre-wrap; margin-top: 8px;">${order.hidden_data}</div>
                    </div>
                ` : ''}
                
                ${order.buyer_details ? `
                    <div style="padding: 12px; background: rgba(243,156,18,0.15); border-radius: 10px; border: 1px solid rgba(243,156,18,0.3);">
                        <div style="color: var(--warning); font-size: 12px;"> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠ</div>
                        <div style="margin-top: 8px;">${order.buyer_details}</div>
                    </div>
                ` : ''}
            </div>
            
            ${order.status === 'pending' ? `
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success" onclick="completeOrder('${order.id}'); closeModal();">
                         Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                    </button>
                </div>
            ` : ''}
        `;
        
        modal.style.display = 'block';
    }

    function closeModal() {
        document.getElementById('orderModal').style.display = 'none';
    }

    async function completeOrder(orderId) {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ÙƒÙ…Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;
        
        try {
            const res = await fetch('/api/admin/complete_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order_id: orderId })
            });
            const data = await res.json();
            
            if (data.status === 'success') {
                showToast(' ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨');
                loadOrders();
            } else {
                showToast(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            }
        } catch (e) {
            showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
        }
    }

    // Filters
    document.getElementById('statusFilter').addEventListener('change', renderOrders);
    document.getElementById('deliveryFilter').addEventListener('change', renderOrders);
    document.getElementById('searchInput').addEventListener('input', renderOrders);

    // Load on page load
    loadOrders();
</script>
{% endblock %}
